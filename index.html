<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hockey Scorekeeper</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-39HWBJQ5Z1"></script>
  <script>window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-39HWBJQ5Z1');</script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    @keyframes sparkle {

      0%,
      100% {
        transform: scale(1);
        opacity: 1
      }

      50% {
        transform: scale(1.2);
        opacity: .8
      }
    }

    .sparkle {
      animation: sparkle .6s ease-in-out
    }

    @keyframes eq-bar {

      0%,
      100% {
        height: 30%
      }

      50% {
        height: 80%
      }
    }

    .eq-bar {
      animation: eq-bar 0.9s ease-in-out infinite alternate;
    }

    .eq-bar:nth-child(1) {
      animation-delay: 0s
    }

    .eq-bar:nth-child(2) {
      animation-delay: 0.15s
    }

    .eq-bar:nth-child(3) {
      animation-delay: 0.3s
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyBFO04MS1hfTnE_ciPxTJCXO_Jk1w8DudY",
      authDomain: "hockey-scorekeeper.firebaseapp.com",
      databaseURL: "https://hockey-scorekeeper-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hockey-scorekeeper",
      storageBucket: "hockey-scorekeeper.firebasestorage.app",
      messagingSenderId: "804304791634",
      appId: "1:804304791634:web:98532061d3768f6b8c178b"
    };

    let db = null;
    let auth = null;
    try {
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      auth = firebase.auth();
    } catch (e) { console.log("Firebase error:", e) }

    const genCode = () => {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    };

    const SoundEQ = () => (
      <div className="flex items-end gap-0.5 h-4 ml-2">
        <div className="eq-bar w-1 bg-white rounded-full"></div>
        <div className="eq-bar w-1 bg-white rounded-full"></div>
        <div className="eq-bar w-1 bg-white rounded-full"></div>
      </div>
    );

    const JuniorLeagueApp = () => {
      const [activeTab, setActiveTab] = useState('stats');
      const [expandedEvents, setExpandedEvents] = useState({});
      const [currentPeriod, setCurrentPeriod] = useState(1);
      const [homeName, setHomeName] = useState('HOME TEAM');
      const [awayName, setAwayName] = useState('AWAY TEAM');
      const [goalFocusSwapped, setGoalFocusSwapped] = useState(false);
      const [activeGoalies, setActiveGoalies] = useState({ home: 'starter', away: 'starter' });
      const [showShootout, setShowShootout] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [darkMode, setDarkMode] = useState(false);
      const [statsCollapsed, setStatsCollapsed] = useState(false);
      const [focusMode, setFocusMode] = useState(null);
      const [spotifyLoaded, setSpotifyLoaded] = useState(false);
      const [spotifyLoading, setSpotifyLoading] = useState(false);
      const [spotifyFallback, setSpotifyFallback] = useState(false);
      const [spotifyPlaylist, setSpotifyPlaylist] = useState('https://open.spotify.com/playlist/3HunXm4QT4dxcOz6eAljak?si=mKiXLeNMQM6ioJivpWP-EQ&pi=lAZXLD_QSPmpq');
      const [keepScreenOn, setKeepScreenOn] = useState(false);
      const [wakeLock, setWakeLock] = useState(null);
      const [externalLinkUrl, setExternalLinkUrl] = useState('');
      const [externalLinkTitle, setExternalLinkTitle] = useState('');
      const [defaultHomeRoster, setDefaultHomeRoster] = useState('');
      const [screen, setScreen] = useState('start');
      const [matchCode, setMatchCode] = useState('');
      const [inputCode, setInputCode] = useState('');
      const [connectedUsers, setConnectedUsers] = useState(1);
      const [isMultiplayer, setIsMultiplayer] = useState(false);
      const [expandedGoalieStats, setExpandedGoalieStats] = useState({ home: false, away: false });
      const [selectedGoalieStats, setSelectedGoalieStats] = useState({ home: 'total', away: 'total' });
      const [gameMode, setGameMode] = useState(localStorage.getItem('gameMode') || 'single');
      const [matchEnded, setMatchEnded] = useState(false);
      const [sparkleStats, setSparkleStats] = useState({});
      const [error, setError] = useState('');
      const [showReconnectPrompt, setShowReconnectPrompt] = useState(false);
      const [savedMatchCode, setSavedMatchCode] = useState('');
      const [currentUser, setCurrentUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [isCreator, setIsCreator] = useState(false);
      const [isAdmin, setIsAdmin] = useState(false);
      const [forceAuth, setForceAuth] = useState(false);
      const [userMatches, setUserMatches] = useState([]);
      const [loadingMatches, setLoadingMatches] = useState(false);
      const [wasInMatch, setWasInMatch] = useState(false);
      const [periodStats, setPeriodStats] = useState({
        1: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 },
        2: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 },
        3: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 }
      });
      const [playerStats, setPlayerStats] = useState({
        home: { players: {} },
        away: { players: {} }
      });
      const [showPlayerStats, setShowPlayerStats] = useState(false);
      const [playerStatsEditMode, setPlayerStatsEditMode] = useState({ home: false, away: false });
      const [playerStatsViewMode, setPlayerStatsViewMode] = useState('sideBySide');
      const [playerStatsMoment, setPlayerStatsMoment] = useState('FO/SOG');
      const [showAddPlayerModal, setShowAddPlayerModal] = useState(false);
      const [addPlayerTeam, setAddPlayerTeam] = useState('');
      const [addPlayerNumbers, setAddPlayerNumbers] = useState(['']);
      const [expandedPlayerStats, setExpandedPlayerStats] = useState({});
      const [collapsedPlayerTables, setCollapsedPlayerTables] = useState({});
      const [goalWizardStep, setGoalWizardStep] = useState(0);
      const [recordingGoal, setRecordingGoal] = useState(null);
      const [goalSituation, setGoalSituation] = useState('EQ');
      const [goalTime, setGoalTime] = useState('');
      const [penaltyWizardOpen, setPenaltyWizardOpen] = useState(false);
      const [penaltyTeam, setPenaltyTeam] = useState(null);
      const [penaltyType, setPenaltyType] = useState("2'");
      const [penaltyInfraction, setPenaltyInfraction] = useState('');
      const [penaltyTime, setPenaltyTime] = useState('');
      const [penaltyPlayer, setPenaltyPlayer] = useState('');
      const [editingPenaltyIndex, setEditingPenaltyIndex] = useState(null);
      const [goalEvents, setGoalEvents] = useState([]);
      const [penaltyEvents, setPenaltyEvents] = useState([]);
      const [otherEvents, setOtherEvents] = useState([]);
      const [goalScorers, setGoalScorers] = useState([]);
      const [goalAssists, setGoalAssists] = useState([]);
      const [goalPlusPlayers, setGoalPlusPlayers] = useState([]);
      const [goalMinusPlayers, setGoalMinusPlayers] = useState([]);
      const [goalSOGPlayers, setGoalSOGPlayers] = useState([]);
      const [editingGoalIndex, setEditingGoalIndex] = useState(null);
      const [goalFormCollapsed, setGoalFormCollapsed] = useState(false);
      const [goalTimelineCollapsed, setGoalTimelineCollapsed] = useState(true);
      const [penaltyFormCollapsed, setPenaltyFormCollapsed] = useState(false);
      const [penaltyTimelineCollapsed, setPenaltyTimelineCollapsed] = useState(true);
      const [otherWizardOpen, setOtherWizardOpen] = useState(false);
      const [otherTeam, setOtherTeam] = useState(null);
      const [otherEventType, setOtherEventType] = useState('timeout');
      const [otherTime, setOtherTime] = useState('');
      const [editingOtherIndex, setEditingOtherIndex] = useState(null);
      const [otherFormCollapsed, setOtherFormCollapsed] = useState(false);
      const [otherTimelineCollapsed, setOtherTimelineCollapsed] = useState(true);
      const [highlightEventId, setHighlightEventId] = useState(null);
      const audioRefs = { homeGoal: useRef(null), awayGoal: useRef(null), homePenalty: useRef(null), awayPenalty: useRef(null), intro: useRef(null) };
      const [introPlaying, setIntroPlaying] = useState(false);
      const matchRef = useRef(null);
      const userId = useRef(
        currentUser?.uid ||
        localStorage.getItem('userId') ||
        (() => {
          const id = Math.random().toString(36).substr(2, 9);
          localStorage.setItem('userId', id);
          return id;
        })()
      );
      const homeTeamInputRef = useRef(null);
      const DEFAULT_HOME = 'HOME TEAM';
      const DEFAULT_AWAY = 'AWAY TEAM';
      const [isViewer, setIsViewer] = useState(false);
      const [viewerCount, setViewerCount] = useState(0);
      const [playingSound, setPlayingSound] = useState(null);
      const IconSettings = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          className="w-4 h-4"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M11.983 13.943a1.96 1.96 0 100-3.92 1.96 1.96 0 000 3.92z"
          />
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 11-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 110-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06a1.65 1.65 0 001.82.33h.01a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51h.01a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 112.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.01a1.65 1.65 0 001.51 1H21a2 2 0 110 4h-.09a1.65 1.65 0 00-1.51 1z"
          />
        </svg>
      );
      const IconBack = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          className="w-4 h-4"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M15 19l-7-7 7-7"
          />
        </svg>
      );
      const IconChevronDown = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          className="w-4 h-4"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M19 9l-7 7-7-7"
          />
        </svg>
      );
      const IconChevronUp = () => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          className="w-4 h-4"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M5 15l7-7 7 7"
          />
        </svg>
      );

      // Normalization functions
      const normalizePeriodStats = (stats) => {
        const normalized = {};
        for (let p = 1; p <= 4; p++) {
          // Only add period 4 if it actually exists in the data
          if (p === 4 && !stats?.[p]) {
            continue;
          }
          normalized[p] = {
            homeScore: stats?.[p]?.homeScore ?? 0,
            awayScore: stats?.[p]?.awayScore ?? 0,
            homeSaves: stats?.[p]?.homeSaves ?? 0,
            awaySaves: stats?.[p]?.awaySaves ?? 0,
            homeGoalie: stats?.[p]?.homeGoalie ?? { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } },
            awayGoalie: stats?.[p]?.awayGoalie ?? { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } }
          };
        }
        return normalized;
      };

      const normalizePlayerStats = (stats) => {
        const normalized = {
          home: { players: {} },
          away: { players: {} }
        };

        ['home', 'away'].forEach(team => {
          const players = stats?.[team]?.players ?? {};
          Object.keys(players).forEach(playerNum => {
            const player = players[playerNum];
            normalized[team].players[playerNum] = {
              periods: player?.periods ?? {},
              total: {
                'G': player?.total?.['G'] ?? 0,
                'A': player?.total?.['A'] ?? 0,
                'OnIce+': player?.total?.['OnIce+'] ?? 0,
                'OnIce-': player?.total?.['OnIce-'] ?? 0,
                'FO+': player?.total?.['FO+'] ?? 0,
                'FO-': player?.total?.['FO-'] ?? 0,
                'SOG': player?.total?.['SOG'] ?? 0,
                "2'": player?.total?.["2'"] ?? 0,
                "5'": player?.total?.["5'"] ?? 0,
                "10'": player?.total?.["10'"] ?? 0,
                "20'": player?.total?.["20'"] ?? 0,
                'PIM': player?.total?.['PIM'] ?? 0
              }
            };
          });
        });
        return normalized;
      };

      // Reset all game state
      const resetGameState = () => {
        setPeriodStats({
          1: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0, homeGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } }, awayGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } } },
          2: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0, homeGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } }, awayGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } } },
          3: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0, homeGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } }, awayGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } } }
        });

        setPlayerStats({ home: { players: {} }, away: { players: {} } });
        setGoalEvents([]);
        setPenaltyEvents([]);
        setOtherEvents([]);
        setCurrentPeriod(1);
        setMatchEnded(false);
        setGoalFocusSwapped(false);
        setActiveGoalies({ home: 'starter', away: 'starter' });
        setIsCreator(false);
        setSparkleStats({});
        setExpandedPlayerStats({});
      };

      useEffect(() => {
        if (isViewer && screen === 'game') {
          setActiveTab('stats');
        }
      }, [isViewer, screen]);

      // Auth listener
      useEffect(() => {
        if (!auth) {
          setAuthLoading(false);
          return;
        }

        const unsubscribe = auth.onAuthStateChanged(user => {
          setCurrentUser(user);
          if (user && db) {
            db.ref(`users/${user.uid}/isAdmin`).once('value', snapshot => {
              setIsAdmin(snapshot.val() === true);
            });
          } else {
            setIsAdmin(false);
          }
          setAuthLoading(false);
        });
        return () => unsubscribe();
      }, []);

      // Update userId ref when user changes
      useEffect(() => {
        if (currentUser?.uid) {
          userId.current = currentUser.uid;
        }
      }, [currentUser]);

      // Load user's matches when logged in
      useEffect(() => {
        if (!currentUser || !db) return;

        setLoadingMatches(true);
        const matchesRef = db.ref('matches').orderByChild('creatorId').equalTo(currentUser.uid);

        matchesRef.on('value', snapshot => {
          const matches = [];
          snapshot.forEach(child => {
            matches.push({
              id: child.key,
              ...child.val()
            });
          });

          // Sort by creation date, newest first
          matches.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

          setUserMatches(matches);
          setLoadingMatches(false);
        });

        return () => matchesRef.off();
      }, [currentUser]);

      useEffect(() => {

        // Clean up old multiplayer data
        try {
          const raw = localStorage.getItem('multiplayerMatch');
          if (raw) {
            const data = JSON.parse(raw);
            if (!data.code || !data.timestamp || Date.now() - data.timestamp > 6 * 60 * 60 * 1000) {
              localStorage.removeItem('multiplayerMatch');
            }
          }
        } catch (e) {
          localStorage.removeItem('multiplayerMatch');
        }

        // Load user preferences
        ['darkMode', 'spotifyPlaylist', 'statsCollapsed', 'keepScreenOn', 'focusMode', 'externalLinkUrl', 'externalLinkTitle', 'defaultHomeRoster'].forEach(k => {
          const v = localStorage.getItem(k);
          if (v) {
            if (['darkMode', 'statsCollapsed', 'keepScreenOn'].includes(k)) {
              try {
                eval(`set${k.charAt(0).toUpperCase() + k.slice(1)}(JSON.parse(v))`);
              } catch (e) {
                console.log('Failed to parse', k);
              }
            } else if (k === 'focusMode') {
              setFocusMode(v === 'null' ? null : v);
            } else if (k === 'externalLinkUrl') {
              setExternalLinkUrl(v);
            } else if (k === 'externalLinkTitle') {
              setExternalLinkTitle(v);
            } else if (k === 'defaultHomeRoster') {
              setDefaultHomeRoster(v);
            } else {
              eval(`set${k.charAt(0).toUpperCase() + k.slice(1)}(v)`);
            }
          }
        });

        // Check for multiplayer reconnect
        const savedMatch = localStorage.getItem('multiplayerMatch');
        if (savedMatch) {
          try {
            const md = JSON.parse(savedMatch);
            if (md.code) {
              setSavedMatchCode(md.code);
              setGameMode(md.gameMode || 'multi');
              setShowReconnectPrompt(true);
            } else {
              localStorage.removeItem('multiplayerMatch');
            }
          } catch (e) {
            localStorage.removeItem('multiplayerMatch');
          }
        }

        // Load single-player game if no multiplayer session
        const lastScreen = localStorage.getItem('currentScreen');
        if (!savedMatch && (!lastScreen || lastScreen === 'game')) {
          const saved = localStorage.getItem('juniorLeagueGame');
          if (saved) {
            try {
              const gs = JSON.parse(saved);
              if (gs.currentPeriod && gs.periodStats && gs.homeName) {
                setCurrentPeriod(gs.currentPeriod);
                setHomeName(gs.homeName);
                setAwayName(gs.awayName);
                setPeriodStats(normalizePeriodStats(gs.periodStats));
                if (gs.playerStats) setPlayerStats(normalizePlayerStats(gs.playerStats));
                if (gs.goalEvents) setGoalEvents(gs.goalEvents);
                if (gs.penaltyEvents) setPenaltyEvents(gs.penaltyEvents);
                if (gs.otherEvents) setOtherEvents(gs.otherEvents);
                setGameMode('single');
                setScreen('game');
              } else {
                localStorage.removeItem('juniorLeagueGame');
              }
            } catch (e) {
              console.log('Failed to load saved game:', e);
              localStorage.removeItem('juniorLeagueGame');
            }
          }
        }

      }, []);

      useEffect(() => { localStorage.setItem('darkMode', JSON.stringify(darkMode)) }, [darkMode]);
      useEffect(() => { localStorage.setItem('spotifyPlaylist', spotifyPlaylist) }, [spotifyPlaylist]);
      useEffect(() => { localStorage.setItem('statsCollapsed', JSON.stringify(statsCollapsed)) }, [statsCollapsed]);
      useEffect(() => { localStorage.setItem('keepScreenOn', JSON.stringify(keepScreenOn)) }, [keepScreenOn]);
      useEffect(() => { localStorage.setItem('focusMode', focusMode) }, [focusMode]);
      useEffect(() => { localStorage.setItem('externalLinkUrl', externalLinkUrl) }, [externalLinkUrl]);
      useEffect(() => { localStorage.setItem('externalLinkTitle', externalLinkTitle) }, [externalLinkTitle]);
      useEffect(() => { localStorage.setItem('defaultHomeRoster', defaultHomeRoster) }, [defaultHomeRoster]);
      useEffect(() => {
        if (!isMultiplayer && screen === 'game') {
          const gs = { currentPeriod, homeName, awayName, periodStats, playerStats, goalEvents, penaltyEvents, otherEvents, timestamp: new Date().toISOString() };
          localStorage.setItem('juniorLeagueGame', JSON.stringify(gs));
        }
      }, [currentPeriod, homeName, awayName, periodStats, playerStats, goalEvents, penaltyEvents, otherEvents, isMultiplayer, screen]);
      useEffect(() => {
        if (screen === 'create') {
          setTimeout(() => {
            homeTeamInputRef.current?.focus();
            homeTeamInputRef.current?.select();
          }, 50);
        }
      }, [screen]);

      // Handle ?join=XXXXXX-V â†’ open "Join game as viewer" dialog with prefilled code
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const joinCode = params.get('join');

        if (!joinCode) return;

        const code = joinCode.toUpperCase().trim();
        const isViewerCode = code.endsWith('-V');
        const baseCode = isViewerCode ? code.slice(0, -2) : code;

        if (!isViewerCode || baseCode.length !== 6) return;

        // Open start screen in viewer-join mode
        setInputCode(code);
        setGameMode('multi');
        localStorage.setItem('gameMode', 'multi');
        setIsViewer(true);
        setScreen('start');

        // Optional: clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }, []);

      useEffect(() => {
        const handleBeforeUnload = (e) => {
          if (
            screen === 'game' &&
            isMultiplayer &&
            matchEnded &&
            isCreator
          ) {
            e.preventDefault();
            e.returnValue = '';
          }
        };

        window.addEventListener('beforeunload', handleBeforeUnload);
        return () => {
          window.removeEventListener('beforeunload', handleBeforeUnload);
        };
      }, [screen, isMultiplayer, matchEnded, isCreator]);


      useEffect(() => {
        const req = async () => { try { if ('wakeLock' in navigator && keepScreenOn) { const l = await navigator.wakeLock.request('screen'); setWakeLock(l) } } catch (e) { } };
        const rel = async () => { if (wakeLock) { try { await wakeLock.release(); setWakeLock(null) } catch (e) { } } };
        if (keepScreenOn) req(); else rel();
        const hvc = () => { if (keepScreenOn && document.visibilityState === 'visible') req() };
        document.addEventListener('visibilitychange', hvc);
        return () => { rel(); document.removeEventListener('visibilitychange', hvc) }
      }, [keepScreenOn]);

      useEffect(() => {
        if (!isMultiplayer || !matchCode || !db) return;

        let connectionTimeout;
        let hasReceivedData = false;

        matchRef.current = db.ref(`matches/${matchCode}`);

        // Timeout efter 10 sekunder utan data
        connectionTimeout = setTimeout(() => {
          if (!hasReceivedData) {
            setError('Failed to connect to match. Check your connection and try again.');
            console.log('Firebase connection timeout for match:', matchCode);
            if (isMultiplayer) {
              setIsMultiplayer(false);
              localStorage.removeItem('multiplayerMatch');
            }
          }
        }, 10000);

        matchRef.current.on('value', s => {
          const d = s.val();

          // Vi fick data! Rensa timeout
          if (!hasReceivedData) {
            clearTimeout(connectionTimeout);
            hasReceivedData = true;
            setError('');
          }

          if (d) {
            setPeriodStats(normalizePeriodStats(d.periodStats));
            setCurrentPeriod(d.currentPeriod ?? 1);
            setHomeName(d.homeName ?? 'HOME TEAM');
            setAwayName(d.awayName ?? 'AWAY TEAM');
            setMatchEnded(d.ended ?? false);
            setPlayerStats(normalizePlayerStats(d.playerStats));
            setGoalEvents(d.goalEvents ?? []);
            setPenaltyEvents(d.penaltyEvents ?? []);
            setOtherEvents(d.otherEvents ?? []);
            setConnectedUsers(d.users ? Object.keys(d.users).length : 0);
            setViewerCount(d.viewers ? Object.keys(d.viewers).length : 0);
            setIsCreator(d.creatorId === userId.current);

            // Check if user was in match but is now removed (kicked)
            const isCurrentlyInMatch = !!(d.users && d.users[userId.current]);
            const isOwner = d.creatorId === userId.current;
            const amIKicked = d.kickedUsers && d.kickedUsers[userId.current];

            if (!isViewer && !isOwner && isMultiplayer && wasInMatch) {
              // SCENARIO 1: Jag Ã¤r kickad
              if (amIKicked) {
                localStorage.removeItem('multiplayerMatch');
                resetGameState();
                setIsMultiplayer(false);
                setMatchCode('');
                setWasInMatch(false);
                setScreen('start');
                alert('You have been removed from this match. You can join as a viewer instead using the viewer code (-V)');
                return;
              }

              // SCENARIO 2: Matchen Ã¤r inte slut, jag var inne, men nu Ã¤r jag inte det (och inte kickad)
              if (!matchEnded && !isCurrentlyInMatch && d.users && Object.keys(d.users).length > 0) {
                // MÃ¶jligt Network-issue, visa reconect-prompt
                localStorage.removeItem('multiplayerMatch');
                resetGameState();
                setIsMultiplayer(false);
                setMatchCode('');
                setScreen('start');
                alert('You have been disconnected from the match');
              }
            }

            // SÃ¤tt wasInMatch ENDAST nÃ¤r vi verkligen Ã¤r inne
            if (isCurrentlyInMatch && !wasInMatch) {
              setWasInMatch(true);
            }
          }
        }, error => {
          clearTimeout(connectionTimeout);
          console.error('Firebase error:', error);
          setError(`Connection error: ${error.message || 'Failed to connect to Firebase'}`);

          if (isMultiplayer && error.code && error.code.includes('PERMISSION')) {
            setIsMultiplayer(false);
            localStorage.removeItem('multiplayerMatch');
          }
        }
        );
        const path = isViewer ? `viewers/${userId.current}` : `users/${userId.current}`;
        const ur = matchRef.current.child(path);

        const kickedUsersRef = matchRef.current.child('kickedUsers');

        if (isViewer) {
          // Viewers kan alltid ansluta
          ur.set(true);
        } else {
          // Editors: kontrollera max 5
          matchRef.current.once('value', snapshot => {
            const currentMatch = snapshot.val();
            const editorCount = currentMatch?.users ? Object.keys(currentMatch.users).length : 0;
            const isCreatorOfThisMatch = currentMatch?.creatorId === userId.current;

            if (editorCount >= 5 && !isCreatorOfThisMatch) {
              setError('Game is full (max 5 editors). Please try joining as viewer instead.');
              setIsMultiplayer(false);
              localStorage.removeItem('multiplayerMatch');
              setScreen('start');
              return;
            }

            ur.set({
              joinedAt: Date.now(),
              role: 'editor'
            });
          });
        }

        ur.onDisconnect().remove();

        // Lyssna pÃ¥ kickedUsers fÃ¶r omedelbar detektion
        kickedUsersRef.on('value', s => {
          const kickedUsers = s.val() || {};

          // Om jag Ã¤r kickad, kasta ut mig omedelbar
          if (!isViewer && kickedUsers[userId.current]) {
            localStorage.removeItem('multiplayerMatch');
            resetGameState();
            setIsMultiplayer(false);
            setMatchCode('');
            setWasInMatch(false);
            setScreen('start');
            alert('You have been removed from this match. You can join as a viewer instead using the viewer code (-V)');
          }
        });

        localStorage.setItem('multiplayerMatch', JSON.stringify({ code: matchCode, timestamp: Date.now(), isViewer: isViewer, gameMode: 'multi' }));

        return () => {
          clearTimeout(connectionTimeout);
          if (matchRef.current) { matchRef.current.off(); kickedUsersRef.off(); ur.remove() }
        }
      }, [isMultiplayer, matchCode, isViewer]);

      const kickEditor = (editorId) => {
        if (!isCreator || !matchRef.current) {
          alert('Only the creator can kick editors');
          return;
        }

        if (editorId === userId.current) {
          alert('You cannot kick yourself');
          return;
        }

        if (window.confirm('Kick this editor from the game?')) {
          matchRef.current.update({
            [`users/${editorId}`]: null,
            [`kickedUsers/${editorId}`]: {
              kickedAt: Date.now(),
              kickedBy: userId.current
            }
          }).catch(e => {
            console.error('Failed to kick editor:', e);
            alert('Failed to kick editor');
          });
        }
      };

      const reconnectToMatch = () => {
        setWasInMatch(false);
        try {
          const saved = JSON.parse(localStorage.getItem('multiplayerMatch'));
          resetGameState();
          setGameMode('multi');
          localStorage.setItem('gameMode', 'multi');
          setMatchCode(savedMatchCode);
          setIsViewer(saved?.isViewer || false);
          setIsMultiplayer(true);
          setScreen('game');
          setShowReconnectPrompt(false);
        } catch (e) {
          resetGameState();
          setGameMode('multi');
          localStorage.setItem('gameMode', 'multi');
          setMatchCode(savedMatchCode);
          setIsMultiplayer(true);
          setScreen('game');
          setShowReconnectPrompt(false);
        }
      };

      const startNewSession = () => {
        localStorage.removeItem('multiplayerMatch');
        localStorage.removeItem('juniorLeagueGame');
        resetGameState();
        // Ta INTE bort gameMode hÃ¤r - lÃ¥t anvÃ¤ndaren vÃ¤lja vad de vill gÃ¶ra
        setShowReconnectPrompt(false);
        setIsViewer(false);
        setMatchEnded(false);
      };

      const createMatch = () => {
        // Check if user is logged in
        if (!currentUser) {
          alert('You must be logged in to create a game');
          setScreen('start');
          return;
        }

        // Rensa ALL single-game data nÃ¤r vi gÃ¥r till multi
        localStorage.removeItem('juniorLeagueGame');
        localStorage.removeItem('tempMatchCode');

        const code = genCode();

        // Rensa error innan vi fÃ¶rsÃ¶ker
        setError('');

        // Uppdatera state OCH navigera
        setMatchCode(code);
        setMatchEnded(false);
        setIsViewer(false);
        setIsCreator(true);
        setGameMode('multi');
        localStorage.setItem('gameMode', 'multi');

        // Lagra koden temporÃ¤rt sÃ¥ vi kan anvÃ¤nda den direkt
        localStorage.setItem('tempMatchCode', code);

        setScreen('created');
      };


      const startMatch = () => {
        if (!db) { setError('Firebase not configured'); return }
        if (!currentUser) { setError('You must be logged in to create a game'); return }

        // AnvÃ¤nd matchCode frÃ¥n state, fallback till localStorage om nÃ¶dvÃ¤ndigt
        const code = matchCode || localStorage.getItem('tempMatchCode');

        if (!code) {
          setError('Match code not found. Please try again.');
          return;
        }

        // SÃ¤kerstÃ¤ll att vi Ã¤r i multi-mode
        if (gameMode !== 'multi') {
          setGameMode('multi');
          localStorage.setItem('gameMode', 'multi');
        }

        // Rensa all single-game data
        localStorage.removeItem('juniorLeagueGame');

        const viewerCode = code + '-V';
        db.ref(`matches/${code}`).set({
          homeName,
          awayName,
          currentPeriod: 1,
          periodStats: {
            1: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 },
            2: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 },
            3: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 }
          },
          playerStats: { home: { players: {} }, away: { players: {} } },
          goalEvents: [],
          penaltyEvents: [],
          otherEvents: [],
          ended: false,
          createdAt: Date.now(),
          creatorId: userId.current,
          ownerEmail: currentUser.email,
          locked: false,

          // Strukturerad users-lista
          users: {
            [userId.current]: {
              joinedAt: Date.now(),
              role: 'editor'
            }
          },

          // Viewers lista
          viewers: {},

          // Kicked users (svartlista)
          kickedUsers: {},

          viewerCode: viewerCode
        }).then(() => {
          resetGameState();
          setGameMode('multi');
          localStorage.setItem('gameMode', 'multi');
          setIsMultiplayer(true);
          setIsCreator(true);
          localStorage.removeItem('juniorLeagueGame');
          // Rensa ALL temp-data
          localStorage.removeItem('tempMatchCode');
          localStorage.removeItem('juniorLeagueGame');

          // Reset game state fÃ¶r att starta friskt
          resetGameState();

          // SÃ¤kerstÃ¤ll korrekt state
          setGameMode('multi');
          setIsMultiplayer(true);
          setIsCreator(true);
          setMatchCode(code);

          // Spara multiplayer session
          localStorage.setItem('multiplayerMatch', JSON.stringify({ code: code, timestamp: Date.now(), isViewer: false, gameMode: 'multi' }));

          setScreen('game');
          if (window.gtag) gtag('event', 'match_created', { match_code: code });
        }).catch(e => setError('Failed: ' + e.message))
      };

      const joinMatch = () => {
        if (!db) { setError('Firebase not configured'); return }

        const c = inputCode.toUpperCase().trim();
        const isViewerCode = c.endsWith('-V');
        const baseCode = isViewerCode ? c.slice(0, -2) : c;

        if ((!isViewerCode && c.length !== 6) || (isViewerCode && baseCode.length !== 6)) {
          setError('Invalid code');
          return;
        }

        // Editor access requires login
        if (!isViewerCode && !currentUser) {
          setError('You must be logged in to join as editor. Use viewer code (-V) to watch without login.');
          return;
        }

        db.ref(`matches/${baseCode}`).once('value').then(s => {
          if (s.exists()) {
            const d = s.val();

            // Ã„r anvÃ¤ndaren kickad? (bara relevant fÃ¶r editors, inte viewers)
            if (!isViewerCode && d.kickedUsers && d.kickedUsers[userId.current]) {
              setError('You have been removed from this game as an editor. You can join as a viewer instead using the viewer code (-V)');
              return;
            }

            // Ã„r matchen lÃ¥st OCH Ã¤r du inte creator?
            if (!isViewerCode && d.locked && d.creatorId !== userId.current) {
              setError('This game is locked to new editors');
              return;
            }

            // Ã„r det redan 5+ editors (exklusive creator)?
            const editorCount = d.users ? Object.keys(d.users).length : 0;
            const isCreatorOfThisMatch = d.creatorId === userId.current;

            if (!isViewerCode && editorCount >= 5 && !isCreatorOfThisMatch) {
              setError('This game is full (max 5 editors). You can join as a viewer instead.');
              return;
            }

            if (d.ended) {
              // NY KOD: Erbjud att joina som viewer
              if (window.confirm('This game has ended. Join as viewer to see final stats?')) {
                resetGameState();
                setGameMode('multi');
                localStorage.setItem('gameMode', 'multi');
                setMatchCode(baseCode);
                setIsViewer(true);
                setIsCreator(d.creatorId === userId.current);
                setIsMultiplayer(true);
                localStorage.removeItem('juniorLeagueGame');
                localStorage.setItem('multiplayerMatch', JSON.stringify({ code: baseCode, timestamp: Date.now(), isViewer: true, gameMode: 'multi' }));
                setScreen('game');
                if (window.gtag) gtag('event', 'match_joined_viewer_ended', { match_code: baseCode });
              } else {
                setError('This game has already ended');
              }
            }
            else {
              resetGameState();
              setGameMode('multi');
              localStorage.setItem('gameMode', 'multi');
              setMatchCode(baseCode);
              setIsViewer(isViewerCode);
              setIsCreator(d.creatorId === userId.current);
              setIsMultiplayer(true);
              localStorage.removeItem('juniorLeagueGame');
              localStorage.setItem('multiplayerMatch', JSON.stringify({ code: baseCode, timestamp: Date.now(), isViewer: isViewerCode, gameMode: 'multi' }));
              setScreen('game');

              // LÃ¤gg till user i rÃ¤tt lista baserat pÃ¥ om det Ã¤r viewer eller editor
              if (isViewerCode) {
                // Viewer: lÃ¤gg in i viewers-listan
                db.ref(`matches/${baseCode}/viewers/${userId.current}`).set(true).catch(e => {
                  console.error('Failed to register as viewer:', e);
                });
              } else {
                // Editor: lÃ¤gg in i users-listan med metadata
                db.ref(`matches/${baseCode}/users/${userId.current}`).set({
                  joinedAt: Date.now(),
                  role: 'editor'
                }).catch(e => {
                  console.error('Failed to register as editor:', e);
                });
              }

              if (window.gtag) gtag('event', isViewerCode ? 'match_joined_viewer' : 'match_joined_editor', { match_code: baseCode });
            }
          } else setError('No game found with that code')
        }).catch(e => setError('Failed: ' + e.message))
      };

      const continueAlone = () => {
        const prevMode = gameMode;
        localStorage.removeItem('multiplayerMatch');

        // Om vi kommer frÃ¥n multi-lÃ¤ge, rensa och bÃ¶rja nytt
        if (prevMode === 'multi') {
          resetGameState();
          localStorage.removeItem('juniorLeagueGame');
        }

        setGameMode('single');
        localStorage.setItem('gameMode', 'single');
        setIsMultiplayer(false);
        setIsViewer(false);
        setMatchEnded(false);
        setScreen('game');
      };

      const endMatch = () => {
        if (window.confirm('End game for all users?')) {
          if (matchRef.current) {
            matchRef.current.update({
              ended: true,
              users: {},      // TÃ¶m users-listan (istÃ¤llet fÃ¶r null)
              viewers: {},    // TÃ¶m viewers-listan (istÃ¤llet fÃ¶r null)
              locked: false
            });
          }

          setMatchEnded(true);
          setWasInMatch(false);
          localStorage.removeItem('multiplayerMatch');
          setShowReconnectPrompt(false);
        }
      };

      const leaveMatch = () => {
        if (window.confirm('Leave multiplayer game?')) {
          // Ta bort frÃ¥n users eller viewers listen innan vi lÃ¤mnar
          if (isMultiplayer && matchCode && matchRef.current) {
            const path = isViewer ? `viewers/${userId.current}` : `users/${userId.current}`;
            matchRef.current.child(path).remove().catch(e => {
              console.error('Failed to remove from match:', e);
            });
          }

          localStorage.removeItem('multiplayerMatch');
          resetGameState();
          setGameMode('single');
          localStorage.setItem('gameMode', 'single');
          setIsMultiplayer(false);
          setIsViewer(false);
          setMatchEnded(false);
          setMatchCode('');
          setScreen('start');
        }
      };

      const exitToStart = () => {
        if (window.confirm('Exit to start screen? Your game data will be removed')) {
          localStorage.removeItem('juniorLeagueGame');
          resetGameState();
          setGoalEvents([]);
          setGameMode('single');
          setScreen('start');
        }
      };

      const MatchHistory = ({ darkMode, matches, loading, onJoinMatch, onBack }) => {
        const [filter, setFilter] = React.useState('all'); // 'all', 'active', 'ended'
        const [expandedMatches, setExpandedMatches] = React.useState({});

        const filteredMatches = matches.filter(m => {
          if (filter === 'active') return !m.ended;
          if (filter === 'ended') return m.ended;
          return true;
        });

        const formatDate = (timestamp) => {
          if (!timestamp) return 'Unknown date';
          const date = new Date(timestamp);
          return date.toLocaleDateString('sv-SE', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        };

        const getTotalScore = (match) => {
          let homeScore = 0;
          let awayScore = 0;

          Object.keys(match.periodStats || {}).forEach(period => {
            homeScore += match.periodStats[period]?.homeScore || 0;
            awayScore += match.periodStats[period]?.awayScore || 0;
          });

          return { homeScore, awayScore };
        };

        return (
          <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
            <div className={`${darkMode ? 'bg-gray-800 border-b border-gray-700' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-4 shadow-lg`}>
              <div className="max-w-6xl mx-auto">
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-xl font-bold">My Games</h2>
                  <button
                    onClick={onBack}
                    className={`${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-4 py-2 rounded-lg text-sm font-semibold`}
                  >
                    <IconBack />
                  </button>
                </div>

                <div className="flex gap-2">
                  {['all', 'active', 'ended'].map(f => (
                    <button
                      key={f}
                      onClick={() => setFilter(f)}
                      className={`px-3 py-1 rounded text-sm font-bold capitalize ${filter === f
                        ? 'bg-yellow-400 text-blue-900'
                        : darkMode
                          ? 'bg-gray-700'
                          : 'bg-white bg-opacity-20'
                        }`}
                    >
                      {f}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="max-w-6xl mx-auto p-4">
              {loading ? (
                <div className="text-center py-12">
                  <div className={`animate-spin inline-block w-12 h-12 border-4 ${darkMode ? 'border-gray-600 border-t-white' : 'border-gray-300 border-t-blue-600'} rounded-full mb-4`}></div>
                  <div className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Loading games...</div>
                </div>
              ) : filteredMatches.length === 0 ? (
                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-lg shadow p-8 text-center`}>
                  <h3 className="text-xl font-bold mb-2">No games yet</h3>
                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'} mb-4`}>
                    {filter === 'active' ? 'No active games' : filter === 'ended' ? 'No ended games' : 'Create your first game to get started!'}
                  </p>
                  <button
                    onClick={onBack}
                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold"
                  >
                    Create Game
                  </button>
                </div>
              ) : (
                <div className="grid gap-4">
                  {filteredMatches.map(match => {
                    const { homeScore, awayScore } = getTotalScore(match);

                    return (
                      <div
                        key={match.id}
                        className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow-lg p-4 hover:shadow-xl transition-shadow`}
                      >
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex items-center gap-2">
                            {match.ended ? (
                              <span className="bg-gray-500 px-2 py-1 rounded text-xs font-bold text-white">ENDED</span>
                            ) : (
                              <span className="flex items-center gap-1 bg-red-500 px-2 py-1 rounded text-xs font-bold text-white">
                                <span className="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></span>
                                LIVE
                              </span>
                            )}
                            <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              {formatDate(match.createdAt)}
                            </span>
                          </div>
                          <span className={`text-xs font-mono ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            {match.id}
                          </span>
                        </div>

                        <div className="grid grid-cols-3 gap-4 items-center mb-3">
                          <div className="text-right">
                            <div className={`font-bold mb-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                              {match.homeName || 'Home Team'}
                            </div>
                          </div>

                          <div className="text-center">
                            <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                              {homeScore} - {awayScore}
                            </div>
                          </div>

                          <div className="text-left">
                            <div className={`font-bold mb-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                              {match.awayName || 'Away Team'}
                            </div>
                          </div>
                        </div>

                        <div className="flex gap-2 items-center">
                          <button
                            onClick={() => onJoinMatch(match.id)}
                            className={`flex-1 ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-600 hover:bg-blue-700'} text-white py-2 rounded-lg font-semibold text-sm`}
                          >
                            {match.ended ? 'View Game' : 'Rejoin Game'}
                          </button>

                          {!match.ended && (
                            <button
                              onClick={() => {
                                navigator.clipboard.writeText(match.id);
                                alert('Game code copied!');
                              }}
                              className={`px-4 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} ${darkMode ? 'text-white' : 'text-gray-800'} py-2 rounded-lg font-semibold text-sm`}
                            >
                              ðŸ“‹
                            </button>
                          )}

                          <button
                            onClick={() => setExpandedMatches(prev => ({ ...prev, [match.id]: !prev[match.id] }))}
                            className={`px-3 py-2 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                          >
                            {expandedMatches[match.id] ? <IconChevronUp /> : <IconChevronDown />}
                          </button>
                        </div>

                        {expandedMatches[match.id] && (
                          <div className={`mt-3 pt-3 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} space-y-3`}>
                            <h4 className="font-semibold">Manage Game</h4>

                            <div>
                              <div className="text-sm font-semibold mb-2">Connected Editors:</div>
                              {match.users && Object.keys(match.users).length > 0 ? (
                                <div className="space-y-1 mb-3">



                                  {Object.keys(match.users).filter(userId => userId !== match.creatorId).map(userId => (
                                    <div key={userId} className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                      <span className="text-sm">{userId}</span>
                                      <button
                                        onClick={() => {
                                          if (window.confirm('Kick out this editor?')) {
                                            db.ref(`matches/${match.id}/users/${userId}`).remove();
                                            db.ref(`matches/${match.id}/kickedUsers/${userId}`).set({
                                              kickedAt: Date.now(),
                                              kickedBy: currentUser.uid
                                            }).catch(e => {
                                              console.error('Failed to record kick:', e);
                                            });
                                          }
                                        }}
                                        className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-semibold"
                                      >
                                        Kick
                                      </button>
                                    </div>
                                  ))}

                                </div>
                              ) : (
                                <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>No editors connected</div>
                              )}

                              {match.viewers && Object.keys(match.viewers).length > 0 && (
                                <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  ðŸ‘ï¸ {Object.keys(match.viewers).length} viewer{Object.keys(match.viewers).length !== 1 ? 's' : ''} connected
                                </div>
                              )}
                            </div>

                            <div className="flex items-center gap-2 py-2">
                              <input
                                type="checkbox"
                                checked={match.locked || false}
                                onChange={(e) => {
                                  db.ref(`matches/${match.id}`).update({ locked: e.target.checked });
                                }}
                                className="w-4 h-4"
                                disabled={match.creatorId !== currentUser?.uid || match.ended}
                              />
                              <label className="text-sm cursor-pointer flex-1">
                                {match.locked ? 'ðŸ”’' : 'ðŸ”“'} Lock for new editors
                              </label>
                            </div>

                            <div className="flex gap-2 pt-2 border-t">
                              {match.ended && (
                                <>
                                  <button
                                    onClick={() => {
                                      if (window.confirm('Restart this game? All kicked editors will be able to rejoin.')) {
                                        db.ref(`matches/${match.id}`).update({
                                          ended: false,
                                          kickedUsers: {}
                                        });
                                      }
                                    }}
                                    className="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded font-semibold text-sm"
                                  >
                                    Restart Game
                                  </button>
                                  <button
                                    onClick={() => {
                                      if (window.confirm(`Delete Game ${match.id}?`)) {
                                        db.ref(`matches/${match.id}`).remove();
                                      }
                                    }}
                                    className="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded font-semibold text-sm"
                                  >
                                    Delete Game
                                  </button>
                                </>
                              )}

                              {!match.ended && (
                                <button
                                  onClick={() => {
                                    if (window.confirm('End this game for all users?')) {
                                      db.ref(`matches/${match.id}`).update({ ended: true });
                                    }
                                  }}
                                  className="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 rounded font-semibold text-sm"
                                >
                                  End Game
                                </button>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        );
      };

      const AuthScreen = ({ darkMode, setDarkMode, onSuccess }) => {
        const [mode, setMode] = React.useState('login'); // 'login' or 'signup'
        const [email, setEmail] = React.useState('');
        const [password, setPassword] = React.useState('');
        const [teamName, setTeamName] = React.useState('');
        const [error, setError] = React.useState('');
        const [loading, setLoading] = React.useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError('');
          setLoading(true);

          if (!auth) {
            setError('Authentication not available');
            setLoading(false);
            return;
          }

          try {
            if (mode === 'signup') {
              // Sign up
              if (!teamName.trim()) {
                setError('Please enter a team name');
                setLoading(false);
                return;
              }

              const userCredential = await auth.createUserWithEmailAndPassword(email, password);
              const user = userCredential.user;

              // Save team info to database
              await db.ref(`users/${user.uid}`).set({
                email: email,
                teamName: teamName.trim(),
                createdAt: Date.now()
              });

              onSuccess();
            } else {
              // Login
              await auth.signInWithEmailAndPassword(email, password);
              onSuccess();
            }
          } catch (err) {
            console.error('Auth error:', err);

            // User-friendly error messages
            if (err.code === 'auth/email-already-in-use') {
              setError('This email is already registered');
            } else if (err.code === 'auth/weak-password') {
              setError('Password should be at least 6 characters');
            } else if (err.code === 'auth/invalid-email') {
              setError('Invalid email address');
            } else if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
              setError('Invalid email or password');
            } else {
              setError(err.message || 'Authentication failed');
            }
            setLoading(false);
          }
        };

        return (
          <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
            <div className="max-w-md w-full p-6">
              <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-2xl shadow-2xl p-8`}>



                <div className="flex justify-end">
                  <button
                    onClick={() => onSuccess()}
                    className={`p-2 rounded-lg transition-colors ${darkMode
                      ? 'hover:bg-gray-700 text-gray-400 hover:text-gray-300'
                      : 'hover:bg-gray-100 text-gray-600 hover:text-gray-800'
                      }`}
                    aria-label="Close"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>



                <div className="text-center mb-8">
                  <h1 className="text-3xl font-bold mb-2">Hockey Scorekeeper</h1>
                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                    {mode === 'login' ? 'Login to your account' : 'Create your team account'}
                  </p>
                </div>

                <form onSubmit={handleSubmit} className="space-y-4">
                  {mode === 'signup' && (
                    <div>
                      <label className="block text-sm mb-2">Team Name</label>
                      <input
                        type="text"
                        value={teamName}
                        onChange={(e) => setTeamName(e.target.value)}
                        placeholder="e.g. SÃ¶dertÃ¤lje SK"
                        className={`w-full px-4 py-3 border rounded-lg ${darkMode
                          ? 'bg-gray-700 border-gray-600 text-white'
                          : 'border-gray-300'
                          }`}
                        required
                      />
                    </div>
                  )}

                  <div>
                    <label className="block text-sm mb-2">Email</label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      placeholder="your@email.com"
                      className={`w-full px-4 py-3 border rounded-lg ${darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'border-gray-300'
                        }`}
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm mb-2">Password</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="Min 6 characters"
                      className={`w-full px-4 py-3 border rounded-lg ${darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'border-gray-300'
                        }`}
                      required
                      minLength={6}
                    />
                  </div>

                  {error && (
                    <div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded text-sm">
                      {error}
                    </div>
                  )}

                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-4 rounded-xl font-bold text-lg shadow-lg"
                  >
                    {loading ? 'Please wait...' : mode === 'login' ? 'LOGIN' : 'CREATE ACCOUNT'}
                  </button>
                </form>

                <div className="mt-6 text-center space-y-2">
                  <div className="text-sm text-center">
                    <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                      {mode === 'login' ? "Don't have an account? " : 'Already have an account? '}
                    </span>
                    <button
                      onClick={() => {
                        setMode(mode === 'login' ? 'signup' : 'login');
                        setError('');
                      }}
                      className={`font-semibold ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'} hover:underline`}
                    >
                      {mode === 'login' ? 'Sign up' : 'Login'}
                    </button>
                  </div>


                </div>
              </div>
            </div>
          </div>
        );
      };

      const AdminPanel = ({ darkMode, setScreen }) => {

        const [sortDir, setSortDir] = React.useState('desc');
        const [matches, setMatches] = React.useState({});

        React.useEffect(() => {
          if (!db) return;

          const ref = db.ref('matches');
          ref.on('value', snap => {
            setMatches(snap.val() || {});
          });

          return () => ref.off();
        }, []);

        const deleteMatch = (id) => {
          if (!window.confirm(`Delete game ${id}?`)) return;
          db.ref(`matches/${id}`).remove();
        };

        const toggleEnded = (id, ended) => {
          db.ref(`matches/${id}`).update({ ended: !ended });
        };

        return (
          <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-blue-600'} text-white p-4`}>
              <div className="max-w-6xl mx-auto flex justify-between items-center">
                <h2 className="font-bold text-lg">Admin â€“ Games</h2>
                <div className="flex gap-2">
                  <button
                    onClick={() => setScreen('start')}
                    className="bg-white bg-opacity-20 px-3 py-2 rounded hover:bg-opacity-30"
                  >
                    <IconBack />
                  </button>
                </div>
              </div>
            </div>

            <div className="max-w-6xl mx-auto p-4">
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className={`${darkMode ? 'bg-gray-800 text-gray-200' : 'bg-gray-200'}`}>
                    <tr>
                      <th className={`px-3 py-3 text-left sticky left-0 z-10 ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>Match ID</th>
                      <th className="px-3 py-3 text-left">Owner Email</th>
                      <th className="px-3 py-3 text-left">Home</th>
                      <th className="px-3 py-3 text-left">Away</th>
                      <th className="px-3 py-3">Status</th>
                      <th
                        onClick={() =>
                          setSortDir(d => (d === 'asc' ? 'desc' : 'asc'))
                        }
                        className="px-3 py-3 text-center cursor-pointer select-none hover:bg-opacity-80"
                      >
                        Created {sortDir === 'asc' ? <IconChevronDown /> : <IconChevronUp />}
                      </th>
                      <th className="px-3 py-3 whitespace-nowrap min-w-[140px]">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.keys(matches).length === 0 && (
                      <tr>
                        <td colSpan="7" className="text-center py-6 opacity-60">
                          No games found
                        </td>
                      </tr>
                    )}

                    {Object.entries(matches)
                      .sort((a, b) => {
                        const tA = a[1].createdAt || 0;
                        const tB = b[1].createdAt || 0;
                        return sortDir === 'asc' ? tA - tB : tB - tA;
                      })
                      .map(([id, m]) => (
                        <tr
                          key={id}
                          className={`border-t ${darkMode ? 'border-gray-700 text-gray-200' : 'border-gray-300'}`}
                        >
                          <td className={`px-3 py-2 font-mono sticky left-0 z-10 ${darkMode ? 'bg-gray-900 text-gray-200' : 'bg-gray-100'}`}>{id}</td>
                          <td className={`px-3 py-2 ${darkMode ? 'text-gray-200' : ''}`}>{m.ownerEmail || 'â€”'}</td>
                          <td className={`px-3 py-2 ${darkMode ? 'text-gray-200' : ''}`}>{m.homeName || 'â€”'}</td>
                          <td className={`px-3 py-2 ${darkMode ? 'text-gray-200' : ''}`}>{m.awayName || 'â€”'}</td>
                          <td className={`px-3 py-2 text-center ${darkMode ? 'text-gray-200' : ''}`}>
                            {m.ended ? 'Ended' : 'Active'}
                          </td>
                          <td className={`px-3 py-2 text-center ${darkMode ? 'text-gray-200' : ''}`}>
                            {m.createdAt
                              ? new Date(m.createdAt).toLocaleString()
                              : 'â€”'}
                          </td>
                          <td className="px-3 py-2 text-center space-x-2 whitespace-nowrap">
                            <button
                              onClick={() => toggleEnded(id, m.ended)}
                              className="px-3 py-1.5 rounded bg-yellow-500 hover:bg-yellow-600 text-white inline-flex items-center"
                              title={m.ended ? 'Resume game' : 'End game'}
                            >
                              {m.ended ? (
                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                  <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" />
                                </svg>
                              ) : (
                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clipRule="evenodd" />
                                </svg>
                              )}
                            </button>
                            <button
                              onClick={() => deleteMatch(id)}
                              className="px-3 py-1.5 rounded bg-red-600 hover:bg-red-700 text-white inline-flex items-center"
                              title="Delete game"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            </button>
                          </td>
                        </tr>
                      ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      };



      const updateStat = (team, stat, delta) => {
        if (isViewer) return;
        if (isMultiplayer && !currentUser) {
          alert('You must be logged in to edit multiplayer games');
          return;
        }
        const ns = structuredClone(periodStats);
        if (!ns[currentPeriod]) {
          ns[currentPeriod] = {
            homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0,
            homeGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } },
            awayGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } }
          };
        }

        // Initiera goalie-data om det saknas
        if (!ns[currentPeriod].homeGoalie) {
          ns[currentPeriod].homeGoalie = { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } };
        }
        if (!ns[currentPeriod].awayGoalie) {
          ns[currentPeriod].awayGoalie = { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } };
        }

        // Om det Ã¤r saves, uppdatera bÃ¥de totala saves OCH den aktiva mÃ¥lvaktens saves
        if (stat === 'Saves') {
          const activeGoalie = activeGoalies[team];

          // Uppdatera aktiv mÃ¥lvakts saves
          ns[currentPeriod][team + 'Goalie'][activeGoalie].saves = Math.max(0, (ns[currentPeriod][team + 'Goalie'][activeGoalie].saves || 0) + delta);

          // RÃ¤kna om totala saves (bÃ¥da mÃ¥lvakter tillsammans)
          const totalSaves = (ns[currentPeriod][team + 'Goalie'].starter.saves || 0) + (ns[currentPeriod][team + 'Goalie'].backup.saves || 0);
          ns[currentPeriod][team + stat] = totalSaves;
        }
        else if (stat === 'Score') {
          // Uppdatera lagets score
          ns[currentPeriod][team + stat] = Math.max(
            0,
            (ns[currentPeriod][team + stat] || 0) + delta
          );

          // Uppdatera GA pÃ¥ motstÃ¥ndarlagets AKTIVA mÃ¥lvakt (bÃ¥de + och -)
          const oppTeam = team === 'home' ? 'away' : 'home';
          const oppActiveGoalie = activeGoalies[oppTeam];

          const goalie =
            ns[currentPeriod][oppTeam + 'Goalie'][oppActiveGoalie];

          goalie.ga = Math.max(0, (goalie.ga || 0) + delta);
        }

        else {
          ns[currentPeriod][team + stat] = Math.max(0, (ns[currentPeriod][team + stat] || 0) + delta);
        }

        setPeriodStats(ns);
        const k = `${team}${stat}${currentPeriod}`;
        setSparkleStats(p => ({ ...p, [k]: true }));
        setTimeout(() => setSparkleStats(p => ({ ...p, [k]: false })), 600);
        if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ periodStats: ns })
      };



      const updatePlayerStat = (team, playerNum, stat, delta) => {
        if (isViewer || matchEnded) return;
        if (isMultiplayer && !currentUser) {
          alert('You must be logged in to edit multiplayer games');
          return;
        }

        const period = currentPeriod;
        const newStats = structuredClone(playerStats);

        if (!newStats[team]) newStats[team] = { players: {} };
        if (!newStats[team].players) newStats[team].players = {};

        if (!newStats[team].players[playerNum]) {
          newStats[team].players[playerNum] = {
            periods: {},
            total: { 'G': 0, 'A': 0, 'OnIce+': 0, 'OnIce-': 0, 'FO+': 0, 'FO-': 0, 'SOG': 0, "2'": 0, "5'": 0, "10'": 0, "20'": 0, 'PIM': 0 }
          };
        }

        if (!newStats[team].players[playerNum].periods[period]) {
          newStats[team].players[playerNum].periods[period] = { 'G': 0, 'A': 0, 'OnIce+': 0, 'OnIce-': 0, 'FO+': 0, 'FO-': 0, 'SOG': 0, "2'": 0, "5'": 0, "10'": 0, "20'": 0, 'PIM': 0 };
        }

        if (stat === 'G') {
          const currentSOG = newStats[team].players[playerNum].periods[period]['SOG'] || 0;
          newStats[team].players[playerNum].periods[period]['SOG'] = Math.max(0, currentSOG + delta);
        }

        const currentPeriodVal = newStats[team].players[playerNum].periods[period][stat] || 0;
        newStats[team].players[playerNum].periods[period][stat] = Math.max(0, currentPeriodVal + delta);

        // If updating a penalty, also update PIM for this period
        const penaltyMinutes = { "2'": 2, "5'": 5, "10'": 10, "20'": 20 };
        if (penaltyMinutes[stat]) {
          const pimDelta = penaltyMinutes[stat] * delta;
          const currentPIM = newStats[team].players[playerNum].periods[period]['PIM'] || 0;
          newStats[team].players[playerNum].periods[period]['PIM'] = Math.max(0, currentPIM + pimDelta);
        }

        const statsToRecalc = stat === 'G' ? [stat, 'SOG'] : penaltyMinutes[stat] ? [stat, 'PIM'] : [stat];
        statsToRecalc.forEach(s => {
          newStats[team].players[playerNum].total[s] = 0;
          Object.keys(newStats[team].players[playerNum].periods).forEach(p => {
            newStats[team].players[playerNum].total[s] += newStats[team].players[playerNum].periods[p][s] || 0;
          });
        });

        setPlayerStats(newStats);
        const sparkleKeys = stat === 'G' ? [`${team}${playerNum}G${period}`, `${team}${playerNum}SOG${period}`] : [`${team}${playerNum}${stat}${period}`];
        sparkleKeys.forEach(k => {
          setSparkleStats(p => ({ ...p, [k]: true }));
        });
        setTimeout(() => {
          sparkleKeys.forEach(k => {
            setSparkleStats(p => ({ ...p, [k]: false }));
          });
        }, 600);

        if (isMultiplayer && matchRef.current) matchRef.current.update({ playerStats: newStats });
      };

      const removePlayer = (team, playerNum) => {
        if (isViewer || matchEnded) return;
        if (isMultiplayer && !currentUser) {
          alert('You must be logged in to edit multiplayer games');
          return;
        }

        if (!window.confirm(`Remove player #${playerNum}?`)) return;

        const newStats = structuredClone(playerStats);

        if (newStats[team]?.players?.[playerNum]) {
          delete newStats[team].players[playerNum];
        }

        setPlayerStats(newStats);
        if (isMultiplayer && matchRef.current) {
          matchRef.current.update({ playerStats: newStats });
        }
      };

      // Parse comma/space separated input into array
      const parsePlayerInput = (input) => {  // Split by comma or space, filter empty, remove duplicates
        const nums = input
          .split(/[,\s]+/)
          .map(n => n.trim())
          .filter(n => n !== '' && /^\d+$/.test(n));
        return [...new Set(nums)];
      };

      // Handle smart input parsing
      const handlePlayerInputChange = (value, idx) => {
        // Check if user typed comma or space (= wants to move to next field)
        if (value.includes(',') || value.includes(' ')) {
          const parsed = parsePlayerInput(value);
          if (parsed.length > 0) {
            // Keep all existing fields before current index, then add parsed numbers
            const before = addPlayerNumbers.slice(0, idx);
            const after = addPlayerNumbers.slice(idx + 1).filter(n => n.trim() !== '');

            // Combine: existing + parsed + remaining + empty
            setAddPlayerNumbers([...before, ...parsed, ...after, '']);

            // Focus will auto-move to the new empty field
            setTimeout(() => {
              const inputs = document.querySelectorAll('input[type="text"][inputmode="decimal"]');
              inputs[inputs.length - 1]?.focus();
            }, 50);
          }
        } else {
          // Normal single character input
          const newNums = [...addPlayerNumbers];
          newNums[idx] = value;
          setAddPlayerNumbers(newNums);
        }
      };

      const playSound = st => {
        const a = audioRefs[st].current;
        if (!a) return;
        setPlayingSound(st);
        a.currentTime = 0;
        a.play().catch(e => console.log('Play failed:', e));
        a.onended = () => {
          setPlayingSound(null);
        };
      };

      const toggleIntro = () => {
        const a = audioRefs.intro.current;
        if (!a) return;
        if (introPlaying) {
          a.pause();
          a.currentTime = 0;
          setIntroPlaying(false);
          setPlayingSound(null);
        } else {
          a.loop = true;
          a.play().catch(e => console.log('Play failed:', e));
          setIntroPlaying(true);
          setPlayingSound('intro');
        }
      };

      const stopAllSounds = () => {
        Object.values(audioRefs).forEach(r => {
          if (r.current) {
            r.current.pause();
            r.current.currentTime = 0;
          }
        });
        setIntroPlaying(false);
        setPlayingSound(null);
      };

      const resetCounters = () => {
        if (window.confirm('Reset all stats?')) {
          const ns = { 1: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 }, 2: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 }, 3: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 } };
          setPeriodStats(ns);
          setCurrentPeriod(1);
          setPlayerStats({ home: { players: {} }, away: { players: {} } });
          setGoalEvents([]);
          setPenaltyEvents([]);
          setOtherEvents([]);
          if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ periodStats: ns, currentPeriod: 1, playerStats: { home: { players: {} }, away: { players: {} } }, goalEvents: [], penaltyEvents: [], otherEvents: [] });
          else localStorage.removeItem('juniorLeagueGame')
        }
      };

      const calcTotals = () => {
        let hs = 0, as = 0, hsv = 0, asv = 0;
        Object.keys(periodStats).forEach(p => {
          hs += (periodStats[p]?.homeScore ?? 0);
          as += (periodStats[p]?.awayScore ?? 0);
          hsv += (periodStats[p]?.homeSaves ?? 0);
          asv += (periodStats[p]?.awaySaves ?? 0);
        });
        return { homeScore: hs, awayScore: as, homeSaves: hsv, awaySaves: asv }
      };


      const calculatePIMFromEvents = (team, player, period = null) => {

        // Hoppa Ã¶ver BENCH penalties i spelarstatistik
        if (player === 'BENCH') return 0;

        const penaltyMinutes = { "2'": 2, "5'": 5, "10'": 10, "20'": 20 };

        return penaltyEvents
          .filter(e =>
            e.team === team &&
            e.player === player &&
            (period === null || e.period === period)
          )
          .reduce((total, e) => total + (penaltyMinutes[e.penaltyType] || 0), 0);
      };

      const calculatePenaltyCountFromEvents = (team, player, penaltyType, period = null) => {
        return penaltyEvents
          .filter(e =>
            e.team === team &&
            e.player === player &&
            e.penaltyType === penaltyType &&
            (period === null || e.period === period)
          ).length;
      };


      const totals = calcTotals();
      const calcSP = (sv, g) => { const sh = sv + g; return sh === 0 ? '0.0' : ((sv / sh) * 100).toFixed(1) };

      const genReport = () => {
        const d = new Date().toLocaleDateString();
        let r = `Game Report - ${d}\n${homeName} ${totals.homeScore} - ${totals.awayScore} ${awayName}\n\nPERIOD BREAKDOWN:\n`;
        Object.keys(periodStats).sort((a, b) => parseInt(a) - parseInt(b)).forEach(p => {
          const ps = periodStats[p];
          const pLabel = parseInt(p) <= 3 ? `Period ${p}` : `OT`;
          r += `${pLabel}: ${homeName} ${ps.homeScore}-${ps.awayScore} ${awayName}\n`;
        });
        r += `\nGOALIE STATS:\n${homeName}: ${totals.homeSaves} saves, ${totals.homeSaves + totals.awayScore} shots against, ${calcSP(totals.homeSaves, totals.awayScore)}%\n`;
        r += `${awayName}: ${totals.awaySaves} saves, ${totals.awaySaves + totals.homeScore} shots against, ${calcSP(totals.awaySaves, totals.homeScore)}%\n`;
        return r;
      };

      const generateCSV = () => {
        let csv = '';
        const d = new Date().toLocaleDateString();

        csv += `Game Report,${d}\n`;
        csv += `${homeName},${totals.homeScore},${awayName},${totals.awayScore}\n\n`;

        csv += `Period Breakdown\n`;
        csv += `Period,${homeName},${awayName}\n`;
        Object.keys(periodStats).sort((a, b) => parseInt(a) - parseInt(b)).forEach(p => {
          const ps = periodStats[p];
          const pLabel = parseInt(p) <= 3 ? `Period ${p}` : `OT`;
          csv += `${pLabel},${ps.homeScore},${ps.awayScore}\n`;
        });

        csv += `\nGoalie Statistics\n`;
        csv += `Team,Saves,Shots Against,Save %\n`;
        csv += `${homeName},${totals.homeSaves},${totals.homeSaves + totals.awayScore},${calcSP(totals.homeSaves, totals.awayScore)}%\n`;
        csv += `${awayName},${totals.awaySaves},${totals.awaySaves + totals.homeScore},${calcSP(totals.awaySaves, totals.homeScore)}%\n`;

        if (playerStats.home?.players || playerStats.away?.players) {
          csv += `\nPlayer Statistics\n`;

          ['home', 'away'].forEach(team => {
            const teamName = team === 'home' ? homeName : awayName;
            const players = playerStats[team]?.players || {};
            const playerNums = Object.keys(players).sort((a, b) => parseInt(a) - parseInt(b));

            if (playerNums.length === 0) return;

            csv += `\n${teamName}\n`;
            csv += `Player #,Period,G,A,OnIce+,OnIce-,+/-,FO+,FO-,FO%,SOG\n`;

            playerNums.forEach(pNum => {
              const pData = players[pNum];

              Object.keys(pData.periods).sort((a, b) => parseInt(a) - parseInt(b)).forEach(period => {
                const pLabel = parseInt(period) <= 3 ? `P${period}` : `OT`;
                const stats = pData.periods[period];
                const onIcePlus = stats['OnIce+'] || 0;
                const onIceMinus = stats['OnIce-'] || 0;
                const plusMinus = onIcePlus - onIceMinus;
                const foPlus = stats['FO+'] || 0;
                const foMinus = stats['FO-'] || 0;
                const foTotal = foPlus + foMinus;
                const foPct = foTotal === 0 ? '-' : ((foPlus / foTotal) * 100).toFixed(1);
                csv += `${pNum},${pLabel},${stats['G'] || 0},${stats['A'] || 0},${onIcePlus},${onIceMinus},${plusMinus},${foPlus},${foMinus},${foPct},${stats['SOG'] || 0}\n`;
              });

              const totalOnIcePlus = pData.total['OnIce+'];
              const totalOnIceMinus = pData.total['OnIce-'];
              const totalPlusMinus = totalOnIcePlus - totalOnIceMinus;
              const totalFoPlus = pData.total['FO+'];
              const totalFoMinus = pData.total['FO-'];
              const totalFoTotal = totalFoPlus + totalFoMinus;
              const totalFoPct = totalFoTotal === 0 ? '-' : ((totalFoPlus / totalFoTotal) * 100).toFixed(1);
              csv += `${pNum},TOTAL,${pData.total['G']},${pData.total['A']},${totalOnIcePlus},${totalOnIceMinus},${totalPlusMinus},${totalFoPlus},${totalFoMinus},${totalFoPct},${pData.total['SOG']}\n`;
            });
          });
        }

        return csv;
      };

      const downloadCSV = () => {
        const csv = generateCSV();
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `hockey_stats_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const copyStats = () => navigator.clipboard.writeText(genReport()).then(() => alert('Stats copied!')).catch(() => alert('Failed to copy'));
      const copyCode = () => navigator.clipboard.writeText(matchCode).then(() => alert('Code copied!')).catch(() => alert('Failed to copy'));
      const shareStats = () => {
        if (navigator.share) navigator.share({ title: 'Game Report', text: genReport() }).catch(() => copyStats());
        else copyStats();
      };

      const getSpotifyUrl = u => {
        const m = u.match(/playlist\/([a-zA-Z0-9]+)/);
        return m && m[1] ? `https://open.spotify.com/embed/playlist/${m[1]}?utm_source=generator&theme=0` : null;
      };

      const loadSpotify = () => {
        setSpotifyLoading(true);
        setTimeout(() => {
          setSpotifyLoaded(true);
          setSpotifyLoading(false);
        }, 100);
      };

      const refSigs = [
        {
          name: 'Crosschecking',
          description: 'A forward motion with both fists clenched extending from the chest',
          image: 'images/ref_crosschecking.png'
        },
        {
          name: 'Checking from behind',
          description: 'A forward motion of both arms, with palms of the hands facing away from the body',
          image: 'images/ref_checking_from_behind.png'
        },
        {
          name: 'Interference',
          description: 'Crossed arms with closed fists stationary in front of the chest',
          image: 'images/ref_interference.png'
        },
        {
          name: 'Elbowing',
          description: 'Tapping either elbow with the opposite hand',
          image: 'images/ref_elbowing.png'
        },
        {
          name: 'Checking to the head',
          description: 'Hand with open palm on the side of the head',
          image: 'images/ref_checking_to_the_head.png'
        },
        {
          name: 'Charging',
          description: 'Rotating clenched fists around one another in front of the chest',
          image: 'images/ref_charging.png'
        },
        {
          name: 'Boarding',
          description: 'Hitting fist in the other open hand in front of the chest',
          image: 'images/ref_boarding.png'
        },
        {
          name: 'Holding',
          description: 'Clasping either wrist with the other hand in front of the chest',
          image: 'images/ref_holding.png'
        },
        {
          name: 'High-sticking',
          description: 'Holding both fists clenched, one slightly above the other as if holding a stick',
          image: 'images/ref_high_sticking.png'
        },
        {
          name: 'Kneeing',
          description: 'Slapping either knee with the palm of the hand',
          image: 'images/ref_kneeing.png'
        },
        {
          name: 'Roughing',
          description: 'Fist clenched and arm extended out of the side of the body',
          image: 'images/ref_roughing.png'
        },
        {
          name: 'Illegal Hit',
          description: 'Hand on opposite chest',
          image: 'images/ref_illegal_hit.png'
        },
        {
          name: 'Penalty Shot',
          description: 'Arms crossed above head',
          image: 'images/ref_penalty_shot.png'
        },
        {
          name: 'Goal',
          description: 'Outstretched hand directed at the goal',
          image: 'images/ref_goal.png'
        },
        {
          name: 'Wash out',
          description: 'Both arms outwards in an outstreched position at sholder level, indicating no goal, no icing or no off-side',
          image: 'images/ref_wash_out.png'
        },
        {
          name: 'Delayed Penalty',
          description: 'Arm extended fully above head',
          image: 'images/ref_delayed_penalty.png'
        },
        {
          name: 'Icing',
          description: 'The back linesman signals an icing by fully extending either arm over the head. It is then washed out or called with this sign',
          image: 'images/ref_icing.png'
        },
        {
          name: 'Timeout',
          description: 'Using both ands to form a T in front of the chest',
          image: 'images/ref_time_out.png'
        }
      ];

      if (showPlayerStats && screen === 'game') {
        const statColumns = {
          'Goal': ['G', 'A', '+', '-'],
          'FO/SOG': ['FO+', 'FO-', 'SOG'],
          'Penalty': ["2'", "5'", "10'", "20'"]
        };

        const activeColumns = statColumns[playerStatsMoment];

        // Save goal handler
        const saveGoalHandler = () => {
          if (isViewer) return;
          if (isMultiplayer && !currentUser) {
            alert('You must be logged in to edit multiplayer games');
            return;
          }

          // Save or update goal event
          const newEvent = {
            team: recordingGoal,
            situation: goalSituation,
            time: goalTime,
            period: currentPeriod,
            timestamp: editingGoalIndex !== null ? goalEvents[editingGoalIndex].timestamp : Date.now(),
            scorers: goalScorers,
            assists: goalAssists,
            plus: goalPlusPlayers,
            minus: goalMinusPlayers,
            sog: goalSOGPlayers
          };

          let updatedEvents;
          const isEditing = editingGoalIndex !== null;
          const oldEvent = isEditing ? goalEvents[editingGoalIndex] : null;

          if (isEditing) {
            updatedEvents = goalEvents.map((ev, i) => i === editingGoalIndex ? newEvent : ev);
          } else {
            updatedEvents = [...goalEvents, newEvent];
          }
          setGoalEvents(updatedEvents);

          if (isMultiplayer && matchRef.current) {
            matchRef.current.child('goalEvents').set(updatedEvents);
          } else if (!isMultiplayer && screen === 'game') {
            const gs = JSON.parse(localStorage.getItem('juniorLeagueGame') || '{}');
            gs.goalEvents = updatedEvents;
            localStorage.setItem('juniorLeagueGame', JSON.stringify(gs));
          }

          // Update player stats
          const newStats = structuredClone(playerStats);

          // If editing, first remove old stats
          if (isEditing && oldEvent) {
            const oldPlayerIds = new Set([
              ...(oldEvent.scorers || []),
              ...(oldEvent.assists || []),
              ...(oldEvent.plus || []),
              ...(oldEvent.minus || []),
              ...(oldEvent.sog || [])
            ]);

            oldPlayerIds.forEach(playerId => {
              const [team, pNum] = playerId.split('-');

              if (!newStats[team]?.players?.[pNum]?.periods?.[oldEvent.period]) return;

              if (oldEvent.scorers?.includes(playerId)) {
                newStats[team].players[pNum].periods[oldEvent.period]['G'] = Math.max(0, (newStats[team].players[pNum].periods[oldEvent.period]['G'] || 0) - 1);
              }
              if (oldEvent.assists?.includes(playerId)) {
                newStats[team].players[pNum].periods[oldEvent.period]['A'] = Math.max(0, (newStats[team].players[pNum].periods[oldEvent.period]['A'] || 0) - 1);
              }
              if (oldEvent.plus?.includes(playerId)) {
                newStats[team].players[pNum].periods[oldEvent.period]['OnIce+'] = Math.max(0, (newStats[team].players[pNum].periods[oldEvent.period]['OnIce+'] || 0) - 1);
              }
              if (oldEvent.minus?.includes(playerId)) {
                newStats[team].players[pNum].periods[oldEvent.period]['OnIce-'] = Math.max(0, (newStats[team].players[pNum].periods[oldEvent.period]['OnIce-'] || 0) - 1);
              }
              if (oldEvent.sog?.includes(playerId)) {
                newStats[team].players[pNum].periods[oldEvent.period]['SOG'] = Math.max(0, (newStats[team].players[pNum].periods[oldEvent.period]['SOG'] || 0) - 1);
              }
            });
          }

          // Get unique player IDs (for new/updated event)
          const allPlayerIds = new Set([...goalScorers, ...goalAssists, ...goalPlusPlayers, ...goalMinusPlayers, ...goalSOGPlayers]);

          // Process each unique player once
          allPlayerIds.forEach(playerId => {
            const [team, pNum] = playerId.split('-');

            if (!newStats[team]) newStats[team] = { players: {} };
            if (!newStats[team].players) newStats[team].players = {};
            if (!newStats[team].players[pNum]) {
              newStats[team].players[pNum] = {
                periods: {},
                total: { 'G': 0, 'A': 0, 'OnIce+': 0, 'OnIce-': 0, 'FO+': 0, 'FO-': 0, 'SOG': 0, "2'": 0, "5'": 0, "10'": 0, "20'": 0, 'PIM': 0 }
              };
            }
            if (!newStats[team].players[pNum].periods[currentPeriod]) {
              newStats[team].players[pNum].periods[currentPeriod] = { 'G': 0, 'A': 0, 'OnIce+': 0, 'OnIce-': 0, 'FO+': 0, 'FO-': 0, 'SOG': 0, "2'": 0, "5'": 0, "10'": 0, "20'": 0, 'PIM': 0 };
            }

            // Add stats
            if (goalScorers.includes(playerId)) {
              newStats[team].players[pNum].periods[currentPeriod]['G'] += 1;
            }
            if (goalAssists.includes(playerId)) {
              newStats[team].players[pNum].periods[currentPeriod]['A'] += 1;
            }
            if (goalPlusPlayers.includes(playerId)) {
              newStats[team].players[pNum].periods[currentPeriod]['OnIce+'] += 1;
            }
            if (goalMinusPlayers.includes(playerId)) {
              newStats[team].players[pNum].periods[currentPeriod]['OnIce-'] += 1;
            }
            if (goalSOGPlayers.includes(playerId)) {
              newStats[team].players[pNum].periods[currentPeriod]['SOG'] += 1;
            }
          });

          // Recalculate totals
          Object.keys(newStats).forEach(team => {
            Object.keys(newStats[team].players).forEach(pNum => {
              const player = newStats[team].players[pNum];
              ['G', 'A', 'OnIce+', 'OnIce-', 'SOG'].forEach(stat => {
                player.total[stat] = 0;
                Object.keys(player.periods).forEach(p => {
                  player.total[stat] += player.periods[p][stat] || 0;
                });
              });
            });
          });

          setPlayerStats(newStats);
          if (isMultiplayer && matchRef.current) matchRef.current.update({ playerStats: newStats });

          // Reset form
          setRecordingGoal(null);
          setGoalSituation('EQ');
          setGoalTime('');
          setGoalScorers([]);
          setGoalAssists([]);
          setGoalPlusPlayers([]);
          setGoalMinusPlayers([]);
          setGoalSOGPlayers([]);
          setEditingGoalIndex(null);

          // Collapse form, expand timeline, highlight new event
          setGoalFormCollapsed(true);
          setGoalTimelineCollapsed(false);
          const eventId = `goal-${isEditing ? editingGoalIndex : goalEvents.length}`;
          setHighlightEventId(eventId);
          setTimeout(() => setHighlightEventId(null), 2000);

          // Scroll to timeline
          setTimeout(() => {
            const timelineEl = document.querySelector('.goal-timeline');
            if (timelineEl) {
              timelineEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
          }, 100);
        };

        // Cleanup function when switching between modes (Goal/Penalty/FO/SOG)
        const resetModeState = () => {
          setGoalWizardStep(0);
          setRecordingGoal(null);
          setEditingGoalIndex(null);
          setGoalScorers([]);
          setGoalAssists([]);
          setGoalPlusPlayers([]);
          setGoalMinusPlayers([]);
          setGoalSOGPlayers([]);
          setPenaltyWizardOpen(false);
          setPenaltyTeam(null);
          setPenaltyType("2'");
          setPenaltyInfraction('');
          setPenaltyTime('');
          setPenaltyPlayer('');
          setEditingPenaltyIndex(null);
          setOtherWizardOpen(false);
          setOtherTeam(null);
          setOtherEventType('timeout');
          setOtherTime('');
          setEditingOtherIndex(null);
        };

        const renderPlayerTable = (team) => {
          const teamName = team === 'home' ? homeName : awayName;
          const players = playerStats?.[team]?.players ?? {};
          const playerNums = Object.keys(players).sort((a, b) => parseInt(a) - parseInt(b));

          // Determine which columns to show based on mode and team
          let columnsToShow = activeColumns;

          // Goal wizard mode: scoring team fÃ¥r fler kolumner, opponent fÃ¥r bara -
          if (playerStatsMoment === 'Goal' && goalWizardStep === 2 && recordingGoal) {
            if (team === recordingGoal) {
              columnsToShow = ['G', 'A', '+', 'SOG'];
            } else {
              columnsToShow = ['-'];
            }
          }
          // Penalty mode shows all penalty columns for both teams (no special logic needed)

          // Map display column names to actual stat names
          const getActualStatName = (col) => {
            if (col === '+') return 'OnIce+';
            if (col === '-') return 'OnIce-';
            return col;
          };

          return (
            <div
              className={`
    ${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'}
    rounded-lg shadow-lg overflow-hidden
  `}
            >

              <div className="px-4 py-3 border-b flex items-center justify-between">
                <div className="flex items-center gap-3 flex-1">
                  <h3 className={`text-sm font-semibold truncate ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                    {teamName}
                  </h3>
                  {playerStatsMoment === 'Goal' && goalWizardStep === 2 && (
                    <span className={`text-xs whitespace-nowrap ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      {editingGoalIndex !== null ? '(edit)' : `(${goalEvents.filter(e => e.team === team).length} goals)`}
                    </span>
                  )}
                  {playerStatsMoment === 'FO/SOG' && (
                    <button
                      onClick={() => {
                        if (matchEnded) return;
                        const otherTeam = team === 'home' ? 'away' : 'home';
                        setPlayerStatsEditMode(prev => ({
                          ...prev,
                          [team]: !prev[team],
                          [otherTeam]: false  // Auto-toggle off the other team
                        }));
                      }}
                      disabled={matchEnded}
                      className={`text-xs px-2 py-1 rounded transition-all whitespace-nowrap ${matchEnded
                        ? (darkMode ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-gray-200 text-gray-400 cursor-not-allowed')
                        : playerStatsEditMode[team]
                          ? (darkMode ? 'bg-yellow-900 bg-opacity-60 text-yellow-200' : 'bg-yellow-100 text-yellow-800 font-semibold')
                          : (darkMode ? 'bg-gray-700 text-gray-400 hover:bg-gray-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')
                        }`}
                    >
                      {playerStatsEditMode[team] ? 'âœŽ Edit ON' : 'âœŽ Edit'}
                    </button>
                  )}
                </div>
              </div>

              {(playerStatsMoment === 'FO/SOG' || !collapsedPlayerTables[team]) ? (
                <>
                  <div className="overflow-x-auto max-h-[70vh] overflow-y-auto">
                    <table className={`w-full ${darkMode ? 'text-gray-200' : ''}`}>
                      <thead className={`${darkMode ? 'bg-gray-700 text-gray-200' : 'bg-gray-100'} sticky top-[1px] z-20`}>
                        <tr>
                          <th className={`px-3 py-3 text-center text-xs font-semibold sticky left-0 ${darkMode ? 'bg-gray-700 text-gray-200' : 'bg-gray-100'} z-10`}>#</th>
                          {columnsToShow.map(col => (
                            <th key={col} className={`px-1 py-3 text-center text-xs font-semibold ${darkMode ? 'text-gray-200' : ''}`}>{col}</th>
                          ))}
                          {playerStatsEditMode[team] && <th className={`px-1 py-3 text-center text-xs font-semibold ${darkMode ? 'text-gray-200' : ''}`}></th>}
                        </tr>
                      </thead>
                      <tbody>
                        {playerNums.length === 0 ? (
                          <tr>
                            <td colSpan={columnsToShow.length + (playerStatsEditMode[team] ? 2 : 1)} className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              No players added yet
                            </td>
                          </tr>
                        ) : playerNums.map(pNum => {
                          const pData = players[pNum];
                          const currentPeriodStats = pData?.periods?.[currentPeriod] ?? { 'G': 0, 'A': 0, 'OnIce+': 0, 'OnIce-': 0, 'FO+': 0, 'FO-': 0, 'SOG': 0 };

                          return (
                            <tr key={pNum} className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} transition-colors group`}>
                              <td className={`px-3 py-2 font-bold sticky left-0 ${darkMode ? 'bg-gray-800' : 'bg-white'} ${darkMode ? 'group-hover:bg-gray-700' : 'group-hover:bg-gray-50'} z-10 transition-colors text-center`}>{pNum}</td>
                              {columnsToShow.map(col => {
                                const actualStat = getActualStatName(col);
                                const isPIM = col === 'PIM';

                                // BerÃ¤kna PIM frÃ¥n events fÃ¶r denna spelare i nuvarande period
                                const calculatedPIM = isPIM ? calculatePIMFromEvents(team, pNum, currentPeriod) : 0;
                                const isGoalMode = playerStatsMoment === 'Goal' && goalWizardStep === 2;

                                // Goal wizard checkbox mode
                                if (isGoalMode && !isPIM) {
                                  const isChecked =
                                    (col === 'G' && goalScorers.includes(`${team}-${pNum}`)) ||
                                    (col === 'A' && goalAssists.includes(`${team}-${pNum}`)) ||
                                    (col === '+' && goalPlusPlayers.includes(`${team}-${pNum}`)) ||
                                    (col === '-' && goalMinusPlayers.includes(`${team}-${pNum}`)) ||
                                    (col === 'SOG' && goalSOGPlayers.includes(`${team}-${pNum}`));

                                  const toggleCheckbox = () => {
                                    const playerId = `${team}-${pNum}`;
                                    if (col === 'G') {
                                      const isAdding = !goalScorers.includes(playerId);
                                      setGoalScorers(prev =>
                                        isAdding ? [...prev, playerId] : prev.filter(id => id !== playerId)
                                      );
                                      // Auto-check SOG when G is checked
                                      if (isAdding && !goalSOGPlayers.includes(playerId)) {
                                        setGoalSOGPlayers(prev => [...prev, playerId]);
                                      }
                                      // Auto-uncheck SOG when G is unchecked
                                      if (!isAdding && goalSOGPlayers.includes(playerId)) {
                                        setGoalSOGPlayers(prev => prev.filter(id => id !== playerId));
                                      }
                                      // Auto-check + when G is checked
                                      if (isAdding && !goalPlusPlayers.includes(playerId)) {
                                        setGoalPlusPlayers(prev => [...prev, playerId]);
                                      }
                                    } else if (col === 'A') {
                                      const isAdding = !goalAssists.includes(playerId);
                                      setGoalAssists(prev =>
                                        isAdding ? [...prev, playerId] : prev.filter(id => id !== playerId)
                                      );
                                      // Auto-check + when A is checked
                                      if (isAdding && !goalPlusPlayers.includes(playerId)) {
                                        setGoalPlusPlayers(prev => [...prev, playerId]);
                                      }

                                    } else if (col === '+') {
                                      setGoalPlusPlayers(prev =>
                                        prev.includes(playerId) ? prev.filter(id => id !== playerId) : [...prev, playerId]
                                      );
                                    } else if (col === '-') {
                                      setGoalMinusPlayers(prev =>
                                        prev.includes(playerId) ? prev.filter(id => id !== playerId) : [...prev, playerId]
                                      );
                                    } else if (col === 'SOG') {
                                      setGoalSOGPlayers(prev =>
                                        prev.includes(playerId) ? prev.filter(id => id !== playerId) : [...prev, playerId]
                                      );
                                    }
                                  };

                                  return (
                                    <td key={col} className="px-1 py-1">
                                      <div className="flex items-center justify-center">
                                        <input
                                          type="checkbox"
                                          checked={isChecked}
                                          onChange={col === 'SOG' ? undefined : toggleCheckbox}
                                          disabled={col === 'SOG'}
                                          className={col === 'SOG' ? 'w-5 h-5 cursor-not-allowed opacity-50' : 'w-5 h-5 cursor-pointer'}
                                        />
                                      </div>
                                    </td>
                                  );
                                }

                                // Normal mode (original code)
                                return (
                                  <td key={col} className="px-1 py-3">
                                    <div className="flex items-center justify-center gap-1">
                                      {playerStatsEditMode[team] && !isPIM && (
                                        <button
                                          onClick={() => updatePlayerStat(team, pNum, actualStat, -1)}
                                          disabled={matchEnded || isViewer}
                                          className={`w-7 h-7 rounded flex items-center justify-center text-sm font-bold transition-all ${darkMode ? 'bg-red-900 hover:bg-red-800 text-red-100 disabled:opacity-50' : 'bg-red-200 hover:bg-red-300 text-red-900 disabled:opacity-50'}`}
                                        >âˆ’</button>
                                      )}
                                      <div
                                        onClick={isPIM ? undefined : () => updatePlayerStat(team, pNum, actualStat, 1)}
                                        className={`min-w-[2.2rem] h-7 px-1 rounded border flex items-center justify-center transition-all text-sm ${isPIM
                                          ? (darkMode ? 'bg-gray-700 text-gray-400 border-gray-600' : 'bg-gray-100 text-gray-600 border-gray-300 cursor-default')
                                          : (matchEnded || isViewer)
                                            ? (darkMode ? 'bg-blue-900 bg-opacity-20 text-blue-300 border-blue-800 cursor-not-allowed' : 'bg-blue-50 text-blue-700 border-blue-300 cursor-not-allowed')
                                            : (darkMode ? 'bg-blue-900 bg-opacity-20 text-blue-200 border-blue-800 hover:bg-opacity-30 cursor-pointer' : 'bg-blue-50 text-blue-800 border-blue-300 hover:bg-blue-100 cursor-pointer')
                                          } ${!isPIM && sparkleStats[`${team}${pNum}${actualStat}${currentPeriod}`] ? 'sparkle' : ''}`}
                                      >
                                        <span className="text-sm font-bold">{isPIM ? calculatedPIM : (currentPeriodStats[actualStat] || 0)}</span>
                                      </div>

                                    </div>
                                  </td>
                                );
                              })}
                              {playerStatsEditMode[team] && (
                                <td className="px-1 py-3">
                                  <button
                                    onClick={() => removePlayer(team, pNum)}
                                    disabled={matchEnded || isViewer}
                                    className={`w-7 h-7 rounded flex items-center justify-center text-lg font-bold transition-all ${darkMode ? 'bg-red-900 hover:bg-red-800 text-red-100 disabled:opacity-50' : 'bg-red-200 hover:bg-red-300 text-red-900 disabled:opacity-50'}`}
                                  >Ã—</button>
                                </td>
                              )}
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>

                  {!isViewer && !matchEnded && playerStatsMoment !== 'Goal' && (
                    <div className="p-3 border-t">
                      <button
                        onClick={() => { setAddPlayerTeam(team); setShowAddPlayerModal(true) }}
                        className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-800'} py-2 rounded font-semibold text-sm`}
                      >
                        + Add Player
                      </button>
                    </div>
                  )}
                </>
              ) : null}
            </div>
          );
        };


        return (
          <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
            <div className={`${darkMode ? 'bg-gray-800 border-b border-gray-700' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-3 py-2 shadow-lg sticky top-0 z-50`}>
              <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-3">
                  <div className="flex gap-2 items-center flex-wrap">

                    {[1, 2, 3].map(p => (
                      <button
                        key={p}
                        onClick={() => {
                          setCurrentPeriod(p);
                          if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ currentPeriod: p });
                        }}
                        disabled={matchEnded || isViewer}
                        className={`px-3 py-1 rounded font-bold text-base ${currentPeriod === p ? 'bg-yellow-400 text-blue-900' : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}
                      >
                        {p}
                      </button>
                    ))}
                    {periodStats[4] && (
                      <button
                        onClick={() => {
                          setCurrentPeriod(4);
                          if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ currentPeriod: 4 });
                        }}
                        disabled={matchEnded || isViewer}
                        className={`px-3 py-1 rounded font-bold text-base ${currentPeriod === 4 ? 'bg-yellow-400 text-blue-900' : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}
                      >
                        OT
                      </button>
                    )}
                    {!periodStats[4] && currentPeriod === 3 && (
                      <button
                        onClick={() => {
                          const updated = { ...periodStats, 4: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 } };
                          setPeriodStats(updated);
                          setCurrentPeriod(4);
                          if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ periodStats: updated, currentPeriod: 4 });
                        }}
                        disabled={matchEnded || isViewer}
                        className={`px-3 py-1 rounded font-bold text-base ${darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}
                      >
                        +OT
                      </button>
                    )}
                  </div>

                  <button
                    onClick={() => setShowPlayerStats(false)}
                    className={`${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-1`}
                  >
                    <span className="text-lg"><IconBack /></span>
                    <span className="hidden sm:inline">Back</span>
                  </button>
                </div>

                <div className="flex gap-2 items-center flex-wrap">

                  {[
                    { key: 'FO/SOG', label: 'FO/SOG' }
                  ].map(m => (
                    <button
                      key={m.key}
                      onClick={() => {
                        resetModeState();
                        setPlayerStatsMoment(m.key);
                      }}
                      className={`px-3 py-1 rounded text-sm font-bold ${playerStatsMoment === m.key ? 'bg-yellow-400 text-blue-900' : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}
                    >
                      {m.label}
                    </button>
                  ))}

                  <button
                    onClick={() => {
                      resetModeState();
                      setPlayerStatsMoment('Goal');
                      setGoalWizardStep(1);
                      // Force collapse form if match ended
                      if (matchEnded) {
                        setGoalFormCollapsed(true);
                        setGoalTimelineCollapsed(false);
                      }
                    }}
                    className={`px-3 py-1 rounded text-sm font-bold ${playerStatsMoment === 'Goal' ? 'bg-yellow-400 text-blue-900' : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}
                  >
                    Goal
                  </button>

                  <button
                    onClick={() => {
                      resetModeState();
                      setPlayerStatsMoment('Penalty');
                      setPenaltyWizardOpen(true);
                      setPenaltyTeam(null);
                      // Force collapse form if match ended
                      if (matchEnded) {
                        setPenaltyFormCollapsed(true);
                        setPenaltyTimelineCollapsed(false);
                      }
                    }}
                    disabled={isViewer}
                    className={`px-3 py-1 rounded text-sm font-bold ${isViewer
                      ? 'bg-gray-500 cursor-not-allowed opacity-50'
                      : penaltyWizardOpen
                        ? 'bg-yellow-400 text-blue-900'
                        : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'
                      }`}
                  >
                    Penalty
                  </button>

                  <button
                    onClick={() => {
                      resetModeState();
                      setPlayerStatsMoment('Other');
                      setOtherWizardOpen(true);
                      setOtherTeam(null);
                      // Force collapse form if match ended
                      if (matchEnded) {
                        setOtherFormCollapsed(true);
                        setOtherTimelineCollapsed(false);
                      }
                    }}
                    disabled={isViewer}
                    className={`px-3 py-1 rounded text-sm font-bold ${isViewer
                      ? 'bg-gray-500 cursor-not-allowed opacity-50'
                      : playerStatsMoment === 'Other'
                        ? 'bg-yellow-400 text-blue-900'
                        : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'
                      }`}
                  >
                    Other
                  </button>

                  <div className="flex gap-2 items-center flex-wrap">

                  </div>
                </div>
              </div>



            </div>

            <div className="max-w-7xl mx-auto p-2">


              {playerStatsMoment === 'Penalty' && (

                <div className="max-w-4xl mx-auto penalty-form">
                  <div className={darkMode ? 'bg-gray-800 border border-gray-700 rounded-lg shadow-lg overflow-hidden' : 'bg-white rounded-lg shadow-lg overflow-hidden'}>
                    {/* Collapsable Header */}
                    {!matchEnded && (
                      <button
                        onClick={() => setPenaltyFormCollapsed(!penaltyFormCollapsed)}
                        className={`w-full ${darkMode ? 'bg-gradient-to-r from-blue-700 to-blue-600' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-3 font-bold flex items-center justify-between transition-colors hover:opacity-90`}
                      >
                        <span>{editingPenaltyIndex !== null ? `Edit Penalty #${editingPenaltyIndex + 1}` : 'Add Penalty'}</span>
                        <span className={`transition-transform duration-300 ${penaltyFormCollapsed ? '' : 'rotate-180'}`}>
                          <IconChevronDown />
                        </span>
                      </button>
                    )}

                    {/* Form Content */}
                    {!penaltyFormCollapsed && (
                      <div className="p-6" style={{ animation: 'fadeIn 0.3s ease-in' }}>

                        {/* Team Selection */}
                        <div className="mb-4">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Which team?
                          </label>
                          <div className="grid grid-cols-2 gap-3">
                            <button
                              onClick={() => setPenaltyTeam('home')}
                              className={penaltyTeam === 'home'
                                ? (darkMode ? 'bg-yellow-500 text-gray-900 py-2 rounded-lg font-bold' : 'bg-yellow-400 text-gray-900 py-2 rounded-lg font-bold')
                                : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold')
                              }
                            >
                              {homeName}
                            </button>
                            <button
                              onClick={() => setPenaltyTeam('away')}
                              className={penaltyTeam === 'away'
                                ? (darkMode ? 'bg-yellow-500 text-gray-900 py-2 rounded-lg font-bold' : 'bg-yellow-400 text-gray-900 py-2 rounded-lg font-bold')
                                : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold')
                              }
                            >
                              {awayName}
                            </button>
                          </div>
                        </div>

                        {/* Penalty Type */}
                        <div className="mb-4">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Penalty Type
                          </label>
                          <div className="grid grid-cols-4 gap-2">
                            {["2'", "5'", "10'", "20'"].map(type => (
                              <button
                                key={type}
                                onClick={() => setPenaltyType(type)}
                                className={penaltyType === type
                                  ? (darkMode ? 'bg-yellow-500 text-gray-900 py-2 rounded-lg font-bold' : 'bg-yellow-400 text-gray-900 py-2 rounded-lg font-bold')
                                  : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold')
                                }
                              >
                                {type}
                              </button>
                            ))}
                          </div>
                        </div>

                        {/* Infraction (optional dropdown) */}
                        <div className="mb-4">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Infraction (optional)
                          </label>
                          <select
                            value={penaltyInfraction}
                            onChange={(e) => setPenaltyInfraction(e.target.value)}
                            className={darkMode ? 'w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white' : 'w-full px-4 py-2 border border-gray-300 rounded-lg'}
                          >
                            <option value="">Select infraction...</option>
                            <option value="Tripping">Tripping</option>
                            <option value="Hooking">Hooking</option>
                            <option value="Slashing">Slashing</option>
                            <option value="High-sticking">High-sticking</option>
                            <option value="Interference">Interference</option>
                            <option value="Holding">Holding</option>
                            <option value="Cross-checking">Cross-checking</option>
                            <option value="Boarding">Boarding</option>
                            <option value="Charging">Charging</option>
                            <option value="Roughing">Roughing</option>
                            <option value="Elbowing">Elbowing</option>
                            <option value="Kneeing">Kneeing</option>
                            <option value="Delay of game">Delay of game</option>
                            <option value="Too many men">Too many men</option>
                            <option value="Unsportsmanlike conduct">Unsportsmanlike conduct</option>
                            <option value="Fighting">Fighting</option>
                            <option value="Misconduct">Misconduct</option>
                          </select>
                        </div>

                        {/* Game Time (optional) */}
                        <div className="mb-4">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Game Time (optional)
                          </label>
                          <input
                            type="text"
                            value={penaltyTime}
                            onChange={(e) => setPenaltyTime(e.target.value)}
                            placeholder="e.g. 12:34"
                            className={darkMode ? 'w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white' : 'w-full px-4 py-2 border border-gray-300 rounded-lg'}
                          />
                        </div>

                        {/* Player Selection */}
                        {penaltyTeam && (
                          <div className="mb-6">
                            <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                              Player #
                            </label>
                            <select
                              value={penaltyPlayer}
                              onChange={(e) => setPenaltyPlayer(e.target.value)}
                              className={darkMode ? 'w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white' : 'w-full px-4 py-2 border border-gray-300 rounded-lg'}
                            >
                              <option value="">Select player...</option>
                              <option value="BENCH">Bench / Team</option>
                              {Object.keys(playerStats[penaltyTeam]?.players || {})
                                .sort((a, b) => parseInt(a) - parseInt(b))
                                .map(pNum => (
                                  <option key={pNum} value={pNum}>#{pNum}</option>
                                ))
                              }
                            </select>
                          </div>
                        )}

                        {/* Buttons */}
                        <div className="flex gap-2">
                          <button
                            onClick={() => {
                              setPenaltyWizardOpen(true);
                              setPenaltyTeam(null);
                              setPenaltyType("2'");
                              setPenaltyInfraction('');
                              setPenaltyTime('');
                              setPenaltyPlayer('');
                              setEditingPenaltyIndex(null);
                            }}
                            className={darkMode ? 'flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded font-semibold text-white' : 'flex-1 bg-gray-200 hover:bg-gray-300 py-2 rounded font-semibold'}
                          >
                            Cancel
                          </button>
                          <button
                            onClick={() => {
                              if (!penaltyTeam) {
                                alert('Please select which team got the penalty');
                                return;
                              }
                              if (!penaltyPlayer) {
                                alert('Please select a player');
                                return;
                              }
                              if (isViewer) return;
                              if (isMultiplayer && !currentUser) {
                                alert('You must be logged in to edit multiplayer games');
                                return;
                              }

                              // Create penalty event
                              const newEvent = {
                                team: penaltyTeam,
                                player: penaltyPlayer,
                                penaltyType: penaltyType,
                                infraction: penaltyInfraction,
                                time: penaltyTime,
                                period: currentPeriod,
                                timestamp: editingPenaltyIndex !== null ? penaltyEvents[editingPenaltyIndex].timestamp : Date.now()
                              };

                              let updatedEvents;
                              const isEditing = editingPenaltyIndex !== null;
                              const oldEvent = isEditing ? penaltyEvents[editingPenaltyIndex] : null;

                              if (isEditing) {
                                // Editing existing penalty - replace it
                                updatedEvents = penaltyEvents.map((ev, i) => i === editingPenaltyIndex ? newEvent : ev);
                              } else {
                                // New penalty - add to end
                                updatedEvents = [...penaltyEvents, newEvent];
                              }
                              setPenaltyEvents(updatedEvents);

                              if (isMultiplayer && matchRef.current) {
                                matchRef.current.child('penaltyEvents').set(updatedEvents);
                              } else if (!isMultiplayer && screen === 'game') {
                                const gs = JSON.parse(localStorage.getItem('juniorLeagueGame') || '{}');
                                gs.penaltyEvents = updatedEvents;
                                localStorage.setItem('juniorLeagueGame', JSON.stringify(gs));
                              }

                              // We don't need to update playerStats for penalties anymore
                              // PIM is calculated from penaltyEvents on-the-fly



                              // Reset wizard
                              setPenaltyWizardOpen(false);
                              setPenaltyTeam(null);
                              setPenaltyType("2'");
                              setPenaltyInfraction('');
                              setPenaltyTime('');
                              setPenaltyPlayer('');
                              setEditingPenaltyIndex(null);

                              // Collapse form, expand timeline, highlight new event
                              setPenaltyFormCollapsed(true);
                              setPenaltyTimelineCollapsed(false);
                              const eventId = `penalty-${isEditing ? editingPenaltyIndex : penaltyEvents.length}`;
                              setHighlightEventId(eventId);
                              setTimeout(() => setHighlightEventId(null), 2000);

                              // Scroll to timeline
                              setTimeout(() => {
                                const timelineEl = document.querySelector('.penalty-timeline');
                                if (timelineEl) {
                                  timelineEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }
                              }, 100);
                            }}
                            disabled={!penaltyTeam || !penaltyPlayer}
                            className={penaltyTeam && penaltyPlayer
                              ? (darkMode ? 'flex-1 bg-blue-700 hover:bg-blue-600 py-2 rounded font-bold text-white' : 'flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded font-bold text-white')
                              : (darkMode ? 'flex-1 bg-gray-600 py-2 rounded font-bold text-gray-500 cursor-not-allowed' : 'flex-1 bg-gray-300 py-2 rounded font-bold text-gray-400 cursor-not-allowed')
                            }
                          >
                            {editingPenaltyIndex !== null ? 'Update Penalty' : 'Save Penalty'}
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {playerStatsMoment === 'Other' && (

                <div className="max-w-4xl mx-auto other-form">
                  <div className={darkMode ? 'bg-gray-800 border border-gray-700 rounded-lg shadow-lg overflow-hidden' : 'bg-white rounded-lg shadow-lg overflow-hidden'}>
                    {/* Collapsable Header */}
                    {!matchEnded && (
                      <button
                        onClick={() => setOtherFormCollapsed(!otherFormCollapsed)}
                        className={`w-full ${darkMode ? 'bg-gradient-to-r from-blue-700 to-blue-600' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-3 font-bold flex items-center justify-between transition-colors hover:opacity-90`}
                      >
                        <span>{editingOtherIndex !== null ? `Edit Event #${editingOtherIndex + 1}` : 'Add Event'}</span>
                        <span className={`transition-transform duration-300 ${otherFormCollapsed ? '' : 'rotate-180'}`}>
                          <IconChevronDown />
                        </span>
                      </button>
                    )}

                    {!otherFormCollapsed && (
                      <div className="p-6" style={{ animation: 'fadeIn 0.3s ease-in' }}>

                        {/* Team Selection */}
                        <div className="mb-4">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Which team?
                          </label>
                          <div className="grid grid-cols-2 gap-3">
                            <button
                              onClick={() => setOtherTeam('home')}
                              className={otherTeam === 'home'
                                ? (darkMode ? 'bg-yellow-500 text-gray-900 py-2 rounded-lg font-bold' : 'bg-yellow-400 text-gray-900 py-2 rounded-lg font-bold')
                                : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold')
                              }
                            >
                              {homeName}
                            </button>
                            <button
                              onClick={() => setOtherTeam('away')}
                              className={otherTeam === 'away'
                                ? (darkMode ? 'bg-yellow-500 text-gray-900 py-2 rounded-lg font-bold' : 'bg-yellow-400 text-gray-900 py-2 rounded-lg font-bold')
                                : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold')
                              }
                            >
                              {awayName}
                            </button>
                          </div>
                        </div>

                        {/* Event Type */}
                        <div className="mb-4">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Event Type
                          </label>
                          <div className="grid grid-cols-2 gap-2">
                            {['timeout', 'goalieSwitch', 'gkOut', 'gkIn'].map(type => (
                              <button
                                key={type}
                                onClick={() => setOtherEventType(type)}
                                className={otherEventType === type
                                  ? (darkMode ? 'bg-yellow-500 text-gray-900 py-2 rounded-lg font-bold' : 'bg-yellow-400 text-gray-900 py-2 rounded-lg font-bold')
                                  : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold')
                                }
                              >
                                {type === 'timeout' ? 'Time-Out' : type === 'goalieSwitch' ? 'Switch Goalie' : type === 'gkOut' ? 'GK Out' : 'GK In'}
                              </button>
                            ))}
                          </div>
                        </div>

                        {/* Game Time (optional) */}
                        <div className="mb-6">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Game Time (optional)
                          </label>
                          <input
                            type="text"
                            value={otherTime}
                            onChange={(e) => setOtherTime(e.target.value)}
                            placeholder="e.g. 12:34"
                            className={darkMode ? 'w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white' : 'w-full px-4 py-2 border border-gray-300 rounded-lg'}
                          />
                        </div>

                        {/* Buttons */}
                        <div className="flex gap-2">
                          <button
                            onClick={() => {
                              setOtherWizardOpen(false);
                              setOtherTeam(null);
                              setOtherEventType('timeout');
                              setOtherTime('');
                              setEditingOtherIndex(null);
                            }}
                            className={darkMode ? 'flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded font-semibold text-white' : 'flex-1 bg-gray-200 hover:bg-gray-300 py-2 rounded font-semibold'}
                          >
                            Cancel
                          </button>
                          <button
                            onClick={() => {
                              if (!otherTeam) {
                                alert('Please select which team');
                                return;
                              }
                              if (isViewer) return;
                              if (isMultiplayer && !currentUser) {
                                alert('You must be logged in to edit multiplayer games');
                                return;
                              }

                              // Create other event
                              const newEvent = {
                                team: otherTeam,
                                eventType: otherEventType,
                                time: otherTime,
                                period: currentPeriod,
                                timestamp: editingOtherIndex !== null ? otherEvents[editingOtherIndex].timestamp : Date.now()
                              };

                              let updatedEvents;
                              const isEditing = editingOtherIndex !== null;

                              if (isEditing) {
                                updatedEvents = otherEvents.map((ev, i) => i === editingOtherIndex ? newEvent : ev);
                              } else {
                                updatedEvents = [...otherEvents, newEvent];
                              }
                              setOtherEvents(updatedEvents);

                              if (isMultiplayer && matchRef.current) {
                                matchRef.current.child('otherEvents').set(updatedEvents);
                              } else if (!isMultiplayer && screen === 'game') {
                                const gs = JSON.parse(localStorage.getItem('juniorLeagueGame') || '{}');
                                gs.otherEvents = updatedEvents;
                                localStorage.setItem('juniorLeagueGame', JSON.stringify(gs));
                              }

                              // Reset wizard
                              setOtherWizardOpen(false);
                              setOtherTeam(null);
                              setOtherEventType('timeout');
                              setOtherTime('');
                              setEditingOtherIndex(null);

                              // Collapse form, expand timeline, highlight new event
                              setOtherFormCollapsed(true);
                              setOtherTimelineCollapsed(false);
                              const eventId = `other-${isEditing ? editingOtherIndex : otherEvents.length}`;
                              setHighlightEventId(eventId);
                              setTimeout(() => setHighlightEventId(null), 2000);


                              // Scroll to timeline
                              setTimeout(() => {
                                const timelineEl = document.querySelector('.other-timeline');
                                if (timelineEl) {
                                  timelineEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }
                              }, 100);
                            }}
                            disabled={!otherTeam}
                            className={otherTeam
                              ? (darkMode ? 'flex-1 bg-blue-700 hover:bg-blue-600 py-2 rounded font-bold text-white' : 'flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded font-bold text-white')
                              : (darkMode ? 'flex-1 bg-gray-600 py-2 rounded font-bold text-gray-500 cursor-not-allowed' : 'flex-1 bg-gray-300 py-2 rounded font-bold text-gray-400 cursor-not-allowed')
                            }
                          >
                            {editingOtherIndex !== null ? 'Update Event' : 'Save Event'}
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}


              {playerStatsMoment === 'Goal' && (
                <div className="max-w-4xl mx-auto goal-form">

                  <div className={darkMode ? 'bg-gray-800 border border-gray-700 rounded-lg shadow-lg overflow-hidden' : 'bg-white rounded-lg shadow-lg overflow-hidden'}>

                    {!matchEnded && (
                      <button
                        onClick={() => setGoalFormCollapsed(!goalFormCollapsed)}
                        className={`w-full ${darkMode ? 'bg-gradient-to-r from-blue-700 to-blue-600' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-3 font-bold flex items-center justify-between transition-colors hover:opacity-90`}
                      >
                        <span>{editingGoalIndex !== null ? `Edit Goal #${editingGoalIndex + 1}` : 'Add Goal'}</span>
                        <span className={`transition-transform duration-300 ${goalFormCollapsed ? '' : 'rotate-180'}`}>
                          <IconChevronDown />
                        </span>
                      </button>
                    )}


                    {!goalFormCollapsed && (
                      <div className="p-6" style={{ animation: 'fadeIn 0.3s ease-in' }}>

                        <div className="mb-4">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Who scored?
                          </label>
                          <div className="grid grid-cols-2 gap-3">
                            <button
                              onClick={() => setRecordingGoal('home')}
                              className={recordingGoal === 'home'
                                ? (darkMode ? 'bg-yellow-500 text-gray-900 py-2 rounded-lg font-bold' : 'bg-yellow-400 text-gray-900 py-2 rounded-lg font-bold')
                                : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold')
                              }
                            >
                              {homeName}
                            </button>
                            <button
                              onClick={() => setRecordingGoal('away')}
                              className={recordingGoal === 'away'
                                ? (darkMode ? 'bg-yellow-500 text-gray-900 py-2 rounded-lg font-bold' : 'bg-yellow-400 text-gray-900 py-2 rounded-lg font-bold')
                                : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold')
                              }
                            >
                              {awayName}
                            </button>
                          </div>
                        </div>
                        <div className="mb-6">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Situation
                          </label>
                          <div className="grid grid-cols-3 gap-2">
                            {['EQ', 'PP', 'PP2', 'SH', 'SH2', 'EN'].map(sit => (
                              <button
                                key={sit}
                                onClick={() => setGoalSituation(sit)}
                                className={goalSituation === sit
                                  ? (darkMode ? 'bg-yellow-500 text-gray-900 py-2 rounded-lg font-bold' : 'bg-yellow-400 text-gray-900 py-2 rounded-lg font-bold')
                                  : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg font-semibold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold')
                                }
                              >
                                {sit}
                              </button>
                            ))}
                          </div>
                        </div>

                        <div className="mb-6">
                          <label className={darkMode ? 'block text-sm font-semibold mb-2 text-gray-300' : 'block text-sm font-semibold mb-2 text-gray-700'}>
                            Game Time (optional)
                          </label>
                          <input
                            type="text"
                            value={goalTime}
                            onChange={(e) => setGoalTime(e.target.value)}
                            placeholder="e.g. 12:34"
                            className={darkMode ? 'w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white' : 'w-full px-4 py-2 border border-gray-300 rounded-lg'}
                          />
                        </div>

                        {/* Player tables - visas nÃ¤r lag Ã¤r valt */}
                        {recordingGoal && (
                          <div className="mb-6" style={{ animation: 'fadeIn 0.3s ease-in' }}>
                            <div className="grid gap-3" style={{ gridTemplateColumns: '2fr 1fr' }}>
                              {/* Scoring team table */}
                              <div className={`${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-gray-50 border border-gray-200'} rounded-lg overflow-hidden`}>
                                <div className="overflow-x-auto max-h-[50vh] overflow-y-auto">
                                  <table className={`w-full ${darkMode ? 'text-gray-200' : ''}`}>
                                    <thead className={`${darkMode ? 'bg-gray-800 text-gray-200' : 'bg-gray-100'} sticky top-0 z-10`}>
                                      <tr>
                                        <th className={`px-2 py-2 text-left text-xs font-semibold sticky left-0 ${darkMode ? 'bg-gray-800' : 'bg-gray-100'} z-10`}>#</th>
                                        {['G', 'A', '+', 'SOG'].map(col => (
                                          <th key={col} className="px-2 py-2 text-center text-xs font-semibold">{col}</th>
                                        ))}
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {(() => {
                                        const team = recordingGoal;
                                        const players = playerStats?.[team]?.players ?? {};
                                        const playerNums = Object.keys(players).sort((a, b) => parseInt(a) - parseInt(b));

                                        if (playerNums.length === 0) {
                                          return (
                                            <tr>
                                              <td colSpan="5" className="text-center py-8 text-sm opacity-60">
                                                No players added yet
                                              </td>
                                            </tr>
                                          );
                                        }

                                        return playerNums.map(pNum => {
                                          const playerId = `${team}-${pNum}`;
                                          const isGoal = goalScorers.includes(playerId);
                                          const isAssist = goalAssists.includes(playerId);
                                          const isPlus = goalPlusPlayers.includes(playerId);
                                          const isSOG = goalSOGPlayers.includes(playerId);

                                          return (
                                            <tr key={pNum} className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} hover:bg-opacity-50 transition-colors`}>
                                              <td className={`px-2 py-2 font-bold sticky left-0 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} z-10`}>{pNum}</td>

                                              {/* G */}
                                              <td className="px-2 py-2 text-center">
                                                <input
                                                  type="checkbox"
                                                  checked={isGoal}
                                                  onChange={() => {
                                                    const isAdding = !isGoal;
                                                    setGoalScorers(prev =>
                                                      isAdding ? [...prev, playerId] : prev.filter(id => id !== playerId)
                                                    );
                                                    if (isAdding && !isSOG) {
                                                      setGoalSOGPlayers(prev => [...prev, playerId]);
                                                    }
                                                    if (!isAdding && isSOG) {
                                                      setGoalSOGPlayers(prev => prev.filter(id => id !== playerId));
                                                    }
                                                    if (isAdding && !isPlus) {
                                                      setGoalPlusPlayers(prev => [...prev, playerId]);
                                                    }
                                                  }}
                                                  className="w-5 h-5 cursor-pointer"
                                                />
                                              </td>

                                              {/* A */}
                                              <td className="px-2 py-2 text-center">
                                                <input
                                                  type="checkbox"
                                                  checked={isAssist}
                                                  onChange={() => {
                                                    const isAdding = !isAssist;
                                                    setGoalAssists(prev =>
                                                      isAdding ? [...prev, playerId] : prev.filter(id => id !== playerId)
                                                    );
                                                    if (isAdding && !isPlus) {
                                                      setGoalPlusPlayers(prev => [...prev, playerId]);
                                                    }
                                                  }}
                                                  className="w-5 h-5 cursor-pointer"
                                                />
                                              </td>

                                              {/* + */}
                                              <td className="px-2 py-2 text-center">
                                                <input
                                                  type="checkbox"
                                                  checked={isPlus}
                                                  onChange={() => {
                                                    setGoalPlusPlayers(prev =>
                                                      prev.includes(playerId) ? prev.filter(id => id !== playerId) : [...prev, playerId]
                                                    );
                                                  }}
                                                  className="w-5 h-5 cursor-pointer"
                                                />
                                              </td>

                                              {/* SOG */}
                                              <td className="px-2 py-2 text-center">
                                                <input
                                                  type="checkbox"
                                                  checked={isSOG}
                                                  disabled={true}
                                                  className="w-5 h-5 cursor-not-allowed opacity-50"
                                                />
                                              </td>
                                            </tr>
                                          );
                                        });
                                      })()}
                                    </tbody>
                                  </table>
                                </div>
                              </div>

                              {/* Opponent team table */}
                              <div className={`${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-gray-50 border border-gray-200'} rounded-lg overflow-hidden`}>
                                <div className="overflow-x-auto max-h-[50vh] overflow-y-auto">
                                  <table className={`w-full ${darkMode ? 'text-gray-200' : ''}`}>
                                    <thead className={`${darkMode ? 'bg-gray-800 text-gray-200' : 'bg-gray-100'} sticky top-0 z-10`}>
                                      <tr>
                                        <th className={`px-2 py-2 text-left text-xs font-semibold sticky left-0 ${darkMode ? 'bg-gray-800' : 'bg-gray-100'} z-10`}>#</th>
                                        <th className="px-2 py-2 text-center text-xs font-semibold">-</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {(() => {
                                        const oppTeam = recordingGoal === 'home' ? 'away' : 'home';
                                        const players = playerStats?.[oppTeam]?.players ?? {};
                                        const playerNums = Object.keys(players).sort((a, b) => parseInt(a) - parseInt(b));

                                        if (playerNums.length === 0) {
                                          return (
                                            <tr>
                                              <td colSpan="2" className="text-center py-8 text-sm opacity-60">
                                                No players added yet
                                              </td>
                                            </tr>
                                          );
                                        }

                                        return playerNums.map(pNum => {
                                          const playerId = `${oppTeam}-${pNum}`;
                                          const isMinus = goalMinusPlayers.includes(playerId);

                                          return (
                                            <tr key={pNum} className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} hover:bg-opacity-50 transition-colors`}>
                                              <td className={`px-2 py-2 font-bold sticky left-0 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} z-10`}>{pNum}</td>
                                              <td className="px-2 py-2 text-center">
                                                <input
                                                  type="checkbox"
                                                  checked={isMinus}
                                                  onChange={() => {
                                                    setGoalMinusPlayers(prev =>
                                                      prev.includes(playerId) ? prev.filter(id => id !== playerId) : [...prev, playerId]
                                                    );
                                                  }}
                                                  className="w-5 h-5 cursor-pointer"
                                                />
                                              </td>
                                            </tr>
                                          );
                                        });
                                      })()}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}

                        <div className="flex gap-2">
                          <button
                            onClick={() => {
                              setRecordingGoal(null);
                              setGoalSituation('EQ');
                              setGoalTime('');
                              setEditingGoalIndex(null);
                              setGoalScorers([]);
                              setGoalAssists([]);
                              setGoalPlusPlayers([]);
                              setGoalMinusPlayers([]);
                              setGoalSOGPlayers([]);
                            }}
                            className={darkMode ? 'flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded font-semibold text-white' : 'flex-1 bg-gray-200 hover:bg-gray-300 py-2 rounded font-semibold'}
                          >
                            Cancel
                          </button>
                          <button
                            onClick={saveGoalHandler}
                            disabled={!recordingGoal}
                            className={recordingGoal
                              ? (darkMode ? 'flex-1 bg-blue-700 hover:bg-blue-600 py-2 rounded font-bold text-white' : 'flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded font-bold text-white')
                              : (darkMode ? 'flex-1 bg-gray-600 py-2 rounded font-bold text-gray-500 cursor-not-allowed' : 'flex-1 bg-gray-300 py-2 rounded font-bold text-gray-400 cursor-not-allowed')
                            }
                          >
                            {editingGoalIndex !== null ? 'Update Goal' : 'Save Goal'}
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}


              {playerStatsMoment === 'Goal' && goalWizardStep !== 2 && goalEvents.length > 0 && (

                <div className="max-w-4xl mx-auto mt-2 goal-timeline">
                  <div className={darkMode ? 'bg-gray-800 border border-gray-700 rounded-lg overflow-hidden' : 'bg-white rounded-lg shadow-lg overflow-hidden'}>
                    <button
                      onClick={() => setGoalTimelineCollapsed(!goalTimelineCollapsed)}
                      className={`w-full ${darkMode ? 'bg-gradient-to-r from-blue-700 to-blue-600' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-2 font-bold flex items-center justify-between transition-colors hover:opacity-90`}
                    >
                      <span> Goals - Timeline </span>
                      <span className={`transition-transform duration-300 ${goalTimelineCollapsed ? '' : 'rotate-180'}`}>
                        <IconChevronDown />
                      </span>
                    </button>

                    {!goalTimelineCollapsed && (
                      <div className="p-3">
                        <div className="space-y-2">
                          {[...goalEvents].reverse().map((event, reverseIdx) => {
                            const idx = goalEvents.length - 1 - reverseIdx;
                            return (
                              <div
                                key={idx}
                                className={`${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-gray-50 border border-gray-200'} rounded p-3 transition-all duration-500 ${highlightEventId === `goal-${idx}` ? 'ring-2 ring-yellow-400 shadow-lg' : ''
                                  }`}
                                style={highlightEventId === `goal-${idx}` ? { animation: 'pulse 1s ease-in-out' } : {}}
                              >
                                <div className="flex items-start justify-between gap-2">
                                  <div className="flex-1">
                                    <div className="font-bold mb-1">
                                      {(() => {
                                        const homeGoals = goalEvents.slice(0, idx + 1).filter(e => e.team === 'home').length;
                                        const awayGoals = goalEvents.slice(0, idx + 1).filter(e => e.team === 'away').length;
                                        const teamName = event.team === 'home' ? homeName : awayName;

                                        return (
                                          <>
                                            {event.team === 'home' ? (
                                              <><span className="font-extrabold text-blue-500">{homeGoals}</span>-{awayGoals}</>
                                            ) : (
                                              <>{homeGoals}-<span className="font-extrabold text-blue-500">{awayGoals}</span></>
                                            )}
                                            {' '}{teamName}
                                          </>
                                        );
                                      })()}
                                    </div>
                                    <div className={darkMode ? 'text-sm text-gray-300' : 'text-sm text-gray-600'}>
                                      <div>
                                        {event.time && `${event.time} â€¢ `}Period {event.period} â€¢ {event.situation}
                                      </div>
                                      <div>
                                        {event.scorers && event.scorers.length > 0 && `G: #${event.scorers.map(id => id.split('-')[1]).join(', #')} `}
                                        {event.assists && event.assists.length > 0 && `A: #${event.assists.map(id => id.split('-')[1]).join(', #')}`}
                                      </div>
                                    </div>
                                  </div>
                                  <div className="flex gap-1">
                                    <button
                                      onClick={() => {
                                        if (matchEnded) return;
                                        const event = goalEvents[idx];
                                        setEditingGoalIndex(idx);
                                        setRecordingGoal(event.team);
                                        setGoalSituation(event.situation);
                                        setGoalTime(event.time || '');
                                        setGoalScorers(event.scorers || []);
                                        setGoalAssists(event.assists || []);
                                        setGoalPlusPlayers(event.plus || []);
                                        setGoalMinusPlayers(event.minus || []);
                                        setGoalSOGPlayers(event.sog || []);
                                        setGoalWizardStep(1);
                                        setGoalFormCollapsed(false);
                                        setGoalTimelineCollapsed(true);
                                        setTimeout(() => {
                                          const formEl = document.querySelector('.goal-form');
                                          if (formEl) {
                                            formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                          }
                                        }, 100);
                                      }}
                                      disabled={matchEnded}
                                      className={matchEnded
                                        ? (darkMode ? 'bg-gray-600 text-gray-400 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed' : 'bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed')
                                        : (darkMode ? 'bg-blue-700 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-semibold' : 'bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-semibold')
                                      }
                                    >
                                      Edit
                                    </button>
                                    <button
                                      onClick={() => {
                                        if (!window.confirm('Delete this goal?')) return;
                                        if (isViewer || matchEnded) return;
                                        if (isMultiplayer && !currentUser) {
                                          alert('You must be logged in to edit multiplayer games');
                                          return;
                                        }

                                        const eventToDelete = goalEvents[idx];
                                        const updatedEvents = goalEvents.filter((_, i) => i !== idx);

                                        setGoalEvents(updatedEvents);

                                        if (isMultiplayer && matchRef.current) {
                                          matchRef.current.update({ goalEvents: updatedEvents });
                                        } else if (!isMultiplayer && screen === 'game') {
                                          const gs = JSON.parse(localStorage.getItem('juniorLeagueGame') || '{}');
                                          gs.goalEvents = updatedEvents;
                                          localStorage.setItem('juniorLeagueGame', JSON.stringify(gs));
                                        }

                                        // Remove player stats from the deleted goal
                                        const newStats = structuredClone(playerStats);
                                        const deletePeriod = eventToDelete.period;

                                        const allPlayerIds = new Set([
                                          ...(eventToDelete.scorers || []),
                                          ...(eventToDelete.assists || []),
                                          ...(eventToDelete.plus || []),
                                          ...(eventToDelete.minus || []),
                                          ...(eventToDelete.sog || [])
                                        ]);

                                        allPlayerIds.forEach(playerId => {
                                          const [team, pNum] = playerId.split('-');

                                          if (!newStats[team]?.players?.[pNum]?.periods?.[deletePeriod]) return;

                                          // Subtract stats
                                          if (eventToDelete.scorers?.includes(playerId)) {
                                            newStats[team].players[pNum].periods[deletePeriod]['G'] = Math.max(0, (newStats[team].players[pNum].periods[deletePeriod]['G'] || 0) - 1);
                                          }
                                          if (eventToDelete.assists?.includes(playerId)) {
                                            newStats[team].players[pNum].periods[deletePeriod]['A'] = Math.max(0, (newStats[team].players[pNum].periods[deletePeriod]['A'] || 0) - 1);
                                          }
                                          if (eventToDelete.plus?.includes(playerId)) {
                                            newStats[team].players[pNum].periods[deletePeriod]['OnIce+'] = Math.max(0, (newStats[team].players[pNum].periods[deletePeriod]['OnIce+'] || 0) - 1);
                                          }
                                          if (eventToDelete.minus?.includes(playerId)) {
                                            newStats[team].players[pNum].periods[deletePeriod]['OnIce-'] = Math.max(0, (newStats[team].players[pNum].periods[deletePeriod]['OnIce-'] || 0) - 1);
                                          }
                                          if (eventToDelete.sog?.includes(playerId)) {
                                            newStats[team].players[pNum].periods[deletePeriod]['SOG'] = Math.max(0, (newStats[team].players[pNum].periods[deletePeriod]['SOG'] || 0) - 1);
                                          }
                                        });

                                        // Recalculate totals
                                        Object.keys(newStats).forEach(team => {
                                          Object.keys(newStats[team].players).forEach(pNum => {
                                            const player = newStats[team].players[pNum];
                                            ['G', 'A', 'OnIce+', 'OnIce-', 'SOG'].forEach(stat => {
                                              player.total[stat] = 0;
                                              Object.keys(player.periods).forEach(p => {
                                                player.total[stat] += player.periods[p][stat] || 0;
                                              });
                                            });
                                          });
                                        });

                                        setPlayerStats(newStats);
                                        if (isMultiplayer && matchRef.current) {
                                          matchRef.current.update({ playerStats: newStats });
                                        }
                                      }}
                                      disabled={matchEnded}
                                      className={matchEnded
                                        ? (darkMode ? 'bg-gray-600 text-gray-400 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed' : 'bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed')
                                        : (darkMode ? 'bg-red-700 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-semibold' : 'bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-semibold')
                                      }
                                    >
                                      Del
                                    </button>
                                  </div>
                                </div>
                              </div>
                            )
                          })}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}



              {playerStatsMoment === 'Penalty' && penaltyEvents.length > 0 && (
                <div className="max-w-4xl mx-auto mt-2 penalty-timeline">
                  <div className={darkMode ? 'bg-gray-800 border border-gray-700 rounded-lg overflow-hidden' : 'bg-white rounded-lg shadow-lg overflow-hidden'}>
                    <button
                      onClick={() => setPenaltyTimelineCollapsed(!penaltyTimelineCollapsed)}
                      className={`w-full ${darkMode ? 'bg-gradient-to-r from-blue-700 to-blue-600' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-2 font-bold flex items-center justify-between transition-colors hover:opacity-90`}
                    >
                      <span>Penalty - Timeline</span>
                      <span className={`transition-transform duration-300 ${penaltyTimelineCollapsed ? '' : 'rotate-180'}`}>
                        <IconChevronDown />
                      </span>
                    </button>

                    {!penaltyTimelineCollapsed && (
                      <div className="p-3">
                        <div className="space-y-2">
                          {[...penaltyEvents].reverse().map((event, reverseIdx) => {
                            const idx = penaltyEvents.length - 1 - reverseIdx;
                            const teamName = event.team === 'home' ? homeName : awayName;
                            return (
                              <div
                                key={idx}
                                className={`${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-gray-50 border border-gray-200'} rounded p-3 transition-all duration-500 ${highlightEventId === `penalty-${idx}` ? 'ring-2 ring-yellow-400 shadow-lg' : ''
                                  }`}
                                style={highlightEventId === `penalty-${idx}` ? { animation: 'pulse 1s ease-in-out' } : {}}
                              >
                                <div className="flex items-start justify-between gap-2">
                                  <div className="flex-1">
                                    <div className="font-bold mb-1">
                                      {event.penaltyType.replace("'", " min")} Penalty - {teamName}
                                    </div>
                                    <div className={darkMode ? 'text-sm text-gray-300' : 'text-sm text-gray-600'}>
                                      <div>
                                        {event.time && `${event.time} â€¢ `}Period {event.period}{event.infraction && ` â€¢ ${event.infraction}`} #{event.player === 'BENCH' ? 'Bench' : event.player}
                                      </div>
                                    </div>
                                  </div>
                                  <div className="flex gap-1">
                                    <button
                                      onClick={() => {
                                        if (matchEnded) return;
                                        const event = penaltyEvents[idx];
                                        setEditingPenaltyIndex(idx);
                                        setPenaltyTeam(event.team);
                                        setPenaltyType(event.penaltyType);
                                        setPenaltyInfraction(event.infraction || '');
                                        setPenaltyTime(event.time || '');
                                        setPenaltyPlayer(event.player);
                                        setPenaltyWizardOpen(true);
                                        setPenaltyFormCollapsed(false);
                                        setPenaltyTimelineCollapsed(true);
                                        setTimeout(() => {
                                          const formEl = document.querySelector('.penalty-form');
                                          if (formEl) {
                                            formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                          }
                                        }, 100);
                                      }}
                                      disabled={matchEnded}
                                      className={matchEnded
                                        ? (darkMode ? 'bg-gray-600 text-gray-400 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed' : 'bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed')
                                        : (darkMode ? 'bg-blue-700 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-semibold' : 'bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-semibold')
                                      }
                                    >
                                      Edit
                                    </button>
                                    <button
                                      onClick={() => {
                                        if (!window.confirm('Delete this penalty?')) return;
                                        if (isViewer || matchEnded) return;
                                        if (isMultiplayer && !currentUser) {
                                          alert('You must be logged in to edit multiplayer games');
                                          return;
                                        }

                                        const eventToDelete = penaltyEvents[idx];
                                        const updatedEvents = penaltyEvents.filter((_, i) => i !== idx);

                                        setPenaltyEvents(updatedEvents);

                                        if (isMultiplayer && matchRef.current) {
                                          matchRef.current.update({ penaltyEvents: updatedEvents });
                                        } else if (!isMultiplayer && screen === 'game') {
                                          const gs = JSON.parse(localStorage.getItem('juniorLeagueGame') || '{}');
                                          gs.penaltyEvents = updatedEvents;
                                          localStorage.setItem('juniorLeagueGame', JSON.stringify(gs));
                                        }


                                      }}
                                      disabled={matchEnded}
                                      className={matchEnded
                                        ? (darkMode ? 'bg-gray-600 text-gray-400 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed' : 'bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed')
                                        : (darkMode ? 'bg-red-700 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-semibold' : 'bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-semibold')
                                      }
                                    >
                                      Del
                                    </button>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {playerStatsMoment === 'Other' && otherEvents.length > 0 && (
                <div className="max-w-4xl mx-auto mt-2 other-timeline">
                  <div className={darkMode ? 'bg-gray-800 border border-gray-700 rounded-lg overflow-hidden' : 'bg-white rounded-lg shadow-lg overflow-hidden'}>
                    <button
                      onClick={() => setOtherTimelineCollapsed(!otherTimelineCollapsed)}
                      className={`w-full ${darkMode ? 'bg-gradient-to-r from-blue-700 to-blue-600' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-2 font-bold flex items-center justify-between transition-colors hover:opacity-90`}
                    >
                      <span>Events - Timeline</span>
                      <span className={`transition-transform duration-300 ${otherTimelineCollapsed ? '' : 'rotate-180'}`}>
                        <IconChevronDown />
                      </span>
                    </button>

                    {!otherTimelineCollapsed && (
                      <div className="p-3">
                        <div className="space-y-2">
                          {[...otherEvents].reverse().map((event, reverseIdx) => {
                            const idx = otherEvents.length - 1 - reverseIdx;
                            const teamName = event.team === 'home' ? homeName : awayName;
                            const eventLabel = event.eventType === 'timeout' ? 'Time-Out' :
                              event.eventType === 'goalieSwitch' ? 'Goalie Switch' :
                                event.eventType === 'gkOut' ? 'GK Out' :
                                  event.eventType === 'gkIn' ? 'GK In' : event.eventType;
                            return (
                              <div
                                key={idx}
                                className={`${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-gray-50 border border-gray-200'} rounded p-3 transition-all duration-500 ${highlightEventId === `other-${idx}` ? 'ring-2 ring-yellow-400 shadow-lg' : ''
                                  }`}
                                style={highlightEventId === `other-${idx}` ? { animation: 'pulse 1s ease-in-out' } : {}}
                              >
                                <div className="flex items-start justify-between gap-2">
                                  <div className="flex-1">
                                    <div className="font-bold mb-1">
                                      {eventLabel} - {teamName}
                                    </div>
                                    <div className={darkMode ? 'text-sm text-gray-300' : 'text-sm text-gray-600'}>
                                      <div>
                                        {event.time && `${event.time} â€¢ `}Period {event.period}
                                      </div>
                                    </div>
                                  </div>
                                  <div className="flex gap-1">
                                    <button
                                      onClick={() => {
                                        if (matchEnded) return;
                                        const event = otherEvents[idx];
                                        setEditingOtherIndex(idx);
                                        setOtherTeam(event.team);
                                        setOtherEventType(event.eventType);
                                        setOtherTime(event.time || '');
                                        setOtherWizardOpen(true);
                                        setOtherFormCollapsed(false);
                                        setOtherTimelineCollapsed(true);
                                        setTimeout(() => {
                                          const formEl = document.querySelector('.other-form');
                                          if (formEl) {
                                            formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                          }
                                        }, 100);
                                      }}
                                      disabled={matchEnded}
                                      className={matchEnded
                                        ? (darkMode ? 'bg-gray-600 text-gray-400 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed' : 'bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed')
                                        : (darkMode ? 'bg-blue-700 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-semibold' : 'bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-semibold')
                                      }
                                    >
                                      Edit
                                    </button>
                                    <button
                                      onClick={() => {
                                        if (!window.confirm('Delete this event?')) return;
                                        if (isViewer || matchEnded) return;
                                        if (isMultiplayer && !currentUser) {
                                          alert('You must be logged in to edit multiplayer games');
                                          return;
                                        }

                                        const updatedEvents = otherEvents.filter((_, i) => i !== idx);

                                        setOtherEvents(updatedEvents);

                                        if (isMultiplayer && matchRef.current) {
                                          matchRef.current.update({ otherEvents: updatedEvents });
                                        } else if (!isMultiplayer && screen === 'game') {
                                          const gs = JSON.parse(localStorage.getItem('juniorLeagueGame') || '{}');
                                          gs.otherEvents = updatedEvents;
                                          localStorage.setItem('juniorLeagueGame', JSON.stringify(gs));
                                        }
                                      }}
                                      disabled={matchEnded}
                                      className={matchEnded
                                        ? (darkMode ? 'bg-gray-600 text-gray-400 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed' : 'bg-gray-300 text-gray-500 px-2 py-1 rounded text-xs font-semibold cursor-not-allowed')
                                        : (darkMode ? 'bg-red-700 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-semibold' : 'bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-semibold')
                                      }
                                    >
                                      Del
                                    </button>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {playerStatsMoment === 'FO/SOG' && (
                <div className={`grid gap-2`}
                  style={{
                    gridTemplateColumns:
                      playerStatsEditMode.home || playerStatsEditMode.away
                        ? playerStatsEditMode.home && !playerStatsEditMode.away ? '1fr' : !playerStatsEditMode.home && playerStatsEditMode.away ? '1fr' : '1fr'
                        : '1fr 1fr'
                  }}
                >
                  {(!playerStatsEditMode.home && !playerStatsEditMode.away) || playerStatsEditMode.home ? renderPlayerTable('home') : null}
                  {(!playerStatsEditMode.home && !playerStatsEditMode.away) || playerStatsEditMode.away ? renderPlayerTable('away') : null}
                </div>
              )}
            </div>
            {showAddPlayerModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-lg shadow-xl p-4 max-w-sm w-full`}>
                  <h3 className="text-lg font-bold mb-3">Add Player(s)</h3>

                  {/* Default roster hint */}
                  {addPlayerTeam === 'home' && defaultHomeRoster && addPlayerNumbers.length === 1 && addPlayerNumbers[0] === '' && Object.keys(playerStats.home?.players || {}).length === 0 && (
                    <div className={`mb-3 p-3 rounded ${darkMode ? 'bg-blue-900 bg-opacity-30 border border-blue-700' : 'bg-blue-50 border border-blue-200'}`}>
                      <p className="text-xs mb-2 opacity-75">Default home roster (from settings):</p>
                      <button
                        onClick={() => {
                          const parsed = parsePlayerInput(defaultHomeRoster);
                          setAddPlayerNumbers([...parsed, '']);
                        }}
                        className={`w-full ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-500 hover:bg-blue-600'} text-white py-2 rounded font-semibold text-sm`}
                      >
                        Load: {defaultHomeRoster}
                      </button>
                    </div>
                  )}

                  <div className={`mb-2 p-2 rounded text-xs ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>
                    ðŸ’¡ Tip: Type "2,3,4" or "2 3 4" to add multiple players at once
                  </div>

                  <div className="space-y-3 mb-3 max-h-64 overflow-y-auto">
                    {addPlayerNumbers.map((num, idx) => (
                      <div key={idx}>
                        <input
                          type="text"
                          inputMode="decimal"
                          value={num}
                          onChange={(e) => handlePlayerInputChange(e.target.value, idx)}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter' && num.trim() !== '') {
                              e.preventDefault();
                              if (idx === addPlayerNumbers.length - 1) {
                                setAddPlayerNumbers([...addPlayerNumbers, '']);
                                setTimeout(() => {
                                  const inputs = document.querySelectorAll('input[type="text"][inputmode="decimal"]');
                                  inputs[inputs.length - 1]?.focus();
                                }, 50);
                              } else {
                                const inputs = document.querySelectorAll('input[type="text"][inputmode="decimal"]');
                                inputs[idx + 1]?.focus();
                              }
                            }
                          }}
                          placeholder={idx === 0 ? "e.g. 2,3,4 or 2 3 4" : `Player #${idx + 1}`}
                          className={`w-full px-3 py-3 border rounded text-center font-bold text-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                          autoFocus={idx === addPlayerNumbers.length - 1}
                        />
                        {num.trim() !== '' && idx === addPlayerNumbers.length - 1 && (
                          <button
                            onClick={() => {
                              setAddPlayerNumbers([...addPlayerNumbers, '']);
                              setTimeout(() => {
                                const inputs = document.querySelectorAll('input[type="text"][inputmode="decimal"]');
                                inputs[inputs.length - 1]?.focus();
                              }, 50);
                            }}
                            className={`w-full mt-2 ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-500 hover:bg-blue-600'} text-white py-2 rounded font-semibold text-sm`}
                          >
                            Next â†’ Add Another Player
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => { setShowAddPlayerModal(false); setAddPlayerNumbers(['']) }}
                      className={`flex-1 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} py-2 rounded font-semibold text-sm`}
                    >
                      Cancel
                    </button>
                    <button
                      onClick={() => {
                        const validNumbers = addPlayerNumbers.filter(n => n && n.trim() !== '');
                        if (validNumbers.length === 0) return;
                        if (isMultiplayer && !currentUser) {
                          alert('You must be logged in to edit multiplayer games');
                          return;
                        }

                        const newStats = structuredClone(playerStats);
                        if (!newStats[addPlayerTeam]) newStats[addPlayerTeam] = { players: {} };
                        if (!newStats[addPlayerTeam].players) newStats[addPlayerTeam].players = {};

                        validNumbers.forEach(playerNum => {
                          if (!newStats[addPlayerTeam].players[playerNum]) {
                            newStats[addPlayerTeam].players[playerNum] = {
                              periods: {},
                              total: { 'G': 0, 'A': 0, 'OnIce+': 0, 'OnIce-': 0, 'FO+': 0, 'FO-': 0, 'SOG': 0, "2'": 0, "5'": 0, "10'": 0, "20'": 0, 'PIM': 0 }
                            };
                          }
                        });

                        setPlayerStats(newStats);
                        if (isMultiplayer && matchRef.current) matchRef.current.update({ playerStats: newStats });
                        setShowAddPlayerModal(false);
                        setAddPlayerNumbers(['']);
                      }}
                      disabled={addPlayerNumbers.filter(n => n && n.trim() !== '').length === 0}
                      className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-2 rounded font-semibold text-sm"
                    >
                      Add ({addPlayerNumbers.filter(n => n && n.trim() !== '').length})
                    </button>
                  </div>
                </div>
              </div>
            )}          </div>
        );
      }

      // Show loading while checking auth
      if (authLoading) return (
        <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="text-center">
            <div className={`animate-spin inline-block w-12 h-12 border-4 ${darkMode ? 'border-gray-600 border-t-white' : 'border-gray-300 border-t-blue-600'} rounded-full mb-4`}></div>
            <div className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Loading...</div>
          </div>
        </div>
      );

      // Show auth screen if not logged in and trying to create OR if forced
      if (!currentUser && (screen === 'create' || screen === 'created' || forceAuth)) return (
        <AuthScreen darkMode={darkMode} setDarkMode={setDarkMode} onSuccess={() => {
          // After successful login, clear force flag and go to start
          setForceAuth(false);
          setScreen('start');
        }} />
      );

      if (showReconnectPrompt) return (
        <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <h3 className="text-xl font-bold mb-3">Reconnect to game</h3>
              <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'} mb-6`}>
                Match Code: <span className="font-mono font-bold">{savedMatchCode}</span>
              </p>
              <div className="flex gap-3">
                <button onClick={reconnectToMatch} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">Reconnect</button>
                <button onClick={startNewSession} className={`flex-1 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} py-3 rounded-lg font-semibold`}>Start Screen</button>
              </div>
            </div>
          </div>
        </div>
      );

      if (screen === 'start') return (
        <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <div className="text-center mb-8">
                <h1 className="text-3xl font-bold mb-2">Hockey Scorekeeper</h1>
                {currentUser ? (
                  <div className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>

                    <p className="text-sm opacity-75">{currentUser.email}</p>

                    {currentUser && (
                      <button
                        onClick={async () => {
                          if (window.confirm('Sign out?')) {
                            await auth.signOut();
                            setScreen('start');
                          }
                        }}
                        className={`w-full text-sm ${darkMode ? 'text-red-400 hover:text-red-300' : 'text-red-600 hover:text-red-700'} py-2 font-semibold`}
                      >
                        SIGN OUT
                      </button>
                    )}

                  </div>
                ) : (
                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                    Track your game together
                  </p>
                )}
              </div>

              <div className="space-y-3">
                {/* Login / Create Account - only if not logged in */}
                {!currentUser && (
                  <button
                    onClick={() => { setForceAuth(true) }}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-semibold text-lg shadow-lg flex items-center justify-center gap-2"
                  >
                    <span>ðŸ”</span>
                    <span>LOGIN / CREATE ACCOUNT</span>
                  </button>
                )}

                {/* My Matches - only if logged in with matches */}
                {currentUser && userMatches.length > 0 && (
                  <button
                    onClick={() => setScreen('history')}
                    className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600' : 'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
                  >
                    MY GAMES ({userMatches.length})
                  </button>
                )}

                {/* Create Match */}
                <button
                  onClick={() => {
                    if (!currentUser) {
                      setForceAuth(true);
                    } else {
                      setScreen('create');
                    }
                  }}
                  className={`w-full flex items-center justify-center relative ${darkMode ? 'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600' : 'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
                >
                  <span className="absolute right-4">{!currentUser && 'ðŸ”’'}</span>
                  <span>CREATE GAME</span>
                </button>

                {/* Join Game as Editor */}
                <button
                  onClick={() => {
                    if (!currentUser) {
                      setForceAuth(true);
                    } else {
                      setScreen('join');
                    }
                  }}
                  className={`w-full flex items-center justify-center relative ${darkMode ? 'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600' : 'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
                >
                  <span className="absolute right-4">{!currentUser && 'ðŸ”’'}</span>
                  <span>JOIN GAME</span>
                </button>

                {/* Join Game as Viewer - always available */}
                <button
                  onClick={() => setScreen('join')}
                  className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600' : 'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
                >
                  JOIN GAME AS VIEWER
                </button>

                {/* Continue Alone - always available */}
                <button
                  onClick={continueAlone}
                  className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600' : 'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
                >
                  ... or CONTINUE ALONE
                </button>
              </div>

              {/* Bottom section with admin and logout */}
              <div className="mt-6 pt-6 border-t border-opacity-20 space-y-2">
                {currentUser && isAdmin && (
                  <button
                    onClick={() => setScreen('admin')}
                    className={`w-full text-sm ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-800'} py-2 rounded font-semibold`}
                  >
                    ðŸ”’ Admin Panel
                  </button>
                )}

              </div>
            </div>
          </div>
        </div>
      );

      if (screen === 'admin') {
        return <AdminPanel
          darkMode={darkMode}
          setScreen={setScreen}
        />;
      }

      if (screen === 'history') {
        return <MatchHistory
          darkMode={darkMode}
          matches={userMatches}
          loading={loadingMatches}
          onJoinMatch={(matchCode) => {
            resetGameState();
            setGameMode('multi');
            localStorage.setItem('gameMode', 'multi');
            setMatchCode(matchCode);
            setIsViewer(false);
            setIsMultiplayer(true);
            localStorage.setItem('multiplayerMatch', JSON.stringify({ code: matchCode, timestamp: Date.now(), isViewer: false, gameMode: 'multi' }));
            setScreen('game');
          }}
          onBack={() => setScreen('start')}
        />;
      }

      if (screen === 'create') return (
        <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-2xl shadow-2xl p-8`}>

              <div className="flex justify-end">
                <button
                  onClick={() => setScreen('start')}
                  className={`p-2 rounded-lg transition-colors ${darkMode
                    ? 'hover:bg-gray-700 text-gray-400 hover:text-gray-300'
                    : 'hover:bg-gray-100 text-gray-600 hover:text-gray-800'
                    }`}
                  aria-label="Close"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <h2 className="text-2xl font-bold mb-6">New Game</h2>
              <div className="space-y-4 mb-6">

                <div>
                  <label className="block text-sm mb-2">Home Team</label>
                  <div className="relative">
                    <input
                      type="text"
                      value={homeName}
                      onChange={e => setHomeName(e.target.value)}
                      placeholder="Enter home team name"
                      className={`w-full px-4 py-3 pr-10 border rounded-lg
        ${darkMode
                          ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                          : 'border-gray-300 placeholder-gray-400'
                        }`}
                    />
                    {homeName && (
                      <button
                        type="button"
                        onClick={() => setHomeName('')}
                        className="absolute right-3 top-1/2 -translate-y-1/2
                   text-gray-400 hover:text-gray-600 text-xl font-light"
                        aria-label="Clear home team"
                      >
                        Ã—
                      </button>
                    )}
                  </div>
                </div>

                <div>
                  <label className="block text-sm mb-2">Away Team</label>
                  <div className="relative">
                    <input
                      type="text"
                      value={awayName}
                      onChange={e => setAwayName(e.target.value)}
                      placeholder="Enter away team name"
                      className={`w-full px-4 py-3 pr-10 border rounded-lg
        ${darkMode
                          ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                          : 'border-gray-300 placeholder-gray-400'
                        }`}
                    />
                    {awayName && (
                      <button
                        type="button"
                        onClick={() => setAwayName('')}
                        className="absolute right-3 top-1/2 -translate-y-1/2
                   text-gray-400 hover:text-gray-600 text-xl font-light"
                        aria-label="Clear away team"
                      >
                        Ã—
                      </button>
                    )}
                  </div>
                </div>


              </div>
              <button onClick={createMatch} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">START GAME</button>
            </div>
          </div>
        </div>
      );


      if (screen === 'created') return (
        <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-2xl shadow-2xl p-8`}>

              <div className="flex justify-end mb-4">
                <button
                  onClick={() => setScreen('start')}
                  className={`p-2 rounded-lg transition-colors ${darkMode
                    ? 'hover:bg-gray-700 text-gray-400 hover:text-gray-300'
                    : 'hover:bg-gray-100 text-gray-600 hover:text-gray-800'
                    }`}
                  aria-label="Close"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <div className="text-center mb-6">
                <h2 className="text-2xl font-bold mb-2 -mt-2">Game Created</h2>
              </div>

              <div className={`${darkMode ? 'bg-gray-700' : 'bg-blue-50'} rounded-xl p-4 mb-4`}>
                <p className={`text-sm font-semibold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Editor Code (max 5 users)</p>
                <div className="flex items-stretch gap-3 mb-6">
                  <div className={`flex-1 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg py-3 px-3 flex items-center justify-center border-2 ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                    <div className={`text-lg font-bold tracking-widest ${darkMode ? 'text-white' : 'text-gray-900'}`}>{matchCode}</div>
                  </div>
                  <button onClick={copyCode} className="bg-gray-600 hover:bg-gray-700 text-white px-5 rounded-lg font-semibold whitespace-nowrap">Copy</button>
                </div>

                <p className={`text-sm font-semibold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Viewer Code (read-only)</p>
                <div className="flex items-stretch gap-3">
                  <div className={`flex-1 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg py-3 px-3 flex items-center justify-center border-2 ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                    <div className={`text-lg font-bold tracking-widest ${darkMode ? 'text-white' : 'text-gray-900'}`}>{matchCode}-V</div>
                  </div>
                  <button onClick={() => navigator.clipboard.writeText(matchCode + '-V').then(() => alert('Code copied!')).catch(() => alert('Failed to copy'))} className="bg-gray-600 hover:bg-gray-700 text-white px-5 rounded-lg font-semibold whitespace-nowrap">Copy</button>
                </div>
              </div>

              {error && <div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded mb-4">{error}</div>}

              <button onClick={startMatch} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">CONTINUE TO GAME</button>
            </div>
          </div>
        </div>
      );

      if (screen === 'join') return (
        <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <div className="flex justify-end">
                <button
                  onClick={() => setScreen('start')}
                  className={`p-2 rounded-lg transition-colors ${darkMode
                    ? 'hover:bg-gray-700 text-gray-400 hover:text-gray-300'
                    : 'hover:bg-gray-100 text-gray-600 hover:text-gray-800'
                    }`}
                  aria-label="Close"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <h2 className="text-2xl font-bold mb-6 -mt-2">Join Game</h2>


              <div className={`${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-blue-50 border-blue-200'} border rounded-lg p-4 mb-6 text-sm`}>
                <div className="font-semibold mb-2">Two ways to join:</div>
                <div className="space-y-2">
                  <div>
                    <span className="font-bold">Editor code (ABC123):</span>
                    <div className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Full editing rights {!currentUser && '(requires login)'}</div>
                  </div>
                  <div>
                    <span className="font-bold">Viewer code (ABC123-V):</span>
                    <div className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Read-only live stats (no login needed)</div>
                  </div>
                </div>
              </div>

              <div className="mb-6">
                <label className="block text-sm mb-2">Enter game code:</label>
                <input type="text" value={inputCode} onChange={e => { setInputCode(e.target.value.toUpperCase()); setError('') }} maxLength={8} placeholder="ABC123" className={`w-full px-4 py-4 border rounded-lg text-center text-2xl font-bold tracking-widest ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
              </div>
              {error && <div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded mb-4 text-sm">
                <div className="mb-2">{error}</div>
                {error.includes('logged in') && (
                  <div className="flex justify-end mb-4">
                    <button
                      onClick={() => setScreen('start')}
                      className={`p-2 rounded-lg transition-colors ${darkMode
                        ? 'hover:bg-gray-700 text-gray-400 hover:text-gray-300'
                        : 'hover:bg-gray-100 text-gray-600 hover:text-gray-800'
                        }`}
                      aria-label="Close"
                    >
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                )}
              </div>}
              <button onClick={joinMatch} disabled={!(inputCode.length === 6 || (inputCode.length === 8 && inputCode.endsWith('-V')))} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-4 rounded-xl font-bold text-lg shadow-lg">CONNECT</button>
            </div>
          </div>
        </div>
      );

      if (focusMode && screen === 'game') {
        const homeTeam = goalFocusSwapped ? 'away' : 'home';
        const awayTeam = goalFocusSwapped ? 'home' : 'away';
        const homeName_ = goalFocusSwapped ? awayName : homeName;
        const awayName_ = goalFocusSwapped ? homeName : awayName;
        const homeGoals = goalFocusSwapped ? totals.awayScore : totals.homeScore;
        const awayGoals = goalFocusSwapped ? totals.homeScore : totals.awayScore;
        const homeSaves = goalFocusSwapped ? totals.awaySaves : totals.homeSaves;
        const awaySaves = goalFocusSwapped ? totals.homeSaves : totals.awaySaves;
        const renderGoalieCard = (team, name, goals, saves) => {
          const activeGoalie = activeGoalies[team];
          const currentPeriodSaves = periodStats[currentPeriod]?.[team + 'Saves'] ?? 0;

          return (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-lg overflow-hidden border ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
              {/* Header with team name and total goals */}
              <div className={`${darkMode ? 'bg-gradient-to-r from-blue-700 to-blue-600' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-3 flex items-center justify-between`}>
                <span className="font-bold">{name}</span>
                <span className="text-2xl font-bold">{goals}</span>
              </div>

              {/* Content */}
              <div className="p-4">
                {/* Period info and total saves */}
                <div className={`text-sm mb-2 text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  <span className="opacity-75">Period {currentPeriod}</span>
                  <span className="opacity-30 mx-1">Â·</span>
                  <span className="opacity-90 font-semibold">{currentPeriodSaves} {currentPeriodSaves === 1 ? 'save' : 'saves'}</span>
                </div>

                {/* Saves controls - same style as main screen */}
                <div className="flex items-center justify-center gap-3 mb-2">

                  <button
                    onClick={() => updateStat(team, 'Saves', -1)}
                    disabled={matchEnded || isViewer}
                    className="bg-[#6187E3] bg-opacity-80 w-10 h-10 rounded flex items-center justify-center text-white text-xl font-bold hover:bg-opacity-70"
                  >
                    âˆ’
                  </button>
                  <div className={`text-4xl font-bold min-w-[3rem] text-center ${sparkleStats[`${team}Saves${currentPeriod}`] ? 'sparkle' : ''} ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {saves}
                  </div>
                  <button
                    onClick={() => updateStat(team, 'Saves', 1)}
                    disabled={matchEnded || isViewer}
                    className="bg-[#6187E3] bg-opacity-80 w-10 h-10 rounded flex items-center justify-center text-white text-xl font-bold hover:bg-opacity-70"
                  >
                    +
                  </button>
                </div>

                {/* Period breakdown */}
                <div className={`text-xs opacity-75 text-center mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  ({Object.keys(periodStats).sort((a, b) => parseInt(a) - parseInt(b)).map((p, i, arr) => {
                    const isCurrentPeriod = parseInt(p) === currentPeriod;
                    return <span key={p} className={isCurrentPeriod ? 'font-bold underline' : ''}>{periodStats[p][team + 'Saves']}{i < arr.length - 1 ? '-' : ''}</span>;
                  })})
                </div>

                {/* Goalie switch button */}
                <div className={`text-center pt-3 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                  <div className={`text-xs mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    Recording for: <span className="font-semibold">{activeGoalie === 'starter' ? 'Starter' : 'Backup'}</span>
                  </div>
                  <button
                    onClick={() => setActiveGoalies(prev => ({ ...prev, [team]: activeGoalie === 'starter' ? 'backup' : 'starter' }))}
                    disabled={matchEnded || isViewer}
                    className={`px-4 py-2 rounded font-semibold text-sm transition-colors ${darkMode
                      ? 'bg-gray-700 hover:bg-gray-600 text-gray-300'
                      : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                      } disabled:opacity-50`}
                  >
                    Switch Goalie
                  </button>
                </div>
              </div>
            </div>
          );
        };


        {/* Statistics Section */ }
        <div className="space-y-3">
          {[
            { team: homeTeam, name: homeName_, goals: homeGoals, saves: homeSaves },
            { team: awayTeam, name: awayName_, goals: awayGoals, saves: awaySaves }
          ].map(teamStats => {
            const selectedGoalie = selectedGoalieStats[teamStats.team];

            const periodKeys = Object.keys(periodStats).sort((a, b) => parseInt(a) - parseInt(b));

            // Calculate per goalie per period
            const tableData = periodKeys.map(p => {
              const goalieData = periodStats[p]?.[teamStats.team + 'Goalie'];
              const starterSaves = goalieData?.starter?.saves ?? 0;
              const starterGA = goalieData?.starter?.ga ?? 0;
              const backupSaves = goalieData?.backup?.saves ?? 0;
              const backupGA = goalieData?.backup?.ga ?? 0;

              return {
                period: p,
                starter: {
                  saves: starterSaves,
                  ga: starterGA,
                  sog: starterSaves + starterGA,
                  svsPct: (starterSaves + starterGA) === 0 ? '-' : ((starterSaves / (starterSaves + starterGA)) * 100).toFixed(1)
                },
                backup: {
                  saves: backupSaves,
                  ga: backupGA,
                  sog: backupSaves + backupGA,
                  svsPct: (backupSaves + backupGA) === 0 ? '-' : ((backupSaves / (backupSaves + backupGA)) * 100).toFixed(1)
                }
              };
            });

            // Calculate totals per goalie
            let starterTotalSaves = 0, starterTotalGA = 0;
            let backupTotalSaves = 0, backupTotalGA = 0;
            tableData.forEach(d => {
              starterTotalSaves += d.starter.saves;
              starterTotalGA += d.starter.ga;
              backupTotalSaves += d.backup.saves;
              backupTotalGA += d.backup.ga;
            });
            const starterTotalSOG = starterTotalSaves + starterTotalGA;
            const backupTotalSOG = backupTotalSaves + backupTotalGA;
            const starterTotalSvsPct = starterTotalSOG === 0 ? '-' : ((starterTotalSaves / starterTotalSOG) * 100).toFixed(1);
            const backupTotalSvsPct = backupTotalSOG === 0 ? '-' : ((backupTotalSaves / backupTotalSOG) * 100).toFixed(1);
            const isExpanded = expandedGoalieStats[teamStats.team];

            // Choose which goalie's data to display
            const displayData = selectedGoalie === 'starter'
              ? { tableData: tableData.map(d => ({ period: d.period, ...d.starter })), total: { saves: starterTotalSaves, ga: starterTotalGA, sog: starterTotalSOG, svsPct: starterTotalSvsPct } }
              : { tableData: tableData.map(d => ({ period: d.period, ...d.backup })), total: { saves: backupTotalSaves, ga: backupTotalGA, sog: backupTotalSOG, svsPct: backupTotalSvsPct } };

            return (
              <div key={teamStats.team} className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow-lg overflow-hidden`}>
                {/* Toggle Header */}
                <button
                  onClick={() => setExpandedGoalieStats(prev => ({ ...prev, [teamStats.team]: !prev[teamStats.team] }))}
                  className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} px-4 py-3 font-semibold text-left flex items-center justify-between transition-colors`}
                >
                  <span>{teamStats.name}</span>
                  <span className={`transition-transform ${isExpanded ? 'rotate-180' : ''}`}><IconChevronDown /></span>
                </button>

                {/* Goalie Toggle & Statistics Table - Collapsible */}
                {isExpanded && (
                  <div className="p-4">

                    {/* Goalie Toggle */}
                    <div className="mb-3 flex gap-1">
                      <button
                        onClick={() => setSelectedGoalieStats(prev => ({ ...prev, [teamStats.team]: 'starter' }))}
                        className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${selectedGoalie === 'starter'
                          ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
                          : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
                          }`}
                      >
                        Starter
                      </button>
                      <button
                        onClick={() => setSelectedGoalieStats(prev => ({ ...prev, [teamStats.team]: 'backup' }))}
                        className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${selectedGoalie === 'backup'
                          ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
                          : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
                          }`}
                      >
                        Backup
                      </button>
                    </div>

                    <div className="overflow-x-auto">
                      <table className={`w-full text-xs ${darkMode ? 'text-gray-100' : 'text-gray-900'}`}>
                        <thead>
                          <tr className={`${darkMode ? 'bg-gray-700 text-gray-100' : 'bg-gray-100 text-gray-800'}`}>
                            <th className="text-left px-2 py-2">Stat</th>
                            {periodKeys.map(p => (
                              <th key={p} className="text-center px-1 py-2">
                                {parseInt(p) <= 3 ? `P${p}` : 'OT'}
                              </th>
                            ))}
                            <th className="text-center px-2 py-2 font-bold">Tot</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">GA</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs">{d.ga}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.ga}</td>
                          </tr>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">SOG</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs">{d.sog}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.sog}</td>
                          </tr>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">SVS</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs">{d.saves}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.saves}</td>
                          </tr>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">SVS%</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs font-semibold">{d.svsPct}{d.svsPct !== '-' ? '%' : ''}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.svsPct}{displayData.total.svsPct !== '-' ? '%' : ''}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>

        return (
          <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
            <audio ref={audioRefs.homeGoal} src="homeGoal.mp3" />
            <audio ref={audioRefs.awayGoal} src="awayGoal.mp3" />
            <audio ref={audioRefs.homePenalty} src="homePenalty.mp3" />
            <audio ref={audioRefs.awayPenalty} src="awayPenalty.mp3" />
            <audio ref={audioRefs.intro} src="intro.mp3" />

            <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
              <div className={`${darkMode ? 'bg-gray-800 border-b border-gray-700' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-3 py-2 shadow-lg sticky top-0 z-50`}>
                <div className="max-w-7xl mx-auto">
                  <div className="flex justify-between items-center">
                    <div className="flex gap-2 items-center flex-wrap">

                      {[1, 2, 3].map(p => <button key={p} onClick={() => {
                        setCurrentPeriod(p);
                        if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ currentPeriod: p })
                      }} disabled={matchEnded || isViewer} className={`px-3 py-1 rounded font-bold ${currentPeriod === p ? 'bg-yellow-400 text-blue-900' : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}>{p}</button>)}
                      {periodStats[4] && <button onClick={() => { setCurrentPeriod(4); if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ currentPeriod: 4 }) }} disabled={matchEnded || isViewer} className={`px-2 py-1 rounded text-sm font-bold ${currentPeriod === 4 ? 'bg-yellow-400 text-blue-900' : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}>OT</button>}
                      {!periodStats[4] && currentPeriod === 3 && (
                        <button
                          onClick={() => {
                            const updated = { ...periodStats, 4: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 } };
                            setPeriodStats(updated);
                            setCurrentPeriod(4);
                            if (isMultiplayer && matchRef.current && !matchEnded) {
                              matchRef.current.update({ periodStats: updated, currentPeriod: 4 });
                            }
                          }}
                          disabled={matchEnded || isViewer}
                          className={`px-2 py-1 rounded text-sm font-bold ${darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}
                        >
                          +OT
                        </button>
                      )}

                      <button
                        onClick={() => setGoalFocusSwapped(!goalFocusSwapped)}
                        className={`px-3 py-1 rounded font-bold ${darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}
                        title="Swap sides"
                      >
                        â‡„
                      </button>

                    </div>
                    <button
                      onClick={() => setFocusMode(null)}
                      className={`${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-1`}
                    >
                      <span className="text-lg"><IconBack /></span>
                      <span className="hidden sm:inline">Back</span>
                    </button>
                  </div>
                </div>

              </div>


              <div className="max-w-6xl mx-auto p-2 sm:p-4">
                <div className="grid grid-cols-2 gap-2 sm:gap-4 mb-4">
                  {renderGoalieCard(homeTeam, homeName_, homeGoals, homeSaves)}
                  {renderGoalieCard(awayTeam, awayName_, awayGoals, awaySaves)}
                </div>

                {/* Statistics Section */}
                <div className="space-y-3">
                  {[
                    { team: homeTeam, name: homeName_, goals: homeGoals, saves: homeSaves },
                    { team: awayTeam, name: awayName_, goals: awayGoals, saves: awaySaves }
                  ].map(teamStats => {
                    const selectedGoalie = selectedGoalieStats[teamStats.team];

                    const periodKeys = Object.keys(periodStats).sort((a, b) => parseInt(a) - parseInt(b));

                    // Calculate per goalie per period
                    const tableData = periodKeys.map(p => {
                      const goalieData = periodStats[p]?.[teamStats.team + 'Goalie'];
                      const starterSaves = goalieData?.starter?.saves ?? 0;
                      const starterGA = goalieData?.starter?.ga ?? 0;
                      const backupSaves = goalieData?.backup?.saves ?? 0;
                      const backupGA = goalieData?.backup?.ga ?? 0;

                      return {
                        period: p,
                        starter: {
                          saves: starterSaves,
                          ga: starterGA,
                          sog: starterSaves + starterGA,
                          svsPct: (starterSaves + starterGA) === 0 ? '-' : ((starterSaves / (starterSaves + starterGA)) * 100).toFixed(1)
                        },
                        backup: {
                          saves: backupSaves,
                          ga: backupGA,
                          sog: backupSaves + backupGA,
                          svsPct: (backupSaves + backupGA) === 0 ? '-' : ((backupSaves / (backupSaves + backupGA)) * 100).toFixed(1)
                        }
                      };
                    });

                    // Calculate totals per goalie
                    let starterTotalSaves = 0, starterTotalGA = 0;
                    let backupTotalSaves = 0, backupTotalGA = 0;
                    tableData.forEach(d => {
                      starterTotalSaves += d.starter.saves;
                      starterTotalGA += d.starter.ga;
                      backupTotalSaves += d.backup.saves;
                      backupTotalGA += d.backup.ga;
                    });
                    const starterTotalSOG = starterTotalSaves + starterTotalGA;
                    const backupTotalSOG = backupTotalSaves + backupTotalGA;
                    const starterTotalSvsPct = starterTotalSOG === 0 ? '-' : ((starterTotalSaves / starterTotalSOG) * 100).toFixed(1);
                    const backupTotalSvsPct = backupTotalSOG === 0 ? '-' : ((backupTotalSaves / backupTotalSOG) * 100).toFixed(1);
                    const isExpanded = expandedGoalieStats[teamStats.team];

                    // Choose which goalie's data to display
                    const displayData = selectedGoalie === 'total'
                      ? {
                        tableData: tableData.map(d => ({
                          period: d.period,
                          saves: d.starter.saves + d.backup.saves,
                          ga: d.starter.ga + d.backup.ga,
                          sog: d.starter.sog + d.backup.sog,
                          svsPct: (d.starter.sog + d.backup.sog) === 0 ? '-' : (((d.starter.saves + d.backup.saves) / (d.starter.sog + d.backup.sog)) * 100).toFixed(1)
                        })),
                        total: {
                          saves: starterTotalSaves + backupTotalSaves,
                          ga: starterTotalGA + backupTotalGA,
                          sog: starterTotalSOG + backupTotalSOG,
                          svsPct: (starterTotalSOG + backupTotalSOG) === 0 ? '-' : (((starterTotalSaves + backupTotalSaves) / (starterTotalSOG + backupTotalSOG)) * 100).toFixed(1)
                        }
                      }
                      : selectedGoalie === 'starter'
                        ? { tableData: tableData.map(d => ({ period: d.period, ...d.starter })), total: { saves: starterTotalSaves, ga: starterTotalGA, sog: starterTotalSOG, svsPct: starterTotalSvsPct } }
                        : { tableData: tableData.map(d => ({ period: d.period, ...d.backup })), total: { saves: backupTotalSaves, ga: backupTotalGA, sog: backupTotalSOG, svsPct: backupTotalSvsPct } };

                    return (
                      <div key={teamStats.team} className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow-lg overflow-hidden`}>
                        {/* Toggle Header */}
                        <button
                          onClick={() => setExpandedGoalieStats(prev => ({ ...prev, [teamStats.team]: !prev[teamStats.team] }))}
                          className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} px-4 py-3 font-semibold text-left flex items-center justify-between transition-colors`}
                        >
                          <span>{teamStats.name}</span>
                          <span className={`transition-transform ${isExpanded ? 'rotate-180' : ''}`}><IconChevronDown /></span>
                        </button>

                        {/* Goalie Toggle & Statistics Table - Collapsible */}
                        {isExpanded && (
                          <div className="p-4">



                            {/* Goalie Toggle */}
                            <div className="mb-3 flex gap-1">
                              <button
                                onClick={() => setSelectedGoalieStats(prev => ({ ...prev, [teamStats.team]: 'total' }))}
                                className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${selectedGoalie === 'total'
                                  ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
                                  : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
                                  }`}
                              >
                                All
                              </button>
                              <button
                                onClick={() => setSelectedGoalieStats(prev => ({ ...prev, [teamStats.team]: 'starter' }))}
                                className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${selectedGoalie === 'starter'
                                  ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
                                  : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
                                  }`}
                              >
                                Starter
                              </button>
                              <button
                                onClick={() => setSelectedGoalieStats(prev => ({ ...prev, [teamStats.team]: 'backup' }))}
                                className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${selectedGoalie === 'backup'
                                  ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
                                  : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
                                  }`}
                              >
                                Backup
                              </button>
                            </div>
                            <div className="overflow-x-auto">
                              <table className={`w-full text-xs ${darkMode ? 'text-gray-100' : 'text-gray-900'}`}>
                                <thead>
                                  <tr className={`${darkMode ? 'bg-gray-700 text-gray-100' : 'bg-gray-100 text-gray-800'}`}>
                                    <th className="text-left px-2 py-2">Stat</th>
                                    {periodKeys.map(p => (
                                      <th key={p} className="text-center px-1 py-2">
                                        {parseInt(p) <= 3 ? `P${p}` : 'OT'}
                                      </th>
                                    ))}
                                    <th className="text-center px-2 py-2 font-bold">Tot</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <td className="px-2 py-2 font-semibold text-left">GA</td>
                                    {displayData.tableData.map(d => (
                                      <td key={d.period} className="text-center px-1 py-2 text-xs">{d.ga}</td>
                                    ))}
                                    <td className="text-center px-2 py-2 font-semibold">{displayData.total.ga}</td>
                                  </tr>
                                  <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <td className="px-2 py-2 font-semibold text-left">SOG</td>
                                    {displayData.tableData.map(d => (
                                      <td key={d.period} className="text-center px-1 py-2 text-xs">{d.sog}</td>
                                    ))}
                                    <td className="text-center px-2 py-2 font-semibold">{displayData.total.sog}</td>
                                  </tr>
                                  <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <td className="px-2 py-2 font-semibold text-left">SVS</td>
                                    {displayData.tableData.map(d => (
                                      <td key={d.period} className="text-center px-1 py-2 text-xs">{d.saves}</td>
                                    ))}
                                    <td className="text-center px-2 py-2 font-semibold">{displayData.total.saves}</td>
                                  </tr>
                                  <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                                    <td className="px-2 py-2 font-semibold text-left">SVS%</td>
                                    {displayData.tableData.map(d => (
                                      <td key={d.period} className="text-center px-1 py-2 text-xs font-semibold">{d.svsPct}{d.svsPct !== '-' ? '%' : ''}</td>
                                    ))}
                                    <td className="text-center px-2 py-2 font-semibold">{displayData.total.svsPct}{displayData.total.svsPct !== '-' ? '%' : ''}</td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>

              </div>

            </div>
          </div>
        );
      }

      return (
        <div className={`min-h-screen pb-20 ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          {isViewer && <div className="bg-yellow-500 text-gray-900 px-4 py-2 text-center font-semibold text-sm">
            VIEWER MODE - live stats (read-only)
          </div>}
          <audio ref={audioRefs.homeGoal} src="homeGoal.mp3" />
          <audio ref={audioRefs.awayGoal} src="awayGoal.mp3" />
          <audio ref={audioRefs.homePenalty} src="homePenalty.mp3" />
          <audio ref={audioRefs.awayPenalty} src="awayPenalty.mp3" />
          <audio ref={audioRefs.intro} src="intro.mp3" />



          <div className={`${darkMode ? 'bg-gray-800 border-b border-gray-700' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-3 shadow-lg sticky top-0 z-50`}>
            <div className="max-w-6xl mx-auto">
              {isMultiplayer && <div className="mb-2 flex items-center justify-between gap-2">
                <div className="flex items-center gap-2 flex-wrap">
                  {!matchEnded && <span className="flex items-center gap-1 bg-red-500 px-2 py-1 rounded text-xs font-bold"><span className="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></span>LIVE</span>}
                  {matchEnded && <span className="bg-gray-500 px-2 py-1 rounded text-xs font-bold">GAME ENDED</span>}
                  <span className="text-xs">ðŸ‘¥ {connectedUsers}</span>
                  {!isViewer && viewerCount > 0 && <span className="text-xs">ðŸ‘ï¸ {viewerCount}</span>}

                </div>
                <div className="flex items-center gap-1">
                  <button
                    className={`${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-2 py-1 rounded font-mono font-bold text-xs transition-colors`}
                  >
                    {matchCode}
                  </button>
                </div>
              </div>}

              <div className="flex justify-between items-center mb-2">
                <div className="flex gap-2 items-center">

                  {[1, 2, 3].map(p => <button key={p} onClick={() => {
                    setCurrentPeriod(p);
                    if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ currentPeriod: p })
                  }} disabled={matchEnded || isViewer} className={`px-3 py-1 rounded font-bold ${currentPeriod === p ? 'bg-yellow-400 text-blue-900' : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}>{p}</button>)}
                  {periodStats[4] && <button onClick={() => { setCurrentPeriod(4); if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ currentPeriod: 4 }) }} disabled={matchEnded || isViewer} className={`px-3 py-1 rounded font-bold text-xs ${currentPeriod === 4 ? 'bg-yellow-400 text-blue-900' : darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}>OT</button>}
                  {!periodStats[4] && currentPeriod === 3 && (
                    <button
                      onClick={() => {
                        const updated = { ...periodStats, 4: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 } };
                        setPeriodStats(updated);
                        setCurrentPeriod(4);
                        if (isMultiplayer && matchRef.current && !matchEnded) {
                          matchRef.current.update({ periodStats: updated, currentPeriod: 4 });
                        }
                      }}
                      disabled={matchEnded || isViewer}
                      className={`px-3 py-1 rounded font-bold text-xs ${darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20'}`}
                    >
                      +OT
                    </button>
                  )}
                </div>
                <div className="flex gap-2">
                  {!isMultiplayer && (
                    <button onClick={exitToStart} className={`${darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}>
                      <IconBack />
                    </button>
                  )}
                  {isViewer && (
                    <button onClick={() => {
                      localStorage.removeItem('multiplayerMatch');
                      resetGameState();
                      setIsMultiplayer(false);
                      setIsViewer(false);
                      setMatchCode('');
                      setScreen('start');
                    }} className={`${darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}>
                      <IconBack />
                    </button>
                  )}
                  {isMultiplayer && !isViewer && (
                    <button onClick={() => {
                      localStorage.removeItem('multiplayerMatch');
                      resetGameState();
                      setIsMultiplayer(false);
                      setMatchCode('');
                      setScreen('start');
                    }} className={`${darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}>
                      <IconBack />
                    </button>
                  )}
                  <button onClick={() => setStatsCollapsed(!statsCollapsed)} className={`${darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}>{statsCollapsed ? <IconChevronDown /> : <IconChevronUp />}</button>
                  <button onClick={() => setShowSettings(!showSettings)} className={`${darkMode ? 'bg-gray-700' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}><IconSettings /></button>
                </div>
              </div>

              {showSettings && <div className={`${darkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-800'} rounded-lg p-4 mb-4 max-h-[70vh] overflow-y-auto`}>
                <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-lg">Settings</h3>
                  <button
                    onClick={() => setShowSettings(false)}
                    className={`${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'} px-4 py-2 rounded font-semibold text-sm`}
                  >
                    Close
                  </button>
                </div>

                {/* MY PREFERENCES - HÃ¶gst upp */}
                <div className="mb-6">
                  <h4 className={`text-sm font-semibold mb-3 pb-2 border-b ${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-200 text-gray-700'}`}>
                    My Preferences
                  </h4>

                  <div className="space-y-2">
                    <label className="flex items-center justify-between py-2">
                      <span className="text-sm">Dark Mode</span>
                      <input
                        type="checkbox"
                        checked={darkMode}
                        onChange={e => setDarkMode(e.target.checked)}
                        className="w-5 h-5"
                      />
                    </label>

                    <label className="flex items-center justify-between py-2">
                      <span className="text-sm">Keep Screen On</span>
                      <input
                        type="checkbox"
                        checked={keepScreenOn}
                        onChange={e => setKeepScreenOn(e.target.checked)}
                        className="w-5 h-5"
                      />
                    </label>
                  </div>
                </div>

                {/* GAME INFO - Endast multiplayer */}
                {isMultiplayer && (
                  <div className="mb-6">
                    <h4 className={`text-sm font-semibold mb-3 pb-2 border-b ${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-200 text-gray-700'}`}>
                      Game Info
                    </h4>

                    <div className="space-y-3">
                      {/* Match Code - DÃ¶lj fÃ¶r viewers */}
                      {!isViewer && (
                        <div>
                          <label className="block text-xs mb-1 opacity-75">Match Code</label>
                          <div className="flex gap-2">
                            <input
                              type="text"
                              value={matchCode}
                              readOnly
                              className={`flex-1 px-3 py-2 border rounded font-mono text-center font-bold ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-gray-50 border-gray-300'}`}
                            />
                            <button
                              onClick={copyCode}
                              className={`px-4 py-2 rounded font-semibold whitespace-nowrap ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-600 hover:bg-blue-700'} text-white`}
                            >
                              Copy
                            </button>
                          </div>
                        </div>
                      )}

                      {/* Viewer Link - DÃ¶lj fÃ¶r viewers */}
                      {!isViewer && (
                        <div>
                          <label className="block text-xs mb-1 opacity-75">Viewer Link</label>
                          <div className="flex gap-2">
                            <input
                              type="text"
                              value={`${window.location.origin}${window.location.pathname}?join=${matchCode}-V`}
                              readOnly
                              className={`flex-1 px-3 py-2 border rounded font-mono text-xs ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-gray-50 border-gray-300'}`}
                            />
                            <button
                              onClick={() => {
                                const viewerLink = `${window.location.origin}${window.location.pathname}?join=${matchCode}-V`;
                                navigator.clipboard.writeText(viewerLink).then(() => {
                                  alert('Viewer link copied!');
                                }).catch(() => {
                                  alert('Failed to copy');
                                });
                              }}
                              className={`px-4 py-2 rounded font-semibold whitespace-nowrap ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-600 hover:bg-blue-700'} text-white`}
                            >
                              Copy
                            </button>
                          </div>
                        </div>
                      )}

                      {/* Connected Users */}
                      <div className={`${darkMode ? 'bg-gray-800' : 'bg-gray-50'} rounded p-3 text-sm`}>
                        <div className="flex items-center justify-between">
                          <span className="opacity-75">Connected Editors:</span>
                          <span className="font-bold">ðŸ‘¥ {connectedUsers}</span>
                        </div>
                        {viewerCount > 0 && (
                          <div className="flex items-center justify-between mt-1">
                            <span className="opacity-75">Viewers:</span>
                            <span className="font-bold">ðŸ‘ï¸ {viewerCount}</span>
                          </div>
                        )}
                      </div>

                      {/* End Game - endast creator */}
                      {!matchEnded && isCreator && !isViewer && (
                        <button
                          onClick={endMatch}
                          className="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded font-semibold"
                        >
                          End Game for All Users
                        </button>
                      )}
                    </div>
                  </div>
                )}

                {/* TEAM SETTINGS - Endast editors */}
                {!isViewer && (
                  <div className="mb-6">
                    <h4 className={`text-sm font-semibold mb-3 pb-2 border-b ${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-200 text-gray-700'}`}>
                      Team Settings
                    </h4>

                    <div className="space-y-3">
                      <div>
                        <label className="block text-xs mb-1 opacity-75">Home Team</label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={homeName}
                            onChange={e => { setHomeName(e.target.value); if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ homeName: e.target.value }) }}
                            disabled={matchEnded || isViewer}
                            className={`flex-1 px-3 py-2 border rounded ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                          />
                          <button
                            onClick={() => setHomeName('')}
                            disabled={matchEnded || isViewer}
                            className={`px-3 py-2 rounded ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                          >
                            Clear
                          </button>
                        </div>
                      </div>

                      <div>
                        <label className="block text-xs mb-1 opacity-75">Away Team</label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={awayName}
                            onChange={e => { setAwayName(e.target.value); if (isMultiplayer && matchRef.current && !matchEnded) matchRef.current.update({ awayName: e.target.value }) }}
                            disabled={matchEnded || isViewer}
                            className={`flex-1 px-3 py-2 border rounded ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                          />
                          <button
                            onClick={() => setAwayName('')}
                            disabled={matchEnded || isViewer}
                            className={`px-3 py-2 rounded ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                          >
                            Clear
                          </button>
                        </div>
                      </div>

                      <button
                        onClick={resetCounters}
                        disabled={matchEnded || isViewer}
                        className={`w-full ${darkMode ? 'bg-gray-800 hover:bg-gray-700 border border-gray-600 text-red-400' : 'bg-white hover:bg-gray-50 border border-red-300 text-red-600'} py-2 rounded font-semibold`}
                      >
                        Reset All Stats
                      </button>
                    </div>
                  </div>
                )}

                {/* CONTENT - Endast fÃ¶r editors (dÃ¶lj fÃ¶r viewers) */}
                {!isViewer && (
                  <div className="mb-6">
                    <h4 className={`text-sm font-semibold mb-3 pb-2 border-b ${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-200 text-gray-700'}`}>
                      Content
                    </h4>

                    <div className="space-y-3">
                      <div>
                        <label className="block text-xs mb-1 opacity-75">Spotify Playlist URL</label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={spotifyPlaylist}
                            onChange={e => { setSpotifyPlaylist(e.target.value); setSpotifyLoaded(false) }}
                            placeholder="https://open.spotify.com/playlist/..."
                            className={`flex-1 px-3 py-2 border rounded text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                          />
                          <button
                            onClick={() => { setSpotifyPlaylist('https://open.spotify.com/playlist/3HunXm4QT4dxcOz6eAljak?si=mKiXLeNMQM6ioJivpWP-EQ&pi=lAZXLD_QSPmpq'); setSpotifyLoaded(false) }}
                            className={`px-3 py-2 rounded text-sm whitespace-nowrap ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'}`}
                          >
                            Default
                          </button>
                        </div>
                      </div>

                      <div>
                        <label className="block text-xs mb-1 opacity-75">External Link Title</label>
                        <input
                          type="text"
                          value={externalLinkTitle}
                          onChange={e => setExternalLinkTitle(e.target.value)}
                          placeholder="Club Rules"
                          className={`w-full px-3 py-2 border rounded text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                        />
                      </div>

                      <div>
                        <label className="block text-xs mb-1 opacity-75">External Link URL</label>
                        <input
                          type="text"
                          value={externalLinkUrl}
                          onChange={e => setExternalLinkUrl(e.target.value)}
                          placeholder="https://..."
                          className={`w-full px-3 py-2 border rounded text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                        />
                      </div>

                      <div>
                        <label className="block text-xs mb-1 opacity-75">Default Home Roster</label>
                        <input
                          type="text"
                          inputMode="decimal"
                          value={defaultHomeRoster}
                          onChange={e => setDefaultHomeRoster(e.target.value)}
                          placeholder="e.g. 2,3,4,7,9"
                          className={`w-full px-3 py-2 border rounded text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'border-gray-300'}`}
                        />
                        <p className={`text-xs mt-1 opacity-60`}>
                          Comma or space separated player numbers
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {/* ACCOUNT - LÃ¤ngst ner */}
                {currentUser && (
                  <div className={`pt-4 border-t ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                    <button
                      onClick={async () => {
                        if (window.confirm('Sign out from your account?')) {
                          await auth.signOut();
                          setShowSettings(false);
                          setScreen('start');
                        }
                      }}
                      className={`w-full ${darkMode ? 'bg-gray-800 hover:bg-gray-700 text-red-400' : 'bg-gray-100 hover:bg-gray-200 text-red-600'} py-2 rounded font-semibold text-sm`}
                    >
                      Sign Out
                    </button>
                  </div>
                )}

                {/* Close knapp lÃ¤ngst ner */}
                <div className="pt-4 mt-4 border-t border-gray-600">
                  <button
                    onClick={() => setShowSettings(false)}
                    className={`w-full ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300'} py-2 rounded font-semibold`}
                  >
                    Close
                  </button>
                </div>
              </div>}

              <div className="grid grid-cols-2 gap-2 mb-2">
                {[
                  { name: homeName, score: totals.homeScore, saves: totals.homeSaves, team: 'home' },
                  { name: awayName, score: totals.awayScore, saves: totals.awaySaves, team: 'away' }
                ].map((tm, idx) => {
                  const currentPeriodScore = periodStats[currentPeriod]?.[tm.team + 'Score'] ?? 0;
                  return (
                    <div key={idx} className={`${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-white bg-opacity-10'} rounded-lg p-3`}>
                      <div className="text-sm font-semibold mb-3 text-left">{tm.name}</div>

                      <div>
                        <div className="text-sm mb-2 text-center">
                          <span className="opacity-50">Period {currentPeriod}</span>
                          <span className="opacity-30 mx-1">Â·</span>
                          <span className="font-semibold">{currentPeriodScore} {currentPeriodScore === 1 ? 'goal' : 'goals'}</span>
                        </div>
                        <div className="flex items-center justify-center gap-3 mb-2">
                          <button onClick={() => updateStat(tm.team, 'Score', -1)} disabled={matchEnded || isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold hover:bg-opacity-30">âˆ’</button>
                          <div className={`text-4xl font-bold min-w-[3rem] text-center ${sparkleStats[`${tm.team}Score${currentPeriod}`] ? 'sparkle' : ''}`}>
                            {tm.score}
                          </div>
                          <button onClick={() => updateStat(tm.team, 'Score', 1)} disabled={matchEnded || isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold hover:bg-opacity-30">+</button>
                        </div>
                        <div className="text-xs opacity-75 text-center">
                          ({Object.keys(periodStats).sort((a, b) => parseInt(a) - parseInt(b)).map((p, i, arr) => <span key={p} className={parseInt(p) === currentPeriod ? 'font-bold underline' : ''}>{periodStats[p][tm.team + 'Score']}{i < arr.length - 1 ? '-' : ''}</span>)})
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              {!statsCollapsed && (
                <div className="grid grid-cols-2 gap-2 mb-2">
                  {[
                    { saves: totals.homeSaves, team: 'home' },
                    { saves: totals.awaySaves, team: 'away' }
                  ].map((tm, idx) => {
                    const currentPeriodSaves = periodStats[currentPeriod]?.[tm.team + 'Saves'] ?? 0;
                    return (
                      <div key={idx} className={`${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-white bg-opacity-10'} rounded-lg p-3`}>
                        <div className="text-sm mb-2 text-center">
                          <span className="opacity-50">Period {currentPeriod}</span>
                          <span className="opacity-30 mx-1">Â·</span>
                          <span className="font-semibold">{currentPeriodSaves} {currentPeriodSaves === 1 ? 'save' : 'saves'}</span>
                        </div>
                        <div className="flex items-center justify-center gap-3 mb-2">
                          <button onClick={() => updateStat(tm.team, 'Saves', -1)} disabled={matchEnded || isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold hover:bg-opacity-30">âˆ’</button>
                          <div className={`text-4xl font-bold min-w-[3rem] text-center ${sparkleStats[`${tm.team}Saves${currentPeriod}`] ? 'sparkle' : ''}`}>
                            {tm.saves}
                          </div>
                          <button onClick={() => updateStat(tm.team, 'Saves', 1)} disabled={matchEnded || isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold hover:bg-opacity-30">+</button>
                        </div>
                        <div className="text-xs opacity-75 text-center">
                          ({Object.keys(periodStats).sort((a, b) => parseInt(a) - parseInt(b)).map((p, i, arr) => <span key={p} className={parseInt(p) === currentPeriod ? 'font-bold underline' : ''}>{periodStats[p][tm.team + 'Saves']}{i < arr.length - 1 ? '-' : ''}</span>)})
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              <div className="grid grid-cols-2 gap-2">
                {!isViewer && <button onClick={() => { setFocusMode('home'); setActiveTab('stats') }} className={`${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-500 bg-opacity-80 hover:bg-opacity-100'} py-2 rounded text-sm font-semibold`}>â›¶ Goalie Focus</button>}
                {!isViewer && <button onClick={() => setShowPlayerStats(true)} className={`${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-500 bg-opacity-80 hover:bg-opacity-100'} py-2 rounded text-sm font-semibold`}>â›¶ Skater Focus</button>}
              </div>
            </div>
          </div>


          {!isViewer && (
            <div className={`${darkMode ? 'bg-gray-800 border-b border-gray-700' : 'bg-white'} shadow-md sticky top-48 z-40`}>
              <div className="max-w-6xl mx-auto flex">
                {['stats', 'timeline', 'audio', 'referee', ...(externalLinkUrl ? ['external'] : [])].map(tab => (
                  <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-3 font-semibold text-sm ${activeTab === tab ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white') : (darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600')}`}>
                    {tab === 'audio' ? 'Audio' : tab === 'stats' ? 'Stats' : tab === 'timeline' ? 'Timeline' : tab === 'referee' ? 'Referee' : externalLinkTitle || 'Link'}
                  </button>
                ))}
              </div>
            </div>
          )}



          {activeTab === 'timeline' && <div className="max-w-6xl mx-auto p-2 sm:p-4">
            {/* Timeline Content */}
            {(() => {
              // SVG Icon Components
              const GoalIcon = () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M15 12H21" />
                  <path d="M22 6L20 8" />
                  <path d="M22 18L20 16" />
                </svg>
              );

              const GameEndedIcon = () => (
                <svg width="24" height="24" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <g className="opacity-80">
                    <path fill="currentColor" d="M470.253,247.982c0-3.256,0-56.453,0-69.438c0-12.985-8.47-25.958-21.645-25.958
		c-4.324,0-23.808-47.615-23.808-47.615s2.186,5.406-2.162-20.552c-4.313-25.993-62.75-72.516-72.492-77.921
		c-9.742-5.417-18.39-1.081-18.39,3.243c0,4.325,0,17.298,0,17.298h-28.132V17.19c0-9.48-7.698-17.19-17.19-17.19h-30.425h-30.436
		c-9.48,0-17.178,7.71-17.178,17.19v9.849h-28.132c0,0,0-12.973,0-17.298c0-4.324-8.66-8.66-18.39-3.243
		c-9.742,5.405-68.179,51.928-72.504,77.921c-4.336,25.958-2.162,20.552-2.162,20.552s-8.542,20.874-15.575,34.974h224.412v12.641
		H63.391c-13.152,0-21.645,12.972-21.645,25.958c0,12.985,0,66.182,0,69.438c0,3.231-6.712,118.454,76.648,201.804
		c34.619,34.618,86.546,54.813,127.876,62.214h19.482c41.318-7.401,93.257-27.596,127.875-62.214
		C476.977,366.436,470.253,251.212,470.253,247.982z M206.235,102.797c0,4.776-3.886,8.66-8.649,8.66
		c-4.799,0-8.672-3.884-8.672-8.66V76.828c0-4.776,3.873-8.649,8.672-8.649c4.764,0,8.649,3.873,8.649,8.649V102.797z
		 M130.299,422.509c-16.525-21.241-27.015-43.92-33.098-61.039h33.098V422.509z M130.299,349.305H93.304
		c-2.233-7.817-3.219-13.259-3.219-14.933v-47.924h40.214V349.305z M130.299,274.284H90.085v-27.918
		c0-9.575,7.758-17.333,17.32-17.333h22.894V274.284z M133.731,200.189h-25.97c-4.776,0-8.66-3.886-8.66-8.66
		c0-4.776,3.884-8.637,8.66-8.637h25.97c4.787,0,8.66,3.861,8.66,8.637C142.392,196.303,138.519,200.189,133.731,200.189z
		 M210.047,478.107c-28.369-8.209-50.478-23.665-67.584-41.52v-0.095h67.584V478.107z M210.047,424.327h-67.584V361.47h67.584
		V424.327z M210.047,349.305h-67.584v-62.857h67.584V349.305z M210.047,274.284h-67.584v-45.25h67.584V274.284z M289.798,481.124
		c-10.478,2.103-21.705,3.28-33.787,3.28c-12.081,0-23.319-1.188-33.798-3.315v-44.597h67.585V481.124z M289.798,424.327h-67.585
		V361.47h67.585V424.327z M289.798,349.305h-67.585v-62.857h67.585V349.305z M289.798,274.284h-67.585v-45.25h67.585V274.284z
		 M305.787,76.828c0-4.776,3.873-8.649,8.649-8.649c4.776,0,8.672,3.873,8.672,8.649v25.969c0,4.776-3.896,8.66-8.672,8.66
		c0-4.776-3.896-8.649-3.896-8.649V76.828z M369.548,437.098c-17.072,17.701-39.169,33.002-67.585,41.116v-41.722h67.585V437.098z
		 M369.548,424.327h-67.585V361.47h67.585V424.327z M369.548,349.305h-67.585v-62.857h67.585V349.305z M369.548,274.284h-67.585
		v-45.25h67.585V274.284z M369.631,191.528c0-4.776,3.861-8.637,8.648-8.637h25.97c4.776,0,8.648,3.861,8.648,8.637
		c0,4.775-3.872,8.66-8.648,8.66h-25.97C373.492,200.189,369.631,196.303,369.631,191.528z M381.713,423.078V361.47h33.252
		C408.93,378.743,398.44,401.684,381.713,423.078z M421.925,334.372c0,1.674-0.95,7.116-3.136,14.933h-37.076v-62.857h40.212
		V334.372z M421.925,274.284h-40.212v-45.25h22.904c9.563,0,17.308,7.758,17.308,17.333V274.284z"/>
                  </g>
                </svg>
              );

              const PenaltyIcon = () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <rect x="4" y="4" width="16" height="16" rx="2" />
                  <path d="M12 8 L12 12 M12 16 L12 16" />
                </svg>
              );

              const GoalieSwitchIcon = () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <circle cx="12" cy="8" r="3" />
                  <path d="M8 14 L8 22 M16 14 L16 22 M8 14 L16 14" />
                </svg>
              );

              const TimeoutIcon = () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <rect x="6" y="4" width="4" height="16" />
                  <rect x="14" y="4" width="4" height="16" />
                </svg>
              );

              const WhistleIcon = () => (
                <svg width="24" height="24" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path fill="currentColor" d="M93.75 81.443c-5.38 0-12.368 2.49-22.358 8.967 3.966 4.682 8.167 9.687 16.47 19.256 5.782 6.663 11.618 13.29 16.026 18.088.038.042.055.055.092.096l30.894-17.932-14.652-14.148c-11.292-9.404-18.644-13.866-25.418-14.293-.345-.022-.696-.034-1.055-.034zm120.08 15.082c-.885-.01-1.767-.006-2.643.01-10.46.193-20.2 2.23-26.742 5.424l-67.262 39.038c2.45.544 4.885 1.196 7.287 2.02 17.275 5.923 33.093 18.223 49.568 34.7l216.44 213.5 80.978-44.433L258.54 111.38c-8.656-7.84-22.49-12.908-36.693-14.394-2.677-.28-5.363-.43-8.018-.46zM58.192 102.74c-17.543 20.723-20.57 37.186-15.326 57.004.692 2.618 3.057 6.357 6.373 10.47 2.195-3.144 4.55-6.304 7.086-9.478 3.99-4.995 8.385-9.183 13.085-12.558l-.106-.2 2.768-1.61c1.354-.862 2.73-1.66 4.13-2.393l11.868-6.89c-4.175-4.618-8.94-10.017-13.803-15.622-5.956-6.864-11.732-13.62-16.074-18.723zm184.093 13.438l58.415 61.67c-46.086-5.037-56.79 13.2-69.027 34.2l-57.334-59.304 67.946-36.566zM103.702 157.23c-.714-.016-1.43-.016-2.15.002-6.976.18-14.207 2.058-22.252 5.885-3.035 2.29-5.99 5.196-8.91 8.852-25.77 32.264-30.45 59.135-25.484 83.477 4.965 24.343 20.536 46.656 37.916 66.455 13.314 15.168 28.86 23.992 48.472 27.93 19.614 3.94 43.438 2.708 71.98-3.475 33.246-7.2 66.01 8.42 95.81 27.665 26.118 16.868 50.676 37.09 70.98 49.95l8.79-18.935-217.52-214.57-.022-.022c-15.524-15.524-29.565-25.905-42.682-30.402-5.02-1.722-9.925-2.695-14.928-2.813zm367.08 210.456l-73.45 40.304-10.48 22.567 70.833-38.41 13.096-24.46z" className="opacity-80" />
                </svg>
              );

              // Combine all events with type
              const allEvents = [
                ...goalEvents.map(e => ({ ...e, type: 'goal' })),
                ...penaltyEvents.map(e => ({ ...e, type: 'penalty' })),
                ...otherEvents.map(e => ({ ...e, type: 'other' }))
              ];

              // Sort by period (ascending) then by time (DESCENDING for reverse chronological order - latest first)
              allEvents.sort((a, b) => {
                if (a.period !== b.period) return a.period - b.period;
                // Sort by time if available, otherwise by timestamp - REVERSED
                if (a.time && b.time) {
                  // Parse time format "12:34" to minutes for comparison
                  const parseTime = (timeStr) => {
                    if (!timeStr) return 0;
                    const [min, sec] = timeStr.split(':').map(Number);
                    return (min || 0) * 60 + (sec || 0);
                  };
                  return parseTime(b.time) - parseTime(a.time); // REVERSED
                }
                return b.timestamp - a.timestamp; // REVERSED
              });

              // Group by period
              const eventsByPeriod = {};
              allEvents.forEach(event => {
                if (!eventsByPeriod[event.period]) {
                  eventsByPeriod[event.period] = [];
                }
                eventsByPeriod[event.period].push(event);
              });

              const periods = Object.keys(eventsByPeriod).map(Number).sort((a, b) => b - a);

              if (allEvents.length === 0) {
                return (
                  <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-4 sm:p-8 text-center`}>
                    <p className={`${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>No events recorded yet</p>
                  </div>
                );
              }

              const toggleEventExpanded = (eventId) => {
                setExpandedEvents(prev => ({
                  ...prev,
                  [eventId]: !prev[eventId]
                }));
              };

              const getEventIcon = (type, eventType) => {
                if (type === 'goal') return <GoalIcon />;
                if (type === 'penalty') return <PenaltyIcon />;
                if (type === 'other') {
                  if (eventType === 'timeout') return <TimeoutIcon />;
                  if (eventType === 'goalieSwitch' || eventType === 'gkOut' || eventType === 'gkIn') return <GoalieSwitchIcon />;
                }
                return <GoalIcon />;
              };

              const getEventLabel = (event) => {
                if (event.type === 'goal') return 'GOAL';
                if (event.type === 'penalty') return `${event.penaltyType.replace("'", " min")} Penalty`;
                if (event.type === 'other') {
                  if (event.eventType === 'timeout') return 'Time-Out';
                  if (event.eventType === 'goalieSwitch') return 'Goalie Switch';
                  if (event.eventType === 'gkOut') return 'GK Out';
                  if (event.eventType === 'gkIn') return 'GK In';
                }
                return 'Event';
              };

              const hasDetails = (event) => {
                if (event.type === 'goal') {
                  return (event.scorers?.length > 0 || event.assists?.length > 0 || event.plus?.length > 0 || event.minus?.length > 0);
                }
                if (event.type === 'penalty') {
                  return (event.player || event.infraction);
                }
                return false;
              };

              return (
                <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-3 sm:p-6`}>
                  {/* Game Ended Marker (Top of Timeline) */}
                  {matchEnded && (
                    <div className="mb-6 sm:mb-8 relative">
                      <div className={`absolute left-1/2 top-0 bottom-0 w-0.5 ${darkMode ? 'bg-gray-600' : 'bg-gray-300'} transform -translate-x-1/2`}></div>
                      <div className="relative z-10 flex flex-col items-center justify-center">
                        <div className={`w-12 h-12 rounded-full ${darkMode ? 'bg-gray-800 border-2 border-gray-600' : 'bg-white border-2 border-gray-300'} flex items-center justify-center mb-2 shadow-sm`}>
                          <GameEndedIcon />
                        </div>

                        {/* Game Ended Text - Absolute positioned to the right of the icon */}
                        <div className={`absolute left-1/2 ml-8 whitespace-nowrap font-bold text-sm tracking-wider ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                          GAME ENDED {totals.homeScore} - {totals.awayScore}
                        </div>
                      </div>
                    </div>
                  )}

                  {periods.map((period, pIndex) => (
                    <div key={period} className="mb-6 sm:mb-8">
                      {/* Timeline with center line - REVERSED: events at top, period marker at bottom */}
                      <div className="relative">
                        {/* Center vertical line */}
                        <div className={`absolute left-1/2 top-0 bottom-8 w-0.5 ${darkMode ? 'bg-gray-600' : 'bg-gray-300'} transform -translate-x-1/2`}></div>

                        {/* Events - now at the TOP */}
                        <div className="space-y-4 sm:space-y-6 mb-6">
                          {eventsByPeriod[period].map((event, idx) => {
                            const eventId = `${event.type}-${event.timestamp}-${idx}`;
                            const isExpanded = expandedEvents[eventId];
                            const teamName = event.team === 'home' ? homeName : awayName;
                            const isHome = event.team === 'home';
                            const canExpand = hasDetails(event);

                            // Calculate score at this point for goal events
                            let scoreText = '';
                            if (event.type === 'goal') {
                              const eventIndex = goalEvents.findIndex(e => e.timestamp === event.timestamp);
                              const homeGoals = goalEvents.slice(0, eventIndex + 1).filter(e => e.team === 'home').length;
                              const awayGoals = goalEvents.slice(0, eventIndex + 1).filter(e => e.team === 'away').length;
                              scoreText = `${homeGoals}-${awayGoals}`;
                            }

                            return (
                              <div key={eventId} className="relative w-full">
                                {/* Event positioned left (Home) or right (Away) */}
                                <div className={`flex items-center w-1/2 ${isHome ? 'mr-auto justify-end pr-4 sm:pr-8' : 'ml-auto justify-start pl-4 sm:pl-8'}`}>
                                  <div className={`w-full ${isHome ? 'text-right' : 'text-left'}`}>
                                    <div
                                      className={`${darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-gray-50 border border-gray-200'} rounded-lg p-2 shadow-sm transition-all ${canExpand ? 'cursor-pointer hover:shadow-md' : ''} inline-block w-auto max-w-[200px] sm:max-w-[240px] relative z-20 text-left`}
                                      onClick={() => canExpand && toggleEventExpanded(eventId)}
                                    >
                                      {/* Compact view */}
                                      <div className="flex flex-col">
                                        {/* Top row: Time + Event Label */}
                                        <div className="flex items-baseline gap-2 mb-0.5">
                                          {/* Time */}
                                          {event.time && (
                                            <span className={`text-[10px] sm:text-xs font-mono ${darkMode ? 'text-gray-400' : 'text-gray-500'} flex-shrink-0`}>
                                              {event.time}
                                            </span>
                                          )}

                                          {/* Event Label */}
                                          <div className="font-semibold text-xs sm:text-sm truncate">
                                            {getEventLabel(event)}
                                            {event.type === 'goal' && scoreText && (
                                              <span className="ml-1 font-bold">{scoreText}</span>
                                            )}
                                          </div>
                                        </div>

                                        {/* Bottom row: Team Name (+ Situation) */}
                                        <div className={`text-[10px] sm:text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} truncate`}>
                                          {teamName}
                                          {event.type === 'goal' && event.situation && (
                                            <span className="ml-1">({event.situation})</span>
                                          )}
                                        </div>
                                      </div>

                                      {/* Expanded details */}
                                      {isExpanded && canExpand && (
                                        <div className={`mt-2 sm:mt-3 pt-2 sm:pt-3 border-t ${darkMode ? 'border-gray-600' : 'border-gray-200'} text-[10px] sm:text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                          {event.type === 'goal' && (
                                            <div className="space-y-1">
                                              {event.scorers && event.scorers.length > 0 && (
                                                <div><span className="font-semibold">G:</span> {event.scorers.map(id => id.split('-')[1]).join(', ')}</div>
                                              )}
                                              {event.assists && event.assists.length > 0 && (
                                                <div><span className="font-semibold">A:</span> {event.assists.map(id => id.split('-')[1]).join(', ')}</div>
                                              )}
                                              {event.plus && event.plus.length > 0 && (
                                                <div><span className="font-semibold">+:</span> {event.plus.map(id => id.split('-')[1]).join(', ')}</div>
                                              )}
                                              {event.minus && event.minus.length > 0 && (
                                                <div><span className="font-semibold">-:</span> {event.minus.map(id => id.split('-')[1]).join(', ')}</div>
                                              )}
                                            </div>
                                          )}

                                          {event.type === 'penalty' && (
                                            <div className="space-y-1">
                                              {event.player && (
                                                <div><span className="font-semibold">Player:</span> {event.player === 'BENCH' ? 'Bench' : event.player}</div>
                                              )}
                                              {event.infraction && (
                                                <div><span className="font-semibold">Infraction:</span> {event.infraction}</div>
                                              )}
                                            </div>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>

                                {/* Connecting line to center */}
                                <div className={`absolute top-1/2 ${isHome ? 'right-1/2 left-auto' : 'left-1/2 right-auto'} w-8 sm:w-16 h-0.5 ${darkMode ? 'bg-gray-600' : 'bg-gray-300'} transform -translate-y-1/2 z-0`}></div>

                                {/* Center dot */}
                                <div className={`absolute top-1/2 left-1/2 w-2 h-2 sm:w-3 sm:h-3 rounded-full ${darkMode ? 'bg-gray-500' : 'bg-gray-400'} transform -translate-x-1/2 -translate-y-1/2 z-10`}></div>
                              </div>
                            );
                          })}
                        </div>

                        {/* Period Marker at BOTTOM with whistle icon */}
                        <div className="relative flex items-center justify-center h-12">
                          {/* Whistle icon on the center line */}
                          <div className={`relative z-10 p-1.5 rounded-full border-2 ${darkMode ? 'bg-gray-800 border-gray-600 text-gray-300' : 'bg-white border-gray-300 text-gray-600'}`}>
                            <WhistleIcon />
                          </div>

                          {/* Period text TO THE SIDE of whistle */}
                          <div className={`absolute left-1/2 ml-8 whitespace-nowrap ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            <span className="font-bold text-sm sm:text-base tracking-wider uppercase">
                              {period <= 3 ? `Period ${period}` : 'Overtime'}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              );
            })()}
          </div>}


          <div className="max-w-6xl mx-auto p-4">
            {activeTab === 'audio' && <div>
              <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-4 mb-3`}>
                <h3 className={`text-sm font-semibold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Soundboard</h3>
                <div className="grid grid-cols-3 gap-3">
                  {/* Intro */}
                  <button
                    onClick={toggleIntro}
                    className={`p-3 rounded-lg font-semibold transition-colors flex flex-col items-center justify-center gap-1 ${introPlaying
                      ? (darkMode ? 'bg-green-700 text-white' : 'bg-green-600 text-white')
                      : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-800')
                      }`}
                  >
                    {introPlaying ? (
                      <>
                        <div className="flex items-end gap-0.5 h-4">
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                        </div>
                        <span className="text-xs">Stop</span>
                      </>
                    ) : (
                      <>
                        <span className="text-lg">â–¶</span>
                        <span className="text-xs">Intro</span>
                      </>
                    )}
                  </button>

                  {/* Goal */}
                  <button
                    onClick={() => playingSound === 'homeGoal' ? stopAllSounds() : playSound('homeGoal')}
                    className={`p-3 rounded-lg font-semibold transition-colors flex flex-col items-center justify-center gap-1 ${playingSound === 'homeGoal'
                      ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
                      : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-800')
                      }`}
                  >
                    {playingSound === 'homeGoal' ? (
                      <>
                        <div className="flex items-end gap-0.5 h-4">
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                        </div>
                        <span className="text-xs">Stop</span>
                      </>
                    ) : (
                      <>
                        <span className="text-lg">ðŸš¨</span>
                        <span className="text-xs">Goal</span>
                      </>
                    )}
                  </button>

                  {/* Penalty */}
                  <button
                    onClick={() => playingSound === 'awayPenalty' ? stopAllSounds() : playSound('awayPenalty')}
                    className={`p-3 rounded-lg font-semibold transition-colors flex flex-col items-center justify-center gap-1 ${playingSound === 'awayPenalty'
                      ? (darkMode ? 'bg-orange-700 text-white' : 'bg-orange-600 text-white')
                      : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-800')
                      }`}
                  >
                    {playingSound === 'awayPenalty' ? (
                      <>
                        <div className="flex items-end gap-0.5 h-4">
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                        </div>
                        <span className="text-xs">Stop</span>
                      </>
                    ) : (
                      <>
                        <span className="text-lg">ðŸš”</span>
                        <span className="text-xs">Penalty</span>
                      </>
                    )}
                  </button>
                </div>
              </div>

              <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-3`}>
                {!spotifyLoaded && !spotifyLoading ? <button onClick={loadSpotify} className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-600 hover:bg-gray-700'} text-white py-8 rounded-lg font-semibold text-lg transition-colors`}>Load Spotify</button> : spotifyLoading ? <div className={`py-8 text-center ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}><div className="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-2"></div><div>Loading...</div></div> : <div style={{ opacity: 0, animation: 'fadeIn 0.5s ease-in forwards' }}>
                  {spotifyFallback || !getSpotifyUrl(spotifyPlaylist) ? (
                    <div className={`text-center py-8`}>
                      <a
                        href={spotifyPlaylist}
                        target="_blank"
                        rel="noopener noreferrer"
                        className={`inline-block ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-600 hover:bg-gray-700'} text-white px-6 py-3 rounded-lg font-semibold transition-colors`}
                      >
                        Open Spotify in new window â†’
                      </a>
                    </div>
                  ) : (
                    <div>
                      <iframe
                        style={{ borderRadius: '12px' }}
                        src={getSpotifyUrl(spotifyPlaylist)}
                        width="100%"
                        height="352"
                        frameBorder="0"
                        allowFullScreen=""
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                        loading="lazy"
                        onError={() => setSpotifyFallback(true)}
                        title="Spotify Playlist"
                      ></iframe>
                      <div className={`text-center mt-3 text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        <button onClick={() => setSpotifyFallback(true)} className={`${darkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-800'} underline`}>
                          Show direct link to playlist instead
                        </button>
                      </div>
                    </div>
                  )}
                </div>}
              </div>

            </div>}

            {activeTab === 'stats' && <div>
              {Object.keys(periodStats).sort((a, b) => parseInt(a) - parseInt(b)).map(p => {
                p = parseInt(p);
                const ps = periodStats[p];

                const renderTeamStats = (team) => {
                  const isHome = team === 'home';
                  const name = isHome ? homeName : awayName;
                  const score = ps[team + 'Score'];
                  const saves = ps[team + 'Saves'];
                  const oppTeam = isHome ? 'away' : 'home';
                  const oppScore = ps[oppTeam + 'Score'];
                  const shotsFor = ps[oppTeam + 'Saves'] + score;
                  const shotsAgainst = saves + oppScore;
                  const color = darkMode ? (isHome ? 'bg-blue-900 bg-opacity-30 border-blue-700' : 'bg-red-900 bg-opacity-30 border-red-700') : (isHome ? 'bg-blue-50' : 'bg-red-50');

                  return (
                    <div className={`${color} ${darkMode ? 'border' : ''} rounded p-3`}>
                      <div className={`font-semibold mb-2 ${darkMode ? 'text-white' : ''}`}>{name}</div>
                      <div className={`text-sm space-y-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        <div className="flex justify-between"><span>Goals:</span><span className="font-bold">{score}</span></div>
                        <div className="flex justify-between"><span>SOG:</span><span className="font-bold">{shotsFor}</span></div>
                        <div className="flex justify-between"><span>Saves:</span><span className="font-bold">{saves}</span></div>
                        <div className="flex justify-between"><span>SA:</span><span className="font-bold">{shotsAgainst}</span></div>
                        <div className="flex justify-between border-t pt-1"><span>SVS %:</span><span className="font-bold">{calcSP(saves, oppScore)}%</span></div>
                      </div>
                    </div>
                  );
                };

                return (
                  <div key={p} className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-4 mb-4`}>
                    <div className="flex justify-between items-center mb-3">
                      <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : ''}`}>{p <= 3 ? `Period ${p}` : `OT`}</h3>
                      {currentPeriod === p && <span className="bg-yellow-400 text-blue-900 px-3 py-1 rounded text-sm font-bold">Current</span>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      {renderTeamStats('home')}
                      {renderTeamStats('away')}
                    </div>

                    {(playerStats.home?.players || playerStats.away?.players) && (() => {
                      const homePlayers = playerStats.home?.players || {};
                      const awayPlayers = playerStats.away?.players || {};
                      const hasPlayersWithData = Object.keys(homePlayers).some(pNum => homePlayers[pNum]?.periods?.[p]) ||
                        Object.keys(awayPlayers).some(pNum => awayPlayers[pNum]?.periods?.[p]);

                      if (!hasPlayersWithData) return null;

                      return (
                        <div className="mt-4 pt-4 border-t">
                          <button
                            onClick={() => setExpandedPlayerStats(prev => ({ ...prev, [p]: !prev[p] }))}
                            className={`w-full text-left font-semibold text-sm ${darkMode ? 'bg-gray-700 text-gray-200' : 'bg-gray-100 text-gray-800'} px-3 py-2 rounded flex items-center justify-between`}
                          >
                            <span>Player Statistics</span>

                            <span>{expandedPlayerStats[p] ? <IconChevronUp /> : <IconChevronDown />}</span>
                          </button>

                          {expandedPlayerStats[p] && (
                            <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                              {['home', 'away'].map(team => {
                                const teamName = team === 'home' ? homeName : awayName;
                                const players = playerStats[team]?.players || {};
                                const playerNums = Object.keys(players)
                                  .filter(pNum => {
                                    // Visa spelare om de har stats ELLER penalties fÃ¶r denna period
                                    const hasStats = players[pNum]?.periods?.[p];
                                    const hasPenalties = penaltyEvents.some(e =>
                                      e.team === team &&
                                      e.player === pNum &&
                                      e.period === parseInt(p)
                                    );
                                    return hasStats || hasPenalties;
                                  })
                                  .sort((a, b) => parseInt(a) - parseInt(b));

                                if (playerNums.length === 0) return null;

                                return (
                                  <div key={team} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded p-3`}>
                                    <div className={`font-semibold mb-2 ${darkMode ? 'text-white' : ''}`}>{teamName}</div>
                                    <div className="overflow-x-auto">
                                      <table className="w-full text-xs">
                                        <thead>
                                          <tr className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>
                                            <th className="text-left px-2 py-2 font-semibold">#</th>
                                            <th className="text-center px-2 py-2 font-semibold">G</th>
                                            <th className="text-center px-2 py-2 font-semibold">A</th>
                                            <th className="text-center px-2 py-2 font-semibold">+/-</th>
                                            <th className="text-center px-2 py-2 font-semibold">FO</th>
                                            <th className="text-center px-2 py-2 font-semibold">FO%</th>
                                            <th className="text-center px-2 py-2 font-semibold">SOG</th>
                                            <th className="text-center px-2 py-2 font-semibold">PIM</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {playerNums.map(pNum => {
                                            const pStats = players[pNum].periods[p];
                                            const pim = calculatePIMFromEvents(team, pNum, parseInt(p));
                                            const onIcePlus = pStats?.['OnIce+'] || 0;
                                            const onIceMinus = pStats?.['OnIce-'] || 0;
                                            const plusMinus = onIcePlus - onIceMinus;
                                            const foPlus = pStats?.['FO+'] || 0;
                                            const foMinus = pStats?.['FO-'] || 0;
                                            const foTotal = foPlus + foMinus;
                                            const foPct = foTotal === 0 ? '-' : ((foPlus / foTotal) * 100).toFixed(0);
                                            return (
                                              <tr key={pNum} className={`border-t ${darkMode ? 'border-gray-600' : 'border-gray-200'} text-sm`}>
                                                <td className="font-bold px-2 py-2">{pNum}</td>
                                                <td className="text-center px-2 py-2">{pStats?.['G'] || 0}</td>
                                                <td className="text-center px-2 py-2">{pStats?.['A'] || 0}</td>
                                                <td className="text-center px-2 py-2 font-semibold">
                                                  {plusMinus === 0 ? '0' : `${plusMinus > 0 ? '+' : ''}${plusMinus}`}
                                                </td>
                                                <td className="text-center px-2 py-2">{foTotal}</td>
                                                <td className="text-center px-2 py-2 font-semibold">{foPct}{foPct !== '-' ? '%' : ''}</td>
                                                <td className="text-center px-2 py-2">{pStats?.['SOG'] || 0}</td>
                                                <td className="text-center px-2 py-2">{pim}</td>
                                              </tr>
                                            );
                                          })}
                                          {/* TOTAL ROW */}
                                          {(() => {
                                            let totalG = 0, totalA = 0, totalFO = 0, totalFOPlus = 0, totalSOG = 0, totalPIM = 0;
                                            playerNums.forEach(pNum => {
                                              const pStats = players[pNum].periods[p];
                                              totalG += pStats?.['G'] || 0;
                                              totalA += pStats?.['A'] || 0;
                                              totalFOPlus += pStats?.['FO+'] || 0;
                                              totalFO += (pStats?.['FO+'] || 0) + (pStats?.['FO-'] || 0);
                                              totalSOG += pStats?.['SOG'] || 0;
                                              totalPIM += calculatePIMFromEvents(team, pNum, parseInt(p));
                                            });
                                            const teamFOPct = totalFO === 0 ? '-' : ((totalFOPlus / totalFO) * 100).toFixed(0);
                                            return (
                                              <tr className={`border-t-2 ${darkMode ? 'border-gray-500 bg-gray-600' : 'border-gray-400 bg-gray-100'} text-sm font-bold`}>
                                                <td className="px-2 py-2">TOT</td>
                                                <td className="text-center px-2 py-2">{totalG}</td>
                                                <td className="text-center px-2 py-2">{totalA}</td>
                                                <td className="text-center px-2 py-2">-</td>
                                                <td className="text-center px-2 py-2">{totalFO}</td>
                                                <td className="text-center px-2 py-2">{teamFOPct}{teamFOPct !== '-' ? '%' : ''}</td>
                                                <td className="text-center px-2 py-2">{totalSOG}</td>
                                                <td className="text-center px-2 py-2">{totalPIM}</td>
                                              </tr>
                                            );
                                          })()}
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                );
              })}

              <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow p-4 mb-4`}>
                <div className="flex justify-between items-center mb-3">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : ''}`}>FINAL</h3>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  {['home', 'away'].map(team => {
                    const name = team === 'home' ? homeName : awayName;
                    const score = team === 'home' ? totals.homeScore : totals.awayScore;
                    const saves = team === 'home' ? totals.homeSaves : totals.awaySaves;
                    const oppTeam = team === 'home' ? 'away' : 'home';
                    const oppScore = team === 'home' ? totals.awayScore : totals.homeScore;
                    const shotsFor = (team === 'home' ? totals.awaySaves : totals.homeSaves) + score;
                    const shotsAgainst = saves + oppScore;
                    const color = darkMode ? (team === 'home' ? 'bg-blue-900 bg-opacity-30 border-blue-700' : 'bg-red-900 bg-opacity-30 border-red-700') : (team === 'home' ? 'bg-blue-50' : 'bg-red-50');

                    return (
                      <div key={team} className={`${color} ${darkMode ? 'border' : ''} rounded p-3`}>
                        <div className={`font-semibold mb-2 ${darkMode ? 'text-white' : ''}`}>{name}</div>
                        <div className={`text-sm space-y-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          <div className="flex justify-between"><span>Goals:</span><span className="font-bold text-lg">{score}</span></div>
                          <div className="flex justify-between"><span>SOG:</span><span className="font-bold">{shotsFor}</span></div>
                          <div className="flex justify-between"><span>Saves:</span><span className="font-bold">{saves}</span></div>
                          <div className="flex justify-between"><span>SA:</span><span className="font-bold">{shotsAgainst}</span></div>
                          <div className="flex justify-between border-t pt-1"><span>SVS %:</span><span className="font-bold">{calcSP(saves, oppScore)}%</span></div>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {(playerStats.home?.players || playerStats.away?.players) && (() => {
                  const homePlayers = playerStats.home?.players || {};
                  const awayPlayers = playerStats.away?.players || {};

                  if (Object.keys(homePlayers).length === 0 && Object.keys(awayPlayers).length === 0) return null;

                  return (
                    <div className="mt-4 pt-4 border-t">
                      <button
                        onClick={() => setExpandedPlayerStats(prev => ({ ...prev, total: !prev.total }))}
                        className={`w-full text-left font-semibold text-sm ${darkMode ? 'bg-gray-700 text-gray-200' : 'bg-gray-100 text-gray-800'} px-3 py-2 rounded flex items-center justify-between mb-3`}
                      >
                        <span>Total Player Statistics</span>
                        <span>{expandedPlayerStats.total ? <IconChevronUp /> : <IconChevronDown />}</span>
                      </button>

                      {expandedPlayerStats.total && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          {['home', 'away'].map(team => {
                            const teamName = team === 'home' ? homeName : awayName;
                            const players = playerStats[team]?.players || {};
                            const playerNums = Object.keys(players).sort((a, b) => parseInt(a) - parseInt(b));

                            if (playerNums.length === 0) return null;

                            return (
                              <div key={team} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded p-3`}>
                                <div className={`font-semibold mb-2 ${darkMode ? 'text-white' : ''}`}>{teamName}</div>
                                <div className="overflow-x-auto">
                                  <table className="w-full text-xs">
                                    <thead>
                                      <tr className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>
                                        <th className="text-left px-2 py-2 font-semibold">#</th>
                                        <th className="text-center px-2 py-2 font-semibold">G</th>
                                        <th className="text-center px-2 py-2 font-semibold">A</th>
                                        <th className="text-center px-2 py-2 font-semibold">+/-</th>
                                        <th className="text-center px-2 py-2 font-semibold">FO</th>
                                        <th className="text-center px-2 py-2 font-semibold">FO%</th>
                                        <th className="text-center px-2 py-2 font-semibold">SOG</th>
                                        <th className="text-center px-2 py-2 font-semibold">PIM</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {playerNums.map(pNum => {
                                        const pStats = players[pNum].total;
                                        const onIcePlus = pStats?.['OnIce+'] ?? 0;
                                        const onIceMinus = pStats?.['OnIce-'] ?? 0;
                                        const plusMinus = onIcePlus - onIceMinus;
                                        const foPlus = pStats?.['FO+'] ?? 0;
                                        const foMinus = pStats?.['FO-'] ?? 0;
                                        const foTotal = foPlus + foMinus;
                                        const foPct = foTotal === 0 ? '-' : ((foPlus / foTotal) * 100).toFixed(0);
                                        const pim = calculatePIMFromEvents(team, pNum);  // Ã„NDRAD RAD - null som period = alla perioder

                                        return (
                                          <tr key={pNum} className={`border-t ${darkMode ? 'border-gray-600' : 'border-gray-200'} text-sm`}>
                                            <td className="font-bold px-2 py-2">{pNum}</td>
                                            <td className="text-center px-2 py-2">{pStats?.['G'] || 0}</td>
                                            <td className="text-center px-2 py-2">{pStats?.['A'] || 0}</td>
                                            <td className="text-center px-2 py-2 font-semibold">{plusMinus >= 0 ? '+' : ''}{plusMinus}</td>
                                            <td className="text-center px-2 py-2">{foTotal}</td>
                                            <td className="text-center px-2 py-2 font-semibold">{foPct}{foPct !== '-' ? '%' : ''}</td>
                                            <td className="text-center px-2 py-2">{pStats?.['SOG'] || 0}</td>
                                            <td className="text-center px-2 py-2">{pim}</td>
                                          </tr>
                                        );
                                      })}
                                      {/* TOTAL ROW */}
                                      {(() => {
                                        let totalG = 0, totalA = 0, totalFO = 0, totalFOPlus = 0, totalSOG = 0, totalPIM = 0;
                                        playerNums.forEach(pNum => {
                                          const pStats = players[pNum].total;
                                          totalG += pStats?.['G'] || 0;
                                          totalA += pStats?.['A'] || 0;
                                          totalFOPlus += pStats?.['FO+'] || 0;
                                          totalFO += (pStats?.['FO+'] || 0) + (pStats?.['FO-'] || 0);
                                          totalSOG += pStats?.['SOG'] || 0;
                                          totalPIM += calculatePIMFromEvents(team, pNum);
                                        });
                                        const teamFOPct = totalFO === 0 ? '-' : ((totalFOPlus / totalFO) * 100).toFixed(0);
                                        return (
                                          <tr className={`border-t-2 ${darkMode ? 'border-gray-500 bg-gray-600' : 'border-gray-400 bg-gray-100'} text-sm font-bold`}>
                                            <td className="px-2 py-2">TOT</td>
                                            <td className="text-center px-2 py-2">{totalG}</td>
                                            <td className="text-center px-2 py-2">{totalA}</td>
                                            <td className="text-center px-2 py-2">-</td>
                                            <td className="text-center px-2 py-2">{totalFO}</td>
                                            <td className="text-center px-2 py-2">{teamFOPct}{teamFOPct !== '-' ? '%' : ''}</td>
                                            <td className="text-center px-2 py-2">{totalSOG}</td>
                                            <td className="text-center px-2 py-2">{totalPIM}</td>
                                          </tr>
                                        );
                                      })()}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>

              <div className="grid grid-cols-3 gap-3 mt-4">
                <button onClick={copyStats} className={`${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>Copy Stats</button>
                <button onClick={downloadCSV} className={`${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>Export CSV</button>
                <button onClick={shareStats} className={`${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>Share</button>
              </div>

            </div>}


            {activeTab === 'referee' && <div>
              <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 p-2">
                {refSigs.map((sig, i) => (
                  <div
                    key={i}
                    className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-2 shadow-md hover:shadow-lg transition-shadow cursor-pointer relative group`}
                    title={`${sig.name}: ${sig.description}`}
                    onClick={() => {
                      const modal = document.getElementById('refModal');
                      const modalImg = document.getElementById('refModalImg');
                      const modalTitle = document.getElementById('refModalTitle');
                      const modalDesc = document.getElementById('refModalDesc');
                      modal.style.display = 'flex';
                      modalImg.src = sig.image;
                      modalTitle.textContent = sig.name;
                      modalDesc.textContent = sig.description;
                    }}
                  >
                    <div className="w-full aspect-square flex items-center justify-center">
                      <img
                        src={sig.image}
                        alt={sig.name}
                        className="w-full h-full object-contain"
                      />
                    </div>

                    {/* Tooltip som visas UNDER vid hover pÃ¥ desktop */}
                    <div className="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10 hidden md:block">
                      <div className="font-bold">{sig.name}</div>
                      <div className="text-xs">{sig.description}</div>
                      <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-gray-900"></div>
                    </div>

                    {/* Rubrik under bilden (visas alltid pÃ¥ mobil) */}
                    <div className={`text-center mt-1 text-xs font-semibold ${darkMode ? 'text-white' : 'text-gray-800'} md:hidden`}>
                      {sig.name}
                    </div>
                  </div>
                ))}
              </div>

              {/* Modal fÃ¶r fÃ¶rstoring */}
              <div
                id="refModal"
                className="hidden fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50 p-4"
                onClick={(e) => {
                  if (e.target.id === 'refModal') {
                    document.getElementById('refModal').style.display = 'none';
                  }
                }}
              >
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-6 max-w-md w-full relative`}>
                  <button
                    className="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-gray-700"
                    onClick={() => document.getElementById('refModal').style.display = 'none'}
                  >
                    Ã—
                  </button>
                  <div className="flex items-center justify-center mb-4" style={{ minHeight: '300px' }}>
                    <img
                      id="refModalImg"
                      alt="Referee signal"
                      className="max-w-full max-h-96 object-contain"
                    />
                  </div>
                  <h3 id="refModalTitle" className={`text-xl font-bold mb-2 text-center ${darkMode ? 'text-white' : 'text-gray-900'}`}></h3>
                  <p id="refModalDesc" className={`text-center ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}></p>
                </div>
              </div>
            </div>}

            {activeTab === 'external' && externalLinkUrl && <div>
              <div className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow overflow-hidden`}>
                <iframe src={externalLinkUrl} className="w-full" style={{ height: '70vh', border: 'none' }} title={externalLinkTitle || 'External Link'}></iframe>
              </div>
            </div>}
          </div>
        </div>
      );
    };

    ReactDOM.render(<JuniorLeagueApp />, document.getElementById('root'));
  </script>
</body>

</html>
