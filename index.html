<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hockey Scorekeeper</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-39HWBJQ5Z1"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-39HWBJQ5Z1');</script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes sparkle{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.8}}
    .sparkle{animation:sparkle .6s ease-in-out}
    @keyframes eq-bar{0%,100%{height:30%}50%{height:80%}}
    .eq-bar{animation:eq-bar 0.6s ease-in-out infinite}
    .eq-bar:nth-child(1){animation-delay:0s}
    .eq-bar:nth-child(2){animation-delay:0.15s}
    .eq-bar:nth-child(3){animation-delay:0.3s}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const {useState,useRef,useEffect}=React;

const firebaseConfig={
      apiKey:"AIzaSyBFO04MS1hfTnE_ciPxTJCXO_Jk1w8DudY",
      authDomain:"hockey-scorekeeper.firebaseapp.com",
      databaseURL:"https://hockey-scorekeeper-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"hockey-scorekeeper",
      storageBucket:"hockey-scorekeeper.firebasestorage.app",
      messagingSenderId:"804304791634",
      appId:"1:804304791634:web:98532061d3768f6b8c178b"
    };

let db=null;
let auth=null;
try{
  if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
  db=firebase.database();
  auth=firebase.auth();
}catch(e){console.log("Firebase error:",e)}

    const genCode=()=>{
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code='';
      for(let i=0;i<6;i++){
        code+=chars.charAt(Math.floor(Math.random()*chars.length));
      }
      return code;
    };


    const SoundEQ = () => (
      <div className="flex items-end gap-0.5 h-4 ml-2">
        <div className="eq-bar w-1 bg-white rounded-full"></div>
        <div className="eq-bar w-1 bg-white rounded-full"></div>
        <div className="eq-bar w-1 bg-white rounded-full"></div>
      </div>
    );

    const JuniorLeagueApp=()=>{
      const [activeTab,setActiveTab]=useState('stats');
      const [currentPeriod,setCurrentPeriod]=useState(1);
      const [homeName,setHomeName]=useState('HOME TEAM');
      const [awayName,setAwayName]=useState('AWAY TEAM');
      const [sidesSwapped,setSidesSwapped]=useState(false);
      const [showSettings,setShowSettings]=useState(false);
      const [darkMode,setDarkMode]=useState(false);
      const [statsCollapsed,setStatsCollapsed]=useState(false);
      const [focusMode,setFocusMode]=useState(null);
      const [spotifyLoaded,setSpotifyLoaded]=useState(false);
      const [spotifyLoading,setSpotifyLoading]=useState(false);
      const [spotifyPlaylist,setSpotifyPlaylist]=useState('https://open.spotify.com/playlist/3HunXm4QT4dxcOz6eAljak?si=mKiXLeNMQM6ioJivpWP-EQ&pi=lAZXLD_QSPmpq');
      const [keepScreenOn,setKeepScreenOn]=useState(false);
      const [wakeLock,setWakeLock]=useState(null);
      const [externalLinkUrl,setExternalLinkUrl]=useState('');
      const [externalLinkTitle,setExternalLinkTitle]=useState('');
      const [defaultHomeRoster,setDefaultHomeRoster]=useState('');
      const [screen,setScreen]=useState('start');
      const [matchCode,setMatchCode]=useState('');
      const [inputCode,setInputCode]=useState('');
      const [connectedUsers,setConnectedUsers]=useState(1);
      const [isMultiplayer,setIsMultiplayer]=useState(false);
      const [gameMode,setGameMode]=useState(localStorage.getItem('gameMode')||'single');
      const [matchEnded,setMatchEnded]=useState(false);
      const [sparkleStats,setSparkleStats]=useState({});
      const [error,setError]=useState('');
      const [showReconnectPrompt,setShowReconnectPrompt]=useState(false);
      const [savedMatchCode,setSavedMatchCode]=useState('');
      const [isCreator,setIsCreator]=useState(false);
      const [periodStats,setPeriodStats]=useState({
        1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
        2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
        3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}
      });


      const [playerStats,setPlayerStats]=useState({
        home:{players:{}},
        away:{players:{}}
      });
      const [showPlayerStats,setShowPlayerStats]=useState(false);
      const [playerStatsEditMode,setPlayerStatsEditMode]=useState(false);
      const [playerStatsViewMode,setPlayerStatsViewMode]=useState('sideBySide');
      const [playerStatsMoment,setPlayerStatsMoment]=useState('FO/SOG');
      const [showAddPlayerModal,setShowAddPlayerModal]=useState(false);
      const [addPlayerTeam,setAddPlayerTeam]=useState('');
      const [addPlayerNumbers,setAddPlayerNumbers]=useState(['']);
      const [expandedPlayerStats,setExpandedPlayerStats]=useState({});

      const [collapsedPlayerTables,setCollapsedPlayerTables]=useState({});
     
      const audioRefs={homeGoal:useRef(null),awayGoal:useRef(null),homePenalty:useRef(null),awayPenalty:useRef(null),intro:useRef(null)};
      const [introPlaying,setIntroPlaying]=useState(false);
      const matchRef=useRef(null);
      const userId = useRef(
        localStorage.getItem('userId') ||
        (() => {
          const id = Math.random().toString(36).substr(2,9);
          localStorage.setItem('userId', id);
          return id;
        })()
      );
      const homeTeamInputRef = useRef(null);

const DEFAULT_HOME = 'HOME TEAM';
const DEFAULT_AWAY = 'AWAY TEAM';

      const [isViewer,setIsViewer]=useState(false);
      const [viewerCount,setViewerCount]=useState(0);
      const [playingSound, setPlayingSound] = useState(null);

      // Normalization functions
      const normalizePeriodStats = (stats) => {
        const normalized = {};
        for (let p = 1; p <= 4; p++) {
          // Only add period 4 if it actually exists in the data
          if (p === 4 && !stats?.[p]) {
            continue;
          }
          normalized[p] = {
            homeScore: stats?.[p]?.homeScore ?? 0,
            awayScore: stats?.[p]?.awayScore ?? 0,
            homeSaves: stats?.[p]?.homeSaves ?? 0,
            awaySaves: stats?.[p]?.awaySaves ?? 0
          };
        }
        return normalized;
      };

      const normalizePlayerStats = (stats) => {
        const normalized = {
          home: { players: {} },
          away: { players: {} }
        };
        
        ['home', 'away'].forEach(team => {
          const players = stats?.[team]?.players ?? {};
          Object.keys(players).forEach(playerNum => {
            const player = players[playerNum];
            normalized[team].players[playerNum] = {
              periods: player?.periods ?? {},
              total: {
                'G': player?.total?.['G'] ?? 0,
                'A': player?.total?.['A'] ?? 0,
                'OnIce+': player?.total?.['OnIce+'] ?? 0,
                'OnIce-': player?.total?.['OnIce-'] ?? 0,
                'FO+': player?.total?.['FO+'] ?? 0,
                'FO-': player?.total?.['FO-'] ?? 0,
                'SOG': player?.total?.['SOG'] ?? 0
              }
            };
          });
        });
        
        return normalized;
      };

      // Reset all game state
      const resetGameState = () => {
        setPeriodStats({
          1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
          2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
          3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}
        });
        setPlayerStats({home:{players:{}},away:{players:{}}});
        setCurrentPeriod(1);
        setSidesSwapped(false);
        setMatchEnded(false);
        setIsCreator(false);
        setSparkleStats({});
        setExpandedPlayerStats({});
      };

      useEffect(() => {
        if (isViewer && screen === 'game') {
          setActiveTab('stats');
        }
      }, [isViewer, screen]);


      useEffect(()=>{
        // Clean up old multiplayer data
        try {
          const raw = localStorage.getItem('multiplayerMatch');
          if (raw) {
            const data = JSON.parse(raw);
            if (!data.code || !data.timestamp || Date.now() - data.timestamp > 6 * 60 * 60 * 1000) {
              localStorage.removeItem('multiplayerMatch');
            }
          }
        } catch (e) {
          localStorage.removeItem('multiplayerMatch');
        }

      // Load user preferences
      ['darkMode','spotifyPlaylist','statsCollapsed','keepScreenOn','focusMode','externalLinkUrl','externalLinkTitle','defaultHomeRoster'].forEach(k=>{
          const v=localStorage.getItem(k);
          if(v){
            if(['darkMode','statsCollapsed','keepScreenOn'].includes(k)){
              try {
                eval(`set${k.charAt(0).toUpperCase()+k.slice(1)}(JSON.parse(v))`);
              } catch(e) {
                console.log('Failed to parse', k);
              }
            }else if(k==='focusMode'){
              setFocusMode(v==='null'?null:v);
          }else if(k==='externalLinkUrl'){
            setExternalLinkUrl(v);
          }else if(k==='externalLinkTitle'){
            setExternalLinkTitle(v);
          }else if(k==='defaultHomeRoster'){
            setDefaultHomeRoster(v);
          }else{
              eval(`set${k.charAt(0).toUpperCase()+k.slice(1)}(v)`);
            }
          }
        });
        
// Check for multiplayer reconnect
const savedMatch=localStorage.getItem('multiplayerMatch');
if(savedMatch){
  try{
    const md=JSON.parse(savedMatch);
    if(md.code){
      setSavedMatchCode(md.code);
      setGameMode(md.gameMode||'multi');
      setShowReconnectPrompt(true);
    }else{
      localStorage.removeItem('multiplayerMatch');
    }
  }catch(e){
    localStorage.removeItem('multiplayerMatch');
  }
}

// Load single-player game if no multiplayer session
if(!savedMatch){
  const saved=localStorage.getItem('juniorLeagueGame');
  if(saved){
    try {
      const gs=JSON.parse(saved);
      if(gs.currentPeriod && gs.periodStats && gs.homeName) {
        setCurrentPeriod(gs.currentPeriod);
        setHomeName(gs.homeName);
        setAwayName(gs.awayName);
        setSidesSwapped(gs.sidesSwapped ?? false);
        setPeriodStats(normalizePeriodStats(gs.periodStats));
        if(gs.playerStats) setPlayerStats(normalizePlayerStats(gs.playerStats));
        setGameMode('single');
        setScreen('game');
      } else {
        localStorage.removeItem('juniorLeagueGame');
      }
    } catch(e) {
      console.log('Failed to load saved game:', e);
      localStorage.removeItem('juniorLeagueGame');
    }
  }
}      },[]);

      useEffect(()=>{localStorage.setItem('darkMode',JSON.stringify(darkMode))},[darkMode]);
      useEffect(()=>{localStorage.setItem('spotifyPlaylist',spotifyPlaylist)},[spotifyPlaylist]);
      useEffect(()=>{localStorage.setItem('statsCollapsed',JSON.stringify(statsCollapsed))},[statsCollapsed]);
      useEffect(()=>{localStorage.setItem('keepScreenOn',JSON.stringify(keepScreenOn))},[keepScreenOn]);
      useEffect(()=>{localStorage.setItem('focusMode',focusMode)},[focusMode]);
      useEffect(()=>{localStorage.setItem('externalLinkUrl',externalLinkUrl)},[externalLinkUrl]);
      useEffect(()=>{localStorage.setItem('externalLinkTitle',externalLinkTitle)},[externalLinkTitle]);
      useEffect(()=>{localStorage.setItem('defaultHomeRoster',defaultHomeRoster)},[defaultHomeRoster]);

      useEffect(()=>{
        if(!isMultiplayer&&screen==='game'){
          const gs={currentPeriod,homeName,awayName,sidesSwapped,periodStats,playerStats,timestamp:new Date().toISOString()};
          localStorage.setItem('juniorLeagueGame',JSON.stringify(gs));
        }
      },[currentPeriod,homeName,awayName,sidesSwapped,periodStats,playerStats,isMultiplayer,screen]);

useEffect(() => {
  if (screen === 'create') {
    setTimeout(() => {
      homeTeamInputRef.current?.focus();
      homeTeamInputRef.current?.select();
    }, 50);
  }
}, [screen]);


useEffect(() => {
  const handleBeforeUnload = (e) => {
    if (
      screen === 'game' &&
      isMultiplayer && 
      matchEnded && 
      isCreator
    ) {
      e.preventDefault();
      e.returnValue = '';
    }
  };

  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => {
    window.removeEventListener('beforeunload', handleBeforeUnload);
  };
}, [screen, isMultiplayer, matchEnded, isCreator]);


      useEffect(()=>{
        const req=async()=>{try{if('wakeLock'in navigator&&keepScreenOn){const l=await navigator.wakeLock.request('screen');setWakeLock(l)}}catch(e){}};
        const rel=async()=>{if(wakeLock){try{await wakeLock.release();setWakeLock(null)}catch(e){}}};
        if(keepScreenOn)req();else rel();
        const hvc=()=>{if(keepScreenOn&&document.visibilityState==='visible')req()};
        document.addEventListener('visibilitychange',hvc);
        return()=>{rel();document.removeEventListener('visibilitychange',hvc)}
      },[keepScreenOn]);

      useEffect(()=>{
        if(!isMultiplayer||!matchCode||!db)return;
        matchRef.current=db.ref(`matches/${matchCode}`);
        matchRef.current.on('value',s=>{
          const d=s.val();
          if(d){
            setPeriodStats(normalizePeriodStats(d.periodStats));
            setCurrentPeriod(d.currentPeriod ?? 1);
            setHomeName(d.homeName ?? 'HOME TEAM');
            setAwayName(d.awayName ?? 'AWAY TEAM');
            setSidesSwapped(d.sidesSwapped ?? false);
            setMatchEnded(d.ended ?? false);
            setPlayerStats(normalizePlayerStats(d.playerStats));
            setConnectedUsers(d.users ? Object.keys(d.users).length : 0);
            setViewerCount(d.viewers ? Object.keys(d.viewers).length : 0);
            setIsCreator(d.creatorId === userId.current);
          }
        });
        const path=isViewer?`viewers/${userId.current}`:`users/${userId.current}`;
        const ur=matchRef.current.child(path);
        ur.set(true);
        ur.onDisconnect().remove();       
localStorage.setItem('multiplayerMatch',JSON.stringify({code:matchCode,timestamp:Date.now(),isViewer:isViewer,gameMode:'multi'}));
        return()=>{if(matchRef.current){matchRef.current.off();ur.remove()}}
      },[isMultiplayer,matchCode,isViewer]);

const reconnectToMatch=()=>{
  try{
    const saved=JSON.parse(localStorage.getItem('multiplayerMatch'));
    resetGameState();
    setGameMode('multi');
    localStorage.setItem('gameMode','multi');
    setMatchCode(savedMatchCode);
    setIsViewer(saved?.isViewer||false);
    setIsMultiplayer(true);
    setScreen('game');
    setShowReconnectPrompt(false);
  }catch(e){
    resetGameState();
    setGameMode('multi');
    localStorage.setItem('gameMode','multi');
    setMatchCode(savedMatchCode);
    setIsMultiplayer(true);
    setScreen('game');
    setShowReconnectPrompt(false);
  }
};
      
const startNewSession=()=>{
  localStorage.removeItem('multiplayerMatch');
  localStorage.removeItem('juniorLeagueGame');
  resetGameState();
  // Ta INTE bort gameMode h√§r - l√•t anv√§ndaren v√§lja vad de vill g√∂ra
  setShowReconnectPrompt(false);
  setIsViewer(false);
  setMatchEnded(false);
};
      
const createMatch=()=>{
  // Rensa single-game data n√§r vi g√•r till multi
  if(gameMode==='single'){
    localStorage.removeItem('juniorLeagueGame');
  }
  
  const code=genCode();
  setMatchCode(code);
  setMatchEnded(false);
  setIsViewer(false);
  setIsCreator(true);
  setGameMode('multi');
  localStorage.setItem('gameMode','multi');
  setScreen('created');
};


      const startMatch=()=>{
        if(!db){setError('Firebase not configured');return}
        const viewerCode=matchCode+'-V';
        db.ref(`matches/${matchCode}`).set({
          homeName,awayName,currentPeriod:1,sidesSwapped:false,
          periodStats:{1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}},
          playerStats:{home:{players:{}},away:{players:{}}},
          ended:false,createdAt:Date.now(),
          creatorId:userId.current,
          users:{[userId.current]:true},
          viewerCode:viewerCode,viewers:{}
   }).then(()=>{
    resetGameState();
    setGameMode('multi');
    localStorage.setItem('gameMode','multi');
    setIsMultiplayer(true);
    setIsCreator(true);
    localStorage.removeItem('juniorLeagueGame');
    localStorage.setItem('multiplayerMatch',JSON.stringify({code:matchCode,timestamp:Date.now(),isViewer:false,gameMode:'multi'}));
    setScreen('game');
    if(window.gtag)gtag('event','match_created',{match_code:matchCode});
  }).catch(e=>setError('Failed: '+e.message))
};
      
const joinMatch=()=>{
  if(!db){setError('Firebase not configured');return}
  const c=inputCode.toUpperCase().trim();
  const isViewerCode=c.endsWith('-V');
  const baseCode=isViewerCode?c.slice(0,-2):c;

  if((!isViewerCode&&c.length!==6)||(isViewerCode&&baseCode.length!==6)){
    setError('Invalid code');
    return;
  }

  db.ref(`matches/${baseCode}`).once('value').then(s=>{
    if(s.exists()){
      const d=s.val();
      if(d.ended){
        // NY KOD: Erbjud att joina som viewer
if(window.confirm('This match has ended. Join as viewer to see final stats?')){
  resetGameState();
  setGameMode('multi');
  localStorage.setItem('gameMode','multi');
  setMatchCode(baseCode);
  setIsViewer(true);
  setIsCreator(d.creatorId === userId.current);
  setIsMultiplayer(true);
  localStorage.removeItem('juniorLeagueGame');
  localStorage.setItem('multiplayerMatch',JSON.stringify({code:baseCode,timestamp:Date.now(),isViewer:true,gameMode:'multi'}));
  setScreen('game');
  if(window.gtag)gtag('event','match_joined_viewer_ended',{match_code:baseCode});
        }else{
          setError('This match has already ended');
        }
      }
else{
  resetGameState();
  setGameMode('multi');
  localStorage.setItem('gameMode','multi');
  setMatchCode(baseCode);
  setIsViewer(isViewerCode);
  setIsCreator(d.creatorId === userId.current);
  setIsMultiplayer(true);
  localStorage.removeItem('juniorLeagueGame');
  localStorage.setItem('multiplayerMatch',JSON.stringify({code:baseCode,timestamp:Date.now(),isViewer:isViewerCode,gameMode:'multi'}));
  setScreen('game');
  if(window.gtag)gtag('event',isViewerCode?'match_joined_viewer':'match_joined_editor',{match_code:baseCode});
      }
    }else setError('No match found with that code')
  }).catch(e=>setError('Failed: '+e.message))
};

const continueAlone=()=>{
  const prevMode=gameMode;
  localStorage.removeItem('multiplayerMatch');
  
  // Om vi kommer fr√•n multi-l√§ge, rensa och b√∂rja nytt
  if(prevMode==='multi'){
    resetGameState();
    localStorage.removeItem('juniorLeagueGame');
  }
  
  setGameMode('single');
  localStorage.setItem('gameMode','single');
  setIsMultiplayer(false);
  setIsViewer(false);
  setMatchEnded(false);
  setScreen('game');
};
      
      const endMatch = () => {
        if (window.confirm('End match for all users?')) {
          if (matchRef.current) {
            matchRef.current.update({ ended: true });
          }
          setMatchEnded(true);
          localStorage.removeItem('multiplayerMatch');
          setShowReconnectPrompt(false);
        }
      };

const leaveMatch=()=>{
  if(window.confirm('Leave multiplayer match?')){
    localStorage.removeItem('multiplayerMatch');
    resetGameState();
    setGameMode('single');
    localStorage.setItem('gameMode','single');
    setIsMultiplayer(false);
    setIsViewer(false);
    setMatchEnded(false);
    setMatchCode('');
    setScreen('start');
  }
};

const exitToStart=()=>{
  if(window.confirm('Exit to start screen? Current game will be saved.')){
    setScreen('start');
  }
};


const AdminPanel = ({ darkMode, setScreen }) => {

  const [sortDir, setSortDir] = React.useState('desc');
  const [matches, setMatches] = React.useState({});

  React.useEffect(() => {
    if (!db) return;

    const ref = db.ref('matches');
    ref.on('value', snap => {
      setMatches(snap.val() || {});
    });

    return () => ref.off();
  }, []);

  const deleteMatch = (id) => {
    if (!window.confirm(`Delete match ${id}?`)) return;
    db.ref(`matches/${id}`).remove();
  };

  const toggleEnded = (id, ended) => {
    db.ref(`matches/${id}`).update({ ended: !ended });
  };

  return (
    <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
      <div className={`${darkMode?'bg-gray-800':'bg-blue-600'} text-white p-4`}>
        <div className="max-w-5xl mx-auto flex justify-between items-center">
          <h2 className="font-bold text-lg">Admin ‚Äì Matches</h2>
<div className="flex gap-2">
  <button
    onClick={async () => {
      await auth.signOut();
      setScreen('game');
    }}
    className="bg-white bg-opacity-20 px-3 py-2 rounded"
  >
    ‚Üê Back & Sign Out
  </button>
</div>
        </div>
      </div>

      <div className="max-w-5xl mx-auto p-4 overflow-x-auto">
        <table className="w-full text-sm">
          <thead className={darkMode ? 'bg-gray-800 text-gray-200' : 'bg-gray-200'}>
            <tr>
              <th className="px-3 py-2 text-left">Match ID</th>
              
<th className="px-3 py-2 text-left">Home</th>
              <th className="px-3 py-2 text-left">Away</th>
              <th className="px-3 py-2">Status</th>
              <th
               onClick={() =>
               setSortDir(d => (d === 'asc' ? 'desc' : 'asc'))
               }
               className="px-3 py-2 text-center cursor-pointer select-none"
               >
               Created {sortDir === 'asc' ? '‚ñ≤' : '‚ñº'}
              </th>
              <th className="px-3 py-2 whitespace-nowrap min-w-[120px]">Actions</th>
            </tr>
          </thead>
          <tbody>
            {Object.keys(matches).length === 0 && (
              <tr>
                <td colSpan="4" className="text-center py-6 opacity-60">
                  No matches found
                </td>
              </tr>
            )}

            {Object.entries(matches)
  .sort((a, b) => {
    const tA = a[1].createdAt || 0;
    const tB = b[1].createdAt || 0;
    return sortDir === 'asc' ? tA - tB : tB - tA;
  })
  .map(([id, m]) => (
              <tr
  key={id}
  className={`border-t ${darkMode?'border-gray-700 text-gray-200':'border-gray-300'}`}
>
  <td className={`px-3 py-2 font-mono ${darkMode?'text-gray-200':''}`}>{id}</td>
  <td className={`px-3 py-2 ${darkMode?'text-gray-200':''}`}>{m.homeName || '‚Äî'}</td>
  <td className={`px-3 py-2 ${darkMode?'text-gray-200':''}`}>{m.awayName || '‚Äî'}</td>
  <td className={`px-3 py-2 text-center ${darkMode?'text-gray-200':''}`}>
    {m.ended ? 'Ended' : 'Active'}
  </td>
  <td className={`px-3 py-2 text-center ${darkMode?'text-gray-200':''}`}>
    {m.createdAt
      ? new Date(m.createdAt).toLocaleString()
      : '‚Äî'}
  </td>
  <td className="px-3 py-2 text-center space-x-2 whitespace-nowrap">
                  <button
                    onClick={() => toggleEnded(id, m.ended)}
                    className="px-2 py-1 rounded bg-yellow-500 text-white"
                  >
                    {m.ended ? '‚ñ∂' : '‚èπ'}
                  </button>
                  <button
                    onClick={() => deleteMatch(id)}
                    className="px-2 py-1 rounded bg-red-600 text-white"
                  >
                    üóë
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};


      const updateStat=(team,stat,delta)=>{
        if(isViewer)return;
        const ns=structuredClone(periodStats);
        if(!ns[currentPeriod]) {
          ns[currentPeriod]={homeScore:0,awayScore:0,homeSaves:0,awaySaves:0};
        }
        ns[currentPeriod][team+stat]=Math.max(0,(ns[currentPeriod][team+stat]||0)+delta);
        setPeriodStats(ns);
        const k=`${team}${stat}${currentPeriod}`;
        setSparkleStats(p=>({...p,[k]:true}));
        setTimeout(()=>setSparkleStats(p=>({...p,[k]:false})),600);
        if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({periodStats:ns})
      };

      const updatePlayerStat=(team,playerNum,stat,delta)=>{
        if(isViewer||matchEnded)return;
        
        const period=currentPeriod;
        const newStats=structuredClone(playerStats);
        
        if(!newStats[team])newStats[team]={players:{}};
        if(!newStats[team].players)newStats[team].players={};
        
        if(!newStats[team].players[playerNum]){
          newStats[team].players[playerNum]={
            periods:{},
            total:{'G':0,'A':0,'OnIce+':0,'OnIce-':0,'FO+':0,'FO-':0,'SOG':0}
          };
        }
        
        if(!newStats[team].players[playerNum].periods[period]){
          newStats[team].players[playerNum].periods[period]={'G':0,'A':0,'OnIce+':0,'OnIce-':0,'FO+':0,'FO-':0,'SOG':0};
        }
        
        if(stat==='G'){
          const currentSOG=newStats[team].players[playerNum].periods[period]['SOG']||0;
          newStats[team].players[playerNum].periods[period]['SOG']=Math.max(0,currentSOG+delta);
        }
        
        const currentPeriodVal=newStats[team].players[playerNum].periods[period][stat]||0;
        newStats[team].players[playerNum].periods[period][stat]=Math.max(0,currentPeriodVal+delta);
        
        const statsToRecalc=stat==='G'?[stat,'SOG']:[stat];
        statsToRecalc.forEach(s=>{
          newStats[team].players[playerNum].total[s]=0;
          Object.keys(newStats[team].players[playerNum].periods).forEach(p=>{
            newStats[team].players[playerNum].total[s]+=newStats[team].players[playerNum].periods[p][s]||0;
          });
        });
        
        setPlayerStats(newStats);
        
        const sparkleKeys=stat==='G'?[`${team}${playerNum}G${period}`,`${team}${playerNum}SOG${period}`]:[`${team}${playerNum}${stat}${period}`];
        sparkleKeys.forEach(k=>{
          setSparkleStats(p=>({...p,[k]:true}));
        });
        setTimeout(()=>{
          sparkleKeys.forEach(k=>{
            setSparkleStats(p=>({...p,[k]:false}));
          });
        },600);
        
        if(isMultiplayer&&matchRef.current)matchRef.current.update({playerStats:newStats});
      };
      
      const removePlayer=(team,playerNum)=>{
        if(isViewer||matchEnded)return;
        
        const newStats=structuredClone(playerStats);
        
        if(newStats[team]&&newStats[team].players){
          delete newStats[team].players[playerNum];
        }
        
        setPlayerStats(newStats);
        if(isMultiplayer&&matchRef.current)matchRef.current.update({playerStats:newStats});
      };





const addPlayers=(team,numbers)=>{
  const validNumbers=numbers.filter(n=>n&&n.trim()!=='');
  if(validNumbers.length===0)return;
  
  const newStats=structuredClone(playerStats);
  
  if(!newStats[team])newStats[team]={players:{}};
  if(!newStats[team].players)newStats[team].players={};
  
  validNumbers.forEach(playerNum=>{
    if(!newStats[team].players[playerNum]){
      newStats[team].players[playerNum]={
        periods:{},
        total:{'G':0,'A':0,'OnIce+':0,'OnIce-':0,'FO+':0,'FO-':0,'SOG':0}
      };
    }
  });
  
  setPlayerStats(newStats);
  if(isMultiplayer&&matchRef.current)matchRef.current.update({playerStats:newStats});
  
  setShowAddPlayerModal(false);
  setAddPlayerNumbers(['']);
};

// Parse comma/space separated input into array
const parsePlayerInput = (input) => {
  // Split by comma or space, filter empty, remove duplicates
  const nums = input
    .split(/[,\s]+/)
    .map(n => n.trim())
    .filter(n => n !== '' && /^\d+$/.test(n));
  return [...new Set(nums)];
};



// Handle smart input parsing
const handlePlayerInputChange = (value, idx) => {
  // Check if user typed comma or space (= wants to move to next field)
  if (value.includes(',') || value.includes(' ')) {
    const parsed = parsePlayerInput(value);
    if (parsed.length > 0) {
      // Keep all existing fields before current index, then add parsed numbers
      const before = addPlayerNumbers.slice(0, idx);
      const after = addPlayerNumbers.slice(idx + 1).filter(n => n.trim() !== '');
      
      // Combine: existing + parsed + remaining + empty
      setAddPlayerNumbers([...before, ...parsed, ...after, '']);
      
      // Focus will auto-move to the new empty field
      setTimeout(() => {
        const inputs = document.querySelectorAll('input[type="text"][inputmode="decimal"]');
        inputs[inputs.length - 1]?.focus();
      }, 50);
    }
  } else {
    // Normal single character input
    const newNums = [...addPlayerNumbers];
    newNums[idx] = value;
    setAddPlayerNumbers(newNums);
  }
};

      const playSound = st => {
        const a = audioRefs[st].current;
        if (!a) return;
        setPlayingSound(st);
        a.currentTime = 0;
        a.play().catch(e => console.log('Play failed:', e));
        a.onended = () => {
          setPlayingSound(null);
        };
      };
      
      const toggleIntro=()=>{
        const a=audioRefs.intro.current;
        if(!a)return;
        if(introPlaying){
          a.pause();
          a.currentTime=0;
          setIntroPlaying(false);
          setPlayingSound(null);
        }else{
          a.loop=true;
          a.play().catch(e=>console.log('Play failed:',e));
          setIntroPlaying(true);
          setPlayingSound('intro');
        }
      };
      
      const stopAllSounds=()=>{
        Object.values(audioRefs).forEach(r=>{
          if(r.current){
            r.current.pause();
            r.current.currentTime=0;
          }
        });
        setIntroPlaying(false);
        setPlayingSound(null);
      };
      
      const resetCounters=()=>{
        if(window.confirm('Reset all stats?')){
          const ns={1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}};
          setPeriodStats(ns);
          setCurrentPeriod(1);
          setPlayerStats({home:{players:{}},away:{players:{}}});
          if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({periodStats:ns,currentPeriod:1,playerStats:{home:{players:{}},away:{players:{}}}});
          else localStorage.removeItem('juniorLeagueGame')
        }
      };

      const calcTotals=()=>{
        let hs=0,as=0,hsv=0,asv=0;
        Object.keys(periodStats).forEach(p=>{
          hs+=(periodStats[p]?.homeScore ?? 0);
          as+=(periodStats[p]?.awayScore ?? 0);
          hsv+=(periodStats[p]?.homeSaves ?? 0);
          asv+=(periodStats[p]?.awaySaves ?? 0);
        });
        return{homeScore:hs,awayScore:as,homeSaves:hsv,awaySaves:asv}
      };
      
      const totals=calcTotals();
      const calcSP=(sv,g)=>{const sh=sv+g;return sh===0?'0.0':((sv/sh)*100).toFixed(1)};


      const genReport=()=>{
        const d=new Date().toLocaleDateString();
        let r=`Game Report - ${d}\n${homeName} ${totals.homeScore} - ${totals.awayScore} ${awayName}\n\nPERIOD BREAKDOWN:\n`;
        Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(p=>{
          const ps=periodStats[p];
          const pLabel=parseInt(p)<=3?`Period ${p}`:`OT`;
          r+=`${pLabel}: ${homeName} ${ps.homeScore}-${ps.awayScore} ${awayName}\n`;
        });
        r+=`\nGOALIE STATS:\n${homeName}: ${totals.homeSaves} saves, ${totals.homeSaves+totals.awayScore} shots against, ${calcSP(totals.homeSaves,totals.awayScore)}%\n`;
        r+=`${awayName}: ${totals.awaySaves} saves, ${totals.awaySaves+totals.homeScore} shots against, ${calcSP(totals.awaySaves,totals.homeScore)}%\n`;
        return r;
      };
      
      const generateCSV=()=>{
        let csv='';
        const d=new Date().toLocaleDateString();
        
        csv+=`Game Report,${d}\n`;
        csv+=`${homeName},${totals.homeScore},${awayName},${totals.awayScore}\n\n`;
        
        csv+=`Period Breakdown\n`;
        csv+=`Period,${homeName},${awayName}\n`;
        Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(p=>{
          const ps=periodStats[p];
          const pLabel=parseInt(p)<=3?`Period ${p}`:`OT`;
          csv+=`${pLabel},${ps.homeScore},${ps.awayScore}\n`;
        });
        
        csv+=`\nGoalie Statistics\n`;
        csv+=`Team,Saves,Shots Against,Save %\n`;
        csv+=`${homeName},${totals.homeSaves},${totals.homeSaves+totals.awayScore},${calcSP(totals.homeSaves,totals.awayScore)}%\n`;
        csv+=`${awayName},${totals.awaySaves},${totals.awaySaves+totals.homeScore},${calcSP(totals.awaySaves,totals.homeScore)}%\n`;
        
        if(playerStats.home?.players||playerStats.away?.players){
          csv+=`\nPlayer Statistics\n`;
          
          ['home','away'].forEach(team=>{
            const teamName=team==='home'?homeName:awayName;
            const players=playerStats[team]?.players||{};
            const playerNums=Object.keys(players).sort((a,b)=>parseInt(a)-parseInt(b));
            
            if(playerNums.length===0)return;
            
            csv+=`\n${teamName}\n`;
            csv+=`Player #,Period,G,A,OnIce+,OnIce-,FO+,FO-,SOG\n`;
            
            playerNums.forEach(pNum=>{
              const pData=players[pNum];
              
              Object.keys(pData.periods).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(period=>{
                const pLabel=parseInt(period)<=3?`P${period}`:`OT`;
                const stats=pData.periods[period];
                csv+=`${pNum},${pLabel},${stats['G']||0},${stats['A']||0},${stats['OnIce+']||0},${stats['OnIce-']||0},${stats['FO+']||0},${stats['FO-']||0},${stats['SOG']||0}\n`;
              });
              
              csv+=`${pNum},TOTAL,${pData.total['G']},${pData.total['A']},${pData.total['OnIce+']},${pData.total['OnIce-']},${pData.total['FO+']},${pData.total['FO-']},${pData.total['SOG']}\n`;
            });
          });
        }
        
        return csv;
      };
      
      const downloadCSV=()=>{
        const csv=generateCSV();
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const link=document.createElement('a');
        const url=URL.createObjectURL(blob);
        link.setAttribute('href',url);
        link.setAttribute('download',`hockey_stats_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility='hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
      
      const copyStats=()=>navigator.clipboard.writeText(genReport()).then(()=>alert('Stats copied!')).catch(()=>alert('Failed to copy'));
      const copyCode=()=>navigator.clipboard.writeText(matchCode).then(()=>alert('Code copied!')).catch(()=>alert('Failed to copy'));
      const shareStats=()=>{
        if(navigator.share)navigator.share({title:'Game Report',text:genReport()}).catch(()=>copyStats());
        else copyStats();
      };
      
      const getSpotifyUrl=u=>{
        const m=u.match(/playlist\/([a-zA-Z0-9]+)/);
        return m&&m[1]?`https://open.spotify.com/embed/playlist/${m[1]}?utm_source=generator&theme=0`:null;
      };
      
      const loadSpotify=()=>{
        setSpotifyLoading(true);
        setTimeout(()=>{
        setSpotifyLoaded(true);
        setSpotifyLoading(false);
        },100);
      };

      const refSigs=[
        {name:'Offside',description:'Arm raised straight up'},
        {name:'Tripping',description:'Strike leg with hand'},
        {name:'Holding',description:'Clasping wrist'},
        {name:'High Sticking',description:'Two hands held high'},
        {name:'Slashing',description:'Chopping motion'},
        {name:'Icing',description:'Arms crossed at chest'},
        {name:'Goal',description:'Both arms pointed at goal'},
        {name:'No Goal',description:'Arms crossed overhead'},
        {name:'Time Out',description:'Hands forming T'},
        {name:'Penalty Shot',description:'Arms crossed then pointed'}
      ];


if(showPlayerStats&&screen==='game'){
const statColumns={
  'HG':['G','A','+','-'],
  'AG':['G','A','+','-'],
  'FO/SOG':['FO+','FO-','SOG'],
  'All':['G','A','+','-','FO+','FO-','SOG']
};
        
        const activeColumns=statColumns[playerStatsMoment];
        
const renderPlayerTable=(team)=>{
  const teamName=team==='home'?homeName:awayName;
  const players=playerStats?.[team]?.players??{};
  const playerNums=Object.keys(players).sort((a,b)=>parseInt(a)-parseInt(b));
  
  // Determine which columns to show based on mode and team
  let columnsToShow = activeColumns;
  if (playerStatsMoment === 'HG') {
    // Home Goal mode: home team shows G,A,+  away team shows only -
    columnsToShow = team === 'home' ? ['G', 'A', '+'] : ['-'];
  } else if (playerStatsMoment === 'AG') {
    // Away Goal mode: away team shows G,A,+  home team shows only -
    columnsToShow = team === 'away' ? ['G', 'A', '+'] : ['-'];
  }
  
  // Map display column names to actual stat names
  const getActualStatName = (col) => {
    if (col === '+') return 'OnIce+';
    if (col === '-') return 'OnIce-';
    return col;
  };
  
  return(
            <div
  className={`
    ${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'}
    rounded-lg shadow-lg overflow-hidden
    ${
      (playerStatsMoment === 'HG' && team === 'away') ||
      (playerStatsMoment === 'AG' && team === 'home')
        ? 'text-sm'
        : ''
    }
  `}
>

<button 
  onClick={() => setCollapsedPlayerTables(prev => ({...prev, [team]: !prev[team]}))}
  className={`${darkMode?'bg-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-3 font-bold text-center w-full flex items-center justify-between hover:opacity-90 transition-opacity`}
>
  <span>{teamName}</span>
  <span className="text-xl">{collapsedPlayerTables[team] ? '‚ñº' : '‚ñ≤'}</span>
</button>
              
{!collapsedPlayerTables[team] && (
  <>
    <div className="overflow-x-auto">
      <table className="w-full">
        <thead className={`${darkMode?'bg-gray-700':'bg-gray-100'} sticky top-0`}>
          <tr>
            <th className={`px-2 py-2 text-left text-xs font-semibold sticky left-0 ${darkMode?'bg-gray-700':'bg-gray-100'} z-10`}>#</th>
            {columnsToShow.map(col=>(
              <th key={col} className="px-2 py-2 text-center text-xs font-semibold">{col}</th>
            ))}
            {playerStatsEditMode&&<th className="px-2 py-2 text-center text-xs font-semibold"></th>}
          </tr>
        </thead>
        <tbody>
          {playerNums.length===0?(
            <tr>
              <td colSpan={columnsToShow.length+(playerStatsEditMode?2:1)} className={`text-center py-8 ${darkMode?'text-gray-400':'text-gray-500'}`}>
                No players added yet
              </td>
            </tr>
          ):playerNums.map(pNum=>{
            const pData=players[pNum];
            const currentPeriodStats=pData?.periods?.[currentPeriod]??{'G':0,'A':0,'OnIce+':0,'OnIce-':0,'FO+':0,'FO-':0,'SOG':0};
            
            return(
              <tr key={pNum} className={`border-t ${darkMode?'border-gray-700':'border-gray-200'}`}>
                <td className={`px-2 py-2 font-bold sticky left-0 ${darkMode?'bg-gray-800':'bg-white'} z-10`}>{pNum}</td>
                {columnsToShow.map(col=>{
                  const actualStat = getActualStatName(col);
                  return (
                    <td key={col} className="px-2 py-2">
                      <div className="flex items-center justify-center gap-1">
                        {playerStatsEditMode&&(
                          <button
                            onClick={()=>updatePlayerStat(team,pNum,actualStat,-1)}
                            disabled={matchEnded||isViewer}
                            className={`w-6 h-6 rounded text-xs font-bold ${darkMode?'bg-red-900 bg-opacity-40 hover:bg-opacity-60 text-red-200':'bg-red-100 hover:bg-red-200 text-red-800'}`}
                          >‚àí</button>
                        )}
                        <button
                          onClick={()=>updatePlayerStat(team,pNum,actualStat,1)}
                          disabled={matchEnded||isViewer}
                          className={`min-w-[2rem] h-6 px-2 rounded text-xs font-bold ${darkMode?'bg-blue-900 bg-opacity-40 hover:bg-opacity-60 text-blue-200':'bg-blue-100 hover:bg-blue-200 text-blue-800'} ${sparkleStats[`${team}${pNum}${actualStat}${currentPeriod}`]?'sparkle':''}`}
                        >
                          {currentPeriodStats[actualStat]||0}
                        </button>
                      </div>
                    </td>
                  );
                })}
                {playerStatsEditMode&&(
                  <td
  className={
    (playerStatsMoment === 'HG' && team === 'away') ||
    (playerStatsMoment === 'AG' && team === 'home')
      ? 'px-1 py-1'
      : 'px-2 py-2'
  }
>

                    <button
                      onClick={()=>removePlayer(team,pNum)}
                      disabled={matchEnded||isViewer}
                      className={`w-6 h-6 rounded text-xs font-bold ${darkMode?'bg-red-900 bg-opacity-40 hover:bg-opacity-60 text-red-200':'bg-red-100 hover:bg-red-200 text-red-800'}`}
                    >√ó</button>
                  </td>
                )}
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
    
    {!isViewer&&!matchEnded&&(
      <div className="p-3 border-t">
        <button
          onClick={()=>{setAddPlayerTeam(team);setShowAddPlayerModal(true)}}
          className={`w-full ${darkMode?'bg-gray-700 hover:bg-gray-600 text-gray-200':'bg-gray-100 hover:bg-gray-200 text-gray-800'} py-2 rounded font-semibold text-sm`}
        >
          + Add Player
        </button>
      </div>
    )}
  </>
)}
            </div>
          );
        };


return(
          <div className={`min-h-screen ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
            <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-4 shadow-lg sticky top-0 z-50`}>
              <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-3">
                  <div className="flex gap-2 items-center flex-wrap">
                   <span className="text-sm font-medium">Per:</span>
                    {[1,2,3].map(p=>(
                      <button
                        key={p}
                        onClick={()=>{
                          setCurrentPeriod(p);
                          if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:p});
                        }}
                        disabled={matchEnded||isViewer}
                        className={`px-3 py-1 rounded text-sm font-bold ${currentPeriod===p?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                      >
                        {p}
                      </button>
                    ))}
                    {periodStats[4]&&(
                      <button
                        onClick={()=>{
                          setCurrentPeriod(4);
                          if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:4});
                        }}
                        disabled={matchEnded||isViewer}
                        className={`px-3 py-1 rounded text-sm font-bold ${currentPeriod===4?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                      >
                        OT
                      </button>
                    )}
                    {!periodStats[4]&&currentPeriod===3&&(
                      <button
                        onClick={()=>{
                          const updated={...periodStats,4:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}};
                          setPeriodStats(updated);
                          setCurrentPeriod(4);
                          if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({periodStats:updated,currentPeriod:4});
                        }}
                        disabled={matchEnded||isViewer}
                        className={`px-3 py-1 rounded text-sm font-bold ${darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                      >
                        +OT
                      </button>
                    )}
                  </div>
                  
                  <button
                    onClick={()=>setShowPlayerStats(false)}
                    className={`${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-1`}
                  >
                    <span className="text-lg">‚Üê</span>
                    <span className="hidden sm:inline">Back</span>
                  </button>
                </div>

                
                <div className="flex gap-2 items-center flex-wrap">
                  <span className="text-sm font-medium"></span>
{[
  {key:'HG',label:window.innerWidth >= 640 ? 'Home Goal' : 'HG'},
  {key:'AG',label:window.innerWidth >= 640 ? 'Away Goal' : 'AG'},
  {key:'FO/SOG',label:'FO/SOG'},
  {key:'All',label:'All'}
].map(m=>(
                    <button
                      key={m.key}
                      onClick={()=>setPlayerStatsMoment(m.key)}
                      className={`px-3 py-1 rounded text-sm font-bold ${playerStatsMoment===m.key?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                    >
                      {m.label}
                    </button>
                  ))}


                <div className="flex gap-2 items-center flex-wrap">
 
<label className="hidden sm:flex items-center gap-2">
  <span className="text-sm"></span>
  <select
    value={playerStatsViewMode}
    onChange={(e)=>setPlayerStatsViewMode(e.target.value)}
    className={`px-2 py-1 rounded text-sm ${
      darkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-800'
    }`}
  >
    <option value="sideBySide">Side by Side</option>
    <option value="stacked">Stacked</option>
  </select>
</label>


                 <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={playerStatsEditMode}
                      onChange={(e)=>setPlayerStatsEditMode(e.target.checked)}
                      className="w-4 h-4"
                    />
                    <span className="text-sm">Edit</span>
                  </label>
                  

                </div>

                </div>
              </div>
            </div>
            
            <div className="max-w-7xl mx-auto p-4">
                <div
    className="grid gap-3"
    style={
      playerStatsViewMode === 'sideBySide' &&
      (playerStatsMoment === 'HG' || playerStatsMoment === 'AG')
        ? {
            gridTemplateColumns:
              playerStatsMoment === 'HG'
                ? '2fr 1fr'   // HOME bred, AWAY smal
                : '1fr 2fr'   // AWAY bred, HOME smal
          }
        : undefined
    }
  >
    {renderPlayerTable('home')}
    {renderPlayerTable('away')}
  </div>
            </div>




{showAddPlayerModal&&(
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-lg shadow-xl p-4 max-w-sm w-full`}>
      <h3 className="text-lg font-bold mb-3">Add Player(s)</h3>
      
      {/* Default roster hint */}
      {addPlayerTeam === 'home' && defaultHomeRoster && addPlayerNumbers.length === 1 && addPlayerNumbers[0] === '' && Object.keys(playerStats.home?.players || {}).length === 0 && (
        <div className={`mb-3 p-3 rounded ${darkMode ? 'bg-blue-900 bg-opacity-30 border border-blue-700' : 'bg-blue-50 border border-blue-200'}`}>
          <p className="text-xs mb-2 opacity-75">Default home roster:</p>
          <button
            onClick={() => {
              const parsed = parsePlayerInput(defaultHomeRoster);
              setAddPlayerNumbers([...parsed, '']);
            }}
            className={`w-full ${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-500 hover:bg-blue-600'} text-white py-2 rounded font-semibold text-sm`}
          >
            Load: {defaultHomeRoster}
          </button>
        </div>
      )}
      
      <div className={`mb-2 p-2 rounded text-xs ${darkMode?'bg-gray-700 text-gray-300':'bg-gray-100 text-gray-600'}`}>
        üí° Tip: Type "2,3,4" or "2 3 4" to add multiple players at once
      </div>
      
      <div className="space-y-3 mb-3 max-h-64 overflow-y-auto">
        {addPlayerNumbers.map((num,idx)=>(
          <div key={idx}>
            <input
              type="text"
              inputMode="decimal"
              value={num}
              onChange={(e)=>handlePlayerInputChange(e.target.value, idx)}
              onKeyDown={(e)=>{
                if(e.key==='Enter'&&num.trim()!==''){
                  e.preventDefault();
                  if(idx===addPlayerNumbers.length-1){
                    setAddPlayerNumbers([...addPlayerNumbers,'']);
                    setTimeout(()=>{
                      const inputs=document.querySelectorAll('input[type="text"][inputmode="decimal"]');
                      inputs[inputs.length-1]?.focus();
                    },50);
                  }else{
                    const inputs=document.querySelectorAll('input[type="text"][inputmode="decimal"]');
                    inputs[idx+1]?.focus();
                  }
                }
              }}
              placeholder={idx === 0 ? "e.g. 2,3,4 or 2 3 4" : `Player #${idx+1}`}
              className={`w-full px-3 py-3 border rounded text-center font-bold text-xl ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'}`}
              autoFocus={idx===addPlayerNumbers.length-1}
            />
            {num.trim()!==''&&idx===addPlayerNumbers.length-1&&(
              <button
                onClick={()=>{
                  setAddPlayerNumbers([...addPlayerNumbers,'']);
                  setTimeout(()=>{
                    const inputs=document.querySelectorAll('input[type="text"][inputmode="decimal"]');
                    inputs[inputs.length-1]?.focus();
                  },50);
                }}
                className={`w-full mt-2 ${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-500 hover:bg-blue-600'} text-white py-2 rounded font-semibold text-sm`}
              >
                Next ‚Üí Add Another Player
              </button>
            )}
          </div>
        ))}
      </div>
      <div className="flex gap-2">
        <button
          onClick={()=>{setShowAddPlayerModal(false);setAddPlayerNumbers([''])}}
          className={`flex-1 ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-200 hover:bg-gray-300'} py-2 rounded font-semibold text-sm`}
        >
          Cancel
        </button>
        <button
          onClick={()=>addPlayers(addPlayerTeam,addPlayerNumbers)}
          disabled={addPlayerNumbers.filter(n=>n&&n.trim()!=='').length===0}
          className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-2 rounded font-semibold text-sm"
        >
          Add ({addPlayerNumbers.filter(n=>n&&n.trim()!=='').length})
        </button>
      </div>
    </div>
  </div>
)}          </div>
        );
      }

      if(showReconnectPrompt)return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <h3 className="text-xl font-bold mb-3">Reconnect to match</h3>
              <p className={`${darkMode?'text-gray-300':'text-gray-600'} mb-6`}>
                Match Code: <span className="font-mono font-bold">{savedMatchCode}</span>
              </p>
              <div className="flex gap-3">
                <button onClick={reconnectToMatch} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">Reconnect</button>
                <button onClick={startNewSession} className={`flex-1 ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-200 hover:bg-gray-300'} py-3 rounded-lg font-semibold`}>Start New</button>
              </div>
            </div>
          </div>
        </div>
      );

      if(screen==='start')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <div className="text-center mb-8">
                <h1 className="text-3xl font-bold mb-2">Hockey Scorekeeper</h1>
                <p className={`${darkMode?'text-gray-300':'text-gray-600'}`}>
                  Track your game together
                </p>
              </div>
              <div className="space-y-4">
                <button onClick={()=>setScreen('create')} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">CREATE NEW MATCH</button>
                <button onClick={()=>setScreen('join')} className={`w-full ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-200 hover:bg-gray-300'} py-4 rounded-xl font-bold text-lg shadow-lg`}>JOIN MATCH</button>
                <button onClick={continueAlone} className={`w-full ${darkMode?'text-gray-400 hover:text-gray-300':'text-gray-500 hover:text-gray-700'} py-2 text-sm`}>‚Üí Or continue alone</button>
              </div>
              <div className="mt-6 text-center">
                <button onClick={()=>setDarkMode(!darkMode)} className={`text-sm ${darkMode?'text-gray-400':'text-gray-500'}`}>{darkMode?'‚òÄÔ∏è Light Mode':'üåô Dark Mode'}</button>
              </div>
            </div>
          </div>
        </div>
      );

if (screen === 'admin') {
  return <AdminPanel
    darkMode={darkMode}
    setScreen={setScreen}
  />;
}


if(screen==='create')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <button onClick={()=>setScreen('start')} className={`mb-6 ${darkMode?'text-gray-400':'text-gray-600'}`}>‚Üê Go Back</button>
              <h2 className="text-2xl font-bold mb-6">New Match</h2>
              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-sm mb-2">Home Team</label>
                  
<div className="relative">
  <input
    ref={homeTeamInputRef}
    type="text"
    value={homeName}
    onChange={e => setHomeName(e.target.value)}
    className={`w-full px-4 py-3 pr-10 border rounded-lg
      ${darkMode
        ? 'bg-gray-700 border-gray-600 text-white'
        : 'border-gray-300'
      }`}
  />

  {homeName === DEFAULT_HOME && (
    <button
      type="button"
      onClick={() => setHomeName('')}
      className="absolute right-3 top-1/2 -translate-y-1/2
                 text-gray-400 hover:text-gray-600"
      aria-label="Clear home team"
    >
      √ó
    </button>
  )}
</div>
                </div>
                <div>
                  <label className="block text-sm mb-2">Away Team</label>
                  <div className="relative">
  <input
    type="text"
    value={awayName}
    onChange={e => setAwayName(e.target.value)}
    className={`w-full px-4 py-3 pr-10 border rounded-lg
      ${darkMode
        ? 'bg-gray-700 border-gray-600 text-white'
        : 'border-gray-300'
      }`}
  />

  {awayName && (
    <button
      type="button"
      onClick={() => setAwayName('')}
      className="absolute right-3 top-1/2 -translate-y-1/2
                 text-gray-400 hover:text-gray-600"
      aria-label="Clear away team"
    >
      √ó
    </button>
  )}
</div>
                </div>
              </div>
              <button onClick={createMatch} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">START MATCH</button>
            </div>
          </div>
        </div>
      );

      if(screen==='created')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <div className="text-center mb-6">
                <h2 className="text-2xl font-bold mb-2">Match Created</h2>
              </div>
              <div className={`${darkMode?'bg-gray-700':'bg-blue-50'} rounded-xl p-6 mb-6`}>
                <p className={`text-sm font-semibold mb-3 ${darkMode?'text-gray-300':'text-gray-600'}`}>üìù Editor Code (max 5 users)</p>
                <div className="flex flex-col sm:flex-row items-stretch gap-3 mb-4">
                  <div className={`flex-1 ${darkMode?'bg-gray-800':'bg-white'} rounded-lg py-4 px-6 text-center border-2 ${darkMode?'border-gray-600':'border-gray-200'}`}>
                    <div className={`text-3xl font-bold tracking-widest ${darkMode?'text-white':'text-gray-900'}`}>{matchCode}</div>
                  </div>
                  <button onClick={copyCode} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-lg font-semibold whitespace-nowrap">Copy</button>
                </div>
                
                <p className={`text-sm font-semibold mb-3 ${darkMode?'text-gray-300':'text-gray-600'}`}>üëÅÔ∏è Viewer Code (read-only)</p>
                <div className="flex flex-col sm:flex-row items-stretch gap-3">
                  <div className={`flex-1 ${darkMode?'bg-gray-800':'bg-white'} rounded-lg py-4 px-6 text-center border-2 ${darkMode?'border-gray-600':'border-gray-200'}`}>
                    <div className={`text-2xl font-bold tracking-widest ${darkMode?'text-white':'text-gray-900'}`}>{matchCode}-V</div>
                  </div>
                  <button onClick={()=>navigator.clipboard.writeText(matchCode+'-V').then(()=>alert('Code copied!')).catch(()=>alert('Failed to copy'))} className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-4 rounded-lg font-semibold whitespace-nowrap">Copy</button>
                </div>
              </div>

              {error&&<div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded mb-4">{error}</div>}
              <button onClick={startMatch} className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">CONTINUE TO MATCH</button>
              <button onClick={()=>setScreen('start')} className={`w-full mt-3 ${darkMode?'text-gray-400':'text-gray-600'} py-2`}>Go Back</button>
            </div>
          </div>
        </div>
      );

      if(screen==='join')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <button onClick={()=>setScreen('start')} className={`mb-6 ${darkMode?'text-gray-400':'text-gray-600'}`}>‚Üê Go Back</button>
              <h2 className="text-2xl font-bold mb-6">Join Match</h2>
              <div className="mb-6">
                <label className="block text-sm mb-2">Enter match code:</label>
                <input type="text" value={inputCode} onChange={e=>{setInputCode(e.target.value.toUpperCase());setError('')}} maxLength={8} placeholder="ABC123" className={`w-full px-4 py-4 border rounded-lg text-center text-2xl font-bold tracking-widest ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'}`}/>
              </div>
              {error&&<div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded mb-4 text-sm">{error}</div>}
              <button onClick={joinMatch} disabled={!(inputCode.length===6||(inputCode.length===8&&inputCode.endsWith('-V')))} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-4 rounded-xl font-bold text-lg shadow-lg">CONNECT</button>
            </div>
          </div>
        </div>
      );


      if(focusMode&&screen==='game'){
        const ft=focusMode==='home'?
          {name:sidesSwapped?awayName:homeName,score:sidesSwapped?totals.awayScore:totals.homeScore,saves:sidesSwapped?totals.awaySaves:totals.homeSaves,team:sidesSwapped?'away':'home',oppScore:sidesSwapped?totals.homeScore:totals.awayScore}:
          {name:sidesSwapped?homeName:awayName,score:sidesSwapped?totals.homeScore:totals.awayScore,saves:sidesSwapped?totals.homeSaves:totals.awaySaves,team:sidesSwapped?'home':'away',oppScore:sidesSwapped?totals.awayScore:totals.homeScore};
        const ot=focusMode==='home'?'away':'home';
        const on=focusMode==='home'?(sidesSwapped?homeName:awayName):(sidesSwapped?awayName:homeName);
        const os=focusMode==='home'?(sidesSwapped?totals.homeScore:totals.awayScore):(sidesSwapped?totals.awayScore:totals.homeScore);
        const otsv=ot==='home'?totals.homeSaves:totals.awaySaves;

return(
          <div className={`min-h-screen ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
            <audio ref={audioRefs.homeGoal} src="homeGoal.mp3"/>
            <audio ref={audioRefs.awayGoal} src="awayGoal.mp3"/>
            <audio ref={audioRefs.homePenalty} src="homePenalty.mp3"/>
            <audio ref={audioRefs.awayPenalty} src="awayPenalty.mp3"/>
            <audio ref={audioRefs.intro} src="intro.mp3"/>

            <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-3 shadow-lg`}>
              <div className="max-w-4xl mx-auto flex justify-between items-center">
                <div className="flex gap-2 items-center">
                  <span className="text-sm font-medium">Per:</span>
                  {[1,2,3].map(p=><button key={p} onClick={()=>{setCurrentPeriod(p);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:p})}} disabled={matchEnded||isViewer} className={`px-2 py-1 rounded text-sm font-bold ${currentPeriod===p?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>{p}</button>)}
                  {periodStats[4]&&<button onClick={()=>{setCurrentPeriod(4);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:4})}} disabled={matchEnded||isViewer} className={`px-2 py-1 rounded text-sm font-bold ${currentPeriod===4?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>OT</button>}
                  {!periodStats[4]&&currentPeriod===3&&(
                    <button
                      onClick={() => {
                        const updated = {...periodStats,4:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}};
                        setPeriodStats(updated);
                        setCurrentPeriod(4);
                        if (isMultiplayer && matchRef.current && !matchEnded) {
                          matchRef.current.update({periodStats:updated,currentPeriod:4});
                        }
                      }}
                      disabled={matchEnded||isViewer}
                      className={`px-2 py-1 rounded text-sm font-bold ${darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                    >
                      +OT
                    </button>
                  )}
                </div>
                <button
                  onClick={() => {
                    setFocusMode(null);
                    if (isViewer) {
                      setActiveTab('stats');
                    }
                  }} 
                  className={`${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-1`}
                >
                  <span className="text-lg">‚Üê</span>
                  <span className="hidden sm:inline">Exit</span>
                </button>
              </div>
            </div>

            <div className="max-w-4xl mx-auto p-3">
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-xl shadow-xl p-4`}>
                <div className={`text-lg font-semibold mb-3 text-center ${darkMode?'text-gray-200':'opacity-75'}`}>Goals</div>
                <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className={`${darkMode?'bg-gray-700':'bg-blue-50'} rounded-lg p-3`}>
                    <div className={`text-sm font-semibold text-center mb-2 ${darkMode?'text-gray-100':''}`}>{ft.name}</div>
                    <div className="flex items-center justify-center gap-2 mb-2">
                      <button onClick={()=>updateStat(ft.team,'Score',-1)} disabled={matchEnded||isViewer} className="bg-red-500 hover:bg-red-600 text-white w-12 h-12 rounded-lg text-2xl font-bold">‚àí</button>
                      <div className={`text-5xl font-bold text-center min-w-[80px] ${darkMode?'text-white':''} ${sparkleStats[`${ft.team}Score${currentPeriod}`]?'sparkle':''}`}>{ft.score}</div>
                      <button onClick={()=>updateStat(ft.team,'Score',1)} disabled={matchEnded||isViewer} className="bg-green-500 hover:bg-green-600 text-white w-12 h-12 rounded-lg text-2xl font-bold">+</button>
                    </div>
                    <div className={`text-xs text-center ${darkMode?'text-gray-300':'opacity-75'}`}>By period: {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][ft.team+'Score']}{i<arr.length-1?'-':''}</span>)}</div>
                  </div>
                  
                  <div className={`${darkMode?'bg-gray-700':'bg-red-50'} rounded-lg p-3`}>
                    <div className={`text-sm font-semibold text-center mb-2 ${darkMode?'text-gray-100':''}`}>{on}</div>
                    <div className="flex items-center justify-center gap-2 mb-2">
                      <button onClick={()=>updateStat(ot,'Score',-1)} disabled={matchEnded||isViewer} className="bg-red-500 hover:bg-red-600 text-white w-12 h-12 rounded-lg text-2xl font-bold">‚àí</button>
                      <div className={`text-5xl font-bold text-center min-w-[80px] ${darkMode?'text-white':''} ${sparkleStats[`${ot}Score${currentPeriod}`]?'sparkle':''}`}>{os}</div>
                      <button onClick={()=>updateStat(ot,'Score',1)} disabled={matchEnded||isViewer} className="bg-green-500 hover:bg-green-600 text-white w-12 h-12 rounded-lg text-2xl font-bold">+</button>
                    </div>
                    <div className={`text-xs text-center ${darkMode?'text-gray-300':'opacity-75'}`}>By period: {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][ot+'Score']}{i<arr.length-1?'-':''}</span>)}</div>
                  </div>
                </div>

                <div className={`pt-4 border-t-2 ${darkMode?'border-gray-600':'border-gray-200'}`}>
                  <div className={`text-lg font-semibold mb-3 text-center ${darkMode?'text-gray-200':'opacity-75'}`}>Saves</div>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <div className={`${darkMode?'bg-gray-700':'bg-blue-50'} rounded-lg p-3`}>
                      <div className={`text-sm font-semibold text-center mb-2 ${darkMode?'text-gray-100':''}`}>{ft.name}</div>
                      <div className="flex items-center justify-center gap-2 mb-2">
                        <button onClick={()=>updateStat(ft.team,'Saves',-1)} disabled={matchEnded||isViewer} className={`${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-red-500 hover:bg-red-600'} text-white w-12 h-12 rounded-lg text-2xl font-bold`}>‚àí</button>
                        <div className={`text-4xl font-bold text-center min-w-[80px] ${darkMode?'text-white':''} ${sparkleStats[`${ft.team}Saves${currentPeriod}`]?'sparkle':''}`}>{ft.saves}</div>
                        <button onClick={()=>updateStat(ft.team,'Saves',1)} disabled={matchEnded||isViewer} className={`${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-green-500 hover:bg-green-600'} text-white w-12 h-12 rounded-lg text-2xl font-bold`}>+</button>
                      </div>
                      <div className={`text-xs text-center mb-2 ${darkMode?'text-gray-300':'opacity-75'}`}>By period: {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][ft.team+'Saves']}{i<arr.length-1?'-':''}</span>)}</div>
                      <div className={`${darkMode?'bg-gray-600 text-gray-100':'bg-white'} rounded p-2 text-xs`}>
                        <div className="flex justify-between mb-1"><span>SOG:</span><span className="font-bold">{(() => {
                          const oppTeam = ft.team === 'home' ? 'away' : 'home';
                          return Object.keys(periodStats).reduce((sum,p)=>sum+(periodStats[p][oppTeam+'Saves']+periodStats[p][ft.team+'Score']),0);
                        })()}</span></div>
                        <div className={`text-center ${darkMode?'text-gray-300':'opacity-75'}`}>({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                          const oppTeam = ft.team === 'home' ? 'away' : 'home';
                          return periodStats[p][oppTeam+'Saves']+periodStats[p][ft.team+'Score'];
                        }).join('-')})</div>
                        <div className="flex justify-between mb-1 mt-2"><span>SA:</span><span className="font-bold">{(() => {
                          const oppTeam = ft.team === 'home' ? 'away' : 'home';
                          return Object.keys(periodStats).reduce((sum,p)=>sum+(periodStats[p][ft.team+'Saves']+periodStats[p][oppTeam+'Score']),0);
                        })()}</span></div>
                        <div className={`text-center ${darkMode?'text-gray-300':'opacity-75'}`}>({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                          const oppTeam = ft.team === 'home' ? 'away' : 'home';
                          return periodStats[p][ft.team+'Saves']+periodStats[p][oppTeam+'Score'];
                        }).join('-')})</div>
                        <div className={`flex justify-between mt-2 pt-2 border-t ${darkMode?'border-gray-500':''}`}><span>SVS %:</span><span className="font-bold">{calcSP(ft.saves,ft.oppScore)}%</span></div>
                      </div>
                    </div>
                    
                    <div className={`${darkMode?'bg-gray-700':'bg-red-50'} rounded-lg p-3`}>
                      <div className={`text-sm font-semibold text-center mb-2 ${darkMode?'text-gray-100':''}`}>{on}</div>
                      <div className="flex items-center justify-center gap-2 mb-2">
                        <button onClick={()=>updateStat(ot,'Saves',-1)} disabled={matchEnded||isViewer} className={`${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-red-500 hover:bg-red-600'} text-white w-12 h-12 rounded-lg text-2xl font-bold`}>‚àí</button>
                        <div className={`text-4xl font-bold text-center min-w-[80px] ${darkMode?'text-white':''} ${sparkleStats[`${ot}Saves${currentPeriod}`]?'sparkle':''}`}>{otsv}</div>
                        <button onClick={()=>updateStat(ot,'Saves',1)} disabled={matchEnded||isViewer} className={`${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-green-500 hover:bg-green-600'} text-white w-12 h-12 rounded-lg text-2xl font-bold`}>+</button>
                      </div>
                      <div className={`text-xs text-center mb-2 ${darkMode?'text-gray-300':'opacity-75'}`}>By period: {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][ot+'Saves']}{i<arr.length-1?'-':''}</span>)}</div>
                      <div className={`${darkMode?'bg-gray-600 text-gray-100':'bg-white'} rounded p-2 text-xs`}>
                        <div className="flex justify-between mb-1"><span>SOG:</span><span className="font-bold">{(() => {
                          const oppTeam = ot === 'home' ? 'away' : 'home';
                          return Object.keys(periodStats).reduce((sum,p)=>sum+(periodStats[p][oppTeam+'Saves']+periodStats[p][ot+'Score']),0);
                        })()}</span></div>
                        <div className={`text-center ${darkMode?'text-gray-300':'opacity-75'}`}>({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                          const oppTeam = ot === 'home' ? 'away' : 'home';
                          return periodStats[p][oppTeam+'Saves']+periodStats[p][ot+'Score'];
                        }).join('-')})</div>
                        <div className="flex justify-between mb-1 mt-2"><span>SA:</span><span className="font-bold">{(() => {
                          const oppTeam = ot === 'home' ? 'away' : 'home';
                          return Object.keys(periodStats).reduce((sum,p)=>sum+(periodStats[p][ot+'Saves']+periodStats[p][oppTeam+'Score']),0);
                        })()}</span></div>
                        <div className={`text-center ${darkMode?'text-gray-300':'opacity-75'}`}>({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                          const oppTeam = ot === 'home' ? 'away' : 'home';
                          return periodStats[p][ot+'Saves']+periodStats[p][oppTeam+'Score'];
                        }).join('-')})</div>
                        <div className={`flex justify-between mt-2 pt-2 border-t ${darkMode?'border-gray-500':''}`}><span>SVS %:</span><span className="font-bold">{calcSP(otsv,ft.score)}%</span></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }


return(
        <div className={`min-h-screen pb-20 ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          {isViewer&&<div className="bg-yellow-500 text-gray-900 px-4 py-2 text-center font-semibold text-sm">
             üëÅÔ∏è VIEWER MODE - live stats (read-only)
          </div>}
          <audio ref={audioRefs.homeGoal} src="homeGoal.mp3"/>
          <audio ref={audioRefs.awayGoal} src="awayGoal.mp3"/>
          <audio ref={audioRefs.homePenalty} src="homePenalty.mp3"/>
          <audio ref={audioRefs.awayPenalty} src="awayPenalty.mp3"/>
          <audio ref={audioRefs.intro} src="intro.mp3"/>

          <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-4 shadow-lg sticky top-0 z-50`}>
            <div className="max-w-6xl mx-auto">
              {isMultiplayer&&<div className="mb-3 flex items-center justify-between gap-2">
                <div className="flex items-center gap-2">
                  {!matchEnded&&<span className="flex items-center gap-1 bg-red-500 px-2 py-1 rounded-full text-xs font-bold animate-pulse"><span className="w-1.5 h-1.5 bg-white rounded-full"></span>LIVE</span>}
                  {matchEnded&&<span className="bg-gray-500 px-2 py-1 rounded-full text-xs font-bold">MATCH ENDED</span>}
                  <span className="text-xs">üë• {connectedUsers}</span>
                  {!isViewer&&viewerCount>0&&<span className="text-xs">üëÅÔ∏è {viewerCount}</span>}
                </div>
                <div className="flex items-center gap-1">
                  <button onClick={copyCode} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20'} px-2 py-1 rounded font-mono font-bold text-xs`}>{matchCode}</button>
          {!matchEnded && isCreator && !isViewer && (
            <button onClick={endMatch}
              className="bg-red-500 hover:bg-red-600 px-2 py-1 rounded text-xs font-semibold whitespace-nowrap"
              title="End match for all users (Creator only)"
            >
              End
            </button>
          )}
                  {!matchEnded && !isViewer && !isCreator && (
                    <button onClick={leaveMatch}
                      className="bg-orange-500 hover:bg-orange-600 px-2 py-1 rounded text-xs font-semibold whitespace-nowrap"
                      title="Leave this match"
                    >
                      Leave
                    </button>
                  )}
                </div>
              </div>}

              <div className="flex justify-between items-center mb-3">
                <div className="flex gap-2 items-center">
                  <span className="text-sm font-medium">Per:</span>
                  {[1,2,3].map(p=><button key={p} onClick={()=>{setCurrentPeriod(p);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:p})}} disabled={matchEnded||isViewer} className={`px-3 py-1 rounded font-bold ${currentPeriod===p?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>{p}</button>)}
                  {periodStats[4]&&<button onClick={()=>{setCurrentPeriod(4);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:4})}} disabled={matchEnded||isViewer} className={`px-3 py-1 rounded font-bold text-xs ${currentPeriod===4?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>OT</button>}
                  {!periodStats[4]&&currentPeriod===3&&(
                    <button
                      onClick={() => {
                        const updated = {...periodStats,4:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}};
                        setPeriodStats(updated);
                        setCurrentPeriod(4);
                        if (isMultiplayer && matchRef.current && !matchEnded) {
                          matchRef.current.update({periodStats:updated,currentPeriod:4});
                        }
                      }}
                      disabled={matchEnded||isViewer}
                      className={`px-3 py-1 rounded font-bold text-xs ${darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                    >
                      +OT
                    </button>
                  )}
                </div>
<div className="flex gap-2">
  {!isMultiplayer&&(
    <button onClick={exitToStart} className={`${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 rounded text-sm`}>
      ‚Üê
    </button>
  )}
  <button onClick={()=>setStatsCollapsed(!statsCollapsed)} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20'} px-3 py-1 rounded text-sm`}>{statsCollapsed?'‚ñº':'‚ñ≤'}</button>
  <button onClick={()=>setShowSettings(!showSettings)} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20'} px-3 py-1 rounded text-sm`}>‚öôÔ∏è</button>
</div>
              </div>

              {showSettings&&<div className={`${darkMode?'bg-gray-700 text-white':'bg-white text-gray-800'} rounded-lg p-4 mb-4 max-h-[70vh] overflow-y-auto`}>
                <div className="flex justify-between items-center mb-3">
                  <h3 className="font-bold">Settings</h3>
                  <button onClick={()=>setShowSettings(false)} className={`${darkMode?'text-gray-400':'text-gray-500'} text-2xl`}>√ó</button>
                </div>
                
<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
  
  {!isViewer && (
    <div className="space-y-3">
      <h4 className={`text-sm font-semibold mb-2 pb-2 border-b ${darkMode?'border-gray-600':'border-gray-200'}`}>Match Settings</h4>
      <div>
        <label className="block text-sm mb-1">Home Team</label>
        <div className="flex gap-2">
          <input type="text" value={homeName} onChange={e=>{setHomeName(e.target.value);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({homeName:e.target.value})}} disabled={matchEnded||isViewer} className={`flex-1 px-3 py-2 border rounded ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
          <button onClick={()=>setHomeName('')} disabled={matchEnded||isViewer} className={`px-3 py-2 rounded text-sm ${darkMode?'bg-gray-600':'bg-gray-200'}`}>Clear</button>
        </div>
      </div>
      <div>
        <label className="block text-sm mb-1">Away Team</label>
        <div className="flex gap-2">
          <input type="text" value={awayName} onChange={e=>{setAwayName(e.target.value);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({awayName:e.target.value})}} disabled={matchEnded||isViewer} className={`flex-1 px-3 py-2 border rounded ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
          <button onClick={()=>setAwayName('')} disabled={matchEnded||isViewer} className={`px-3 py-2 rounded text-sm ${darkMode?'bg-gray-600':'bg-gray-200'}`}>Clear</button>
        </div>
      </div>
      <label className="flex items-center justify-between py-2">
        <span className="text-sm">Swap Sides</span>
        <input type="checkbox" checked={sidesSwapped} onChange={e=>{setSidesSwapped(e.target.checked);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({sidesSwapped:e.target.checked})}} disabled={matchEnded||isViewer} className="w-5 h-5"/>
      </label>

<button
  onClick={async () => {
    const email = prompt('Admin email:');
    if (!email) return;
    
    const password = prompt('Admin password:');
    if (!password) return;
    
    try {
      await auth.signInWithEmailAndPassword(email, password);
      setScreen('admin');
    } catch (error) {
      if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
        alert('Wrong email or password');
      } else {
        alert('Login failed: ' + error.message);
      }
    }
  }}
  className={`w-full flex items-center justify-between px-4 py-3 rounded-lg font-semibold ${
    darkMode
      ? 'bg-gray-700 hover:bg-gray-600 text-white'
      : 'bg-gray-100 hover:bg-gray-200 text-gray-800'
  }`}
>
  <span>Admin</span>
  <span>üîí</span>
</button>

      <button onClick={resetCounters} disabled={matchEnded||isViewer} className={`w-full ${darkMode?'bg-red-900 bg-opacity-40 hover:bg-opacity-60 border border-red-700 text-red-200':'bg-red-50 hover:bg-red-100 border border-red-300 text-gray-900'} py-2 rounded text-sm font-semibold`}>
        Reset All Stats
      </button>
    </div>
  )}
  
  <div className="space-y-3">
    <h4 className={`text-sm font-semibold mb-2 pb-2 border-b ${darkMode?'border-gray-600':'border-gray-200'}`}>My Preferences</h4>
    <label className="flex items-center justify-between py-2">
      <span className="text-sm">Dark Mode</span>
      <input type="checkbox" checked={darkMode} onChange={e=>setDarkMode(e.target.checked)} className="w-5 h-5"/>
    </label>
    <label className="flex items-center justify-between py-2">
      <span className="text-sm">Keep Screen On</span>
      <input type="checkbox" checked={keepScreenOn} onChange={e=>setKeepScreenOn(e.target.checked)} className="w-5 h-5"/>
    </label>
  </div>
</div>

                <div className="space-y-3 mt-4 pt-4 border-t">
                  <div>
                    <label className="block text-sm mb-2 font-semibold">Spotify Playlist URL</label>
                    <div className="flex gap-2">
                      <input type="text" value={spotifyPlaylist} onChange={e=>{setSpotifyPlaylist(e.target.value);setSpotifyLoaded(false)}} placeholder="https://open.spotify.com/playlist/..." className={`flex-1 px-3 py-2 border rounded text-sm ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
                      <button onClick={()=>{setSpotifyPlaylist('https://open.spotify.com/playlist/3HunXm4QT4dxcOz6eAljak?si=mKiXLeNMQM6ioJivpWP-EQ&pi=lAZXLD_QSPmpq');setSpotifyLoaded(false)}} className={`px-3 py-2 rounded text-sm whitespace-nowrap ${darkMode?'bg-gray-600':'bg-gray-200'}`}>Restore</button>
                    </div>
                  </div>
                  <div>
  <label className="block text-sm mb-2 font-semibold">External Link</label>
  <input type="text" value={externalLinkTitle} onChange={e=>setExternalLinkTitle(e.target.value)} placeholder="Club Rules" className={`w-full px-3 py-2 border rounded text-sm mb-2 ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
  <input type="text" value={externalLinkUrl} onChange={e=>setExternalLinkUrl(e.target.value)} placeholder="https://..." className={`w-full px-3 py-2 border rounded text-sm ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
</div>

<div>
  <label className="block text-sm mb-2 font-semibold">Default Home Team Roster</label>
  <input 
    type="text" 
    inputMode="decimal"
    value={defaultHomeRoster} 
    onChange={e=>setDefaultHomeRoster(e.target.value)} 
    placeholder="e.g. 2,3,4,7,9" 
    className={`w-full px-3 py-2 border rounded text-sm ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}
  />
  <p className={`text-xs mt-1 ${darkMode?'text-gray-400':'text-gray-500'}`}>
    Comma or space separated player numbers
  </p>
</div>
                  




{isMultiplayer && !isViewer && !isCreator && (
                    <div className="pt-4 border-t">
                     





		    <button
                        onClick={leaveMatch}
                        className="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 rounded text-sm font-semibold"
                      >
                        Leave Multiplayer Match
                      </button>

                    </div>
                  )}
                </div>
              </div>}

<div className="grid grid-cols-2 gap-4 mb-3">
                {[
                  {name:sidesSwapped?awayName:homeName,score:sidesSwapped?totals.awayScore:totals.homeScore,saves:sidesSwapped?totals.awaySaves:totals.homeSaves,team:sidesSwapped?'away':'home',oppScore:sidesSwapped?totals.homeScore:totals.awayScore,oppShots:sidesSwapped?(totals.homeSaves+totals.awayScore):(totals.awaySaves+totals.homeScore)},
                  {name:sidesSwapped?homeName:awayName,score:sidesSwapped?totals.homeScore:totals.awayScore,saves:sidesSwapped?totals.homeSaves:totals.awaySaves,team:sidesSwapped?'home':'away',oppScore:sidesSwapped?totals.awayScore:totals.homeScore,oppShots:sidesSwapped?(totals.awaySaves+totals.homeScore):(totals.homeSaves+totals.awayScore)}
                ].map((tm,idx)=>(
                  <div key={idx} className={`${darkMode?'bg-gray-700 border border-gray-600':'bg-white bg-opacity-10'} rounded-lg p-3`}>
                    <div className="text-sm font-semibold mb-2">{tm.name}</div>
                    <div className="mb-3">
                      <div className="text-xs opacity-75 mb-1">Goals</div>
                      <div className="flex items-center justify-center gap-2">
                        <button onClick={()=>updateStat(tm.team,'Score',-1)} disabled={matchEnded||isViewer} className="bg-red-500 bg-opacity-50 w-10 h-10 rounded flex items-center justify-center text-xl font-bold">‚àí</button>
                        <div className={`text-3xl font-bold w-16 text-center ${sparkleStats[`${tm.team}Score${currentPeriod}`]?'sparkle':''}`}>{tm.score}</div>
                        <button onClick={()=>updateStat(tm.team,'Score',1)} disabled={matchEnded||isViewer} className="bg-green-500 bg-opacity-50 w-10 h-10 rounded flex items-center justify-center text-xl font-bold">+</button>
                      </div>
                      {!statsCollapsed&&<div className="text-xs opacity-75 mt-1 text-center">By period: ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][tm.team+'Score']}{i<arr.length-1?'-':''}</span>)})</div>}
                    </div>
                    <div className={`pt-2 border-t ${darkMode?'border-gray-600':'border-white border-opacity-20'}`}>
                      <div className="text-xs opacity-75 mb-1">Saves</div>
                      <div className="flex items-center justify-center gap-2">
                        <button onClick={()=>updateStat(tm.team,'Saves',-1)} disabled={matchEnded||isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold">‚àí</button>
                        <div className={`text-3xl font-bold w-16 text-center ${sparkleStats[`${tm.team}Saves${currentPeriod}`]?'sparkle':''}`}>{tm.saves}</div>
                        <button onClick={()=>updateStat(tm.team,'Saves',1)} disabled={matchEnded||isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold">+</button>
                      </div>
                      {!statsCollapsed&&<div className={`${darkMode?'bg-gray-600':'bg-white bg-opacity-10'} rounded p-2 text-xs opacity-75 text-center mt-2`}>
                        <div>SOG {tm.oppShots} ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>(periodStats[p][(tm.team==='home'?'away':'home')+'Saves']+periodStats[p][tm.team+'Score'])).join('-')})</div>
                        <div>SA {tm.saves+tm.oppScore} ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>(periodStats[p][tm.team+'Saves']+periodStats[p][(tm.team==='home'?'away':'home')+'Score'])).join('-')})</div>
                        <div>SVS% {calcSP(tm.saves,tm.oppScore)}% ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>calcSP(periodStats[p][tm.team+'Saves'],periodStats[p][(tm.team==='home'?'away':'home')+'Score'])).join('-')})</div>
                      </div>}
                    </div>
                  </div>
                ))}
              </div>

              <div className="grid grid-cols-2 gap-3">
                {!isViewer&&<button onClick={()=>{setFocusMode('home');setActiveTab('stats')}} className={`${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-500 bg-opacity-80 hover:bg-opacity-100'} py-2 rounded text-sm font-semibold`}>‚õ∂ Goalie Focus</button>}
                {!isViewer&&<button onClick={()=>setShowPlayerStats(true)} className={`${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-500 bg-opacity-80 hover:bg-opacity-100'} py-2 rounded text-sm font-semibold`}>‚õ∂ Skater Focus</button>}
              </div>
            </div>
          </div>


          <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-white'} shadow-md sticky top-48 z-40`}>
            <div className="max-w-6xl mx-auto flex">
              {(isViewer?['stats']:['stats','audio','referee',...(externalLinkUrl?['external']:[])]).map(tab=>(
                <button key={tab} onClick={()=>setActiveTab(tab)} className={`flex-1 py-3 font-semibold text-sm ${activeTab===tab?(darkMode?'bg-blue-700 text-white':'bg-blue-600 text-white'):(darkMode?'bg-gray-700 text-gray-300':'bg-gray-100 text-gray-600')}`}>
                  {tab==='audio'?'Audio':tab==='stats'?'Stats':tab==='referee'?'Referee':externalLinkTitle||'Link'}
                </button>
              ))}
            </div>
          </div>

          <div className="max-w-6xl mx-auto p-4">
            {activeTab==='audio'&&<div>
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-3 mb-3`}>
                <button onClick={toggleIntro} className={`w-full ${introPlaying?(darkMode?'bg-green-700 hover:bg-green-600':'bg-green-600 hover:bg-green-700'):(darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-100 hover:bg-gray-200')} ${darkMode&&!introPlaying?'text-gray-200':'text-white'} ${!darkMode&&!introPlaying?'text-gray-800':''} py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2`}>
                  {introPlaying?<>
                    <div className="flex items-end gap-0.5 h-4">
                      <div className="eq-bar w-1 bg-white rounded-full"></div>
                      <div className="eq-bar w-1 bg-white rounded-full"></div>
                      <div className="eq-bar w-1 bg-white rounded-full"></div>
                    </div>
                    <span>Pause Intro</span>
                  </>:'‚ñ∂ Play Intro'}
                </button>
              </div>

              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-3 mb-3`}>
                <h3 className={`text-xs font-semibold mb-2 ${darkMode?'text-white':''}`}>üö® Goal</h3>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    {
                      sound: 'homeGoal',
                      label: homeName,
                      bg: darkMode ? 'bg-blue-900 bg-opacity-40' : 'bg-blue-50',
                      hover: darkMode ? 'hover:bg-blue-900 hover:bg-opacity-60' : 'hover:bg-blue-100',
                      text: darkMode ? 'text-blue-200' : 'text-gray-800',
                      border: darkMode ? 'border-blue-700' : 'border-blue-200'
                    },
                    {
                      sound: 'awayGoal',
                      label: awayName,
                      bg: darkMode ? 'bg-red-900 bg-opacity-40' : 'bg-red-50',
                      hover: darkMode ? 'hover:bg-red-900 hover:bg-opacity-60' : 'hover:bg-red-100',
                      text: darkMode ? 'text-red-200' : 'text-gray-800',
                      border: darkMode ? 'border-red-700' : 'border-red-200'
                    }
                  ].map(btn => (
                    <button
                      key={btn.sound}
                      onClick={() => playSound(btn.sound)}
                      className={`${btn.bg} ${btn.hover} ${btn.text} border ${btn.border} py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2`}
                    >
                      {btn.label}
                      {playingSound === btn.sound && <SoundEQ />}
                    </button>
                  ))}
                </div>
              </div>

              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-3 mb-3`}>
                <h3 className={`text-xs font-semibold mb-2 ${darkMode?'text-white':''}`}>Penalty</h3>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    {
                      sound: 'homePenalty',
                      label: homeName,
                      bg: darkMode ? 'bg-blue-900 bg-opacity-30' : 'bg-blue-50',
                      hover: darkMode ? 'hover:bg-blue-900 hover:bg-opacity-50' : 'hover:bg-blue-100',
                      text: darkMode ? 'text-blue-200' : 'text-gray-900',
                      border: darkMode ? 'border-blue-700' : 'border-blue-300'
                    },
                    {
                      sound: 'awayPenalty',
                      label: awayName,
                      bg: darkMode ? 'bg-red-900 bg-opacity-30' : 'bg-red-50',
                      hover: darkMode ? 'hover:bg-red-900 hover:bg-opacity-50' : 'hover:bg-red-100',
                      text: darkMode ? 'text-red-200' : 'text-gray-900',
                      border: darkMode ? 'border-red-700' : 'border-red-200'
                    }
                  ].map(btn => (
                    <button
                      key={btn.sound}
                      onClick={() => playSound(btn.sound)}
                      className={`${btn.bg} ${btn.hover} ${btn.text} border ${btn.border} py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2`}
                    >
                      {btn.label}
                      {playingSound === btn.sound && <SoundEQ />}
                    </button>
                  ))}
                </div>
              </div>

              <button onClick={stopAllSounds} className={`w-full ${darkMode?'bg-red-900 bg-opacity-40 hover:bg-red-900 hover:bg-opacity-60 border-2 border-red-700 text-red-200':'bg-red-50 hover:bg-red-100 border-2 border-red-300 text-gray-900'} py-2 rounded-lg font-semibold mb-3 transition-colors`}>
                Stop All Sounds
              </button>

              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-3`}>
                {!spotifyLoaded&&!spotifyLoading?<button onClick={loadSpotify} className={`w-full ${darkMode?'bg-green-700 hover:bg-green-600':'bg-green-600 hover:bg-green-700'} text-white py-8 rounded-lg font-semibold text-lg transition-colors`}>‚ñ∂ Load Spotify</button>:spotifyLoading?<div className={`py-8 text-center ${darkMode?'text-gray-300':'text-gray-600'}`}><div className="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-2"></div><div>Loading...</div></div>:<div style={{opacity:0,animation:'fadeIn 0.5s ease-in forwards'}}>{getSpotifyUrl(spotifyPlaylist)?<iframe style={{borderRadius:'12px'}} src={getSpotifyUrl(spotifyPlaylist)} width="100%" height="352" frameBorder="0" allowFullScreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>:<div className={`text-center py-8 ${darkMode?'text-gray-300':'text-gray-600'}`}>Invalid Spotify URL. Please check Settings.</div>}</div>}
              </div>
            </div>}


{activeTab==='stats'&&<div>
              {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                p=parseInt(p);
                const ps=periodStats[p];
                
                const renderTeamStats=(team)=>{
                  const isHome=team==='home';
                  const name=isHome?homeName:awayName;
                  const score=ps[team+'Score'];
                  const saves=ps[team+'Saves'];
                  const oppTeam=isHome?'away':'home';
                  const oppScore=ps[oppTeam+'Score'];
                  const shotsFor=ps[oppTeam+'Saves']+score;
                  const shotsAgainst=saves+oppScore;
                  const color=darkMode?(isHome?'bg-blue-900 bg-opacity-30 border-blue-700':'bg-red-900 bg-opacity-30 border-red-700'):(isHome?'bg-blue-50':'bg-red-50');
                  
                  return(
                    <div className={`${color} ${darkMode?'border':''} rounded p-3`}>
                      <div className={`font-semibold mb-2 ${darkMode?'text-white':''}`}>{name}</div>
                      <div className={`text-sm space-y-1 ${darkMode?'text-gray-300':'text-gray-700'}`}>
                        <div className="flex justify-between"><span>Goals:</span><span className="font-bold">{score}</span></div>
                        <div className="flex justify-between"><span>SOG:</span><span className="font-bold">{shotsFor}</span></div>
                        <div className="flex justify-between"><span>Saves:</span><span className="font-bold">{saves}</span></div>
                        <div className="flex justify-between"><span>SA:</span><span className="font-bold">{shotsAgainst}</span></div>
                        <div className="flex justify-between border-t pt-1"><span>SVS %:</span><span className="font-bold">{calcSP(saves,oppScore)}%</span></div>
                      </div>
                    </div>
                  );
                };
                
                return(
                  <div key={p} className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-4 mb-4`}>
                    <div className="flex justify-between items-center mb-3">
                      <h3 className={`text-xl font-bold ${darkMode?'text-white':''}`}>{p<=3?`Period ${p}`:`OT`}</h3>
                      {currentPeriod===p&&<span className="bg-yellow-400 text-blue-900 px-3 py-1 rounded text-sm font-bold">Current</span>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      {renderTeamStats('home')}
                      {renderTeamStats('away')}
                    </div>
                    
                    {(playerStats.home?.players||playerStats.away?.players)&&(()=>{
                      const homePlayers=playerStats.home?.players||{};
                      const awayPlayers=playerStats.away?.players||{};
                      const hasPlayersWithData=Object.keys(homePlayers).some(pNum=>homePlayers[pNum]?.periods?.[p])||
                                                Object.keys(awayPlayers).some(pNum=>awayPlayers[pNum]?.periods?.[p]);
                      
                      if(!hasPlayersWithData)return null;
                      
                      return(
                        <div className="mt-4 pt-4 border-t">
                          <button
                            onClick={()=>setExpandedPlayerStats(prev=>({...prev,[p]:!prev[p]}))}
                            className={`w-full text-left font-semibold text-sm ${darkMode?'bg-gray-700 text-gray-200':'bg-gray-100 text-gray-800'} px-3 py-2 rounded flex items-center justify-between`}
                          >
                            <span>Player Statistics</span>
                            <span>{expandedPlayerStats[p]?'‚ñ≤':'‚ñº'}</span>
                          </button>
                          
                          {expandedPlayerStats[p]&&(
                            <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                              {['home','away'].map(team=>{
                                const teamName=team==='home'?homeName:awayName;
                                const players=playerStats[team]?.players||{};
                                const playerNums=Object.keys(players).filter(pNum=>players[pNum]?.periods?.[p]).sort((a,b)=>parseInt(a)-parseInt(b));
                                
                                if(playerNums.length===0)return null;
                                
                                return(
                                  <div key={team} className={`${darkMode?'bg-gray-700':'bg-gray-50'} rounded p-3`}>
                                    <div className={`font-semibold mb-2 ${darkMode?'text-white':''}`}>{teamName}</div>
                                    <div className="overflow-x-auto">
                                      <table className="w-full text-xs">
                                        <thead>
                                          <tr className={`${darkMode?'text-gray-400':'text-gray-600'}`}>
                                            <th className="text-left">#</th>
                                            <th className="text-center">G</th>
                                            <th className="text-center">A</th>
                                            <th className="text-center">+</th>
                                            <th className="text-center">-</th>
                                            <th className="text-center">FO+</th>
                                            <th className="text-center">FO-</th>
                                            <th className="text-center">SOG</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {playerNums.map(pNum=>{
                                            const pStats=players[pNum].periods[p];
                                            return(
                                              <tr key={pNum} className={`border-t ${darkMode?'border-gray-600':'border-gray-200'}`}>
                                                <td className="font-bold py-1">{pNum}</td>
                                                <td className="text-center">{pStats?.['G']||0}</td>
                                                <td className="text-center">{pStats?.['A']||0}</td>
                                                <td className="text-center">{pStats?.['OnIce+']||0}</td>
                                                <td className="text-center">{pStats?.['OnIce-']||0}</td>
                                                <td className="text-center">{pStats?.['FO+']||0}</td>
                                                <td className="text-center">{pStats?.['FO-']||0}</td>
                                                <td className="text-center">{pStats?.['SOG']||0}</td>
                                              </tr>
                                            );
                                          })}
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                );
              })}

<div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-4 mb-4`}>
                <div className="flex justify-between items-center mb-3">
                  <h3 className={`text-xl font-bold ${darkMode?'text-white':''}`}>FINAL</h3>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  {['home','away'].map(team=>{
                    const name=team==='home'?homeName:awayName;
                    const score=team==='home'?totals.homeScore:totals.awayScore;
                    const saves=team==='home'?totals.homeSaves:totals.awaySaves;
                    const oppTeam=team==='home'?'away':'home';
                    const oppScore=team==='home'?totals.awayScore:totals.homeScore;
                    const shotsFor=(team==='home'?totals.awaySaves:totals.homeSaves)+score;
                    const shotsAgainst=saves+oppScore;
                    const color=darkMode?(team==='home'?'bg-blue-900 bg-opacity-30 border-blue-700':'bg-red-900 bg-opacity-30 border-red-700'):(team==='home'?'bg-blue-50':'bg-red-50');
                    
                    return(
                      <div key={team} className={`${color} ${darkMode?'border':''} rounded p-3`}>
                        <div className={`font-semibold mb-2 ${darkMode?'text-white':''}`}>{name}</div>
                        <div className={`text-sm space-y-1 ${darkMode?'text-gray-300':'text-gray-700'}`}>
                          <div className="flex justify-between"><span>Goals:</span><span className="font-bold text-lg">{score}</span></div>
                          <div className="flex justify-between"><span>SOG:</span><span className="font-bold">{shotsFor}</span></div>
                          <div className="flex justify-between"><span>Saves:</span><span className="font-bold">{saves}</span></div>
                          <div className="flex justify-between"><span>SA:</span><span className="font-bold">{shotsAgainst}</span></div>
                          <div className="flex justify-between border-t pt-1"><span>SVS %:</span><span className="font-bold">{calcSP(saves,oppScore)}%</span></div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                
                {(playerStats.home?.players||playerStats.away?.players)&&(()=>{
                  const homePlayers=playerStats.home?.players||{};
                  const awayPlayers=playerStats.away?.players||{};
                  
                  if(Object.keys(homePlayers).length===0&&Object.keys(awayPlayers).length===0)return null;
                  
                  return(
                    <div className="mt-4 pt-4 border-t">
                      <button
                        onClick={()=>setExpandedPlayerStats(prev=>({...prev,total:!prev.total}))}
                        className={`w-full text-left font-semibold text-sm ${darkMode?'bg-gray-700 text-gray-200':'bg-gray-100 text-gray-800'} px-3 py-2 rounded flex items-center justify-between mb-3`}
                      >
                        <span>Total Player Statistics</span>
                        <span>{expandedPlayerStats.total?'‚ñ≤':'‚ñº'}</span>
                      </button>
                      
                      {expandedPlayerStats.total&&(
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          {['home','away'].map(team=>{
                            const teamName=team==='home'?homeName:awayName;
                            const players=playerStats[team]?.players||{};
                            const playerNums=Object.keys(players).sort((a,b)=>parseInt(a)-parseInt(b));
                            
                            if(playerNums.length===0)return null;
                            
                            return(
                              <div key={team} className={`${darkMode?'bg-gray-700':'bg-gray-50'} rounded p-3`}>
                                <div className={`font-semibold mb-2 ${darkMode?'text-white':''}`}>{teamName}</div>
                                <div className="overflow-x-auto">
                                  <table className="w-full text-xs">
                                    <thead>
                                      <tr className={`${darkMode?'text-gray-400':'text-gray-600'}`}>
                                        <th className="text-left">#</th>
                                        <th className="text-center">G</th>
                                        <th className="text-center">A</th>
                                        <th className="text-center">+</th>
                                        <th className="text-center">-</th>
                                        <th className="text-center">FO+</th>
                                        <th className="text-center">FO-</th>
                                        <th className="text-center">SOG</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {playerNums.map(pNum=>{
                                        const pStats=players[pNum].total;
                                        return(
                                          <tr key={pNum} className={`border-t ${darkMode?'border-gray-600':'border-gray-200'}`}>
                                            <td className="font-bold py-1">{pNum}</td>
                                            <td className="text-center">{pStats?.['G']??0}</td>
                                            <td className="text-center">{pStats?.['A']??0}</td>
                                            <td className="text-center">{pStats?.['OnIce+']??0}</td>
                                            <td className="text-center">{pStats?.['OnIce-']??0}</td>
                                            <td className="text-center">{pStats?.['FO+']??0}</td>
                                            <td className="text-center">{pStats?.['FO-']??0}</td>
                                            <td className="text-center">{pStats?.['SOG']??0}</td>
                                          </tr>
                                        );
                                      })}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>

              <div className="grid grid-cols-3 gap-3 mt-4">
                <button onClick={copyStats} className={`${darkMode?'bg-gray-800 border-gray-600 text-white':'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>Copy Stats</button>
                <button onClick={downloadCSV} className={`${darkMode?'bg-gray-800 border-gray-600 text-white':'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>Export CSV</button>
                <button onClick={shareStats} className={`${darkMode?'bg-gray-800 border-gray-600 text-white':'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>Share</button> 
              </div>
              
            </div>}

            {activeTab==='referee'&&<div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {refSigs.map((sig,i)=>(
                  <div key={i} className={`${darkMode?'bg-gray-800 border border-gray-600':'bg-gray-100 border-1 border-gray-200'} rounded-sm p-4 shadow`}>
                    <h3 className={`text-lg font-bold mb-2 ${darkMode?'text-white':''}`}>{sig.name}</h3>
                    <p className={`${darkMode?'text-gray-300':'text-gray-700'}`}>{sig.description}</p>
                  </div>
                ))}
              </div>
            </div>}

            {activeTab==='external'&&externalLinkUrl&&<div>
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow overflow-hidden`}>
                <iframe src={externalLinkUrl} className="w-full" style={{height:'70vh',border:'none'}} title={externalLinkTitle||'External Link'}></iframe>
              </div>
            </div>}
          </div>
        </div>
      );
    };

    ReactDOM.render(<JuniorLeagueApp/>,document.getElementById('root'));
  </script>
</body>
</html>

