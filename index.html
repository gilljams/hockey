<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hockey Scorekeeper</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-39HWBJQ5Z1"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-39HWBJQ5Z1');</script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes sparkle{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.8}}
    .sparkle{animation:sparkle .6s ease-in-out}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const {useState,useRef,useEffect}=React;
    
    const firebaseConfig={
      apiKey:"AIzaSyBFO04MS1hfTnE_ciPxTJCXO_Jk1w8DudY",
      authDomain:"hockey-scorekeeper.firebaseapp.com",
      databaseURL:"https://hockey-scorekeeper-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"hockey-scorekeeper",
      storageBucket:"hockey-scorekeeper.firebasestorage.app",
      messagingSenderId:"804304791634",
      appId:"1:804304791634:web:98532061d3768f6b8c178b"
    };

    let db=null;
    try{
      if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
      db=firebase.database();
    }catch(e){console.log("Firebase error:",e)}

    const translations={
      en:{
        homeTeam:'HOME TEAM',awayTeam:'AWAY TEAM',period:'Period',overtime:'OT',settings:'Settings',
        swapSides:'Swap Sides',darkMode:'Dark Mode',goals:'Goals',byPeriod:'By period',
        saves:'Saves',shotsFor:'Shots For',shotsAgainst:'Shots Against',savePercent:'Save %',
        resetAllStats:'Reset All Stats',audio:'Audio',stats:'Stats',referee:'Referee',
        goal:'Goal',penalty:'Penalty',stopAllSounds:'Stop All Sounds',intro:'Intro',
        final:'FINAL',copyStats:'Copy Stats',share:'Share',resetConfirm:'Reset all stats?',
        statsCopied:'Stats copied!',copyFailed:'Failed to copy',gameReport:'Game Report',
        periodBreakdown:'PERIOD BREAKDOWN',goalieStats:'GOALIE STATS',
        shotsAgainstShort:'shots against',clear:'Clear',language:'Language',
        spotifyPlaylistUrl:'Spotify Playlist URL',restore:'Restore',focusMode:'Focus Mode',
        keepScreenOn:'Keep Screen On',createMatch:'CREATE NEW MATCH',joinMatch:'JOIN MATCH',
        continueAlone:'Or continue alone',newMatch:'New Match',startMatch:'START MATCH',
        matchCreated:'Match Created!',shareCode:'Share this code:',copy:'Copy',
        continueToMatch:'CONTINUE TO MATCH',enterCode:'Enter match code:',connect:'CONNECT',
        matchCode:'Match Code',connected:'connected',liveMatch:'LIVE',endMatch:'End Match',
        endMatchConfirm:'End match for all users?',matchEnded:'MATCH ENDED',
        startNewMatch:'Start New Match',matchNotFound:'No match found with that code',
        matchAlreadyEnded:'This match has already ended',goBack:'Go Back',
        reconnectPrompt:'Reconnect to match',reconnect:'Reconnect',startNew:'Start New',
        externalLink:'External Link',externalLinkUrl:'External Link URL',
        externalLinkTitle:'External Link Title',externalLinkTab:'Link',
        offside:'Offside',tripping:'Tripping',holding:'Holding',highSticking:'High Sticking',
        slashing:'Slashing',icing:'Icing',noGoal:'No Goal',timeOut:'Time Out',
        penaltyShot:'Penalty Shot',armRaised:'Arm raised straight up',
        strikeLeg:'Strike leg with hand',claspWrist:'Clasping wrist',
        twoHandsHigh:'Two hands held high',choppingMotion:'Chopping motion',
        armsCrossedChest:'Arms crossed at chest',armsPointedGoal:'Both arms pointed at goal',
        armsCrossedHead:'Arms crossed overhead',handsFormingT:'Hands forming T',
        armsCrossedPointed:'Arms crossed then pointed'
      },
      sv:{
        homeTeam:'HEMMALAG',awayTeam:'BORTALAG',period:'Period',overtime:'F√ñ',settings:'Inst√§llningar',
        swapSides:'Byt Sidor',darkMode:'M√∂rkt L√§ge',goals:'M√•l',byPeriod:'Per period',
        saves:'R√§ddningar',shotsFor:'Skott F√∂r',shotsAgainst:'Skott Mot',
        savePercent:'R√§ddnings %',resetAllStats:'Nollst√§ll All Statistik',audio:'Ljud',
        stats:'Statistik',referee:'Domare',goal:'M√•l',penalty:'Utvisning',
        stopAllSounds:'Stoppa Alla Ljud',intro:'Intro',final:'SLUTRESULTAT',
        copyStats:'Kopiera Statistik',share:'Dela',resetConfirm:'Nollst√§ll all statistik?',
        statsCopied:'Statistik kopierad!',copyFailed:'Misslyckades kopiera',
        gameReport:'Matchrapport',periodBreakdown:'PERIODSAMMANFATTNING',
        goalieStats:'M√ÖLVAKTSSTATISTIK',shotsAgainstShort:'skott mot',clear:'Rensa',
        language:'Spr√•k',spotifyPlaylistUrl:'Spotify Spellista URL',restore:'√Öterst√§ll',
        focusMode:'Fokusl√§ge',keepScreenOn:'H√•ll Sk√§rmen P√•',createMatch:'SKAPA NY MATCH',
        joinMatch:'G√Ö MED I MATCH',continueAlone:'Eller forts√§tt ensam',newMatch:'Ny Match',
        startMatch:'STARTA MATCH',matchCreated:'Match Skapad!',shareCode:'Dela denna kod:',
        copy:'Kopiera',continueToMatch:'FORTS√ÑTT TILL MATCH',enterCode:'Ange matchkod:',
        connect:'ANSLUT',matchCode:'Matchkod',connected:'anslutna',liveMatch:'LIVE',
        endMatch:'Avsluta Match',endMatchConfirm:'Avsluta matchen f√∂r alla anv√§ndare?',
        matchEnded:'MATCH AVSLUTAD',startNewMatch:'Starta Ny Match',
        matchNotFound:'Ingen match hittades med den koden',
        matchAlreadyEnded:'Denna match √§r redan avslutad',goBack:'G√• Tillbaka',
        reconnectPrompt:'√Öteranslut till match',reconnect:'√Öteranslut',startNew:'Starta Ny',
        externalLink:'Extern L√§nk',externalLinkUrl:'Extern L√§nk URL',
        externalLinkTitle:'Extern L√§nk Titel',externalLinkTab:'L√§nk',
        offside:'Offside',tripping:'Tripping',holding:'Holding',highSticking:'High Sticking',
        slashing:'Slashing',icing:'Icing',noGoal:'Inget M√•l',timeOut:'Time Out',
        penaltyShot:'Straff',armRaised:'Arm rakt upp',strikeLeg:'Sl√• benet med handen',
        claspWrist:'H√•lla handleden',twoHandsHigh:'Tv√• h√§nder h√∂gt upp',
        choppingMotion:'Huggande r√∂relse',armsCrossedChest:'Armar korsade vid br√∂stet',
        armsPointedGoal:'B√•da armarna mot m√•let',armsCrossedHead:'Armar korsade √∂ver huvudet',
        handsFormingT:'H√§nder formar T',armsCrossedPointed:'Armar korsade sedan pekande'
      }
    };

    const genCode=()=>Array(6).fill(0).map(()=>'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()*33)]).join('');

    const JuniorLeagueApp=()=>{
      const [activeTab,setActiveTab]=useState('audio');
      const [currentPeriod,setCurrentPeriod]=useState(1);
      const [homeName,setHomeName]=useState('HOME TEAM');
      const [awayName,setAwayName]=useState('AWAY TEAM');
      const [sidesSwapped,setSidesSwapped]=useState(false);
      const [showSettings,setShowSettings]=useState(false);
      const [darkMode,setDarkMode]=useState(false);
      const [statsCollapsed,setStatsCollapsed]=useState(false);
      const [focusMode,setFocusMode]=useState(null);
      const [language,setLanguage]=useState('en');
      const [spotifyLoaded,setSpotifyLoaded]=useState(false);
      const [spotifyLoading,setSpotifyLoading]=useState(false);
      const [spotifyPlaylist,setSpotifyPlaylist]=useState('https://open.spotify.com/playlist/3HunXm4QT4dxcOz6eAljak?si=mKiXLeNMQM6ioJivpWP-EQ&pi=lAZXLD_QSPmpq');
      const [keepScreenOn,setKeepScreenOn]=useState(false);
      const [wakeLock,setWakeLock]=useState(null);
      const [externalLinkUrl,setExternalLinkUrl]=useState('');
      const [externalLinkTitle,setExternalLinkTitle]=useState('');
      const [screen,setScreen]=useState('start');
      const [matchCode,setMatchCode]=useState('');
      const [inputCode,setInputCode]=useState('');
      const [connectedUsers,setConnectedUsers]=useState(1);
      const [isMultiplayer,setIsMultiplayer]=useState(false);
      const [matchEnded,setMatchEnded]=useState(false);
      const [sparkleStats,setSparkleStats]=useState({});
      const [error,setError]=useState('');
      const [showReconnectPrompt,setShowReconnectPrompt]=useState(false);
      const [savedMatchCode,setSavedMatchCode]=useState('');
      const [periodStats,setPeriodStats]=useState({
        1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
        2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
        3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}
      });
      const audioRefs={homeGoal:useRef(null),awayGoal:useRef(null),homePenalty:useRef(null),awayPenalty:useRef(null),intro:useRef(null)};
      const [introPlaying,setIntroPlaying]=useState(false);
      const matchRef=useRef(null);
      const userId=useRef(Math.random().toString(36).substr(2,9));
      const t=translations[language];

      useEffect(()=>{
  // üîí SAFETY CLEANUP (prevents reconnect loop / white screen)
  try {
    const raw = localStorage.getItem('multiplayerMatch');
    if (raw) {
      const data = JSON.parse(raw);

      if (
        !data.code ||
        !data.timestamp ||
        Date.now() - data.timestamp > 6 * 60 * 60 * 1000
      ) {
        localStorage.removeItem('multiplayerMatch');
      }
    }
  } catch (e) {
    localStorage.removeItem('multiplayerMatch');
  }


  	['darkMode','language','spotifyPlaylist','statsCollapsed','keepScreenOn','focusMode','externalLinkUrl','externalLinkTitle'].forEach(k=>{
          const v=localStorage.getItem(k);
          if(v){
            if(['darkMode','statsCollapsed','keepScreenOn'].includes(k)){
              eval(`set${k.charAt(0).toUpperCase()+k.slice(1)}(JSON.parse(v))`);
            }else if(k==='focusMode'){
              setFocusMode(v==='null'?null:v);
            }else if(k==='externalLinkUrl'){
              setExternalLinkUrl(v);
            }else if(k==='externalLinkTitle'){
              setExternalLinkTitle(v);
            }else{
              eval(`set${k.charAt(0).toUpperCase()+k.slice(1)}(v)`);
            }
          }
        });
        const savedMatch=localStorage.getItem('multiplayerMatch');
        if(savedMatch){
          const md=JSON.parse(savedMatch);
          setSavedMatchCode(md.code);
          setShowReconnectPrompt(true);
        }
        if(!savedMatch){
          const saved=localStorage.getItem('juniorLeagueGame');
          if(saved){
            const gs=JSON.parse(saved);
            setCurrentPeriod(gs.currentPeriod);
            setHomeName(gs.homeName);
            setAwayName(gs.awayName);
            setSidesSwapped(gs.sidesSwapped);
            setPeriodStats(gs.periodStats);
          }
        }
      },[]);

      useEffect(()=>{localStorage.setItem('darkMode',JSON.stringify(darkMode))},[darkMode]);
      useEffect(()=>{localStorage.setItem('language',language)},[language]);
      useEffect(()=>{localStorage.setItem('spotifyPlaylist',spotifyPlaylist)},[spotifyPlaylist]);
      useEffect(()=>{localStorage.setItem('statsCollapsed',JSON.stringify(statsCollapsed))},[statsCollapsed]);
      useEffect(()=>{localStorage.setItem('keepScreenOn',JSON.stringify(keepScreenOn))},[keepScreenOn]);
      useEffect(()=>{localStorage.setItem('focusMode',focusMode)},[focusMode]);
      useEffect(()=>{localStorage.setItem('externalLinkUrl',externalLinkUrl)},[externalLinkUrl]);
      useEffect(()=>{localStorage.setItem('externalLinkTitle',externalLinkTitle)},[externalLinkTitle]);

      useEffect(()=>{
        if(!isMultiplayer&&screen==='game'){
          const gs={currentPeriod,homeName,awayName,sidesSwapped,periodStats,timestamp:new Date().toISOString()};
          localStorage.setItem('juniorLeagueGame',JSON.stringify(gs));
        }
      },[currentPeriod,homeName,awayName,sidesSwapped,periodStats,isMultiplayer,screen]);

      useEffect(()=>{
        const req=async()=>{try{if('wakeLock'in navigator&&keepScreenOn){const l=await navigator.wakeLock.request('screen');setWakeLock(l)}}catch(e){}};
        const rel=async()=>{if(wakeLock){try{await wakeLock.release();setWakeLock(null)}catch(e){}}};
        if(keepScreenOn)req();else rel();
        const hvc=()=>{if(keepScreenOn&&document.visibilityState==='visible')req()};
        document.addEventListener('visibilitychange',hvc);
        return()=>{rel();document.removeEventListener('visibilitychange',hvc)}
      },[keepScreenOn]);

      useEffect(()=>{
        if(!isMultiplayer||!matchCode||!db)return;
        matchRef.current=db.ref(`matches/${matchCode}`);
        matchRef.current.on('value',s=>{
          const d=s.val();
          if(d){
            setPeriodStats(d.periodStats);
            setCurrentPeriod(d.currentPeriod);
            setHomeName(d.homeName);
            setAwayName(d.awayName);
            setSidesSwapped(d.sidesSwapped);
            setMatchEnded(d.ended||false);
            if(d.users)setConnectedUsers(Object.keys(d.users).length);
          }
        });
        const ur=matchRef.current.child(`users/${userId.current}`);
        ur.set(true);
        ur.onDisconnect().remove();
        localStorage.setItem('multiplayerMatch',JSON.stringify({code:matchCode,timestamp:Date.now()}));
        return()=>{if(matchRef.current){matchRef.current.off();ur.remove()}}
      },[isMultiplayer,matchCode]);

      const reconnectToMatch=()=>{setMatchCode(savedMatchCode);setIsMultiplayer(true);setScreen('game');setShowReconnectPrompt(false)};
      const startNewSession=()=>{localStorage.removeItem('multiplayerMatch');setShowReconnectPrompt(false)};
      const createMatch=()=>{setMatchCode(genCode());setScreen('created')};
      const startMatch=()=>{
        if(!db){setError('Firebase not configured');return}
        db.ref(`matches/${matchCode}`).set({
          homeName,awayName,currentPeriod:1,sidesSwapped:false,
          periodStats:{1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}},
          ended:false,createdAt:Date.now(),users:{[userId.current]:true}
        }).then(()=>{setIsMultiplayer(true);setScreen('game');localStorage.removeItem('juniorLeagueGame')}).catch(e=>setError('Failed: '+e.message))
      };
      const joinMatch=()=>{
        if(!db){setError('Firebase not configured');return}
        const c=inputCode.toUpperCase().trim();
        if(c.length!==6){setError('Invalid code');return}
        db.ref(`matches/${c}`).once('value').then(s=>{
          if(s.exists()){
            const d=s.val();
            if(d.ended)setError(t.matchAlreadyEnded);
            else{setMatchCode(c);setIsMultiplayer(true);setScreen('game');localStorage.removeItem('juniorLeagueGame')}
          }else setError(t.matchNotFound)
        }).catch(e=>setError('Failed: '+e.message))
      };
      const continueAlone=()=>{setIsMultiplayer(false);setScreen('game');localStorage.removeItem('multiplayerMatch')};
      const endMatch = () => {
  	if (window.confirm(t.endMatchConfirm)) {
    	  if (matchRef.current) {
      	    matchRef.current.update({ ended: true });
    	}

    	setMatchEnded(true);

    	    // üî• IMPORTANT: clear multiplayer state so reconnect cannot trigger
    	    localStorage.removeItem('multiplayerMatch');
    	    setShowReconnectPrompt(false);
  	  }
	};

      const leaveMatch=()=>{if(window.confirm('Leave multiplayer match?')){localStorage.removeItem('multiplayerMatch');setIsMultiplayer(false);setMatchCode('');setScreen('start')}};
      const updateStat=(team,stat,delta)=>{
        const ns={...periodStats,[currentPeriod]:{...periodStats[currentPeriod],[team+stat]:Math.max(0,periodStats[currentPeriod][team+stat]+delta)}};
        setPeriodStats(ns);
        const k=`${team}${stat}${currentPeriod}`;
        setSparkleStats(p=>({...p,[k]:true}));
        setTimeout(()=>setSparkleStats(p=>({...p,[k]:false})),600);
        if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({periodStats:ns})
      };
      const playSound=st=>{const a=audioRefs[st].current;if(a){a.currentTime=0;a.play().catch(e=>console.log('Play failed:',e))}};
      const toggleIntro=()=>{const a=audioRefs.intro.current;if(!a)return;if(introPlaying){a.pause();a.currentTime=0;setIntroPlaying(false)}else{a.loop=true;a.play().catch(e=>console.log('Play failed:',e));setIntroPlaying(true)}};
      const stopAllSounds=()=>{Object.values(audioRefs).forEach(r=>{if(r.current){r.current.pause();r.current.currentTime=0}});setIntroPlaying(false)};
      const resetCounters=()=>{
        if(window.confirm(t.resetConfirm)){
          const ns={1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}};
          setPeriodStats(ns);setCurrentPeriod(1);
          if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({periodStats:ns,currentPeriod:1});
          else localStorage.removeItem('juniorLeagueGame')
        }
      };
      const calcTotals=()=>{
        let hs=0,as=0,hsv=0,asv=0;
        Object.keys(periodStats).forEach(p=>{hs+=periodStats[p].homeScore;as+=periodStats[p].awayScore;hsv+=periodStats[p].homeSaves;asv+=periodStats[p].awaySaves});
        return{homeScore:hs,awayScore:as,homeSaves:hsv,awaySaves:asv}
      };
      const totals=calcTotals();
      const calcSP=(sv,g)=>{const sh=sv+g;return sh===0?'0.0':((sv/sh)*100).toFixed(1)};
      const genReport=()=>{
        const d=new Date().toLocaleDateString();
        let r=`${t.gameReport} - ${d}\n${homeName} ${totals.homeScore} - ${totals.awayScore} ${awayName}\n\n${t.periodBreakdown}:\n`;
        Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(p=>{const ps=periodStats[p];const pLabel=parseInt(p)<=3?`${t.period} ${p}`:`OT'${parseInt(p)-3}`;r+=`${pLabel}: ${homeName} ${ps.homeScore}-${ps.awayScore} ${awayName}\n`});
        r+=`\n${t.goalieStats}:\n${homeName}: ${totals.homeSaves} ${t.saves.toLowerCase()}, ${totals.homeSaves+totals.awayScore} ${t.shotsAgainstShort}, ${calcSP(totals.homeSaves,totals.awayScore)}%\n`;
        r+=`${awayName}: ${totals.awaySaves} ${t.saves.toLowerCase()}, ${totals.awaySaves+totals.homeScore} ${t.shotsAgainstShort}, ${calcSP(totals.awaySaves,totals.homeScore)}%\n`;
        return r
      };
      const copyStats=()=>navigator.clipboard.writeText(genReport()).then(()=>alert(t.statsCopied)).catch(()=>alert(t.copyFailed));
      const copyCode=()=>navigator.clipboard.writeText(matchCode).then(()=>alert(t.statsCopied)).catch(()=>alert(t.copyFailed));
      const shareStats=()=>{if(navigator.share)navigator.share({title:t.gameReport,text:genReport()}).catch(()=>copyStats());else copyStats()};
      const getSpotifyUrl=u=>{const m=u.match(/playlist\/([a-zA-Z0-9]+)/);return m&&m[1]?`https://open.spotify.com/embed/playlist/${m[1]}?utm_source=generator&theme=0`:null};
      const loadSpotify=()=>{setSpotifyLoading(true);setTimeout(()=>{setSpotifyLoaded(true);setSpotifyLoading(false)},100)};
      const refSigs=[
        {name:t.offside,description:t.armRaised},
        {name:t.tripping,description:t.strikeLeg},
        {name:t.holding,description:t.claspWrist},
        {name:t.highSticking,description:t.twoHandsHigh},
        {name:t.slashing,description:t.choppingMotion},
        {name:t.icing,description:t.armsCrossedChest},
        {name:t.goal,description:t.armsPointedGoal},
        {name:t.noGoal,description:t.armsCrossedHead},
        {name:t.timeOut,description:t.handsFormingT},
        {name:t.penaltyShot,description:t.armsCrossedPointed}
      ];


// RECONNECT PROMPT
      if(showReconnectPrompt)return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <h3 className="text-xl font-bold mb-3">{t.reconnectPrompt}</h3>
              <p className={`${darkMode?'text-gray-300':'text-gray-600'} mb-6`}>
                {t.matchCode}: <span className="font-mono font-bold">{savedMatchCode}</span>
              </p>
              <div className="flex gap-3">
                <button onClick={reconnectToMatch} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">{t.reconnect}</button>
                <button onClick={startNewSession} className={`flex-1 ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-200 hover:bg-gray-300'} py-3 rounded-lg font-semibold`}>{t.startNew}</button>
              </div>
            </div>
          </div>
        </div>
      );

      // START SCREEN
      if(screen==='start')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <div className="text-center mb-8">
                <div className="text-5xl mb-4">üèí</div>
                <h1 className="text-3xl font-bold mb-2">Hockey Scorekeeper</h1>
                <p className={`${darkMode?'text-gray-300':'text-gray-600'}`}>
                  {language==='en'?'Track your game together':'F√∂lj matchen tillsammans'}
                </p>
              </div>
              <div className="space-y-4">
                <button onClick={()=>setScreen('create')} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">{t.createMatch}</button>
                <button onClick={()=>setScreen('join')} className={`w-full ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-200 hover:bg-gray-300'} py-4 rounded-xl font-bold text-lg shadow-lg`}>{t.joinMatch}</button>
                <button onClick={continueAlone} className={`w-full ${darkMode?'text-gray-400 hover:text-gray-300':'text-gray-500 hover:text-gray-700'} py-2 text-sm`}>‚Üí {t.continueAlone}</button>
              </div>
              <div className="mt-6 text-center">
                <button onClick={()=>setLanguage(language==='en'?'sv':'en')} className={`text-sm ${darkMode?'text-gray-400':'text-gray-500'}`}>{language==='en'?'üá∏üá™ Svenska':'üá¨üáß English'}</button>
                <span className="mx-2">|</span>
                <button onClick={()=>setDarkMode(!darkMode)} className={`text-sm ${darkMode?'text-gray-400':'text-gray-500'}`}>{darkMode?'‚òÄÔ∏è':'üåô'}</button>
              </div>
            </div>
          </div>
        </div>
      );

      // CREATE SCREEN
      if(screen==='create')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <button onClick={()=>setScreen('start')} className={`mb-6 ${darkMode?'text-gray-400':'text-gray-600'}`}>‚Üê {t.goBack}</button>
              <h2 className="text-2xl font-bold mb-6">{t.newMatch}</h2>
              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-sm mb-2">{t.homeTeam}</label>
                  <input type="text" value={homeName} onChange={e=>setHomeName(e.target.value)} className={`w-full px-4 py-3 border rounded-lg ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'}`}/>
                </div>
                <div>
                  <label className="block text-sm mb-2">{t.awayTeam}</label>
                  <input type="text" value={awayName} onChange={e=>setAwayName(e.target.value)} className={`w-full px-4 py-3 border rounded-lg ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'}`}/>
                </div>
              </div>
              <button onClick={createMatch} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">{t.startMatch}</button>
            </div>
          </div>
        </div>
      );

      // CREATED SCREEN
      if(screen==='created')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <div className="text-center mb-6">
                <div className="text-5xl mb-4">‚úÖ</div>
                <h2 className="text-2xl font-bold mb-2">{t.matchCreated}</h2>
              </div>
              <div className={`${darkMode?'bg-gray-700':'bg-blue-50'} rounded-xl p-6 mb-6`}>
                <p className={`text-sm mb-3 ${darkMode?'text-gray-300':'text-gray-600'}`}>{t.shareCode}</p>
                <div className="flex items-center gap-3">
                  <div className="flex-1 bg-white dark:bg-gray-800 rounded-lg py-4 px-6 text-center">
                    <div className="text-3xl font-bold tracking-widest">{matchCode}</div>
                  </div>
                  <button onClick={copyCode} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-lg font-semibold">{t.copy}</button>
                </div>
              </div>
              {error&&<div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded mb-4">{error}</div>}
              <button onClick={startMatch} className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">{t.continueToMatch}</button>
              <button onClick={()=>setScreen('start')} className={`w-full mt-3 ${darkMode?'text-gray-400':'text-gray-600'} py-2`}>{t.goBack}</button>
            </div>
          </div>
        </div>
      );

      // JOIN SCREEN
      if(screen==='join')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <button onClick={()=>setScreen('start')} className={`mb-6 ${darkMode?'text-gray-400':'text-gray-600'}`}>‚Üê {t.goBack}</button>
              <h2 className="text-2xl font-bold mb-6">{t.joinMatch}</h2>
              <div className="mb-6">
                <label className="block text-sm mb-2">{t.enterCode}</label>
                <input type="text" value={inputCode} onChange={e=>{setInputCode(e.target.value.toUpperCase());setError('')}} maxLength={6} placeholder="ABC123" className={`w-full px-4 py-4 border rounded-lg text-center text-2xl font-bold tracking-widest ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'}`}/>
              </div>
              {error&&<div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded mb-4 text-sm">{error}</div>}
              <button onClick={joinMatch} disabled={inputCode.length!==6} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-4 rounded-xl font-bold text-lg shadow-lg">{t.connect}</button>
            </div>
          </div>
        </div>
      );

      // FOCUS MODE - Improved compact design with dark mode fix
      if(focusMode&&screen==='game'){
        const ft=focusMode==='home'?
          {name:sidesSwapped?awayName:homeName,score:sidesSwapped?totals.awayScore:totals.homeScore,saves:sidesSwapped?totals.awaySaves:totals.homeSaves,team:sidesSwapped?'away':'home',oppScore:sidesSwapped?totals.homeScore:totals.awayScore}:
          {name:sidesSwapped?homeName:awayName,score:sidesSwapped?totals.homeScore:totals.awayScore,saves:sidesSwapped?totals.homeSaves:totals.awaySaves,team:sidesSwapped?'home':'away',oppScore:sidesSwapped?totals.awayScore:totals.homeScore};
        const ot=focusMode==='home'?'away':'home';
        const on=focusMode==='home'?(sidesSwapped?homeName:awayName):(sidesSwapped?awayName:homeName);
        const os=focusMode==='home'?(sidesSwapped?totals.homeScore:totals.awayScore):(sidesSwapped?totals.awayScore:totals.homeScore);
        const otsv=ot==='home'?totals.homeSaves:totals.awaySaves;

        return(
          <div className={`min-h-screen ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
            <audio ref={audioRefs.homeGoal} src="homeGoal.mp3"/>
            <audio ref={audioRefs.awayGoal} src="awayGoal.mp3"/>
            <audio ref={audioRefs.homePenalty} src="homePenalty.mp3"/>
            <audio ref={audioRefs.awayPenalty} src="awayPenalty.mp3"/>
            <audio ref={audioRefs.intro} src="intro.mp3"/>

            <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-3 shadow-lg`}>
              <div className="max-w-4xl mx-auto flex justify-between items-center">
                <div className="flex gap-2 items-center">
                  <span className="text-xs font-medium">{t.period}:</span>
                  {[1,2,3].map(p=><button key={p} onClick={()=>{setCurrentPeriod(p);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:p})}} disabled={matchEnded} className={`px-2 py-1 rounded text-sm font-bold ${currentPeriod===p?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>{p}</button>)}
                  {Object.keys(periodStats).filter(p=>parseInt(p)>3).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=><button key={p} onClick={()=>{setCurrentPeriod(parseInt(p));if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:parseInt(p)})}} disabled={matchEnded} className={`px-2 py-1 rounded text-sm font-bold ${currentPeriod===parseInt(p)?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>OT{parseInt(p)-3}</button>)}
                  {!periodStats[4] && currentPeriod >= 3 && (
  <button
    onClick={() => {
      const newP = 4; // üîí alltid bara en OT
      const updated = {
        ...periodStats,
        [newP]: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 }
      };

      setPeriodStats(updated);
      setCurrentPeriod(newP);

      if (isMultiplayer && matchRef.current && !matchEnded) {
        matchRef.current.update({
          periodStats: updated,
          currentPeriod: newP
        });
      }
    }}
    disabled={matchEnded}
  >
    +OT
  </button>
)}

                </div>
                <button onClick={()=>setFocusMode(null)} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20'} w-8 h-8 rounded-lg text-xl font-bold`}>‚úï</button>
              </div>
            </div>

            <div className="max-w-4xl mx-auto p-3">
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-xl shadow-xl p-4`}>
                {/* GOALS SECTION */}
                <div className={`text-lg font-semibold mb-3 text-center ${darkMode?'text-gray-200':'opacity-75'}`}>{t.goals}</div>
                <div className="grid grid-cols-2 gap-3 mb-4">
                  {/* Focus Team Goals */}
                  <div className={`${darkMode?'bg-gray-700':'bg-blue-50'} rounded-lg p-3`}>
                    <div className={`text-sm font-semibold text-center mb-2 ${darkMode?'text-gray-100':''}`}>{ft.name}</div>
                    <div className="flex items-center justify-center gap-2 mb-2">
                      <button onClick={()=>updateStat(ft.team,'Score',-1)} disabled={matchEnded} className="bg-red-500 hover:bg-red-600 text-white w-12 h-12 rounded-lg text-2xl font-bold">‚àí</button>
                      <div className={`text-5xl font-bold text-center min-w-[80px] ${darkMode?'text-white':''} ${sparkleStats[`${ft.team}Score${currentPeriod}`]?'sparkle':''}`}>{ft.score}</div>
                      <button onClick={()=>updateStat(ft.team,'Score',1)} disabled={matchEnded} className="bg-green-500 hover:bg-green-600 text-white w-12 h-12 rounded-lg text-2xl font-bold">+</button>
                    </div>
                    <div className={`text-xs text-center ${darkMode?'text-gray-300':'opacity-75'}`}>{t.byPeriod}: {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][ft.team+'Score']}{i<arr.length-1?'-':''}</span>)}</div>
                  </div>
                  
                  {/* Opponent Goals */}
                  <div className={`${darkMode?'bg-gray-700':'bg-red-50'} rounded-lg p-3`}>
                    <div className={`text-sm font-semibold text-center mb-2 ${darkMode?'text-gray-100':''}`}>{on}</div>
                    <div className="flex items-center justify-center gap-2 mb-2">
                      <button onClick={()=>updateStat(ot,'Score',-1)} disabled={matchEnded} className="bg-red-500 hover:bg-red-600 text-white w-12 h-12 rounded-lg text-2xl font-bold">‚àí</button>
                      <div className={`text-5xl font-bold text-center min-w-[80px] ${darkMode?'text-white':''} ${sparkleStats[`${ot}Score${currentPeriod}`]?'sparkle':''}`}>{os}</div>
                      <button onClick={()=>updateStat(ot,'Score',1)} disabled={matchEnded} className="bg-green-500 hover:bg-green-600 text-white w-12 h-12 rounded-lg text-2xl font-bold">+</button>
                    </div>
                    <div className={`text-xs text-center ${darkMode?'text-gray-300':'opacity-75'}`}>{t.byPeriod}: {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][ot+'Score']}{i<arr.length-1?'-':''}</span>)}</div>
                  </div>
                </div>

                {/* SAVES SECTION */}
                <div className={`pt-4 border-t-2 ${darkMode?'border-gray-600':'border-gray-200'}`}>
                  <div className={`text-lg font-semibold mb-3 text-center ${darkMode?'text-gray-200':'opacity-75'}`}>{t.saves}</div>
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    {/* Focus Team Saves */}
                    <div className={`${darkMode?'bg-gray-700':'bg-blue-50'} rounded-lg p-3`}>
                      <div className={`text-sm font-semibold text-center mb-2 ${darkMode?'text-gray-100':''}`}>{ft.name}</div>
                      <div className="flex items-center justify-center gap-2 mb-2">
                        <button onClick={()=>updateStat(ft.team,'Saves',-1)} disabled={matchEnded} className={`${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-gray-300 hover:bg-gray-400'} text-white w-12 h-12 rounded-lg text-2xl font-bold`}>‚àí</button>
                        <div className={`text-4xl font-bold text-center min-w-[80px] ${darkMode?'text-white':''} ${sparkleStats[`${ft.team}Saves${currentPeriod}`]?'sparkle':''}`}>{ft.saves}</div>
                        <button onClick={()=>updateStat(ft.team,'Saves',1)} disabled={matchEnded} className={`${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-gray-300 hover:bg-gray-400'} text-white w-12 h-12 rounded-lg text-2xl font-bold`}>+</button>
                      </div>
                      <div className={`text-xs text-center mb-2 ${darkMode?'text-gray-300':'opacity-75'}`}>{t.byPeriod}: {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][ft.team+'Saves']}{i<arr.length-1?'-':''}</span>)}</div>
                      <div className={`${darkMode?'bg-gray-600 text-gray-100':'bg-white'} rounded p-2 text-xs`}>
                        <div className="flex justify-between mb-1"><span>{t.shotsFor}:</span><span className="font-bold">{(() => {
                          const oppTeam = ft.team === 'home' ? 'away' : 'home';
                          return Object.keys(periodStats).reduce((sum,p)=>sum+(periodStats[p][oppTeam+'Saves']+periodStats[p][ft.team+'Score']),0);
                        })()}</span></div>
                        <div className={`text-center ${darkMode?'text-gray-300':'opacity-75'}`}>({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                          const oppTeam = ft.team === 'home' ? 'away' : 'home';
                          return periodStats[p][oppTeam+'Saves']+periodStats[p][ft.team+'Score'];
                        }).join('-')})</div>
                        <div className="flex justify-between mb-1 mt-2"><span>{t.shotsAgainst}:</span><span className="font-bold">{(() => {
                          const oppTeam = ft.team === 'home' ? 'away' : 'home';
                          return Object.keys(periodStats).reduce((sum,p)=>sum+(periodStats[p][ft.team+'Saves']+periodStats[p][oppTeam+'Score']),0);
                        })()}</span></div>
                        <div className={`text-center ${darkMode?'text-gray-300':'opacity-75'}`}>({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                          const oppTeam = ft.team === 'home' ? 'away' : 'home';
                          return periodStats[p][ft.team+'Saves']+periodStats[p][oppTeam+'Score'];
                        }).join('-')})</div>
                        <div className={`flex justify-between mt-2 pt-2 border-t ${darkMode?'border-gray-500':''}`}><span>{t.savePercent}:</span><span className="font-bold">{calcSP(ft.saves,ft.oppScore)}%</span></div>
                      </div>
                    </div>
                    
                    {/* Opponent Saves */}
                    <div className={`${darkMode?'bg-gray-700':'bg-red-50'} rounded-lg p-3`}>
                      <div className={`text-sm font-semibold text-center mb-2 ${darkMode?'text-gray-100':''}`}>{on}</div>
                      <div className="flex items-center justify-center gap-2 mb-2">
                        <button onClick={()=>updateStat(ot,'Saves',-1)} disabled={matchEnded} className={`${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-gray-300 hover:bg-gray-400'} text-white w-12 h-12 rounded-lg text-2xl font-bold`}>‚àí</button>
                        <div className={`text-4xl font-bold text-center min-w-[80px] ${darkMode?'text-white':''} ${sparkleStats[`${ot}Saves${currentPeriod}`]?'sparkle':''}`}>{otsv}</div>
                        <button onClick={()=>updateStat(ot,'Saves',1)} disabled={matchEnded} className={`${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-gray-300 hover:bg-gray-400'} text-white w-12 h-12 rounded-lg text-2xl font-bold`}>+</button>
                      </div>
                      <div className={`text-xs text-center mb-2 ${darkMode?'text-gray-300':'opacity-75'}`}>{t.byPeriod}: {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][ot+'Saves']}{i<arr.length-1?'-':''}</span>)}</div>
                      <div className={`${darkMode?'bg-gray-600 text-gray-100':'bg-white'} rounded p-2 text-xs`}>
                        <div className="flex justify-between mb-1"><span>{t.shotsFor}:</span><span className="font-bold">{(() => {
                          const oppTeam = ot === 'home' ? 'away' : 'home';
                          return Object.keys(periodStats).reduce((sum,p)=>sum+(periodStats[p][oppTeam+'Saves']+periodStats[p][ot+'Score']),0);
                        })()}</span></div>
                        <div className={`text-center ${darkMode?'text-gray-300':'opacity-75'}`}>({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                          const oppTeam = ot === 'home' ? 'away' : 'home';
                          return periodStats[p][oppTeam+'Saves']+periodStats[p][ot+'Score'];
                        }).join('-')})</div>
                        <div className="flex justify-between mb-1 mt-2"><span>{t.shotsAgainst}:</span><span className="font-bold">{(() => {
                          const oppTeam = ot === 'home' ? 'away' : 'home';
                          return Object.keys(periodStats).reduce((sum,p)=>sum+(periodStats[p][ot+'Saves']+periodStats[p][oppTeam+'Score']),0);
                        })()}</span></div>
                        <div className={`text-center ${darkMode?'text-gray-300':'opacity-75'}`}>({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                          const oppTeam = ot === 'home' ? 'away' : 'home';
                          return periodStats[p][ot+'Saves']+periodStats[p][oppTeam+'Score'];
                        }).join('-')})</div>
                        <div className={`flex justify-between mt-2 pt-2 border-t ${darkMode?'border-gray-500':''}`}><span>{t.savePercent}:</span><span className="font-bold">{calcSP(otsv,ft.score)}%</span></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }


// GAME SCREEN - Normal mode
      return(
        <div className={`min-h-screen pb-20 ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <audio ref={audioRefs.homeGoal} src="homeGoal.mp3"/>
          <audio ref={audioRefs.awayGoal} src="awayGoal.mp3"/>
          <audio ref={audioRefs.homePenalty} src="homePenalty.mp3"/>
          <audio ref={audioRefs.awayPenalty} src="awayPenalty.mp3"/>
          <audio ref={audioRefs.intro} src="intro.mp3"/>

          <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-4 shadow-lg sticky top-0 z-50`}>
            <div className="max-w-6xl mx-auto">
              {isMultiplayer&&<div className="mb-3 flex items-center justify-between gap-2">
                <div className="flex items-center gap-2">
                  {!matchEnded&&<span className="flex items-center gap-1 bg-red-500 px-2 py-1 rounded-full text-xs font-bold animate-pulse"><span className="w-1.5 h-1.5 bg-white rounded-full"></span>LIVE</span>}
                  {matchEnded&&<span className="bg-gray-500 px-2 py-1 rounded-full text-xs font-bold">{t.matchEnded}</span>}
                  <span className="text-xs">üë• {connectedUsers}</span>
                </div>
                <div className="flex items-center gap-1">
                  <button onClick={copyCode} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20'} px-2 py-1 rounded font-mono font-bold text-xs`}>{matchCode}</button>
                  {!matchEnded&&<button onClick={endMatch} className="bg-red-500 hover:bg-red-600 px-2 py-1 rounded text-xs font-semibold whitespace-nowrap">End</button>}
                </div>
              </div>}

              <div className="flex justify-between items-center mb-3">
                <div className="flex gap-2 items-center">
                  <span className="text-sm font-medium">{t.period}:</span>
                  {[1,2,3].map(p=><button key={p} onClick={()=>{setCurrentPeriod(p);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:p})}} disabled={matchEnded} className={`px-3 py-1 rounded font-bold ${currentPeriod===p?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>{p}</button>)}
                  {Object.keys(periodStats).filter(p=>parseInt(p)>3).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=><button key={p} onClick={()=>{setCurrentPeriod(parseInt(p));if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:parseInt(p)})}} disabled={matchEnded} className={`px-3 py-1 rounded font-bold text-xs ${currentPeriod===parseInt(p)?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>OT{parseInt(p)-3}</button>)}
                  {!periodStats[4] && currentPeriod >= 3 && (
  <button
    onClick={() => {
      const newP = 4; // üîí alltid bara en OT
      const updated = {
        ...periodStats,
        [newP]: { homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0 }
      };

      setPeriodStats(updated);
      setCurrentPeriod(newP);

      if (isMultiplayer && matchRef.current && !matchEnded) {
        matchRef.current.update({
          periodStats: updated,
          currentPeriod: newP
        });
      }
    }}
    disabled={matchEnded}
  >
    +OT
  </button>
)}

                </div>
                <div className="flex gap-2">
                  <button onClick={()=>setStatsCollapsed(!statsCollapsed)} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20'} px-3 py-1 rounded text-sm`}>{statsCollapsed?'‚ñº':'‚ñ≤'}</button>
                  <button onClick={()=>setShowSettings(!showSettings)} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20'} px-3 py-1 rounded text-sm`}>‚öôÔ∏è</button>
                </div>
              </div>

              {showSettings&&<div className={`${darkMode?'bg-gray-700 text-white':'bg-white text-gray-800'} rounded-lg p-4 mb-4 max-h-[70vh] overflow-y-auto`}>
                <div className="flex justify-between items-center mb-3">
                  <h3 className="font-bold">{t.settings}</h3>
                  <button onClick={()=>setShowSettings(false)} className={`${darkMode?'text-gray-400':'text-gray-500'} text-2xl`}>√ó</button>
                </div>
                
                {/* Two column layout on desktop */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  {/* Left Column - Match Settings */}
                  <div className="space-y-3">
                    <h4 className={`text-sm font-semibold mb-2 pb-2 border-b ${darkMode?'border-gray-600':'border-gray-200'}`}>Match Settings</h4>
                    <div>
                      <label className="block text-sm mb-1">{t.homeTeam}</label>
                      <div className="flex gap-2">
                        <input type="text" value={homeName} onChange={e=>{setHomeName(e.target.value);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({homeName:e.target.value})}} disabled={matchEnded} className={`flex-1 px-3 py-2 border rounded ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
                        <button onClick={()=>setHomeName('')} disabled={matchEnded} className={`px-3 py-2 rounded text-sm ${darkMode?'bg-gray-600':'bg-gray-200'}`}>{t.clear}</button>
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm mb-1">{t.awayTeam}</label>
                      <div className="flex gap-2">
                        <input type="text" value={awayName} onChange={e=>{setAwayName(e.target.value);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({awayName:e.target.value})}} disabled={matchEnded} className={`flex-1 px-3 py-2 border rounded ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
                        <button onClick={()=>setAwayName('')} disabled={matchEnded} className={`px-3 py-2 rounded text-sm ${darkMode?'bg-gray-600':'bg-gray-200'}`}>{t.clear}</button>
                      </div>
                    </div>
                    <label className="flex items-center justify-between py-2">
                      <span className="text-sm">{t.swapSides}</span>
                      <input type="checkbox" checked={sidesSwapped} onChange={e=>{setSidesSwapped(e.target.checked);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({sidesSwapped:e.target.checked})}} disabled={matchEnded} className="w-5 h-5"/>
                    </label>
                  </div>
                  
                  {/* Right Column - My Preferences */}
                  <div className="space-y-3">
                    <h4 className={`text-sm font-semibold mb-2 pb-2 border-b ${darkMode?'border-gray-600':'border-gray-200'}`}>My Preferences</h4>
                    <label className="flex items-center justify-between py-2">
                      <span className="text-sm">{t.language}</span>
                      <select value={language} onChange={e=>setLanguage(e.target.value)} className={`px-3 py-2 rounded ${darkMode?'bg-gray-800 border-gray-600 text-white':'border'}`}>
                        <option value="en">English</option>
                        <option value="sv">Svenska</option>
                      </select>
                    </label>
                    <label className="flex items-center justify-between py-2">
                      <span className="text-sm">{t.darkMode}</span>
                      <input type="checkbox" checked={darkMode} onChange={e=>setDarkMode(e.target.checked)} className="w-5 h-5"/>
                    </label>
                    <label className="flex items-center justify-between py-2">
                      <span className="text-sm">{t.keepScreenOn}</span>
                      <input type="checkbox" checked={keepScreenOn} onChange={e=>setKeepScreenOn(e.target.checked)} className="w-5 h-5"/>
                    </label>
                  </div>
                </div>

                {/* Full width sections below */}
                <div className="space-y-3 mt-4 pt-4 border-t">
                  <div>
                    <label className="block text-sm mb-2 font-semibold">{t.spotifyPlaylistUrl}</label>
                    <div className="flex gap-2">
                      <input type="text" value={spotifyPlaylist} onChange={e=>{setSpotifyPlaylist(e.target.value);setSpotifyLoaded(false)}} placeholder="https://open.spotify.com/playlist/..." className={`flex-1 px-3 py-2 border rounded text-sm ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
                      <button onClick={()=>{setSpotifyPlaylist('https://open.spotify.com/playlist/3HunXm4QT4dxcOz6eAljak?si=mKiXLeNMQM6ioJivpWP-EQ&pi=lAZXLD_QSPmpq');setSpotifyLoaded(false)}} className={`px-3 py-2 rounded text-sm whitespace-nowrap ${darkMode?'bg-gray-600':'bg-gray-200'}`}>{t.restore}</button>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm mb-2 font-semibold">{t.externalLink}</label>
                    <input type="text" value={externalLinkTitle} onChange={e=>setExternalLinkTitle(e.target.value)} placeholder="Club Rules" className={`w-full px-3 py-2 border rounded text-sm mb-2 ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
                    <input type="text" value={externalLinkUrl} onChange={e=>setExternalLinkUrl(e.target.value)} placeholder="https://..." className={`w-full px-3 py-2 border rounded text-sm ${darkMode?'bg-gray-800 border-gray-600 text-white':''}`}/>
                  </div>
                  {isMultiplayer&&<div className="pt-3 border-t">
                    <button onClick={leaveMatch} className="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded text-sm font-semibold">Leave Multiplayer Match</button>
                  </div>}
                </div>
              </div>}

              <div className="grid grid-cols-2 gap-4 mb-3">
                {[
                  {name:sidesSwapped?awayName:homeName,score:sidesSwapped?totals.awayScore:totals.homeScore,saves:sidesSwapped?totals.awaySaves:totals.homeSaves,team:sidesSwapped?'away':'home',oppScore:sidesSwapped?totals.homeScore:totals.awayScore,oppShots:sidesSwapped?(totals.homeSaves+totals.awayScore):(totals.awaySaves+totals.homeScore)},
                  {name:sidesSwapped?homeName:awayName,score:sidesSwapped?totals.homeScore:totals.awayScore,saves:sidesSwapped?totals.homeSaves:totals.awaySaves,team:sidesSwapped?'home':'away',oppScore:sidesSwapped?totals.awayScore:totals.homeScore,oppShots:sidesSwapped?(totals.awaySaves+totals.homeScore):(totals.homeSaves+totals.awayScore)}
                ].map((tm,idx)=>(
                  <div key={idx} className={`${darkMode?'bg-gray-700 border border-gray-600':'bg-white bg-opacity-10'} rounded-lg p-3`}>
                    <div className="text-sm font-semibold mb-2">{tm.name}</div>
                    <div className="mb-3">
                      <div className="text-xs opacity-75 mb-1">{t.goals}</div>
                      <div className="flex items-center justify-center gap-2">
                        <button onClick={()=>updateStat(tm.team,'Score',-1)} disabled={matchEnded} className="bg-red-500 bg-opacity-50 w-10 h-10 rounded flex items-center justify-center text-xl font-bold">‚àí</button>
                        <div className={`text-3xl font-bold w-16 text-center ${sparkleStats[`${tm.team}Score${currentPeriod}`]?'sparkle':''}`}>{tm.score}</div>
                        <button onClick={()=>updateStat(tm.team,'Score',1)} disabled={matchEnded} className="bg-green-500 bg-opacity-50 w-10 h-10 rounded flex items-center justify-center text-xl font-bold">+</button>
                      </div>
                      {!statsCollapsed&&<div className="text-xs opacity-75 mt-1 text-center">{t.byPeriod}: ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][tm.team+'Score']}{i<arr.length-1?'-':''}</span>)})</div>}
                    </div>
                    <div className={`pt-2 border-t ${darkMode?'border-gray-600':'border-white border-opacity-20'}`}>
                      <div className="text-xs opacity-75 mb-1">{t.saves}</div>
                      <div className="flex items-center justify-center gap-2">
                        <button onClick={()=>updateStat(tm.team,'Saves',-1)} disabled={matchEnded} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold">‚àí</button>
                        <div className={`text-3xl font-bold w-16 text-center ${sparkleStats[`${tm.team}Saves${currentPeriod}`]?'sparkle':''}`}>{tm.saves}</div>
                        <button onClick={()=>updateStat(tm.team,'Saves',1)} disabled={matchEnded} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold">+</button>
                      </div>
                      {!statsCollapsed&&<div className={`${darkMode?'bg-gray-600':'bg-white bg-opacity-10'} rounded p-2 text-xs text-center mt-2`}>
                        <div>{t.shotsFor}: {tm.oppShots} ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>(periodStats[p][(tm.team==='home'?'away':'home')+'Saves']+periodStats[p][tm.team+'Score'])).join('-')})</div>
                        <div>{t.shotsAgainst}: {tm.saves+tm.oppScore} ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>(periodStats[p][tm.team+'Saves']+periodStats[p][(tm.team==='home'?'away':'home')+'Score'])).join('-')})</div>
                        <div>{t.savePercent}: {calcSP(tm.saves,tm.oppScore)}% ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>calcSP(periodStats[p][tm.team+'Saves'],periodStats[p][(tm.team==='home'?'away':'home')+'Score'])).join('-')})</div>
                      </div>}
                    </div>
                  </div>
                ))}
              </div>

              <div className="grid grid-cols-2 gap-3">
                <button onClick={resetCounters} disabled={matchEnded} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-10'} py-2 rounded text-sm`}>{t.resetAllStats}</button>
                <button onClick={()=>{setFocusMode('home');setActiveTab('audio')}} className={`${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-500 bg-opacity-80 hover:bg-opacity-100'} py-2 rounded text-sm font-semibold`}>‚õ∂ {t.focusMode}</button>
              </div>
            </div>
          </div>

          <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-white'} shadow-md sticky top-48 z-40`}>
            <div className="max-w-6xl mx-auto flex">
              {['audio','stats','referee',...(externalLinkUrl?['external']:[])].map(tab=>(
                <button key={tab} onClick={()=>setActiveTab(tab)} className={`flex-1 py-3 font-semibold text-sm ${activeTab===tab?(darkMode?'bg-blue-700 text-white':'bg-blue-600 text-white'):(darkMode?'bg-gray-700 text-gray-300':'bg-gray-100 text-gray-600')}`}>
                  {tab==='audio'?t.audio:tab==='stats'?t.stats:tab==='referee'?t.referee:externalLinkTitle||t.externalLinkTab}
                </button>
              ))}
            </div>
          </div>

          <div className="max-w-6xl mx-auto p-4">
            {activeTab==='audio'&&<div>
              {/* Intro Section */}
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-3 mb-3`}>
                <button onClick={toggleIntro} className={`w-full ${introPlaying?(darkMode?'bg-green-700 hover:bg-green-600':'bg-green-600 hover:bg-green-700'):(darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-100 hover:bg-gray-200')} ${darkMode&&!introPlaying?'text-gray-200':'text-white'} ${!darkMode&&!introPlaying?'text-gray-800':''} py-3 rounded-lg font-semibold transition-colors`}>
                  {introPlaying?'‚è∏Ô∏è Pause Intro':'‚ñ∂ Play Intro'}
                </button>
              </div>

              {/* Goal Sounds Section */}
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-3 mb-3`}>
                <h3 className={`text-xs font-semibold mb-2 ${darkMode?'text-white':''}`}>üö® {t.goal}</h3>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    {sound:'homeGoal',label:homeName,bg:darkMode?'bg-blue-900 bg-opacity-40':'bg-blue-50',hover:darkMode?'hover:bg-blue-900 hover:bg-opacity-60':'hover:bg-blue-100',text:darkMode?'text-blue-200':'text-grey-800',border:darkMode?'border-blue-700':'border-blue-200'},
                    {sound:'awayGoal',label:awayName,bg:darkMode?'bg-red-900 bg-opacity-40':'bg-red-50',hover:darkMode?'hover:bg-red-900 hover:bg-opacity-60':'hover:bg-red-100',text:darkMode?'text-red-200':'text-grey-800',border:darkMode?'border-red-700':'border-red-200'}
                  ].map(btn=>(
                    <button key={btn.sound} onClick={()=>playSound(btn.sound)} className={`${btn.bg} ${btn.hover} ${btn.text} border ${btn.border} py-3 rounded-lg font-semibold transition-colors`}>
                      {btn.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Penalty Sounds Section */}
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-3 mb-3`}>
                <h3 className={`text-xs font-semibold mb-2 ${darkMode?'text-white':''}`}>{t.penalty}</h3>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    {sound:'homePenalty',label:homeName,bg:darkMode?'bg-blue-900 bg-opacity-30':'bg-blue-50',hover:darkMode?'hover:bg-blue-900 hover:bg-opacity-50':'hover:bg-blue-100',text:darkMode?'text-blue-200':'text-grey-900',border:darkMode?'border-blue-700':'border-blue-300'},
                    {sound:'awayPenalty',label:awayName,bg:darkMode?'bg-red-900 bg-opacity-30':'bg-red-50',hover:darkMode?'hover:bg-red-900 hover:bg-opacity-50':'hover:bg-red-100',text:darkMode?'text-red-200':'text-grey-900',border:darkMode?'border-red-700':'border-red-200'}
                  ].map(btn=>(
                    <button key={btn.sound} onClick={()=>playSound(btn.sound)} className={`${btn.bg} ${btn.hover} ${btn.text} border ${btn.border} py-3 rounded-lg font-semibold transition-colors`}>
                      {btn.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Stop All Button */}
              <button onClick={stopAllSounds} className={`w-full ${darkMode?'bg-red-900 bg-opacity-40 hover:bg-red-900 hover:bg-opacity-60 border-2 border-red-700 text-red-200':'bg-red-50 hover:bg-red-100 border-2 border-red-300 text-grey-900'} py-2 rounded-lg font-semibold mb-3 transition-colors`}>
                {t.stopAllSounds}
              </button>

              
              {/* Spotify Section */}
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-3`}>
                {!spotifyLoaded&&!spotifyLoading?<button onClick={loadSpotify} className={`w-full ${darkMode?'bg-green-700 hover:bg-green-600':'bg-green-600 hover:bg-green-700'} text-white py-8 rounded-lg font-semibold text-lg transition-colors`}>‚ñ∂ {language==='en'?'Load Spotify':'Ladda Spotify'}</button>:spotifyLoading?<div className={`py-8 text-center ${darkMode?'text-gray-300':'text-gray-600'}`}><div className="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-2"></div><div>{language==='en'?'Loading...':'Laddar...'}</div></div>:<div style={{opacity:0,animation:'fadeIn 0.5s ease-in forwards'}}>{getSpotifyUrl(spotifyPlaylist)?<iframe style={{borderRadius:'12px'}} src={getSpotifyUrl(spotifyPlaylist)} width="100%" height="352" frameBorder="0" allowFullScreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>:<div className={`text-center py-8 ${darkMode?'text-gray-300':'text-gray-600'}`}>{language==='en'?'Invalid Spotify URL. Please check Settings.':'Ogiltig Spotify-URL. Kontrollera inst√§llningarna.'}</div>}</div>}
              </div>
            </div>}

            {activeTab==='stats'&&<div>
                {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                  p=parseInt(p);
                const ps=periodStats[p];
                return(
                  <div key={p} className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-4 mb-4`}>
                    <div className="flex justify-between items-center mb-3">
                      <h3 className={`text-xl font-bold ${darkMode?'text-white':''}`}>{p<=3?`${t.period} ${p}`:`OT${p-3}`}</h3>
                      {currentPeriod===p&&<span className="bg-yellow-400 text-blue-900 px-3 py-1 rounded text-sm font-bold">Current</span>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      {[
                        {name:homeName,score:ps.homeScore,saves:ps.homeSaves,shotsFor:ps.awaySaves+ps.homeScore,shotsAgainst:ps.homeSaves+ps.awayScore,oppScore:ps.awayScore,color:darkMode?'bg-blue-900 bg-opacity-30 border-blue-700':'bg-blue-50'},
                        {name:awayName,score:ps.awayScore,saves:ps.awaySaves,shotsFor:ps.homeSaves+ps.awayScore,shotsAgainst:ps.awaySaves+ps.homeScore,oppScore:ps.homeScore,color:darkMode?'bg-red-900 bg-opacity-30 border-red-700':'bg-red-50'}
                      ].map((tm,i)=>(
                        <div key={i} className={`${tm.color} ${darkMode?'border':''} rounded p-3`}>
                          <div className={`font-semibold mb-2 ${darkMode?'text-white':''}`}>{tm.name}</div>
                          <div className={`text-sm space-y-1 ${darkMode?'text-gray-300':'text-gray-700'}`}>
                            <div className="flex justify-between"><span>{t.goals}:</span><span className="font-bold">{tm.score}</span></div>
                            <div className="flex justify-between"><span>{t.shotsFor}:</span><span className="font-bold">{tm.shotsFor}</span></div>
                            <div className="flex justify-between"><span>{t.saves}:</span><span className="font-bold">{tm.saves}</span></div>
                            <div className="flex justify-between"><span>{t.shotsAgainst}:</span><span className="font-bold">{tm.shotsAgainst}</span></div>
                            <div className="flex justify-between border-t pt-1"><span>{t.savePercent}:</span><span className="font-bold">{calcSP(tm.saves,tm.oppScore)}%</span></div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
              <div className={`${darkMode?'bg-gradient-to-r from-gray-800 to-gray-700 border border-gray-600':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white rounded-lg shadow-lg p-6`}>
                <h3 className="text-2xl font-bold text-center mb-4">{t.final}</h3>
                <div className="flex justify-center gap-8 text-center">
                  <div><div className="text-sm mb-1">{homeName}</div><div className="text-5xl font-bold">{totals.homeScore}</div></div>
                  <div className="text-3xl">-</div>
                  <div><div className="text-sm mb-1">{awayName}</div><div className="text-5xl font-bold">{totals.awayScore}</div></div>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3 mt-4">
                <button onClick={copyStats} className={`${darkMode?'bg-gray-800 border-gray-600 text-white':'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>üìã {t.copyStats}</button>
                <button onClick={shareStats} className="bg-blue-600 text-white py-3 rounded-lg font-semibold">‚úâÔ∏è {t.share}</button>
              </div>
            </div>}

{activeTab==='referee'&&<div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {refSigs.map((sig,i)=>(
                  <div key={i} className={`${darkMode?'bg-gray-800 border border-gray-600':'bg-gray-100 border-1 border-gray-200'} rounded-sm p-4 shadow`}>
                    <h3 className={`text-lg font-bold mb-2 ${darkMode?'text-white':''}`}>{sig.name}</h3>
                    <p className={`${darkMode?'text-gray-300':'text-gray-700'}`}>{sig.description}</p>
                  </div>
                ))}
              </div>
            </div>}

            {activeTab==='external'&&externalLinkUrl&&<div>
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow overflow-hidden`}>
                <iframe src={externalLinkUrl} className="w-full" style={{height:'70vh',border:'none'}} title={externalLinkTitle||t.externalLink}></iframe>
              </div>
            </div>}
          </div>
        </div>
      );
    };

    ReactDOM.render(<JuniorLeagueApp/>,document.getElementById('root'));
  </script>
</body>
</html>
