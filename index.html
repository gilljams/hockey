<!DOCTYPE html >
  <html lang="en">
    <head>
      <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Hockey Scorekeeper</title>
          <script async src="https://www.googletagmanager.com/gtag/js?id=G-39HWBJQ5Z1"></script>
          <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-39HWBJQ5Z1');</script>
          <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
          <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
          <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
          <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
          <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
          <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
          <script src="https://cdn.tailwindcss.com"></script>
          <style>
            @keyframes fadeIn{from{opacity:0}to{opacity:1}}
            @keyframes sparkle{0%, 100% { transform: scale(1); opacity: 1 }50%{transform:scale(1.2);opacity:.8}}
            .sparkle{animation:sparkle .6s ease-in-out}
            @keyframes eq-bar{0%, 100% { height: 30%}50%{height:80%}}
            .eq-bar {
  animation: eq-bar 0.9s ease-in-out infinite alternate;
}
            .eq-bar:nth-child(1){animation-delay:0s}
             .eq-bar:nth-child(2){animation-delay:0.15s}
             .eq-bar:nth-child(3){animation-delay:0.3s}
          </style>
        </head>
        <body>
          <div id="root"></div>
          <script type="text/babel">
            const {useState, useRef, useEffect}=React;

            const firebaseConfig={
              apiKey:"AIzaSyBFO04MS1hfTnE_ciPxTJCXO_Jk1w8DudY",
            authDomain:"hockey-scorekeeper.firebaseapp.com",
            databaseURL:"https://hockey-scorekeeper-default-rtdb.europe-west1.firebasedatabase.app",
            projectId:"hockey-scorekeeper",
            storageBucket:"hockey-scorekeeper.firebasestorage.app",
            messagingSenderId:"804304791634",
            appId:"1:804304791634:web:98532061d3768f6b8c178b"
    };

            let db=null;
            let auth=null;
            try{
  if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
            db=firebase.database();
            auth=firebase.auth();
}catch(e){console.log("Firebase error:", e)}

    const genCode=()=>{
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code='';
            for(let i=0;i<6;i++){
              code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
            return code;
    };

    const SoundEQ = () => (
            <div className="flex items-end gap-0.5 h-4 ml-2">
              <div className="eq-bar w-1 bg-white rounded-full"></div>
              <div className="eq-bar w-1 bg-white rounded-full"></div>
              <div className="eq-bar w-1 bg-white rounded-full"></div>
            </div>
            );

    const JuniorLeagueApp=()=>{
      const [activeTab,setActiveTab]=useState('stats');
            const [currentPeriod,setCurrentPeriod]=useState(1);
            const [homeName,setHomeName]=useState('HOME TEAM');
            const [awayName,setAwayName]=useState('AWAY TEAM');
            const [goalFocusSwapped,setGoalFocusSwapped]=useState(false);
            const [activeGoalies,setActiveGoalies]=useState({home:'starter',away:'starter'});
            const [showShootout,setShowShootout]=useState(false);
            const [showSettings,setShowSettings]=useState(false);
            const [darkMode,setDarkMode]=useState(false);
            const [statsCollapsed,setStatsCollapsed]=useState(false);
            const [focusMode,setFocusMode]=useState(null);
            const [spotifyLoaded,setSpotifyLoaded]=useState(false);
            const [spotifyLoading,setSpotifyLoading]=useState(false);
            const [spotifyFallback,setSpotifyFallback]=useState(false);
            const [spotifyPlaylist,setSpotifyPlaylist]=useState('https://open.spotify.com/playlist/3HunXm4QT4dxcOz6eAljak?si=mKiXLeNMQM6ioJivpWP-EQ&pi=lAZXLD_QSPmpq');
            const [keepScreenOn,setKeepScreenOn]=useState(false);
            const [wakeLock,setWakeLock]=useState(null);
            const [externalLinkUrl,setExternalLinkUrl]=useState('');
            const [externalLinkTitle,setExternalLinkTitle]=useState('');
            const [defaultHomeRoster,setDefaultHomeRoster]=useState('');
            const [screen,setScreen]=useState('start');
            const [matchCode,setMatchCode]=useState('');
            const [inputCode,setInputCode]=useState('');
            const [connectedUsers,setConnectedUsers]=useState(1);
            const [isMultiplayer,setIsMultiplayer]=useState(false);
            const [expandedGoalieStats,setExpandedGoalieStats]=useState({home: false, away: false});
            const [selectedGoalieStats,setSelectedGoalieStats]=useState({home: 'total', away: 'total'});
            const [gameMode,setGameMode]=useState(localStorage.getItem('gameMode')||'single');
            const [matchEnded,setMatchEnded]=useState(false);
            const [sparkleStats,setSparkleStats]=useState({ });
            const [error,setError]=useState('');
            const [showReconnectPrompt,setShowReconnectPrompt]=useState(false);
            const [savedMatchCode,setSavedMatchCode]=useState('');
            const [currentUser,setCurrentUser]=useState(null);
            const [authLoading,setAuthLoading]=useState(true);
            const [isCreator,setIsCreator]=useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [forceAuth,setForceAuth]=useState(false);
            const [userMatches,setUserMatches]=useState([]);
            const [loadingMatches,setLoadingMatches]=useState(false);
            const [wasInMatch, setWasInMatch]=useState(false);
            const [periodStats,setPeriodStats]=useState({
              1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
            2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
            3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}
      });
            const [playerStats,setPlayerStats]=useState({
              home:{players:{ }},
            away:{players:{ }}
      });
            const [showPlayerStats,setShowPlayerStats]=useState(false);
            const [playerStatsEditMode,setPlayerStatsEditMode]=useState(false);
            const [playerStatsViewMode,setPlayerStatsViewMode]=useState('sideBySide');
            const [playerStatsMoment,setPlayerStatsMoment]=useState('FO/SOG');
            const [showAddPlayerModal,setShowAddPlayerModal]=useState(false);
            const [addPlayerTeam,setAddPlayerTeam]=useState('');
            const [addPlayerNumbers,setAddPlayerNumbers]=useState(['']);
            const [expandedPlayerStats,setExpandedPlayerStats]=useState({ });
            const [collapsedPlayerTables,setCollapsedPlayerTables]=useState({ });
            const audioRefs={homeGoal:useRef(null),awayGoal:useRef(null),homePenalty:useRef(null),awayPenalty:useRef(null),intro:useRef(null)};
            const [introPlaying,setIntroPlaying]=useState(false);
            const matchRef=useRef(null);
            const userId = useRef(
            currentUser?.uid ||
            localStorage.getItem('userId') ||
        (() => {
          const id = Math.random().toString(36).substr(2,9);
            localStorage.setItem('userId', id);
            return id;
        })()
            );
            const homeTeamInputRef = useRef(null);
            const DEFAULT_HOME = 'HOME TEAM';
            const DEFAULT_AWAY = 'AWAY TEAM';
            const [isViewer,setIsViewer]=useState(false);
            const [viewerCount,setViewerCount]=useState(0);
            const [playingSound, setPlayingSound] = useState(null);


const IconSettings = () => (
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              className="w-4 h-4"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M11.983 13.943a1.96 1.96 0 100-3.92 1.96 1.96 0 000 3.92z"
              />
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 11-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 110-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06a1.65 1.65 0 001.82.33h.01a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51h.01a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 112.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.01a1.65 1.65 0 001.51 1H21a2 2 0 110 4h-.09a1.65 1.65 0 00-1.51 1z"
              />
            </svg>
            );

const IconBack = () => (
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              className="w-4 h-4"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M15 19l-7-7 7-7"
              />
            </svg>
            );

const IconChevronDown = () => (
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              className="w-4 h-4"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M19 9l-7 7-7-7"
              />
            </svg>
            );

const IconChevronUp = () => (
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              className="w-4 h-4"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M5 15l7-7 7 7"
              />
            </svg>
            );


      // Normalization functions
      const normalizePeriodStats = (stats) => {
  const normalized = {};
  for (let p = 1; p <= 4; p++) {
    // Only add period 4 if it actually exists in the data
    if (p === 4 && !stats?.[p]) {
      continue;
    }
    normalized[p] = {
      homeScore: stats?.[p]?.homeScore ?? 0,
      awayScore: stats?.[p]?.awayScore ?? 0,
      homeSaves: stats?.[p]?.homeSaves ?? 0,
      awaySaves: stats?.[p]?.awaySaves ?? 0,
      homeGoalie: stats?.[p]?.homeGoalie ?? {starter:{saves:0,ga:0},backup:{saves:0,ga:0}},
      awayGoalie: stats?.[p]?.awayGoalie ?? {starter:{saves:0,ga:0},backup:{saves:0,ga:0}}
    };
  }
  return normalized;
};

      const normalizePlayerStats = (stats) => {
        const normalized = {
          home: { players: {} },
          away: { players: {} }
        };
        
        ['home', 'away'].forEach(team => {
          const players = stats?.[team]?.players ?? {};
          Object.keys(players).forEach(playerNum => {
            const player = players[playerNum];
            normalized[team].players[playerNum] = {
              periods: player?.periods ?? {},
              total: {
                'G': player?.total?.['G'] ?? 0,
                'A': player?.total?.['A'] ?? 0,
                'OnIce+': player?.total?.['OnIce+'] ?? 0,
                'OnIce-': player?.total?.['OnIce-'] ?? 0,
                'FO+': player?.total?.['FO+'] ?? 0,
                'FO-': player?.total?.['FO-'] ?? 0,
                'SOG': player?.total?.['SOG'] ?? 0
              }
            };
          });
        });
        
        return normalized;
      };

      // Reset all game state
      const resetGameState = () => {
        setPeriodStats({
  1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0,homeGoalie:{starter:{saves:0,ga:0},backup:{saves:0,ga:0}},awayGoalie:{starter:{saves:0,ga:0},backup:{saves:0,ga:0}}},
  2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0,homeGoalie:{starter:{saves:0,ga:0},backup:{saves:0,ga:0}},awayGoalie:{starter:{saves:0,ga:0},backup:{saves:0,ga:0}}},
  3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0,homeGoalie:{starter:{saves:0,ga:0},backup:{saves:0,ga:0}},awayGoalie:{starter:{saves:0,ga:0},backup:{saves:0,ga:0}}}
});

setPlayerStats({home:{players:{}},away:{players:{}}});
setCurrentPeriod(1);
setMatchEnded(false);
setGoalFocusSwapped(false);
setActiveGoalies({home:'starter',away:'starter'});
        setIsCreator(false);
        setSparkleStats({});
        setExpandedPlayerStats({});
      };

      useEffect(() => {
        if (isViewer && screen === 'game') {
          setActiveTab('stats');
        }
      }, [isViewer, screen]);

  // Auth listener
      useEffect(()=>{
        if(!auth){
          setAuthLoading(false);
          return;
        }
  
  const unsubscribe=auth.onAuthStateChanged(user=>{
    setCurrentUser(user);
    if(user && db){
      db.ref(`users/${user.uid}/isAdmin`).once('value', snapshot => {
        setIsAdmin(snapshot.val() === true);
      });
    } else {
      setIsAdmin(false);
    }
    setAuthLoading(false);
  });
  
  return ()=>unsubscribe();
},[]);

      // Update userId ref when user changes
      useEffect(()=>{
        if(currentUser?.uid){
          userId.current=currentUser.uid;
        }
      },[currentUser]);

      // Load user's matches when logged in
      useEffect(()=>{
        if(!currentUser||!db)return;
        
        setLoadingMatches(true);
        const matchesRef=db.ref('matches').orderByChild('creatorId').equalTo(currentUser.uid);
        
        matchesRef.on('value',snapshot=>{
          const matches=[];
          snapshot.forEach(child=>{
            matches.push({
              id:child.key,
              ...child.val()
            });
          });
          
          // Sort by creation date, newest first
          matches.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
          
          setUserMatches(matches);
          setLoadingMatches(false);
        });
        
        return()=>matchesRef.off();
      },[currentUser]);

      useEffect(()=>{

        // Clean up old multiplayer data
        try {
          const raw = localStorage.getItem('multiplayerMatch');
          if (raw) {
            const data = JSON.parse(raw);
            if (!data.code || !data.timestamp || Date.now() - data.timestamp > 6 * 60 * 60 * 1000) {
              localStorage.removeItem('multiplayerMatch');
            }
          }
        } catch (e) {
          localStorage.removeItem('multiplayerMatch');
        }

      // Load user preferences
      ['darkMode','spotifyPlaylist','statsCollapsed','keepScreenOn','focusMode','externalLinkUrl','externalLinkTitle','defaultHomeRoster'].forEach(k=>{
          const v=localStorage.getItem(k);
          if(v){
            if(['darkMode','statsCollapsed','keepScreenOn'].includes(k)){
              try {
                eval(`set${k.charAt(0).toUpperCase()+k.slice(1)}(JSON.parse(v))`);
              } catch(e) {
                console.log('Failed to parse', k);
              }
            }else if(k==='focusMode'){
              setFocusMode(v==='null'?null:v);
          }else if(k==='externalLinkUrl'){
            setExternalLinkUrl(v);
          }else if(k==='externalLinkTitle'){
            setExternalLinkTitle(v);
          }else if(k==='defaultHomeRoster'){
            setDefaultHomeRoster(v);
          }else{
              eval(`set${k.charAt(0).toUpperCase()+k.slice(1)}(v)`);
            }
          }
        });
        
            // Check for multiplayer reconnect
            const savedMatch=localStorage.getItem('multiplayerMatch');
            if(savedMatch){
  try{
    const md=JSON.parse(savedMatch);
            if(md.code){
              setSavedMatchCode(md.code);
            setGameMode(md.gameMode||'multi');
            setShowReconnectPrompt(true);
    }else{
              localStorage.removeItem('multiplayerMatch');
    }
  }catch(e){
              localStorage.removeItem('multiplayerMatch');
  }
}

            // Load single-player game if no multiplayer session
            const lastScreen=localStorage.getItem('currentScreen');
            if(!savedMatch && (!lastScreen || lastScreen==='game')){
  const saved=localStorage.getItem('juniorLeagueGame');
            if(saved){
    try {
      const gs=JSON.parse(saved);
            if(gs.currentPeriod && gs.periodStats && gs.homeName) {
              setCurrentPeriod(gs.currentPeriod);
            setHomeName(gs.homeName);
            setAwayName(gs.awayName);
            setPeriodStats(normalizePeriodStats(gs.periodStats));
            if(gs.playerStats) setPlayerStats(normalizePlayerStats(gs.playerStats));
            setGameMode('single');
            setScreen('game');
      } else {
              localStorage.removeItem('juniorLeagueGame');
      }
    } catch(e) {
              console.log('Failed to load saved game:', e);
            localStorage.removeItem('juniorLeagueGame');
    }
  }
}

      },[]);

      useEffect(()=>{localStorage.setItem('darkMode', JSON.stringify(darkMode))},[darkMode]);
      useEffect(()=>{localStorage.setItem('spotifyPlaylist', spotifyPlaylist)},[spotifyPlaylist]);
      useEffect(()=>{localStorage.setItem('statsCollapsed', JSON.stringify(statsCollapsed))},[statsCollapsed]);
      useEffect(()=>{localStorage.setItem('keepScreenOn', JSON.stringify(keepScreenOn))},[keepScreenOn]);
      useEffect(()=>{localStorage.setItem('focusMode', focusMode)},[focusMode]);
      useEffect(()=>{localStorage.setItem('externalLinkUrl', externalLinkUrl)},[externalLinkUrl]);
      useEffect(()=>{localStorage.setItem('externalLinkTitle', externalLinkTitle)},[externalLinkTitle]);
      useEffect(()=>{localStorage.setItem('defaultHomeRoster', defaultHomeRoster)},[defaultHomeRoster]);
      useEffect(()=>{
        if(!isMultiplayer&&screen==='game'){
          const gs={currentPeriod, homeName, awayName, periodStats, playerStats, timestamp:new Date().toISOString()};
            localStorage.setItem('juniorLeagueGame',JSON.stringify(gs));
        }
      },[currentPeriod,homeName,awayName,periodStats,playerStats,isMultiplayer,screen]);
      useEffect(() => {
        if (screen === 'create') {
              setTimeout(() => {
                homeTeamInputRef.current?.focus();
                homeTeamInputRef.current?.select();
              }, 50);
        }
      }, [screen]);

// Handle ?join=XXXXXX-V ‚Üí open "Join game as viewer" dialog with prefilled code
useEffect(() => {
  const params = new URLSearchParams(window.location.search);
            const joinCode = params.get('join');

            if (!joinCode) return;

            const code = joinCode.toUpperCase().trim();
            const isViewerCode = code.endsWith('-V');
            const baseCode = isViewerCode ? code.slice(0, -2) : code;

            if (!isViewerCode || baseCode.length !== 6) return;

            // Open start screen in viewer-join mode
            setInputCode(code);
            setGameMode('multi');
            localStorage.setItem('gameMode', 'multi');
            setIsViewer(true);
            setScreen('start');

            // Optional: clean URL
            window.history.replaceState({ }, document.title, window.location.pathname);
}, []);

useEffect(() => {
  const handleBeforeUnload = (e) => {
    if (
            screen === 'game' &&
            isMultiplayer &&
            matchEnded &&
            isCreator
            ) {
              e.preventDefault();
            e.returnValue = '';
    }
  };

            window.addEventListener('beforeunload', handleBeforeUnload);
  return () => {
              window.removeEventListener('beforeunload', handleBeforeUnload);
  };
}, [screen, isMultiplayer, matchEnded, isCreator]);


      useEffect(()=>{
        const req=async()=>{try{if('wakeLock'in navigator&&keepScreenOn){const l=await navigator.wakeLock.request('screen');setWakeLock(l)}}catch(e){ }};
        const rel=async()=>{if(wakeLock){try{await wakeLock.release();setWakeLock(null)}catch(e){ }}};
            if(keepScreenOn)req();else rel();
        const hvc=()=>{if(keepScreenOn&&document.visibilityState==='visible')req()};
            document.addEventListener('visibilitychange',hvc);
        return()=>{rel();document.removeEventListener('visibilitychange',hvc)}
      },[keepScreenOn]);

      useEffect(()=>{
        if(!isMultiplayer||!matchCode||!db)return;

            let connectionTimeout;
            let hasReceivedData=false;

            matchRef.current=db.ref(`matches/${matchCode}`);
        
        // Timeout efter 10 sekunder utan data
        connectionTimeout=setTimeout(()=>{
          if(!hasReceivedData){
            setError('Failed to connect to match. Check your connection and try again.');
            console.log('Firebase connection timeout for match:', matchCode);
            if(isMultiplayer){
              setIsMultiplayer(false);
              localStorage.removeItem('multiplayerMatch');
            }
          }
        },10000);
        
        matchRef.current.on('value',s=>{
          const d=s.val();
          
          // Vi fick data! Rensa timeout
          if(!hasReceivedData){
            clearTimeout(connectionTimeout);
            hasReceivedData=true;
            setError('');
          }
          
          if(d){
            setPeriodStats(normalizePeriodStats(d.periodStats));
            setCurrentPeriod(d.currentPeriod ?? 1);
            setHomeName(d.homeName ?? 'HOME TEAM');
            setAwayName(d.awayName ?? 'AWAY TEAM');
            setMatchEnded(d.ended ?? false);
            setPlayerStats(normalizePlayerStats(d.playerStats));
            setConnectedUsers(d.users ? Object.keys(d.users).length : 0);
            setViewerCount(d.viewers ? Object.keys(d.viewers).length : 0);
                 setIsCreator(d.creatorId === userId.current);
      
// Check if user was in match but is now removed (kicked)
const isCurrentlyInMatch = !!(d.users && d.users[userId.current]);
const isOwner = d.creatorId === userId.current;
const amIKicked = d.kickedUsers && d.kickedUsers[userId.current];

            if (!isViewer && !isOwner && isMultiplayer && wasInMatch) {
  // SCENARIO 1: Jag √§r kickad
  if (amIKicked) {
              localStorage.removeItem('multiplayerMatch');
            resetGameState();
            setIsMultiplayer(false);
            setMatchCode('');
            setWasInMatch(false);
            setScreen('start');
            alert('You have been removed from this match. You can join as a viewer instead using the viewer code (-V)');
            return;
  }

  // SCENARIO 2: Matchen √§r inte slut, jag var inne, men nu √§r jag inte det (och inte kickad)
  if (!matchEnded && !isCurrentlyInMatch && d.users && Object.keys(d.users).length > 0) {
              // M√∂jligt Network-issue, visa reconect-prompt
              localStorage.removeItem('multiplayerMatch');
            resetGameState();
            setIsMultiplayer(false);
            setMatchCode('');
            setScreen('start');
            alert('You have been disconnected from the match');
  }
}

            // S√§tt wasInMatch ENDAST n√§r vi verkligen √§r inne
            if (isCurrentlyInMatch && !wasInMatch) {
              setWasInMatch(true);
      }
    }
  }, error => {
              clearTimeout(connectionTimeout);
            console.error('Firebase error:', error);
            setError(`Connection error: ${error.message || 'Failed to connect to Firebase'}`);

            if(isMultiplayer && error.code && error.code.includes('PERMISSION')){
              setIsMultiplayer(false);
            localStorage.removeItem('multiplayerMatch');
    }
  }
            );
            const path=isViewer?`viewers/${userId.current}`:`users/${userId.current}`;
const ur=matchRef.current.child(path);

const kickedUsersRef = matchRef.current.child('kickedUsers');

if(isViewer){
  // Viewers kan alltid ansluta
  ur.set(true);
} else {
  // Editors: kontrollera max 5
  matchRef.current.once('value', snapshot => {
    const currentMatch = snapshot.val();
    const editorCount = currentMatch?.users ? Object.keys(currentMatch.users).length : 0;
    const isCreatorOfThisMatch = currentMatch?.creatorId === userId.current;
    
    if(editorCount >= 5 && !isCreatorOfThisMatch){
      setError('Game is full (max 5 editors). Please try joining as viewer instead.');
      setIsMultiplayer(false);
      localStorage.removeItem('multiplayerMatch');
      setScreen('start');
      return;
    }
    
    ur.set({
      joinedAt: Date.now(),
      role: 'editor'
    });
  });
}

ur.onDisconnect().remove();

// Lyssna p√• kickedUsers f√∂r omedelbar detektion
kickedUsersRef.on('value', s => {
  const kickedUsers = s.val() || { };

            // Om jag √§r kickad, kasta ut mig omedelbar
            if (!isViewer && kickedUsers[userId.current]) {
              localStorage.removeItem('multiplayerMatch');
            resetGameState();
            setIsMultiplayer(false);
            setMatchCode('');
            setWasInMatch(false);
            setScreen('start');
            alert('You have been removed from this match. You can join as a viewer instead using the viewer code (-V)');
  }
});

            localStorage.setItem('multiplayerMatch',JSON.stringify({code:matchCode,timestamp:Date.now(),isViewer:isViewer,gameMode:'multi'}));

return()=>{
              clearTimeout(connectionTimeout);
            if(matchRef.current){matchRef.current.off();kickedUsersRef.off();ur.remove()}
        }
      },[isMultiplayer,matchCode,isViewer]);

const kickEditor=(editorId)=>{
  if(!isCreator||!matchRef.current){
              alert('Only the creator can kick editors');
            return;
  }

            if(editorId===userId.current){
              alert('You cannot kick yourself');
            return;
  }

            if(window.confirm('Kick this editor from the game?')){
              matchRef.current.update({
                [`users/${editorId}`]: null,
                [`kickedUsers/${editorId}`]: {
                  kickedAt: Date.now(),
                  kickedBy: userId.current
                }
              }).catch(e => {
                console.error('Failed to kick editor:', e);
                alert('Failed to kick editor');
              });
  }
};

const reconnectToMatch=()=>{
              setWasInMatch(false);
            try{
    const saved=JSON.parse(localStorage.getItem('multiplayerMatch'));
            resetGameState();
            setGameMode('multi');
            localStorage.setItem('gameMode','multi');
            setMatchCode(savedMatchCode);
            setIsViewer(saved?.isViewer||false);
            setIsMultiplayer(true);
            setScreen('game');
            setShowReconnectPrompt(false);
  }catch(e){
              resetGameState();
            setGameMode('multi');
            localStorage.setItem('gameMode','multi');
            setMatchCode(savedMatchCode);
            setIsMultiplayer(true);
            setScreen('game');
            setShowReconnectPrompt(false);
  }
};
      
const startNewSession=()=>{
              localStorage.removeItem('multiplayerMatch');
            localStorage.removeItem('juniorLeagueGame');
            resetGameState();
            // Ta INTE bort gameMode h√§r - l√•t anv√§ndaren v√§lja vad de vill g√∂ra
            setShowReconnectPrompt(false);
            setIsViewer(false);
            setMatchEnded(false);
};
      
const createMatch=()=>{
  // Check if user is logged in
  if(!currentUser){
              alert('You must be logged in to create a game');
            setScreen('start');
            return;
  }

            // Rensa ALL single-game data n√§r vi g√•r till multi
            localStorage.removeItem('juniorLeagueGame');
            localStorage.removeItem('tempMatchCode');

            const code=genCode();

            // Rensa error innan vi f√∂rs√∂ker
            setError('');

            // Uppdatera state OCH navigera
            setMatchCode(code);
            setMatchEnded(false);
            setIsViewer(false);
            setIsCreator(true);
            setGameMode('multi');
            localStorage.setItem('gameMode','multi');

            // Lagra koden tempor√§rt s√• vi kan anv√§nda den direkt
            localStorage.setItem('tempMatchCode', code);

            setScreen('created');
};


const startMatch=()=>{
  if(!db){setError('Firebase not configured');return}
            if(!currentUser){setError('You must be logged in to create a game');return}

            // Anv√§nd matchCode fr√•n state, fallback till localStorage om n√∂dv√§ndigt
            const code = matchCode || localStorage.getItem('tempMatchCode');

            if(!code){
              setError('Match code not found. Please try again.');
            return;
  }

            // S√§kerst√§ll att vi √§r i multi-mode
            if(gameMode!=='multi'){
              setGameMode('multi');
            localStorage.setItem('gameMode','multi');
  }

            // Rensa all single-game data
            localStorage.removeItem('juniorLeagueGame');

            const viewerCode=code+'-V';
            db.ref(`matches/${code}`).set({
  homeName,
  awayName,
  currentPeriod:1,
  periodStats:{
      1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
      2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},
      3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}
    },
    playerStats:{home:{players:{}},away:{players:{}}},
    ended:false,
    createdAt:Date.now(),
    creatorId:userId.current,
    ownerEmail:currentUser.email,
    locked:false,
    
            // Strukturerad users-lista
            users:{
              [userId.current]:{
              joinedAt:Date.now(),
            role:'editor'
      }
    },

            // Viewers lista
            viewers:{ },

            // Kicked users (svartlista)
            kickedUsers:{ },

            viewerCode:viewerCode
  }).then(()=>{
              resetGameState();
            setGameMode('multi');
            localStorage.setItem('gameMode','multi');
            setIsMultiplayer(true);
            setIsCreator(true);
            localStorage.removeItem('juniorLeagueGame');
            // Rensa ALL temp-data
            localStorage.removeItem('tempMatchCode');
            localStorage.removeItem('juniorLeagueGame');

            // Reset game state f√∂r att starta friskt
            resetGameState();

            // S√§kerst√§ll korrekt state
            setGameMode('multi');
            setIsMultiplayer(true);
            setIsCreator(true);
            setMatchCode(code);

            // Spara multiplayer session
            localStorage.setItem('multiplayerMatch',JSON.stringify({code:code,timestamp:Date.now(),isViewer:false,gameMode:'multi'}));

            setScreen('game');
            if(window.gtag)gtag('event','match_created',{match_code:code});
  }).catch(e=>setError('Failed: '+e.message))
};
      
const joinMatch=()=>{
  if(!db){setError('Firebase not configured');return}

            const c=inputCode.toUpperCase().trim();
            const isViewerCode=c.endsWith('-V');
            const baseCode=isViewerCode?c.slice(0,-2):c;

            if((!isViewerCode&&c.length!==6)||(isViewerCode&&baseCode.length!==6)){
              setError('Invalid code');
            return;
  }

            // Editor access requires login
            if(!isViewerCode&&!currentUser){
              setError('You must be logged in to join as editor. Use viewer code (-V) to watch without login.');
            return;
  }

            db.ref(`matches/${baseCode}`).once('value').then(s=>{
if(s.exists()){
  const d=s.val();
  
  // √Ñr anv√§ndaren kickad? (bara relevant f√∂r editors, inte viewers)
if(!isViewerCode && d.kickedUsers && d.kickedUsers[userId.current]){
  setError('You have been removed from this game as an editor. You can join as a viewer instead using the viewer code (-V)');
  return;
}
  
            // √Ñr matchen l√•st OCH √§r du inte creator?
            if(!isViewerCode && d.locked && d.creatorId !== userId.current){
              setError('This game is locked to new editors');
            return;
  }

            // √Ñr det redan 5+ editors (exklusive creator)?
            const editorCount = d.users ? Object.keys(d.users).length : 0;
            const isCreatorOfThisMatch = d.creatorId === userId.current;
  
  if(!isViewerCode && editorCount >= 5 && !isCreatorOfThisMatch){
              setError('This game is full (max 5 editors). You can join as a viewer instead.');
            return;
  }

            if(d.ended){
            // NY KOD: Erbjud att joina som viewer
if(window.confirm('This game has ended. Join as viewer to see final stats?')){
              resetGameState();
            setGameMode('multi');
            localStorage.setItem('gameMode','multi');
            setMatchCode(baseCode);
            setIsViewer(true);
            setIsCreator(d.creatorId === userId.current);
            setIsMultiplayer(true);
            localStorage.removeItem('juniorLeagueGame');
            localStorage.setItem('multiplayerMatch',JSON.stringify({code:baseCode,timestamp:Date.now(),isViewer:true,gameMode:'multi'}));
            setScreen('game');
            if(window.gtag)gtag('event','match_joined_viewer_ended',{match_code:baseCode});
        }else{
              setError('This game has already ended');
        }
      }
            else{
              resetGameState();
            setGameMode('multi');
            localStorage.setItem('gameMode','multi');
            setMatchCode(baseCode);
            setIsViewer(isViewerCode);
            setIsCreator(d.creatorId === userId.current);
            setIsMultiplayer(true);
            localStorage.removeItem('juniorLeagueGame');
            localStorage.setItem('multiplayerMatch',JSON.stringify({code:baseCode,timestamp:Date.now(),isViewer:isViewerCode,gameMode:'multi'}));
            setScreen('game');
  
            // L√§gg till user i r√§tt lista baserat p√• om det √§r viewer eller editor
            if(isViewerCode){
              // Viewer: l√§gg in i viewers-listan
              db.ref(`matches/${baseCode}/viewers/${userId.current}`).set(true).catch(e => {
                console.error('Failed to register as viewer:', e);
              });
  } else {
              // Editor: l√§gg in i users-listan med metadata
              db.ref(`matches/${baseCode}/users/${userId.current}`).set({
                joinedAt: Date.now(),
                role: 'editor'
              }).catch(e => {
                console.error('Failed to register as editor:', e);
              });
  }
  
  if(window.gtag)gtag('event',isViewerCode?'match_joined_viewer':'match_joined_editor',{match_code:baseCode});
}
    }else setError('No game found with that code')
  }).catch(e=>setError('Failed: '+e.message))
};

const continueAlone=()=>{
  const prevMode=gameMode;
            localStorage.removeItem('multiplayerMatch');

            // Om vi kommer fr√•n multi-l√§ge, rensa och b√∂rja nytt
            if(prevMode==='multi'){
              resetGameState();
            localStorage.removeItem('juniorLeagueGame');
  }

            setGameMode('single');
            localStorage.setItem('gameMode','single');
            setIsMultiplayer(false);
            setIsViewer(false);
            setMatchEnded(false);
            setScreen('game');
};
      
      const endMatch = () => {
  if (window.confirm('End game for all users?')) {
    if (matchRef.current) {
              matchRef.current.update({
                ended: true,
                users: {},      // T√∂m users-listan (ist√§llet f√∂r null)
                viewers: {},    // T√∂m viewers-listan (ist√§llet f√∂r null)
                locked: false
              });
    }

            setMatchEnded(true);
            setWasInMatch(false);
            localStorage.removeItem('multiplayerMatch');
            setShowReconnectPrompt(false);
  }
};

const leaveMatch=()=>{
  if(window.confirm('Leave multiplayer game?')){
    // Ta bort fr√•n users eller viewers listen innan vi l√§mnar
    if(isMultiplayer && matchCode && matchRef.current){
      const path = isViewer ? `viewers/${userId.current}` : `users/${userId.current}`;
      matchRef.current.child(path).remove().catch(e => {
        console.error('Failed to remove from match:', e);
      });
    }
    
    localStorage.removeItem('multiplayerMatch');
    resetGameState();
    setGameMode('single');
    localStorage.setItem('gameMode','single');
    setIsMultiplayer(false);
    setIsViewer(false);
    setMatchEnded(false);
    setMatchCode('');
    setScreen('start');
  }
};

const exitToStart=()=>{
  if(window.confirm('Exit to start screen? Your game data will be removed')){
              localStorage.removeItem('juniorLeagueGame');
            resetGameState();
            setGameMode('single');
            setScreen('start');
  }
};

            const MatchHistory = ({darkMode, matches, loading, onJoinMatch, onBack}) => {
  const [filter, setFilter] = React.useState('all'); // 'all', 'active', 'ended'
            const [expandedMatches, setExpandedMatches] = React.useState({ });
  
  const filteredMatches = matches.filter(m => {
    if (filter === 'active') return !m.ended;
            if (filter === 'ended') return m.ended;
            return true;
  });

  const formatDate = (timestamp) => {
    if (!timestamp) return 'Unknown date';
            const date = new Date(timestamp);
            return date.toLocaleDateString('sv-SE', {
              year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
    });
  };

  const getTotalScore = (match) => {
              let homeScore = 0;
            let awayScore = 0;

            Object.keys(match.periodStats || { }).forEach(period => {
              homeScore += match.periodStats[period]?.homeScore || 0;
            awayScore += match.periodStats[period]?.awayScore || 0;
    });

            return {homeScore, awayScore};
  };

            return (
            <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
              <div className={`${darkMode ? 'bg-gray-800 border-b border-gray-700' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-4 shadow-lg`}>
                <div className="max-w-6xl mx-auto">
                  <div className="flex justify-between items-center mb-3">
                    <h2 className="text-xl font-bold">My Games</h2>
                    <button
                      onClick={onBack}
                      className={`${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-white bg-opacity-20 hover:bg-opacity-30'} px-4 py-2 rounded-lg text-sm font-semibold`}
                    >
                      <IconBack />
                    </button>
                  </div>

                  <div className="flex gap-2">
                    {['all', 'active', 'ended'].map(f => (
                      <button
                        key={f}
                        onClick={() => setFilter(f)}
                        className={`px-3 py-1 rounded text-sm font-bold capitalize ${filter === f
                            ? 'bg-yellow-400 text-blue-900'
                            : darkMode
                              ? 'bg-gray-700'
                              : 'bg-white bg-opacity-20'
                          }`}
                      >
                        {f}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="max-w-6xl mx-auto p-4">
                {loading ? (
                  <div className="text-center py-12">
                    <div className={`animate-spin inline-block w-12 h-12 border-4 ${darkMode ? 'border-gray-600 border-t-white' : 'border-gray-300 border-t-blue-600'} rounded-full mb-4`}></div>
                    <div className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Loading games...</div>
                  </div>
                ) : filteredMatches.length === 0 ? (
                  <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-lg shadow p-8 text-center`}>
                    <h3 className="text-xl font-bold mb-2">No games yet</h3>
                    <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'} mb-4`}>
                      {filter === 'active' ? 'No active games' : filter === 'ended' ? 'No ended games' : 'Create your first game to get started!'}
                    </p>
                    <button
                      onClick={onBack}
                      className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold"
                    >
                      Create Game
                    </button>
                  </div>
                ) : (
                  <div className="grid gap-4">
                    {filteredMatches.map(match => {
                      const { homeScore, awayScore } = getTotalScore(match);

                      return (
                        <div
                          key={match.id}
                          className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow-lg p-4 hover:shadow-xl transition-shadow`}
                        >
                          <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center gap-2">
                              {match.ended ? (
                                <span className="bg-gray-500 px-2 py-1 rounded text-xs font-bold text-white">ENDED</span>
                              ) : (
                                <span className="flex items-center gap-1 bg-red-500 px-2 py-1 rounded text-xs font-bold text-white">
                                  <span className="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></span>
                                  LIVE
                                </span>
                              )}
                              <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                {formatDate(match.createdAt)}
                              </span>
                            </div>
                            <span className={`text-xs font-mono ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              {match.id}
                            </span>
                          </div>

                          <div className="grid grid-cols-3 gap-4 items-center mb-3">
                            <div className="text-right">
                              <div className={`font-bold mb-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                {match.homeName || 'Home Team'}
                              </div>
                            </div>

                            <div className="text-center">
                              <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                {homeScore} - {awayScore}
                              </div>
                            </div>

                            <div className="text-left">
                              <div className={`font-bold mb-1 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                {match.awayName || 'Away Team'}
                              </div>
                            </div>
                          </div>

                          <div className="flex gap-2 items-center">
                            <button
                              onClick={() => onJoinMatch(match.id)}
                              className={`flex-1 ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-600 hover:bg-blue-700'} text-white py-2 rounded-lg font-semibold text-sm`}
                            >
                              {match.ended ? 'View Game' : 'Rejoin Game'}
                            </button>

                            {!match.ended && (
                              <button
                                onClick={() => {
                                  navigator.clipboard.writeText(match.id);
                                  alert('Game code copied!');
                                }}
                                className={`px-4 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} ${darkMode ? 'text-white' : 'text-gray-800'} py-2 rounded-lg font-semibold text-sm`}
                              >
                                üìã
                              </button>
                            )}

                            <button
                              onClick={() => setExpandedMatches(prev => ({ ...prev, [match.id]: !prev[match.id] }))}
                              className={`px-3 py-2 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                            >
                              {expandedMatches[match.id] ? <IconChevronUp /> : <IconChevronDown />}
                            </button>
                          </div>

                          {expandedMatches[match.id] && (
                            <div className={`mt-3 pt-3 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} space-y-3`}>
                              <h4 className="font-semibold">Manage Game</h4>

                              <div>
                                <div className="text-sm font-semibold mb-2">Connected Editors:</div>
                                {match.users && Object.keys(match.users).length > 0 ? (
                                  <div className="space-y-1 mb-3">



                                    {Object.keys(match.users).filter(userId => userId !== match.creatorId).map(userId => (
                                      <div key={userId} className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                        <span className="text-sm">{userId}</span>
                                        <button
                                          onClick={() => {
                                            if (window.confirm('Kick out this editor?')) {
                                              db.ref(`matches/${match.id}/users/${userId}`).remove();
                                              db.ref(`matches/${match.id}/kickedUsers/${userId}`).set({
                                                kickedAt: Date.now(),
                                                kickedBy: currentUser.uid
                                              }).catch(e => {
                                                console.error('Failed to record kick:', e);
                                              });
                                            }
                                          }}
                                          className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-semibold"
                                        >
                                          Kick
                                        </button>
                                      </div>
                                    ))}
                              
                          </div>
                        ) : (
                          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>No editors connected</div>
                        )}
                        
                        {match.viewers && Object.keys(match.viewers).length > 0 && (
                          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            üëÅÔ∏è {Object.keys(match.viewers).length} viewer{Object.keys(match.viewers).length !== 1 ? 's' : ''} connected
                          </div>
                        )}
                      </div>
                      
                      <div className="flex items-center gap-2 py-2">
                                <input
                                  type="checkbox"
                                  checked={match.locked || false}
                                  onChange={(e) => {
                                    db.ref(`matches/${match.id}`).update({ locked: e.target.checked });
                                  }}
                                  className="w-4 h-4"
                                  disabled={match.creatorId !== currentUser?.uid || match.ended}
                                />
                                <label className="text-sm cursor-pointer flex-1">
                                  {match.locked ? 'üîí' : 'üîì'} Lock for new editors
                                </label>
                              </div>

                              <div className="flex gap-2 pt-2 border-t">
                                {match.ended && (
                                  <>
                                    <button
                                      onClick={() => {
                                        if (window.confirm('Restart this game? All kicked editors will be able to rejoin.')) {
                                          db.ref(`matches/${match.id}`).update({
                                            ended: false,
                                            kickedUsers: {}
                                          });
                                        }
                                      }}
                                      className="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded font-semibold text-sm"
                                    >
                                      Restart Game
                                    </button>
                                    <button
                                      onClick={() => {
                                        if (window.confirm(`Delete Game ${match.id}?`)) {
                                          db.ref(`matches/${match.id}`).remove();
                                        }
                                      }}
                                      className="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded font-semibold text-sm"
                                    >
                                      Delete Game
                                    </button>
                                  </>
                                )}

                                {!match.ended && (
                                  <button
                                    onClick={() => {
                                      if (window.confirm('End this game for all users?')) {
                                        db.ref(`matches/${match.id}`).update({ ended: true });
                                      }
                                    }}
                                    className="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 rounded font-semibold text-sm"
                                  >
                                    End Game
                                  </button>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>
            );
};

            const AuthScreen = ({darkMode, setDarkMode, onSuccess}) => {
  const [mode, setMode] = React.useState('login'); // 'login' or 'signup'
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [teamName, setTeamName] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);

  const handleSubmit = async (e) => {
              e.preventDefault();
            setError('');
            setLoading(true);

            if (!auth) {
              setError('Authentication not available');
            setLoading(false);
            return;
    }

            try {
      if (mode === 'signup') {
        // Sign up
        if (!teamName.trim()) {
              setError('Please enter a team name');
            setLoading(false);
            return;
        }

            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;

            // Save team info to database
            await db.ref(`users/${user.uid}`).set({
          email: email,
          teamName: teamName.trim(),
          createdAt: Date.now()
        });
        
        onSuccess();
      } else {
        // Login
        await auth.signInWithEmailAndPassword(email, password);
        onSuccess();
      }
    } catch (err) {
      console.error('Auth error:', err);
      
            // User-friendly error messages
            if (err.code === 'auth/email-already-in-use') {
              setError('This email is already registered');
      } else if (err.code === 'auth/weak-password') {
              setError('Password should be at least 6 characters');
      } else if (err.code === 'auth/invalid-email') {
              setError('Invalid email address');
      } else if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
              setError('Invalid email or password');
      } else {
              setError(err.message || 'Authentication failed');
      }
            setLoading(false);
    }
  };

            return (
            <div className={`min-h-screen flex items-center justify-center ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
              <div className="max-w-md w-full p-6">
                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-2xl shadow-2xl p-8`}>

                  <div>
                    <button
                      onClick={() => {
                        onSuccess(); // This will close auth and go back to start
                      }}

                      className={`flex items-center gap-1 text-sm ${darkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-800'}`}
                    >
                      <IconBack />
                      <span>Back</span>
                    </button>
                  </div>

                  <div className="text-center mb-8">
                    <h1 className="text-3xl font-bold mb-2">Hockey Scorekeeper</h1>
                    <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      {mode === 'login' ? 'Login to your account' : 'Create your team account'}
                    </p>
                  </div>

                  <form onSubmit={handleSubmit} className="space-y-4">
                    {mode === 'signup' && (
                      <div>
                        <label className="block text-sm mb-2">Team Name</label>
                        <input
                          type="text"
                          value={teamName}
                          onChange={(e) => setTeamName(e.target.value)}
                          placeholder="e.g. S√∂dert√§lje SK"
                          className={`w-full px-4 py-3 border rounded-lg ${darkMode
                            ? 'bg-gray-700 border-gray-600 text-white'
                            : 'border-gray-300'
                            }`}
                          required
                        />
                      </div>
                    )}

                    <div>
                      <label className="block text-sm mb-2">Email</label>
                      <input
                        type="email"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        placeholder="your@email.com"
                        className={`w-full px-4 py-3 border rounded-lg ${darkMode
                          ? 'bg-gray-700 border-gray-600 text-white'
                          : 'border-gray-300'
                          }`}
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm mb-2">Password</label>
                      <input
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        placeholder="Min 6 characters"
                        className={`w-full px-4 py-3 border rounded-lg ${darkMode
                          ? 'bg-gray-700 border-gray-600 text-white'
                          : 'border-gray-300'
                          }`}
                        required
                        minLength={6}
                      />
                    </div>

                    {error && (
                      <div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded text-sm">
                        {error}
                      </div>
                    )}

                    <button
                      type="submit"
                      disabled={loading}
                      className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-4 rounded-xl font-bold text-lg shadow-lg"
                    >
                      {loading ? 'Please wait...' : mode === 'login' ? 'LOGIN' : 'CREATE ACCOUNT'}
                    </button>
                  </form>

                  <div className="mt-6 text-center space-y-2">
                    <button
                      onClick={() => {
                        setMode(mode === 'login' ? 'signup' : 'login');
                        setError('');
                      }}
                      className={`text-sm ${darkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-800'}`}
                    >
                      {mode === 'login' ? "Don't have an account? Sign up" : 'Already have an account? Login'}
                    </button>

                    <div>
                      <button
                        onClick={() => setDarkMode(!darkMode)}
                        className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}
                      >
                        {darkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            );
};

            const AdminPanel = ({darkMode, setScreen}) => {

  const [sortDir, setSortDir] = React.useState('desc');
            const [matches, setMatches] = React.useState({ });

  React.useEffect(() => {
    if (!db) return;

            const ref = db.ref('matches');
    ref.on('value', snap => {
              setMatches(snap.val() || {});
    });

    return () => ref.off();
  }, []);

  const deleteMatch = (id) => {
    if (!window.confirm(`Delete game ${id}?`)) return;
            db.ref(`matches/${id}`).remove();
  };

  const toggleEnded = (id, ended) => {
              db.ref(`matches/${id}`).update({ ended: !ended });
  };

            return (
            <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-blue-600'} text-white p-4`}>
                <div className="max-w-5xl mx-auto flex justify-between items-center">
                  <h2 className="font-bold text-lg">Admin ‚Äì Games</h2>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setScreen('start')}
                      className="bg-white bg-opacity-20 px-3 py-2 rounded"
                    >
                      <IconBack />
                    </button>
                  </div>
                </div>
              </div>

              <div className="max-w-5xl mx-auto p-4 overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className={darkMode ? 'bg-gray-800 text-gray-200' : 'bg-gray-200'}>
                    <tr>
                      <th className="px-3 py-2 text-left">Match ID</th>

                      <th className="px-3 py-2 text-left">Home</th>
                      <th className="px-3 py-2 text-left">Away</th>
                      <th className="px-3 py-2">Status</th>
                      <th
                        onClick={() =>
                          setSortDir(d => (d === 'asc' ? 'desc' : 'asc'))
                        }
                        className="px-3 py-2 text-center cursor-pointer select-none"
                      >
                        Created {sortDir === 'asc' ? <IconChevronDown /> : <IconChevronUp />}
                      </th>
                      <th className="px-3 py-2 whitespace-nowrap min-w-[120px]">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.keys(matches).length === 0 && (
                      <tr>
                        <td colSpan="4" className="text-center py-6 opacity-60">
                          No games found
                        </td>
                      </tr>
                    )}

                    {Object.entries(matches)
                      .sort((a, b) => {
                        const tA = a[1].createdAt || 0;
                        const tB = b[1].createdAt || 0;
                        return sortDir === 'asc' ? tA - tB : tB - tA;
                      })
                      .map(([id, m]) => (
                        <tr
                          key={id}
                          className={`border-t ${darkMode ? 'border-gray-700 text-gray-200' : 'border-gray-300'}`}
                        >
                          <td className={`px-3 py-2 font-mono ${darkMode ? 'text-gray-200' : ''}`}>{id}</td>
                          <td className={`px-3 py-2 ${darkMode ? 'text-gray-200' : ''}`}>{m.homeName || '‚Äî'}</td>
                          <td className={`px-3 py-2 ${darkMode ? 'text-gray-200' : ''}`}>{m.awayName || '‚Äî'}</td>
                          <td className={`px-3 py-2 text-center ${darkMode ? 'text-gray-200' : ''}`}>
                            {m.ended ? 'Ended' : 'Active'}
                          </td>
                          <td className={`px-3 py-2 text-center ${darkMode ? 'text-gray-200' : ''}`}>
                            {m.createdAt
                              ? new Date(m.createdAt).toLocaleString()
                              : '‚Äî'}
                          </td>
                          <td className="px-3 py-2 text-center space-x-2 whitespace-nowrap">
                            <button
                              onClick={() => toggleEnded(id, m.ended)}
                              className="px-2 py-1 rounded bg-yellow-500 text-white"
                            >
                              {m.ended ? '‚ñ∂' : '‚èπ'}
                            </button>
                            <button
                              onClick={() => deleteMatch(id)}
                              className="px-2 py-1 rounded bg-red-600 text-white"
                            >
                              üóë
                            </button>
                          </td>
                        </tr>
                      ))}
                  </tbody>
                </table>
              </div>
            </div>
            );
};


const updateStat=(team,stat,delta)=>{
  if(isViewer)return;
            if(isMultiplayer&&!currentUser){
              alert('You must be logged in to edit multiplayer games');
            return;
  }
            const ns=structuredClone(periodStats);
            if(!ns[currentPeriod]) {
              ns[currentPeriod] = {
                homeScore: 0, awayScore: 0, homeSaves: 0, awaySaves: 0,
                homeGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } },
                awayGoalie: { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } }
              };
  }

            // Initiera goalie-data om det saknas
            if(!ns[currentPeriod].homeGoalie){
              ns[currentPeriod].homeGoalie = { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } };
  }
            if(!ns[currentPeriod].awayGoalie){
              ns[currentPeriod].awayGoalie = { starter: { saves: 0, ga: 0 }, backup: { saves: 0, ga: 0 } };
  }

            // Om det √§r saves, uppdatera b√•de totala saves OCH den aktiva m√•lvaktens saves
            if(stat==='Saves'){
  const activeGoalie = activeGoalies[team];

            // Uppdatera aktiv m√•lvakts saves
            ns[currentPeriod][team+'Goalie'][activeGoalie].saves = Math.max(0, (ns[currentPeriod][team+'Goalie'][activeGoalie].saves || 0) + delta);

            // R√§kna om totala saves (b√•da m√•lvakter tillsammans)
            const totalSaves = (ns[currentPeriod][team+'Goalie'].starter.saves || 0) + (ns[currentPeriod][team+'Goalie'].backup.saves || 0);
            ns[currentPeriod][team+stat] = totalSaves;
}
            else if (stat === 'Score') {
              // Uppdatera lagets score
              ns[currentPeriod][team + stat] = Math.max(
                0,
                (ns[currentPeriod][team + stat] || 0) + delta
              );

            // Uppdatera GA p√• motst√•ndarlagets AKTIVA m√•lvakt (b√•de + och -)
            const oppTeam = team === 'home' ? 'away' : 'home';
            const oppActiveGoalie = activeGoalies[oppTeam];

            const goalie =
            ns[currentPeriod][oppTeam + 'Goalie'][oppActiveGoalie];

            goalie.ga = Math.max(0, (goalie.ga || 0) + delta);
}

            else{
              ns[currentPeriod][team + stat] = Math.max(0, (ns[currentPeriod][team + stat] || 0) + delta);
  }
  
            setPeriodStats(ns);
            const k=`${team}${stat}${currentPeriod}`;
  setSparkleStats(p=>({...p,[k]:true}));
  setTimeout(()=>setSparkleStats(p=>({...p,[k]:false})),600);
  if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({periodStats:ns})
};

      const updatePlayerStat=(team,playerNum,stat,delta)=>{
        if(isViewer||matchEnded)return;
        if(isMultiplayer&&!currentUser){
          alert('You must be logged in to edit multiplayer games');
          return;
        }
        
        const period=currentPeriod;
        const newStats=structuredClone(playerStats);
        
        if(!newStats[team])newStats[team]={players:{}};
        if(!newStats[team].players)newStats[team].players={};
        
        if(!newStats[team].players[playerNum]){
          newStats[team].players[playerNum]={
            periods:{},
            total:{'G':0,'A':0,'OnIce+':0,'OnIce-':0,'FO+':0,'FO-':0,'SOG':0}
          };
        }
        
        if(!newStats[team].players[playerNum].periods[period]){
          newStats[team].players[playerNum].periods[period]={'G':0,'A':0,'OnIce+':0,'OnIce-':0,'FO+':0,'FO-':0,'SOG':0};
        }
        
        if(stat==='G'){
          const currentSOG=newStats[team].players[playerNum].periods[period]['SOG']||0;
          newStats[team].players[playerNum].periods[period]['SOG']=Math.max(0,currentSOG+delta);
        }
        
        const currentPeriodVal=newStats[team].players[playerNum].periods[period][stat]||0;
        newStats[team].players[playerNum].periods[period][stat]=Math.max(0,currentPeriodVal+delta);
        
        const statsToRecalc=stat==='G'?[stat,'SOG']:[stat];
        statsToRecalc.forEach(s=>{
          newStats[team].players[playerNum].total[s]=0;
          Object.keys(newStats[team].players[playerNum].periods).forEach(p=>{
            newStats[team].players[playerNum].total[s]+=newStats[team].players[playerNum].periods[p][s]||0;
          });
        });
        
            setPlayerStats(newStats);

            const sparkleKeys=stat==='G'?[`${team}${playerNum}G${period}`,`${team}${playerNum}SOG${period}`]:[`${team}${playerNum}${stat}${period}`];
        sparkleKeys.forEach(k=>{
          setSparkleStats(p=>({...p,[k]:true}));
        });
        setTimeout(()=>{
          sparkleKeys.forEach(k=>{
            setSparkleStats(p=>({...p,[k]:false}));
          });
        },600);
        
        if(isMultiplayer&&matchRef.current)matchRef.current.update({playerStats:newStats});
      };
      
      const removePlayer=(team,playerNum)=>{
        if(isViewer||matchEnded)return;
        if(isMultiplayer&&!currentUser){
          alert('You must be logged in to edit multiplayer games');
          return;
        }
        
        const newStats=structuredClone(playerStats);
        
        if(newStats[team]&&newStats[team].players){
          delete newStats[team].players[playerNum];
        }
        
        setPlayerStats(newStats);
        if(isMultiplayer&&matchRef.current)matchRef.current.update({playerStats:newStats});
      };

const addPlayers=(team,numbers)=>{
  const validNumbers=numbers.filter(n=>n&&n.trim()!=='');
            if(validNumbers.length===0)return;
            if(isMultiplayer&&!currentUser){
              alert('You must be logged in to edit multiplayer games');
            return;
  }
  
            const newStats=structuredClone(playerStats);

            if(!newStats[team])newStats[team]={players:{ }};
            if(!newStats[team].players)newStats[team].players={ };
  
  validNumbers.forEach(playerNum=>{
    if(!newStats[team].players[playerNum]){
              newStats[team].players[playerNum] = {
                periods: {},
                total: { 'G': 0, 'A': 0, 'OnIce+': 0, 'OnIce-': 0, 'FO+': 0, 'FO-': 0, 'SOG': 0 }
              };
    }
  });
  
            setPlayerStats(newStats);
            if(isMultiplayer&&matchRef.current)matchRef.current.update({playerStats:newStats});

            setShowAddPlayerModal(false);
            setAddPlayerNumbers(['']);
};

// Parse comma/space separated input into array
const parsePlayerInput = (input) => {
  // Split by comma or space, filter empty, remove duplicates
  const nums = input
            .split(/[,\s]+/)
    .map(n => n.trim())
    .filter(n => n !== '' && /^\d+$/.test(n));
            return [...new Set(nums)];
};

// Handle smart input parsing
const handlePlayerInputChange = (value, idx) => {
  // Check if user typed comma or space (= wants to move to next field)
  if (value.includes(',') || value.includes(' ')) {
    const parsed = parsePlayerInput(value);
    if (parsed.length > 0) {
      // Keep all existing fields before current index, then add parsed numbers
      const before = addPlayerNumbers.slice(0, idx);
      const after = addPlayerNumbers.slice(idx + 1).filter(n => n.trim() !== '');
      
      // Combine: existing + parsed + remaining + empty
      setAddPlayerNumbers([...before, ...parsed, ...after, '']);
      
      // Focus will auto-move to the new empty field
      setTimeout(() => {
        const inputs = document.querySelectorAll('input[type="text"][inputmode="decimal"]');
        inputs[inputs.length - 1]?.focus();
      }, 50);
    }
  } else {
    // Normal single character input
    const newNums = [...addPlayerNumbers];
    newNums[idx] = value;
    setAddPlayerNumbers(newNums);
  }
};

      const playSound = st => {
        const a = audioRefs[st].current;
        if (!a) return;
        setPlayingSound(st);
        a.currentTime = 0;
        a.play().catch(e => console.log('Play failed:', e));
        a.onended = () => {
          setPlayingSound(null);
        };
      };
      
      const toggleIntro=()=>{
        const a=audioRefs.intro.current;
        if(!a)return;
        if(introPlaying){
          a.pause();
          a.currentTime=0;
          setIntroPlaying(false);
          setPlayingSound(null);
        }else{
          a.loop=true;
          a.play().catch(e=>console.log('Play failed:',e));
          setIntroPlaying(true);
          setPlayingSound('intro');
        }
      };
      
      const stopAllSounds=()=>{
        Object.values(audioRefs).forEach(r=>{
          if(r.current){
            r.current.pause();
            r.current.currentTime=0;
          }
        });
        setIntroPlaying(false);
        setPlayingSound(null);
      };
      
      const resetCounters=()=>{
        if(window.confirm('Reset all stats?')){
          const ns={1:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},2:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0},3:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}};
          setPeriodStats(ns);
          setCurrentPeriod(1);
          setPlayerStats({home:{players:{}},away:{players:{}}});
          if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({periodStats:ns,currentPeriod:1,playerStats:{home:{players:{}},away:{players:{}}}});
          else localStorage.removeItem('juniorLeagueGame')
        }
      };

      const calcTotals=()=>{
        let hs=0,as=0,hsv=0,asv=0;
        Object.keys(periodStats).forEach(p=>{
          hs+=(periodStats[p]?.homeScore ?? 0);
          as+=(periodStats[p]?.awayScore ?? 0);
          hsv+=(periodStats[p]?.homeSaves ?? 0);
          asv+=(periodStats[p]?.awaySaves ?? 0);
        });
        return{homeScore:hs,awayScore:as,homeSaves:hsv,awaySaves:asv}
      };
      
      const totals=calcTotals();
      const calcSP=(sv,g)=>{const sh=sv+g;return sh===0?'0.0':((sv/sh)*100).toFixed(1)};

      const genReport=()=>{
        const d=new Date().toLocaleDateString();
        let r=`Game Report - ${d}\n${homeName} ${totals.homeScore} - ${totals.awayScore} ${awayName}\n\nPERIOD BREAKDOWN:\n`;
        Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(p=>{
          const ps=periodStats[p];
          const pLabel=parseInt(p)<=3?`Period ${p}`:`OT`;
          r+=`${pLabel}: ${homeName} ${ps.homeScore}-${ps.awayScore} ${awayName}\n`;
        });
        r+=`\nGOALIE STATS:\n${homeName}: ${totals.homeSaves} saves, ${totals.homeSaves+totals.awayScore} shots against, ${calcSP(totals.homeSaves,totals.awayScore)}%\n`;
        r+=`${awayName}: ${totals.awaySaves} saves, ${totals.awaySaves+totals.homeScore} shots against, ${calcSP(totals.awaySaves,totals.homeScore)}%\n`;
        return r;
      };

const generateCSV=()=>{
        let csv='';
        const d=new Date().toLocaleDateString();
        
        csv+=`Game Report,${d}\n`;
        csv+=`${homeName},${totals.homeScore},${awayName},${totals.awayScore}\n\n`;
        
        csv+=`Period Breakdown\n`;
        csv+=`Period,${homeName},${awayName}\n`;
        Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(p=>{
          const ps=periodStats[p];
          const pLabel=parseInt(p)<=3?`Period ${p}`:`OT`;
          csv+=`${pLabel},${ps.homeScore},${ps.awayScore}\n`;
        });
        
        csv+=`\nGoalie Statistics\n`;
        csv+=`Team,Saves,Shots Against,Save %\n`;
        csv+=`${homeName},${totals.homeSaves},${totals.homeSaves+totals.awayScore},${calcSP(totals.homeSaves,totals.awayScore)}%\n`;
        csv+=`${awayName},${totals.awaySaves},${totals.awaySaves+totals.homeScore},${calcSP(totals.awaySaves,totals.homeScore)}%\n`;
        
        if(playerStats.home?.players||playerStats.away?.players){
          csv+=`\nPlayer Statistics\n`;
          
          ['home','away'].forEach(team=>{
            const teamName=team==='home'?homeName:awayName;
            const players=playerStats[team]?.players||{};
            const playerNums=Object.keys(players).sort((a,b)=>parseInt(a)-parseInt(b));
            
            if(playerNums.length===0)return;
            
            csv+=`\n${teamName}\n`;
            csv+=`Player #,Period,G,A,OnIce+,OnIce-,+/-,FO+,FO-,FO%,SOG\n`;
            
            playerNums.forEach(pNum=>{
              const pData=players[pNum];
              
              Object.keys(pData.periods).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(period=>{
                const pLabel=parseInt(period)<=3?`P${period}`:`OT`;
                const stats=pData.periods[period];
                const onIcePlus=stats['OnIce+']||0;
                const onIceMinus=stats['OnIce-']||0;
                const plusMinus=onIcePlus-onIceMinus;
                const foPlus=stats['FO+']||0;
                const foMinus=stats['FO-']||0;
                const foTotal=foPlus+foMinus;
                const foPct=foTotal===0?'-':((foPlus/foTotal)*100).toFixed(1);
                csv+=`${pNum},${pLabel},${stats['G']||0},${stats['A']||0},${onIcePlus},${onIceMinus},${plusMinus},${foPlus},${foMinus},${foPct},${stats['SOG']||0}\n`;
              });
              
              const totalOnIcePlus=pData.total['OnIce+'];
              const totalOnIceMinus=pData.total['OnIce-'];
              const totalPlusMinus=totalOnIcePlus-totalOnIceMinus;
              const totalFoPlus=pData.total['FO+'];
              const totalFoMinus=pData.total['FO-'];
              const totalFoTotal=totalFoPlus+totalFoMinus;
              const totalFoPct=totalFoTotal===0?'-':((totalFoPlus/totalFoTotal)*100).toFixed(1);
              csv+=`${pNum},TOTAL,${pData.total['G']},${pData.total['A']},${totalOnIcePlus},${totalOnIceMinus},${totalPlusMinus},${totalFoPlus},${totalFoMinus},${totalFoPct},${pData.total['SOG']}\n`;
            });
          });
        }
        
        return csv;
      };
      
      const downloadCSV=()=>{
        const csv=generateCSV();
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const link=document.createElement('a');
        const url=URL.createObjectURL(blob);
        link.setAttribute('href',url);
        link.setAttribute('download',`hockey_stats_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility='hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
      
      const copyStats=()=>navigator.clipboard.writeText(genReport()).then(()=>alert('Stats copied!')).catch(()=>alert('Failed to copy'));
      const copyCode=()=>navigator.clipboard.writeText(matchCode).then(()=>alert('Code copied!')).catch(()=>alert('Failed to copy'));
      const shareStats=()=>{
        if(navigator.share)navigator.share({title:'Game Report',text:genReport()}).catch(()=>copyStats());
        else copyStats();
      };
      
      const getSpotifyUrl=u=>{
        const m=u.match(/playlist\/([a-zA-Z0-9]+)/);
        return m&&m[1]?`https://open.spotify.com/embed/playlist/${m[1]}?utm_source=generator&theme=0`:null;
      };
      
      const loadSpotify=()=>{
        setSpotifyLoading(true);
        setTimeout(()=>{
        setSpotifyLoaded(true);
        setSpotifyLoading(false);
        },100);
      };

      const refSigs = [
  { 
    name: 'Boarding', 
    description: 'Right fist striking the open left palm',
    image: 'images/ref_boarding.png'  
  },
  { 
    name: 'Penalty Shot', 
    description: 'Arms crossed over the head',
    image: 'images/ref_penalty_shot.jpg'  
  }
];

if(showPlayerStats&&screen==='game'){
const statColumns={
  'HG':['G','A','+','-'],
  'AG':['G','A','+','-'],
  'FO/SOG':['FO+','FO-','SOG'],
  'All':['G','A','+','-','FO+','FO-','SOG']
};
        
const activeColumns=statColumns[playerStatsMoment];
        
const renderPlayerTable=(team)=>{
  const teamName=team==='home'?homeName:awayName;
  const players=playerStats?.[team]?.players??{};
  const playerNums=Object.keys(players).sort((a,b)=>parseInt(a)-parseInt(b));
  
  // Determine which columns to show based on mode and team
  let columnsToShow = activeColumns;
  if (playerStatsMoment === 'HG') {
    // Home Goal mode: home team shows G,A,+  away team shows only -
    columnsToShow = team === 'home' ? ['G', 'A', '+'] : ['-'];
  } else if (playerStatsMoment === 'AG') {
    // Away Goal mode: away team shows G,A,+  home team shows only -
    columnsToShow = team === 'away' ? ['G', 'A', '+'] : ['-'];
  }
  
  // Map display column names to actual stat names
  const getActualStatName = (col) => {
    if (col === '+') return 'OnIce+';
    if (col === '-') return 'OnIce-';
    return col;
  };
  
  return(
            <div
  className={`
    ${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'}
    rounded-lg shadow-lg overflow-hidden
    ${
      (playerStatsMoment === 'HG' && team === 'away') ||
      (playerStatsMoment === 'AG' && team === 'home')
        ? 'text-sm'
        : ''
    }
    ${
      playerStatsViewMode === 'stacked' &&
      ((playerStatsMoment === 'HG' && team === 'away') ||
       (playerStatsMoment === 'AG' && team === 'home'))
        ? 'max-w-lg'
        : ''
    }
  `}
>

<button 
  onClick={() => setCollapsedPlayerTables(prev => ({...prev, [team]: !prev[team]}))}
  className={`${darkMode?'bg-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-3 font-bold text-center w-full flex items-center justify-between hover:opacity-90 transition-opacity`}
>
  <span>{teamName}</span>
  <span className="text-xl">{collapsedPlayerTables[team] ? <IconChevronDown /> : <IconChevronUp />}</span>
</button>
              
{!collapsedPlayerTables[team] && (
  <>
    <div className="overflow-x-auto">
      <table className={`w-full ${darkMode?'text-gray-200':''}`}>
        <thead className={`${darkMode?'bg-gray-700 text-gray-200':'bg-gray-100'} sticky top-0 z-20`}>
          <tr>
            <th className={`px-2 py-2 text-left text-xs font-semibold sticky left-0 ${darkMode?'bg-gray-700 text-gray-200':'bg-gray-100'} z-10`}>#</th>
            {columnsToShow.map(col=>(
              <th key={col} className={`px-2 py-2 text-center text-xs font-semibold ${darkMode?'text-gray-200':''}`}>{col}</th>
            ))}
            {playerStatsEditMode&&<th className={`px-2 py-2 text-center text-xs font-semibold ${darkMode?'text-gray-200':''}`}></th>}
          </tr>
        </thead>
        <tbody>
          {playerNums.length===0?(
            <tr>
              <td colSpan={columnsToShow.length+(playerStatsEditMode?2:1)} className={`text-center py-8 ${darkMode?'text-gray-400':'text-gray-500'}`}>
                No players added yet
              </td>
            </tr>
          ):playerNums.map(pNum=>{
            const pData=players[pNum];
            const currentPeriodStats=pData?.periods?.[currentPeriod]??{'G':0,'A':0,'OnIce+':0,'OnIce-':0,'FO+':0,'FO-':0,'SOG':0};
            
            return(
              <tr key={pNum} className={`border-t ${darkMode?'border-gray-700':'border-gray-200'} ${darkMode?'hover:bg-gray-700':'hover:bg-gray-50'} transition-colors group`}>
                <td className={`px-2 py-2 font-bold sticky left-0 ${darkMode?'bg-gray-800':'bg-white'} ${darkMode?'group-hover:bg-gray-700':'group-hover:bg-gray-50'} z-10 transition-colors`}>{pNum}</td>
                {columnsToShow.map(col=>{
                  const actualStat = getActualStatName(col);
                  return (
                    <td key={col} className="px-2 py-2">
                      <div className="flex items-center justify-center gap-1">
                        {playerStatsEditMode&&(
                          <button
                            onClick={()=>updatePlayerStat(team,pNum,actualStat,-1)}
                            disabled={matchEnded||isViewer}
                            className={`w-6 h-6 rounded text-xs font-bold ${darkMode?'bg-red-900 bg-opacity-40 hover:bg-opacity-60 text-red-200':'bg-red-100 hover:bg-red-200 text-red-800'}`}
                          >‚àí</button>
                        )}
                        <button
                          onClick={()=>updatePlayerStat(team,pNum,actualStat,1)}
                          disabled={matchEnded||isViewer}
                          className={`min-w-[2rem] h-6 px-2 rounded text-xs font-bold ${darkMode?'bg-blue-900 bg-opacity-40 hover:bg-opacity-60 text-blue-200':'bg-blue-100 hover:bg-blue-200 text-blue-800'} ${sparkleStats[`${team}${pNum}${actualStat}${currentPeriod}`]?'sparkle':''}`}
                        >
                          {currentPeriodStats[actualStat]||0}
                        </button>
                      </div>
                    </td>
                  );
                })}
                {playerStatsEditMode&&(
                  <td
  className={
    (playerStatsMoment === 'HG' && team === 'away') ||
    (playerStatsMoment === 'AG' && team === 'home')
      ? 'px-1 py-1'
      : 'px-2 py-2'
  }
>

                    <button
                      onClick={()=>removePlayer(team,pNum)}
                      disabled={matchEnded||isViewer}
                      className={`w-6 h-6 rounded text-xs font-bold ${darkMode?'bg-red-900 bg-opacity-40 hover:bg-opacity-60 text-red-200':'bg-red-100 hover:bg-red-200 text-red-800'}`}
                    >√ó</button>
                  </td>
                )}
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
    
    {!isViewer&&!matchEnded&&(
      <div className="p-3 border-t">
        <button
          onClick={()=>{setAddPlayerTeam(team);setShowAddPlayerModal(true)}}
          className={`w-full ${darkMode?'bg-gray-700 hover:bg-gray-600 text-gray-200':'bg-gray-100 hover:bg-gray-200 text-gray-800'} py-2 rounded font-semibold text-sm`}
        >
          + Add Player
        </button>
      </div>
    )}
  </>
)}
            </div>
          );
        };


return(
          <div className={`min-h-screen ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
            <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-3 shadow-lg sticky top-0 z-50`}>
              <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-3">
                  <div className="flex gap-2 items-center flex-wrap">
                   
                    {[1,2,3].map(p=>(
                      <button
                        key={p}
                        onClick={()=>{
                          setCurrentPeriod(p);
                          if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:p});
                        }}
                        disabled={matchEnded||isViewer}
                        className={`px-3 py-1 rounded text-sm font-bold ${currentPeriod===p?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                      >
                        {p}
                      </button>
                    ))}
                    {periodStats[4]&&(
                      <button
                        onClick={()=>{
                          setCurrentPeriod(4);
                          if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:4});
                        }}
                        disabled={matchEnded||isViewer}
                        className={`px-3 py-1 rounded text-sm font-bold ${currentPeriod===4?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                      >
                        OT
                      </button>
                    )}
                    {!periodStats[4]&&currentPeriod===3&&(
                      <button
                        onClick={()=>{
                          const updated={...periodStats,4:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}};
                          setPeriodStats(updated);
                          setCurrentPeriod(4);
                          if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({periodStats:updated,currentPeriod:4});
                        }}
                        disabled={matchEnded||isViewer}
                        className={`px-3 py-1 rounded text-sm font-bold ${darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                      >
                        +OT
                      </button>
                    )}
                  </div>
                  
                  <button
                    onClick={()=>setShowPlayerStats(false)}
                    className={`${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-1`}
                  >
                    <span className="text-lg"><IconBack /></span>
                    <span className="hidden sm:inline">Back</span>
                  </button>
                </div>
                
                <div className="flex gap-2 items-center flex-wrap">
                  
{[
  {key:'HG',label:window.innerWidth >= 640 ? 'Home Goal' : 'HG'},
  {key:'AG',label:window.innerWidth >= 640 ? 'Away Goal' : 'AG'},
  {key:'FO/SOG',label:'FO/SOG'},
  {key:'All',label:'All'}
].map(m=>(
                    <button
                      key={m.key}
                      onClick={()=>setPlayerStatsMoment(m.key)}
                      className={`px-3 py-1 rounded text-sm font-bold ${playerStatsMoment===m.key?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                    >
                      {m.label}
                    </button>
                  ))}


                <div className="flex gap-2 items-center flex-wrap">
 
<label className="hidden sm:flex items-center gap-2">
  <span className="text-sm"></span>
  <select
    value={playerStatsViewMode}
    onChange={(e)=>setPlayerStatsViewMode(e.target.value)}
    className={`px-2 py-1 rounded text-sm ${
      darkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-800'
    }`}
  >
    <option value="sideBySide">Side by Side</option>
    <option value="stacked">Stacked</option>
  </select>
</label>

                 <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={playerStatsEditMode}
                      onChange={(e)=>setPlayerStatsEditMode(e.target.checked)}
                      className="w-4 h-4"
                    />
                    <span className="text-sm">Edit</span>
                  </label>  
                </div>
                </div>
              </div>
            </div>
            
            <div className="max-w-7xl mx-auto p-2">
                <div
    className={`grid gap-2 ${
      playerStatsViewMode === 'sideBySide' && playerStatsMoment === 'All'
        ? 'md:grid-cols-2'
        : ''
    }`}
    style={
      playerStatsViewMode === 'sideBySide' &&
      (playerStatsMoment === 'HG' || playerStatsMoment === 'AG' || playerStatsMoment === 'FO/SOG')
        ? {
            gridTemplateColumns:
              playerStatsMoment === 'HG'
                ? '2fr 1fr'   // HOME bred, AWAY smal
                : playerStatsMoment === 'AG'
                ? '1fr 2fr'   // AWAY bred, HOME smal
                : '1fr 1fr'   // FO/SOG - 50/50
          }
        : undefined
    }
  >
    {renderPlayerTable('home')}
    {renderPlayerTable('away')}
  </div>
            </div>

{showAddPlayerModal&&(
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-lg shadow-xl p-4 max-w-sm w-full`}>
      <h3 className="text-lg font-bold mb-3">Add Player(s)</h3>
      
      {/* Default roster hint */}
      {addPlayerTeam === 'home' && defaultHomeRoster && addPlayerNumbers.length === 1 && addPlayerNumbers[0] === '' && Object.keys(playerStats.home?.players || {}).length === 0 && (
        <div className={`mb-3 p-3 rounded ${darkMode ? 'bg-blue-900 bg-opacity-30 border border-blue-700' : 'bg-blue-50 border border-blue-200'}`}>
          <p className="text-xs mb-2 opacity-75">Default home roster (from settings):</p>
          <button
            onClick={() => {
              const parsed = parsePlayerInput(defaultHomeRoster);
              setAddPlayerNumbers([...parsed, '']);
            }}
            className={`w-full ${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-500 hover:bg-blue-600'} text-white py-2 rounded font-semibold text-sm`}
          >
            Load: {defaultHomeRoster}
          </button>
        </div>
      )}
      
      <div className={`mb-2 p-2 rounded text-xs ${darkMode?'bg-gray-700 text-gray-300':'bg-gray-100 text-gray-600'}`}>
        üí° Tip: Type "2,3,4" or "2 3 4" to add multiple players at once
      </div>
      
      <div className="space-y-3 mb-3 max-h-64 overflow-y-auto">
        {addPlayerNumbers.map((num,idx)=>(
          <div key={idx}>
            <input
              type="text"
              inputMode="decimal"
              value={num}
              onChange={(e)=>handlePlayerInputChange(e.target.value, idx)}
              onKeyDown={(e)=>{
                if(e.key==='Enter'&&num.trim()!==''){
                  e.preventDefault();
                  if(idx===addPlayerNumbers.length-1){
                    setAddPlayerNumbers([...addPlayerNumbers,'']);
                    setTimeout(()=>{
                      const inputs=document.querySelectorAll('input[type="text"][inputmode="decimal"]');
                      inputs[inputs.length-1]?.focus();
                    },50);
                  }else{
                    const inputs=document.querySelectorAll('input[type="text"][inputmode="decimal"]');
                    inputs[idx+1]?.focus();
                  }
                }
              }}
              placeholder={idx === 0 ? "e.g. 2,3,4 or 2 3 4" : `Player #${idx+1}`}
              className={`w-full px-3 py-3 border rounded text-center font-bold text-xl ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'}`}
              autoFocus={idx===addPlayerNumbers.length-1}
            />
            {num.trim()!==''&&idx===addPlayerNumbers.length-1&&(
              <button
                onClick={()=>{
                  setAddPlayerNumbers([...addPlayerNumbers,'']);
                  setTimeout(()=>{
                    const inputs=document.querySelectorAll('input[type="text"][inputmode="decimal"]');
                    inputs[inputs.length-1]?.focus();
                  },50);
                }}
                className={`w-full mt-2 ${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-500 hover:bg-blue-600'} text-white py-2 rounded font-semibold text-sm`}
              >
                Next ‚Üí Add Another Player
              </button>
            )}
          </div>
        ))}
      </div>
      <div className="flex gap-2">
        <button
          onClick={()=>{setShowAddPlayerModal(false);setAddPlayerNumbers([''])}}
          className={`flex-1 ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-200 hover:bg-gray-300'} py-2 rounded font-semibold text-sm`}
        >
          Cancel
        </button>
        <button
          onClick={()=>addPlayers(addPlayerTeam,addPlayerNumbers)}
          disabled={addPlayerNumbers.filter(n=>n&&n.trim()!=='').length===0}
          className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-2 rounded font-semibold text-sm"
        >
          Add ({addPlayerNumbers.filter(n=>n&&n.trim()!=='').length})
        </button>
      </div>
    </div>
  </div>
)}          </div>
        );
      }

      // Show loading while checking auth
      if(authLoading)return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="text-center">
            <div className={`animate-spin inline-block w-12 h-12 border-4 ${darkMode?'border-gray-600 border-t-white':'border-gray-300 border-t-blue-600'} rounded-full mb-4`}></div>
            <div className={`${darkMode?'text-gray-300':'text-gray-600'}`}>Loading...</div>
          </div>
        </div>
      );

// Show auth screen if not logged in and trying to create OR if forced
      if(!currentUser&&(screen==='create'||screen==='created'||forceAuth))return(
        <AuthScreen darkMode={darkMode} setDarkMode={setDarkMode} onSuccess={()=>{
          // After successful login, clear force flag and go to start
          setForceAuth(false);
          setScreen('start');
        }}/>
      );

      if(showReconnectPrompt)return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <h3 className="text-xl font-bold mb-3">Reconnect to game</h3>
              <p className={`${darkMode?'text-gray-300':'text-gray-600'} mb-6`}>
                Match Code: <span className="font-mono font-bold">{savedMatchCode}</span>
              </p>
              <div className="flex gap-3">
                <button onClick={reconnectToMatch} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">Reconnect</button>
                <button onClick={startNewSession} className={`flex-1 ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-200 hover:bg-gray-300'} py-3 rounded-lg font-semibold`}>Start Screen</button>
              </div>
            </div>
          </div>
        </div>
      );

if(screen==='start')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <div className="text-center mb-8">
                <h1 className="text-3xl font-bold mb-2">Hockey Scorekeeper</h1>
                {currentUser?(
                  <div className={`${darkMode?'text-gray-300':'text-gray-600'}`}>
                    
                    <p className="text-sm opacity-75">{currentUser.email}</p>

                {currentUser&&(
                  <button 
                    onClick={async()=>{
                      if(window.confirm('Sign out?')){
                        await auth.signOut();
                        setScreen('start');
                      }
                    }} 
                    className={`w-full text-sm ${darkMode?'text-red-400 hover:text-red-300':'text-red-600 hover:text-red-700'} py-2 font-semibold`}
                  >
                    SIGN OUT
                  </button>
                )}

                  </div>
                ):(
                  <p className={`${darkMode?'text-gray-300':'text-gray-600'}`}>
                    Track your game together
                  </p>
                )}
              </div>
              
              <div className="space-y-3">
                {/* Login / Create Account - only if not logged in */}
                {!currentUser&&(
                  <button 
                    onClick={()=>{setForceAuth(true)}}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-semibold text-lg shadow-lg flex items-center justify-center gap-2"
                  >
                    <span>üîê</span>
                    <span>LOGIN / CREATE ACCOUNT</span>
                  </button>
                )}
                
                {/* My Matches - only if logged in with matches */}
                {currentUser&&userMatches.length>0&&(
                  <button 
                    onClick={()=>setScreen('history')} 
                    className={`w-full ${darkMode?'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600':'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
                  >
                    MY GAMES ({userMatches.length})
                  </button>
                )}
                
               {/* Create Match */}
<button 
  onClick={()=>{
    if(!currentUser){
      setForceAuth(true);
    }else{
      setScreen('create');
    }
  }}
  className={`w-full flex items-center justify-center relative ${darkMode?'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600':'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
>
  <span className="absolute right-4">{!currentUser && 'üîí'}</span>
  <span>CREATE GAME</span>
</button>
                
                {/* Join Game as Editor */}
<button 
  onClick={()=>{
    if(!currentUser){
      setForceAuth(true);
    }else{
      setScreen('join');
    }
  }}
  className={`w-full flex items-center justify-center relative ${darkMode?'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600':'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
>
  <span className="absolute right-4">{!currentUser && 'üîí'}</span>
  <span>JOIN GAME</span>
</button>
               
                {/* Join Match as Viewer - always available */}
                <button 
                  onClick={()=>setScreen('join')}
                  className={`w-full ${darkMode?'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600':'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
                >
                  JOIN GAME AS VIEWER
                </button>
                
                {/* Continue Alone - always available */}
                <button 
                  onClick={continueAlone} 
                  className={`w-full ${darkMode?'bg-gray-700 hover:bg-gray-600 border-2 border-gray-600':'bg-white border-2 border-gray-300 hover:bg-gray-50'} py-3 rounded-xl font-semibold shadow-lg`}
                >
                  ... or CONTINUE ALONE
                </button>
              </div>
              
{/* Bottom section with dark mode, admin and logout */}
              <div className="mt-6 pt-6 border-t border-opacity-20 space-y-2">
                {currentUser && isAdmin && (
                  <button 
                    onClick={() => setScreen('admin')}
                    className={`w-full text-sm ${darkMode?'bg-gray-700 hover:bg-gray-600 text-white':'bg-gray-100 hover:bg-gray-200 text-gray-800'} py-2 rounded font-semibold`}
                  >
                    üîí Admin Panel
                  </button>
                )}
                <button 
                  onClick={()=>setDarkMode(!darkMode)} 
                  className={`w-full text-sm ${darkMode?'text-gray-400 hover:text-gray-300':'text-gray-600 hover:text-gray-800'} py-2`}
                >
                  {darkMode?'‚òÄÔ∏è Light Mode':'üåô Dark Mode'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );

if (screen === 'admin') {
  return <AdminPanel
    darkMode={darkMode}
    setScreen={setScreen}
  />;
}

if(screen==='history'){
  return <MatchHistory
    darkMode={darkMode}
    matches={userMatches}
    loading={loadingMatches}
    onJoinMatch={(matchCode)=>{
      resetGameState();
      setGameMode('multi');
      localStorage.setItem('gameMode','multi');
      setMatchCode(matchCode);
      setIsViewer(false);
      setIsMultiplayer(true);
      localStorage.setItem('multiplayerMatch',JSON.stringify({code:matchCode,timestamp:Date.now(),isViewer:false,gameMode:'multi'}));
      setScreen('game');
    }}
    onBack={()=>setScreen('start')}
  />;
}

if(screen==='create')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              
<button onClick={()=>setScreen('start')} className={`flex items-center gap-1 text-sm  ${darkMode?'text-gray-400':'text-gray-600'}`}><IconBack />
  <span>Back</span></button>

              <h2 className="text-2xl font-bold mb-6">New Game</h2>
              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-sm mb-2">Home Team</label>

                 
<div className="relative">
  <input
    ref={homeTeamInputRef}
    type="text"
    value={homeName}
    onChange={e => setHomeName(e.target.value)}
    className={`w-full px-4 py-3 pr-10 border rounded-lg
      ${darkMode
        ? 'bg-gray-700 border-gray-600 text-white'
        : 'border-gray-300'
      }`}
  />

  {homeName === DEFAULT_HOME && (
    <button
      type="button"
      onClick={() => setHomeName('')}
      className="absolute right-3 top-1/2 -translate-y-1/2
                 text-gray-400 hover:text-gray-600"
      aria-label="Clear home team"
    >
      √ó
    </button>
  )}
</div>
                </div>
                <div>
                  <label className="block text-sm mb-2">Away Team</label>
                  <div className="relative">
  <input
    type="text"
    value={awayName}
    onChange={e => setAwayName(e.target.value)}
    className={`w-full px-4 py-3 pr-10 border rounded-lg
      ${darkMode
        ? 'bg-gray-700 border-gray-600 text-white'
        : 'border-gray-300'
      }`}
  />

  {awayName && (
    <button
      type="button"
      onClick={() => setAwayName('')}
      className="absolute right-3 top-1/2 -translate-y-1/2
                 text-gray-400 hover:text-gray-600"
      aria-label="Clear away team"
    >
      √ó
    </button>
  )}
</div>
                </div>
              </div>
              <button onClick={createMatch} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">START GAME</button>
            </div>
          </div>
        </div>
      );

      if(screen==='created')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <div className="text-center mb-6">
                <h2 className="text-2xl font-bold mb-2">Game Created</h2>
              </div>
              <div className={`${darkMode?'bg-gray-700':'bg-blue-50'} rounded-xl p-6 mb-6`}>
                <p className={`text-sm font-semibold mb-3 ${darkMode?'text-gray-300':'text-gray-600'}`}>üìù Editor Code (max 5 users)</p>
                <div className="flex flex-col sm:flex-row items-stretch gap-3 mb-4">
                  <div className={`flex-1 ${darkMode?'bg-gray-800':'bg-white'} rounded-lg py-4 px-6 text-center border-2 ${darkMode?'border-gray-600':'border-gray-200'}`}>
                    <div className={`text-3xl font-bold tracking-widest ${darkMode?'text-white':'text-gray-900'}`}>{matchCode}</div>
                  </div>
                  <button onClick={copyCode} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-lg font-semibold whitespace-nowrap">Copy</button>
                </div>
                
                <p className={`text-sm font-semibold mb-3 ${darkMode?'text-gray-300':'text-gray-600'}`}>üëÅÔ∏è Viewer Code (read-only)</p>
                <div className="flex flex-col sm:flex-row items-stretch gap-3">
                  <div className={`flex-1 ${darkMode?'bg-gray-800':'bg-white'} rounded-lg py-4 px-6 text-center border-2 ${darkMode?'border-gray-600':'border-gray-200'}`}>
                    <div className={`text-2xl font-bold tracking-widest ${darkMode?'text-white':'text-gray-900'}`}>{matchCode}-V</div>
                  </div>
                  <button onClick={()=>navigator.clipboard.writeText(matchCode+'-V').then(()=>alert('Code copied!')).catch(()=>alert('Failed to copy'))} className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-4 rounded-lg font-semibold whitespace-nowrap">Copy</button>
                </div>
              </div>

              {error&&<div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded mb-4">{error}</div>}
              <button onClick={startMatch} className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg">CONTINUE TO GAME</button>
              <button onClick={()=>setScreen('start')} className={`w-full mt-3 ${darkMode?'text-gray-400':'text-gray-600'} py-2`}>Back</button>
            </div>
          </div>
        </div>
      );

      if(screen==='join')return(
        <div className={`min-h-screen flex items-center justify-center ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          <div className="max-w-md w-full p-6">
            <div className={`${darkMode?'bg-gray-800 text-white':'bg-white'} rounded-2xl shadow-2xl p-8`}>
              <button onClick={()=>setScreen('start')} className={`flex items-center gap-1 text-sm  ${darkMode?'text-gray-400':'text-gray-600'}`}><IconBack />
                  <span>Back</span></button>
              <h2 className="text-2xl font-bold mb-6">Join Game</h2>
 
             
              <div className={`${darkMode?'bg-gray-700 border-gray-600':'bg-blue-50 border-blue-200'} border rounded-lg p-4 mb-6 text-sm`}>
                <div className="font-semibold mb-2">Two ways to join:</div>
                <div className="space-y-2">
                  <div>
                    <span className="font-bold">Editor code (ABC123):</span>
                    <div className={`${darkMode?'text-gray-300':'text-gray-600'}`}>Full editing rights {!currentUser&&'(requires login)'}</div>
                  </div>
                  <div>
                    <span className="font-bold">Viewer code (ABC123-V):</span>
                    <div className={`${darkMode?'text-gray-300':'text-gray-600'}`}>Read-only live stats (no login needed)</div>
                  </div>
                </div>
              </div>
              
              <div className="mb-6">
                <label className="block text-sm mb-2">Enter game code:</label>
                <input type="text" value={inputCode} onChange={e=>{setInputCode(e.target.value.toUpperCase());setError('')}} maxLength={8} placeholder="ABC123" className={`w-full px-4 py-4 border rounded-lg text-center text-2xl font-bold tracking-widest ${darkMode?'bg-gray-700 border-gray-600 text-white':'border-gray-300'}`}/>
              </div>
            {error&&<div className="bg-red-100 border border-red-400 text-red-800 px-4 py-3 rounded mb-4 text-sm">
                <div className="mb-2">{error}</div>
 {error.includes('logged in')&&(
                  <button 
                    onClick={()=>{
                      setError('');
                      setForceAuth(true);
                      setScreen('start');
                    }}
                    className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-semibold text-sm"
                  >
                    ‚Üí Login Now
                  </button>
                )}
              </div>}
              <button onClick={joinMatch} disabled={!(inputCode.length===6||(inputCode.length===8&&inputCode.endsWith('-V')))} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-4 rounded-xl font-bold text-lg shadow-lg">CONNECT</button>
            </div>
          </div>
        </div>
      );

if(focusMode&&screen==='game'){
  const homeTeam = goalFocusSwapped ? 'away' : 'home';
 const awayTeam = goalFocusSwapped ? 'home' : 'away';
  const homeName_ = goalFocusSwapped ? awayName : homeName;
  const awayName_ = goalFocusSwapped ? homeName : awayName;
  const homeGoals = goalFocusSwapped ? totals.awayScore : totals.homeScore;
  const awayGoals = goalFocusSwapped ? totals.homeScore : totals.awayScore;
  const homeSaves = goalFocusSwapped ? totals.awaySaves : totals.homeSaves;
  const awaySaves = goalFocusSwapped ? totals.homeSaves : totals.awaySaves;


const renderGoalieCard = (team, name, goals, saves) => {
  const activeGoalie = activeGoalies[team];
  const currentPeriodSaves = periodStats[currentPeriod]?.[team+'Saves'] ?? 0;
  
  return (
    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-lg overflow-hidden border ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
      {/* Header with team name and total goals */}
      <div className={`${darkMode ? 'bg-gradient-to-r from-blue-700 to-blue-600' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white px-4 py-3 flex items-center justify-between`}>
        <span className="font-bold">{name}</span>
        <span className="text-2xl font-bold">{goals}</span>
      </div>

      {/* Content */}
      <div className="p-4">
        {/* Period info and total saves */}
        <div className={`text-sm mb-2 text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          <span className="opacity-75">Period {currentPeriod}</span>
          <span className="opacity-30 mx-1">¬∑</span>
          <span className="opacity-90 font-semibold">{currentPeriodSaves} {currentPeriodSaves === 1 ? 'save' : 'saves'}</span>
        </div>
        
        {/* Saves controls - same style as main screen */}
        <div className="flex items-center justify-center gap-3 mb-2">

          <button 
            onClick={() => updateStat(team, 'Saves', -1)} 
            disabled={matchEnded || isViewer}
            className="bg-[#6187E3] bg-opacity-80 w-10 h-10 rounded flex items-center justify-center text-white text-xl font-bold hover:bg-opacity-70"
          >
            ‚àí
          </button>
          <div className={`text-4xl font-bold min-w-[3rem] text-center ${sparkleStats[`${team}Saves${currentPeriod}`]?'sparkle':''} ${darkMode ? 'text-white' : 'text-gray-900'}`}>
            {saves}
          </div>
          <button 
            onClick={() => updateStat(team, 'Saves', 1)} 
            disabled={matchEnded || isViewer}
            className="bg-[#6187E3] bg-opacity-80 w-10 h-10 rounded flex items-center justify-center text-white text-xl font-bold hover:bg-opacity-70"
          >
            +
          </button>
        </div>
        
        {/* Period breakdown */}
        <div className={`text-xs opacity-75 text-center mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr) => {
            const isCurrentPeriod = parseInt(p) === currentPeriod;
            return <span key={p} className={isCurrentPeriod ? 'font-bold underline' : ''}>{periodStats[p][team+'Saves']}{i<arr.length-1?'-':''}</span>;
          })})
        </div>
        
        {/* Goalie switch button */}
        <div className={`text-center pt-3 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
          <div className={`text-xs mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            Recording for: <span className="font-semibold">{activeGoalie === 'starter' ? 'Starter' : 'Backup'}</span>
          </div>
          <button
            onClick={() => setActiveGoalies(prev => ({...prev, [team]: activeGoalie === 'starter' ? 'backup' : 'starter'}))}
            disabled={matchEnded || isViewer}
            className={`px-4 py-2 rounded font-semibold text-sm transition-colors ${
              darkMode 
                ? 'bg-gray-700 hover:bg-gray-600 text-gray-300' 
                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
            } disabled:opacity-50`}
          >
            Switch Goalie 
          </button>
        </div>
      </div>
    </div>
  );
};


  {/* Statistics Section */}
        <div className="space-y-3">
          {[
            {team: homeTeam, name: homeName_, goals: homeGoals, saves: homeSaves},
            {team: awayTeam, name: awayName_, goals: awayGoals, saves: awaySaves}
         ].map(teamStats => {
  const selectedGoalie = selectedGoalieStats[teamStats.team];
                        
  const periodKeys = Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b));
            
            // Calculate per goalie per period
            const tableData = periodKeys.map(p => {
              const goalieData = periodStats[p]?.[teamStats.team+'Goalie'];
              const starterSaves = goalieData?.starter?.saves ?? 0;
              const starterGA = goalieData?.starter?.ga ?? 0;
              const backupSaves = goalieData?.backup?.saves ?? 0;
              const backupGA = goalieData?.backup?.ga ?? 0;
              
              return { 
                period: p, 
                starter: {
                  saves: starterSaves,
                  ga: starterGA,
                  sog: starterSaves + starterGA,
                  svsPct: (starterSaves + starterGA) === 0 ? '-' : ((starterSaves / (starterSaves + starterGA)) * 100).toFixed(1)
                },
                backup: {
                  saves: backupSaves,
                  ga: backupGA,
                  sog: backupSaves + backupGA,
                  svsPct: (backupSaves + backupGA) === 0 ? '-' : ((backupSaves / (backupSaves + backupGA)) * 100).toFixed(1)
                }
              };
            });
            
            // Calculate totals per goalie
            let starterTotalSaves = 0, starterTotalGA = 0;
            let backupTotalSaves = 0, backupTotalGA = 0;
            tableData.forEach(d => {
              starterTotalSaves += d.starter.saves;
              starterTotalGA += d.starter.ga;
              backupTotalSaves += d.backup.saves;
              backupTotalGA += d.backup.ga;
            });
            const starterTotalSOG = starterTotalSaves + starterTotalGA;
            const backupTotalSOG = backupTotalSaves + backupTotalGA;
            const starterTotalSvsPct = starterTotalSOG === 0 ? '-' : ((starterTotalSaves / starterTotalSOG) * 100).toFixed(1);
            const backupTotalSvsPct = backupTotalSOG === 0 ? '-' : ((backupTotalSaves / backupTotalSOG) * 100).toFixed(1);
            
            const isExpanded = expandedGoalieStats[teamStats.team];
            
            // Choose which goalie's data to display
            const displayData = selectedGoalie === 'starter' 
              ? { tableData: tableData.map(d => ({period: d.period, ...d.starter})), total: {saves: starterTotalSaves, ga: starterTotalGA, sog: starterTotalSOG, svsPct: starterTotalSvsPct} }
              : { tableData: tableData.map(d => ({period: d.period, ...d.backup})), total: {saves: backupTotalSaves, ga: backupTotalGA, sog: backupTotalSOG, svsPct: backupTotalSvsPct} };
            
            return (
              <div key={teamStats.team} className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow-lg overflow-hidden`}>
                {/* Toggle Header */}
                <button
                  onClick={() => setExpandedGoalieStats(prev => ({...prev, [teamStats.team]: !prev[teamStats.team]}))}
                  className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} px-4 py-3 font-semibold text-left flex items-center justify-between transition-colors`}
                >
                  <span>{teamStats.name}</span>
                  <span className={`transition-transform ${isExpanded ? 'rotate-180' : ''}`}><IconChevronDown /></span>
                </button>
                
                {/* Goalie Toggle & Statistics Table - Collapsible */}
                {isExpanded && (
                  <div className="p-4">
                    
{/* Goalie Toggle */}
                    <div className="mb-3 flex gap-1">
                      <button
  onClick={() => setSelectedGoalieStats(prev => ({...prev, [teamStats.team]: 'starter'}))}
                        className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${
                          selectedGoalie === 'starter'
                            ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
                            : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
                        }`}
                      >
                        Starter
                      </button>
                      <button
  onClick={() => setSelectedGoalieStats(prev => ({...prev, [teamStats.team]: 'backup'}))}
                        className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${
                          selectedGoalie === 'backup'
                            ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
                            : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
                        }`}
                      >
                        Backup
                      </button>
                    </div>
                    
                    <div className="overflow-x-auto">
                      <table className={`w-full text-xs ${darkMode ? 'text-gray-100' : 'text-gray-900'}`}>
                        <thead>
                          <tr className={`${darkMode ? 'bg-gray-700 text-gray-100' : 'bg-gray-100 text-gray-800'}`}>
                            <th className="text-left px-2 py-2">Stat</th>
                            {periodKeys.map(p => (
                              <th key={p} className="text-center px-1 py-2">
                                {parseInt(p) <= 3 ? `P${p}` : 'OT'}
                              </th>
                            ))}
                            <th className="text-center px-2 py-2 font-bold">Tot</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">GA</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs">{d.ga}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.ga}</td>
                          </tr>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">SOG</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs">{d.sog}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.sog}</td>
                          </tr>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">SVS</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs">{d.saves}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.saves}</td>
                          </tr>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">SVS%</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs font-semibold">{d.svsPct}{d.svsPct !== '-' ? '%' : ''}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.svsPct}{displayData.total.svsPct !== '-' ? '%' : ''}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>



  return (
    <div className={`min-h-screen ${darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
      <audio ref={audioRefs.homeGoal} src="homeGoal.mp3"/>
      <audio ref={audioRefs.awayGoal} src="awayGoal.mp3"/>
      <audio ref={audioRefs.homePenalty} src="homePenalty.mp3"/>
      <audio ref={audioRefs.awayPenalty} src="awayPenalty.mp3"/>
      <audio ref={audioRefs.intro} src="intro.mp3"/>




 <div className={`min-h-screen ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
            <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-2 pb-1 shadow-lg sticky top-0 z-50`}>
              <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-3">
                  <div className="flex gap-2 items-center flex-wrap">

    {[1,2,3].map(p=><button key={p} onClick={()=>{setCurrentPeriod(p);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:p})}} disabled={matchEnded||isViewer} className={`px-3 py-1 rounded font-bold ${currentPeriod===p?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>{p}</button>)}
            {periodStats[4]&&<button onClick={()=>{setCurrentPeriod(4);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:4})}} disabled={matchEnded||isViewer} className={`px-2 py-1 rounded text-sm font-bold ${currentPeriod===4?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>OT</button>}
            {!periodStats[4]&&currentPeriod===3&&(
              <button
                onClick={() => {
                  const updated = {...periodStats,4:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}};
                  setPeriodStats(updated);
                  setCurrentPeriod(4);
                  if (isMultiplayer && matchRef.current && !matchEnded) {
                    matchRef.current.update({periodStats:updated,currentPeriod:4});
                  }
                }}
                disabled={matchEnded||isViewer}
                className={`px-2 py-1 rounded text-sm font-bold ${darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
              >
                +OT
              </button>
            )}
          

 <button 
  onClick={()=>setGoalFocusSwapped(!goalFocusSwapped)} 
  className={`px-3 py-1 rounded font-bold ${darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
  title="Swap sides"
>
  ‚áÑ
</button>



          </div>
          <button
            onClick={() => setFocusMode(null)} 
            className={`${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-1`}
          >
            <span className="text-lg"><IconBack /></span>
            <span className="hidden sm:inline">Back</span>
          </button>
        </div>
      </div>

</div>


      <div className="max-w-6xl mx-auto p-2 sm:p-4">
        <div className="grid grid-cols-2 gap-2 sm:gap-4 mb-4">
          {renderGoalieCard(homeTeam, homeName_, homeGoals, homeSaves)}
          {renderGoalieCard(awayTeam, awayName_, awayGoals, awaySaves)}
        </div>
    
  

    {/* Statistics Section */}
        <div className="space-y-3">
          {[
            {team: homeTeam, name: homeName_, goals: homeGoals, saves: homeSaves},
            {team: awayTeam, name: awayName_, goals: awayGoals, saves: awaySaves}
          ].map(teamStats => {
            const selectedGoalie = selectedGoalieStats[teamStats.team];
            
            const periodKeys = Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b));
            
            // Calculate per goalie per period
            const tableData = periodKeys.map(p => {
              const goalieData = periodStats[p]?.[teamStats.team+'Goalie'];
              const starterSaves = goalieData?.starter?.saves ?? 0;
              const starterGA = goalieData?.starter?.ga ?? 0;
              const backupSaves = goalieData?.backup?.saves ?? 0;
              const backupGA = goalieData?.backup?.ga ?? 0;
              
              return { 
                period: p, 
                starter: {
                  saves: starterSaves,
                  ga: starterGA,
                  sog: starterSaves + starterGA,
                  svsPct: (starterSaves + starterGA) === 0 ? '-' : ((starterSaves / (starterSaves + starterGA)) * 100).toFixed(1)
                },
                backup: {
                  saves: backupSaves,
                  ga: backupGA,
                  sog: backupSaves + backupGA,
                  svsPct: (backupSaves + backupGA) === 0 ? '-' : ((backupSaves / (backupSaves + backupGA)) * 100).toFixed(1)
                }
              };
            });
            
            // Calculate totals per goalie
            let starterTotalSaves = 0, starterTotalGA = 0;
            let backupTotalSaves = 0, backupTotalGA = 0;
            tableData.forEach(d => {
              starterTotalSaves += d.starter.saves;
              starterTotalGA += d.starter.ga;
              backupTotalSaves += d.backup.saves;
              backupTotalGA += d.backup.ga;
            });
            const starterTotalSOG = starterTotalSaves + starterTotalGA;
            const backupTotalSOG = backupTotalSaves + backupTotalGA;
            const starterTotalSvsPct = starterTotalSOG === 0 ? '-' : ((starterTotalSaves / starterTotalSOG) * 100).toFixed(1);
            const backupTotalSvsPct = backupTotalSOG === 0 ? '-' : ((backupTotalSaves / backupTotalSOG) * 100).toFixed(1);
            
            const isExpanded = expandedGoalieStats[teamStats.team];
            
           // Choose which goalie's data to display
const displayData = selectedGoalie === 'total'
  ? { 
      tableData: tableData.map(d => ({
        period: d.period, 
        saves: d.starter.saves + d.backup.saves,
        ga: d.starter.ga + d.backup.ga,
        sog: d.starter.sog + d.backup.sog,
        svsPct: (d.starter.sog + d.backup.sog) === 0 ? '-' : (((d.starter.saves + d.backup.saves) / (d.starter.sog + d.backup.sog)) * 100).toFixed(1)
      })), 
      total: {
        saves: starterTotalSaves + backupTotalSaves, 
        ga: starterTotalGA + backupTotalGA, 
        sog: starterTotalSOG + backupTotalSOG, 
        svsPct: (starterTotalSOG + backupTotalSOG) === 0 ? '-' : (((starterTotalSaves + backupTotalSaves) / (starterTotalSOG + backupTotalSOG)) * 100).toFixed(1)
      }
    }
  : selectedGoalie === 'starter'
              ? { tableData: tableData.map(d => ({period: d.period, ...d.starter})), total: {saves: starterTotalSaves, ga: starterTotalGA, sog: starterTotalSOG, svsPct: starterTotalSvsPct} }
              : { tableData: tableData.map(d => ({period: d.period, ...d.backup})), total: {saves: backupTotalSaves, ga: backupTotalGA, sog: backupTotalSOG, svsPct: backupTotalSvsPct} };
            
            return (
              <div key={teamStats.team} className={`${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white'} rounded-lg shadow-lg overflow-hidden`}>
                {/* Toggle Header */}
                <button
                  onClick={() => setExpandedGoalieStats(prev => ({...prev, [teamStats.team]: !prev[teamStats.team]}))}
                  className={`w-full ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} px-4 py-3 font-semibold text-left flex items-center justify-between transition-colors`}
                >
                  <span>{teamStats.name}</span>
                  <span className={`transition-transform ${isExpanded ? 'rotate-180' : ''}`}><IconChevronDown /></span>
                </button>
                
                {/* Goalie Toggle & Statistics Table - Collapsible */}
                {isExpanded && (
                  <div className="p-4">



{/* Goalie Toggle */}
<div className="mb-3 flex gap-1">
  <button
    onClick={() => setSelectedGoalieStats(prev => ({...prev, [teamStats.team]: 'total'}))}
    className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${
      selectedGoalie === 'total'
        ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
        : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
    }`}
  >
    All
  </button>
  <button
    onClick={() => setSelectedGoalieStats(prev => ({...prev, [teamStats.team]: 'starter'}))}
    className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${
      selectedGoalie === 'starter'
        ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
        : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
    }`}
  >
    Starter
  </button>
  <button
    onClick={() => setSelectedGoalieStats(prev => ({...prev, [teamStats.team]: 'backup'}))}
    className={`flex-1 py-2 rounded font-semibold text-sm transition-colors ${
      selectedGoalie === 'backup'
        ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
        : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
    }`}
  >
    Backup
  </button>
</div>                    
                    <div className="overflow-x-auto">
                      <table className={`w-full text-xs ${darkMode ? 'text-gray-100' : 'text-gray-900'}`}>
                        <thead>
                          <tr className={`${darkMode ? 'bg-gray-700 text-gray-100' : 'bg-gray-100 text-gray-800'}`}>
                            <th className="text-left px-2 py-2">Stat</th>
                            {periodKeys.map(p => (
                              <th key={p} className="text-center px-1 py-2">
                                {parseInt(p) <= 3 ? `P${p}` : 'OT'}
                              </th>
                            ))}
                            <th className="text-center px-2 py-2 font-bold">Tot</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">GA</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs">{d.ga}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.ga}</td>
                          </tr>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">SOG</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs">{d.sog}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.sog}</td>
                          </tr>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">SVS</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs">{d.saves}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.saves}</td>
                          </tr>
                          <tr className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            <td className="px-2 py-2 font-semibold text-left">SVS%</td>
                            {displayData.tableData.map(d => (
                              <td key={d.period} className="text-center px-1 py-2 text-xs font-semibold">{d.svsPct}{d.svsPct !== '-' ? '%' : ''}</td>
                            ))}
                            <td className="text-center px-2 py-2 font-semibold">{displayData.total.svsPct}{displayData.total.svsPct !== '-' ? '%' : ''}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>

</div>

      </div>
    </div>
  );
}

return(
        <div className={`min-h-screen pb-20 ${darkMode?'bg-gray-900':'bg-gradient-to-br from-blue-50 to-blue-100'}`}>
          {isViewer&&<div className="bg-yellow-500 text-gray-900 px-4 py-2 text-center font-semibold text-sm">
             VIEWER MODE - live stats (read-only)
          </div>}
          <audio ref={audioRefs.homeGoal} src="homeGoal.mp3"/>
          <audio ref={audioRefs.awayGoal} src="awayGoal.mp3"/>
          <audio ref={audioRefs.homePenalty} src="homePenalty.mp3"/>
          <audio ref={audioRefs.awayPenalty} src="awayPenalty.mp3"/>
          <audio ref={audioRefs.intro} src="intro.mp3"/>



         <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-3 shadow-lg sticky top-0 z-50`}>
            <div className="max-w-6xl mx-auto">
              {isMultiplayer&&<div className="mb-2 flex items-center justify-between gap-2">
                <div className="flex items-center gap-2 flex-wrap">
                  {!matchEnded&&<span className="flex items-center gap-1 bg-red-500 px-2 py-1 rounded text-xs font-bold"><span className="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></span>LIVE</span>}
                  {matchEnded&&<span className="bg-gray-500 px-2 py-1 rounded text-xs font-bold">GAME ENDED</span>}
                  <span className="text-xs">üë• {connectedUsers}</span>
                  {!isViewer&&viewerCount>0&&<span className="text-xs">üëÅÔ∏è {viewerCount}</span>}
                  
                </div>
                <div className="flex items-center gap-1">
  <button 
    className={`${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-2 py-1 rounded font-mono font-bold text-xs transition-colors`}
  >
    {matchCode}
  </button>
</div>
              </div>}

              <div className="flex justify-between items-center mb-2">
  <div className="flex gap-2 items-center">
    
    {[1,2,3].map(p=><button key={p} onClick={()=>{setCurrentPeriod(p);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:p})}} disabled={matchEnded||isViewer} className={`px-3 py-1 rounded font-bold ${currentPeriod===p?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>{p}</button>)}
                  {periodStats[4]&&<button onClick={()=>{setCurrentPeriod(4);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({currentPeriod:4})}} disabled={matchEnded||isViewer} className={`px-3 py-1 rounded font-bold text-xs ${currentPeriod===4?'bg-yellow-400 text-blue-900':darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}>OT</button>}
                  {!periodStats[4]&&currentPeriod===3&&(
                    <button
                      onClick={() => {
                        const updated = {...periodStats,4:{homeScore:0,awayScore:0,homeSaves:0,awaySaves:0}};
                        setPeriodStats(updated);
                        setCurrentPeriod(4);
                        if (isMultiplayer && matchRef.current && !matchEnded) {
                          matchRef.current.update({periodStats:updated,currentPeriod:4});
                        }
                      }}
                      disabled={matchEnded||isViewer}
                      className={`px-3 py-1 rounded font-bold text-xs ${darkMode?'bg-gray-700':'bg-white bg-opacity-20'}`}
                    >
                      +OT
                    </button>
                  )}
                </div>
<div className="flex gap-2">
  {!isMultiplayer&&(
    <button onClick={exitToStart} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}>
      <IconBack />
    </button>
  )}
  {isViewer&&(
    <button onClick={()=>{
      localStorage.removeItem('multiplayerMatch');
      resetGameState();
      setIsMultiplayer(false);
      setIsViewer(false);
      setMatchCode('');
      setScreen('start');
    }} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}>
      <IconBack />
    </button>
  )}
  {isMultiplayer && !isViewer && (
    <button onClick={()=>{
      localStorage.removeItem('multiplayerMatch');
      resetGameState();
      setIsMultiplayer(false);
      setMatchCode('');
      setScreen('start');
    }} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}>
      <IconBack />
    </button>
  )}
  <button onClick={()=>setStatsCollapsed(!statsCollapsed)} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}>{statsCollapsed ? <IconChevronDown /> : <IconChevronUp />}</button>
  <button onClick={()=>setShowSettings(!showSettings)} className={`${darkMode?'bg-gray-700':'bg-white bg-opacity-20 hover:bg-opacity-30'} px-3 py-1 min-h-[32px] rounded flex items-center justify-center`}><IconSettings /></button>
</div>
              </div>




         {showSettings&&<div className={`${darkMode?'bg-gray-700 text-white':'bg-white text-gray-800'} rounded-lg p-4 mb-4 max-h-[70vh] overflow-y-auto`}>
                <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-lg">Settings</h3>
                  <button 
                    onClick={()=>setShowSettings(false)} 
                    className={`${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-gray-200 hover:bg-gray-300'} px-4 py-2 rounded font-semibold text-sm`}
                  >
                    Close
                  </button>
                </div>

                {/* MY PREFERENCES - H√∂gst upp */}
                <div className="mb-6">
                  <h4 className={`text-sm font-semibold mb-3 pb-2 border-b ${darkMode?'border-gray-600 text-gray-300':'border-gray-200 text-gray-700'}`}>
                    My Preferences
                  </h4>
                  
                  <div className="space-y-2">
                    <label className="flex items-center justify-between py-2">
                      <span className="text-sm">Dark Mode</span>
                      <input 
                        type="checkbox" 
                        checked={darkMode} 
                        onChange={e=>setDarkMode(e.target.checked)} 
                        className="w-5 h-5"
                      />
                    </label>
                    
                    <label className="flex items-center justify-between py-2">
                      <span className="text-sm">Keep Screen On</span>
                      <input 
                        type="checkbox" 
                        checked={keepScreenOn} 
                        onChange={e=>setKeepScreenOn(e.target.checked)} 
                        className="w-5 h-5"
                      />
                    </label>
                  </div>
                </div>

                {/* GAME INFO - Endast multiplayer */}
                {isMultiplayer && (
                  <div className="mb-6">
                    <h4 className={`text-sm font-semibold mb-3 pb-2 border-b ${darkMode?'border-gray-600 text-gray-300':'border-gray-200 text-gray-700'}`}>
                      Game Info
                    </h4>
                    
                    <div className="space-y-3">
                      {/* Match Code - D√∂lj f√∂r viewers */}
                      {!isViewer && (
                        <div>
                          <label className="block text-xs mb-1 opacity-75">Match Code</label>
                          <div className="flex gap-2">
                            <input 
                              type="text" 
                              value={matchCode} 
                              readOnly 
                              className={`flex-1 px-3 py-2 border rounded font-mono text-center font-bold ${darkMode?'bg-gray-800 border-gray-600 text-white':'bg-gray-50 border-gray-300'}`}
                            />
                            <button 
                              onClick={copyCode}
                              className={`px-4 py-2 rounded font-semibold whitespace-nowrap ${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-600 hover:bg-blue-700'} text-white`}
                            >
                              Copy
                            </button>
                          </div>
                        </div>
                      )}

                      {/* Viewer Link - D√∂lj f√∂r viewers */}
                      {!isViewer && (
                        <div>
                          <label className="block text-xs mb-1 opacity-75">Viewer Link</label>
                          <div className="flex gap-2">
                            <input 
                              type="text" 
                              value={`${window.location.origin}${window.location.pathname}?join=${matchCode}-V`}
                              readOnly 
                              className={`flex-1 px-3 py-2 border rounded font-mono text-xs ${darkMode?'bg-gray-800 border-gray-600 text-white':'bg-gray-50 border-gray-300'}`}
                            />
                            <button
                              onClick={() => {
                                const viewerLink = `${window.location.origin}${window.location.pathname}?join=${matchCode}-V`;
                                navigator.clipboard.writeText(viewerLink).then(() => {
                                  alert('Viewer link copied!');
                                }).catch(() => {
                                  alert('Failed to copy');
                                });
                              }}
                              className={`px-4 py-2 rounded font-semibold whitespace-nowrap ${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-600 hover:bg-blue-700'} text-white`}
                            >
                              Copy
                            </button>
                          </div>
                        </div>
                      )}

                      {/* Connected Users */}
                      <div className={`${darkMode?'bg-gray-800':'bg-gray-50'} rounded p-3 text-sm`}>
                        <div className="flex items-center justify-between">
                          <span className="opacity-75">Connected Editors:</span>
                          <span className="font-bold">üë• {connectedUsers}</span>
                        </div>
                        {viewerCount > 0 && (
                          <div className="flex items-center justify-between mt-1">
                            <span className="opacity-75">Viewers:</span>
                            <span className="font-bold">üëÅÔ∏è {viewerCount}</span>
                          </div>
                        )}
                      </div>

                      {/* End Game - endast creator */}
                      {!matchEnded && isCreator && !isViewer && (
                        <button 
                          onClick={endMatch}
                          className="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded font-semibold"
                        >
                          End Game for All Users
                        </button>
                      )}
                    </div>
                  </div>
                )}

                {/* TEAM SETTINGS - Endast editors */}
                {!isViewer && (
                  <div className="mb-6">
                    <h4 className={`text-sm font-semibold mb-3 pb-2 border-b ${darkMode?'border-gray-600 text-gray-300':'border-gray-200 text-gray-700'}`}>
                      Team Settings
                    </h4>
                    
                    <div className="space-y-3">
                      <div>
                        <label className="block text-xs mb-1 opacity-75">Home Team</label>
                        <div className="flex gap-2">
                          <input 
                            type="text" 
                            value={homeName} 
                            onChange={e=>{setHomeName(e.target.value);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({homeName:e.target.value})}} 
                            disabled={matchEnded||isViewer} 
                            className={`flex-1 px-3 py-2 border rounded ${darkMode?'bg-gray-800 border-gray-600 text-white':'border-gray-300'}`}
                          />
                          <button 
                            onClick={()=>setHomeName('')} 
                            disabled={matchEnded||isViewer} 
                            className={`px-3 py-2 rounded ${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-gray-200 hover:bg-gray-300'}`}
                          >
                            Clear
                          </button>
                        </div>
                      </div>

                      <div>
                        <label className="block text-xs mb-1 opacity-75">Away Team</label>
                        <div className="flex gap-2">
                          <input 
                            type="text" 
                            value={awayName} 
                            onChange={e=>{setAwayName(e.target.value);if(isMultiplayer&&matchRef.current&&!matchEnded)matchRef.current.update({awayName:e.target.value})}} 
                            disabled={matchEnded||isViewer} 
                            className={`flex-1 px-3 py-2 border rounded ${darkMode?'bg-gray-800 border-gray-600 text-white':'border-gray-300'}`}
                          />
                          <button 
                            onClick={()=>setAwayName('')} 
                            disabled={matchEnded||isViewer} 
                            className={`px-3 py-2 rounded ${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-gray-200 hover:bg-gray-300'}`}
                          >
                            Clear
                          </button>
                        </div>
                      </div>

                      <button 
                        onClick={resetCounters} 
                        disabled={matchEnded||isViewer} 
                        className={`w-full ${darkMode?'bg-gray-800 hover:bg-gray-700 border border-gray-600 text-red-400':'bg-white hover:bg-gray-50 border border-red-300 text-red-600'} py-2 rounded font-semibold`}
                      >
                        Reset All Stats
                      </button>
                    </div>
                  </div>
                )}

                {/* CONTENT - Endast f√∂r editors (d√∂lj f√∂r viewers) */}
                {!isViewer && (
                  <div className="mb-6">
                    <h4 className={`text-sm font-semibold mb-3 pb-2 border-b ${darkMode?'border-gray-600 text-gray-300':'border-gray-200 text-gray-700'}`}>
                      Content
                    </h4>
                    
                    <div className="space-y-3">
                      <div>
                        <label className="block text-xs mb-1 opacity-75">Spotify Playlist URL</label>
                        <div className="flex gap-2">
                          <input 
                            type="text" 
                            value={spotifyPlaylist} 
                            onChange={e=>{setSpotifyPlaylist(e.target.value);setSpotifyLoaded(false)}} 
                            placeholder="https://open.spotify.com/playlist/..." 
                            className={`flex-1 px-3 py-2 border rounded text-sm ${darkMode?'bg-gray-800 border-gray-600 text-white':'border-gray-300'}`}
                          />
                          <button 
                            onClick={()=>{setSpotifyPlaylist('https://open.spotify.com/playlist/3HunXm4QT4dxcOz6eAljak?si=mKiXLeNMQM6ioJivpWP-EQ&pi=lAZXLD_QSPmpq');setSpotifyLoaded(false)}} 
                            className={`px-3 py-2 rounded text-sm whitespace-nowrap ${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-gray-200 hover:bg-gray-300'}`}
                          >
                            Default
                          </button>
                        </div>
                      </div>

                      <div>
                        <label className="block text-xs mb-1 opacity-75">External Link Title</label>
                        <input 
                          type="text" 
                          value={externalLinkTitle} 
                          onChange={e=>setExternalLinkTitle(e.target.value)} 
                          placeholder="Club Rules" 
                          className={`w-full px-3 py-2 border rounded text-sm ${darkMode?'bg-gray-800 border-gray-600 text-white':'border-gray-300'}`}
                        />
                      </div>

                      <div>
                        <label className="block text-xs mb-1 opacity-75">External Link URL</label>
                        <input 
                          type="text" 
                          value={externalLinkUrl} 
                          onChange={e=>setExternalLinkUrl(e.target.value)} 
                          placeholder="https://..." 
                          className={`w-full px-3 py-2 border rounded text-sm ${darkMode?'bg-gray-800 border-gray-600 text-white':'border-gray-300'}`}
                        />
                      </div>

                      <div>
                        <label className="block text-xs mb-1 opacity-75">Default Home Roster</label>
                        <input 
                          type="text" 
                          inputMode="decimal"
                          value={defaultHomeRoster} 
                          onChange={e=>setDefaultHomeRoster(e.target.value)} 
                          placeholder="e.g. 2,3,4,7,9" 
                          className={`w-full px-3 py-2 border rounded text-sm ${darkMode?'bg-gray-800 border-gray-600 text-white':'border-gray-300'}`}
                        />
                        <p className={`text-xs mt-1 opacity-60`}>
                          Comma or space separated player numbers
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {/* ACCOUNT - L√§ngst ner */}
                {currentUser && (
                  <div className={`pt-4 border-t ${darkMode?'border-gray-600':'border-gray-200'}`}>
                    <button
                      onClick={async()=>{
                        if(window.confirm('Sign out from your account?')){
                          await auth.signOut();
                          setShowSettings(false);
                          setScreen('start');
                        }
                      }}
                      className={`w-full ${darkMode?'bg-gray-800 hover:bg-gray-700 text-red-400':'bg-gray-100 hover:bg-gray-200 text-red-600'} py-2 rounded font-semibold text-sm`}
                    >
                      Sign Out
                    </button>
                  </div>
                )}

                {/* Close knapp l√§ngst ner */}
                <div className="pt-4 mt-4 border-t border-gray-600">
                  <button 
                    onClick={()=>setShowSettings(false)} 
                    className={`w-full ${darkMode?'bg-gray-600 hover:bg-gray-500':'bg-gray-200 hover:bg-gray-300'} py-2 rounded font-semibold`}
                  >
                    Close
                  </button>
                </div>
              </div>}





<div className="grid grid-cols-2 gap-2 mb-2">
  {[
    {name:homeName,score:totals.homeScore,saves:totals.homeSaves,team:'home'},
    {name:awayName,score:totals.awayScore,saves:totals.awaySaves,team:'away'}
  ].map((tm,idx)=>{
    const currentPeriodScore = periodStats[currentPeriod]?.[tm.team+'Score'] ?? 0;
    return(
    <div key={idx} className={`${darkMode?'bg-gray-700 border border-gray-600':'bg-white bg-opacity-10'} rounded-lg p-3`}>
      <div className="text-sm font-semibold mb-3 text-left">{tm.name}</div>
      
      <div>
        <div className="text-sm mb-2 text-center">
          <span className="opacity-50">Period {currentPeriod}</span>
          <span className="opacity-30 mx-1">¬∑</span>
          <span className="font-semibold">{currentPeriodScore} {currentPeriodScore === 1 ? 'goal' : 'goals'}</span>
        </div>
        <div className="flex items-center justify-center gap-3 mb-2">
          <button onClick={()=>updateStat(tm.team,'Score',-1)} disabled={matchEnded||isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold hover:bg-opacity-30">‚àí</button>
          <div className={`text-4xl font-bold min-w-[3rem] text-center ${sparkleStats[`${tm.team}Score${currentPeriod}`]?'sparkle':''}`}>
            {tm.score}
          </div>
          <button onClick={()=>updateStat(tm.team,'Score',1)} disabled={matchEnded||isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold hover:bg-opacity-30">+</button>
        </div>
        <div className="text-xs opacity-75 text-center">
          ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][tm.team+'Score']}{i<arr.length-1?'-':''}</span>)})
        </div>
      </div>
    </div>
    );
  })}
</div>

{!statsCollapsed&&(
  <div className="grid grid-cols-2 gap-2 mb-2">
    {[
      {saves:totals.homeSaves,team:'home'},
      {saves:totals.awaySaves,team:'away'}
    ].map((tm,idx)=>{
      const currentPeriodSaves = periodStats[currentPeriod]?.[tm.team+'Saves'] ?? 0;
      return(
      <div key={idx} className={`${darkMode?'bg-gray-700 border border-gray-600':'bg-white bg-opacity-10'} rounded-lg p-3`}>
        <div className="text-sm mb-2 text-center">
          <span className="opacity-50">Period {currentPeriod}</span>
          <span className="opacity-30 mx-1">¬∑</span>
          <span className="font-semibold">{currentPeriodSaves} {currentPeriodSaves === 1 ? 'save' : 'saves'}</span>
        </div>
        <div className="flex items-center justify-center gap-3 mb-2">
          <button onClick={()=>updateStat(tm.team,'Saves',-1)} disabled={matchEnded||isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold hover:bg-opacity-30">‚àí</button>
          <div className={`text-4xl font-bold min-w-[3rem] text-center ${sparkleStats[`${tm.team}Saves${currentPeriod}`]?'sparkle':''}`}>
            {tm.saves}
          </div>
          <button onClick={()=>updateStat(tm.team,'Saves',1)} disabled={matchEnded||isViewer} className="bg-white bg-opacity-20 w-10 h-10 rounded flex items-center justify-center text-xl font-bold hover:bg-opacity-30">+</button>
        </div>
        <div className="text-xs opacity-75 text-center">
          ({Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map((p,i,arr)=><span key={p} className={parseInt(p)===currentPeriod?'font-bold underline':''}>{periodStats[p][tm.team+'Saves']}{i<arr.length-1?'-':''}</span>)})
        </div>
      </div>
      );
    })}
  </div>
)}

              <div className="grid grid-cols-2 gap-2">
                {!isViewer&&<button onClick={()=>{setFocusMode('home');setActiveTab('stats')}} className={`${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-500 bg-opacity-80 hover:bg-opacity-100'} py-2 rounded text-sm font-semibold`}>‚õ∂ Goalie Focus</button>}
                {!isViewer&&<button onClick={()=>setShowPlayerStats(true)} className={`${darkMode?'bg-blue-700 hover:bg-blue-600':'bg-blue-500 bg-opacity-80 hover:bg-opacity-100'} py-2 rounded text-sm font-semibold`}>‚õ∂ Skater Focus</button>}
              </div>
            </div>
          </div>


{!isViewer&&(
  <div className={`${darkMode?'bg-gray-800 border-b border-gray-700':'bg-white'} shadow-md sticky top-48 z-40`}>
    <div className="max-w-6xl mx-auto flex">
      {['stats','audio','referee',...(externalLinkUrl?['external']:[])].map(tab=>(
        <button key={tab} onClick={()=>setActiveTab(tab)} className={`flex-1 py-3 font-semibold text-sm ${activeTab===tab?(darkMode?'bg-blue-700 text-white':'bg-blue-600 text-white'):(darkMode?'bg-gray-700 text-gray-300':'bg-gray-100 text-gray-600')}`}>
          {tab==='audio'?'Audio':tab==='stats'?'Stats':tab==='referee'?'Referee':externalLinkTitle||'Link'}
        </button>
      ))}
    </div>
  </div>
)}

          <div className="max-w-6xl mx-auto p-4">
            {activeTab==='audio'&&<div>
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-4 mb-3`}>
                <h3 className={`text-sm font-semibold mb-3 ${darkMode?'text-gray-300':'text-gray-600'}`}>Soundboard</h3>
                <div className="grid grid-cols-3 gap-3">
                  {/* Intro */}
                  <button 
                    onClick={toggleIntro}
                    className={`p-3 rounded-lg font-semibold transition-colors flex flex-col items-center justify-center gap-1 ${
                      introPlaying
                        ? (darkMode ? 'bg-green-700 text-white' : 'bg-green-600 text-white')
                        : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-800')
                    }`}
                  >
                    {introPlaying ? (
                      <>
                        <div className="flex items-end gap-0.5 h-4">
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                        </div>
                        <span className="text-xs">Stop</span>
                      </>
                    ) : (
                      <>
                        <span className="text-lg">‚ñ∂</span>
                        <span className="text-xs">Intro</span>
                      </>
                    )}
                  </button>

                  {/* Goal */}
                  <button 
                    onClick={() => playingSound === 'homeGoal' ? stopAllSounds() : playSound('homeGoal')}
                    className={`p-3 rounded-lg font-semibold transition-colors flex flex-col items-center justify-center gap-1 ${
                      playingSound === 'homeGoal'
                        ? (darkMode ? 'bg-blue-700 text-white' : 'bg-blue-600 text-white')
                        : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-800')
                    }`}
                  >
                    {playingSound === 'homeGoal' ? (
                      <>
                        <div className="flex items-end gap-0.5 h-4">
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                        </div>
                        <span className="text-xs">Stop</span>
                      </>
                    ) : (
                      <>
                        <span className="text-lg">üö®</span>
                        <span className="text-xs">Goal</span>
                      </>
                    )}
                  </button>

                  {/* Penalty */}
                  <button 
                    onClick={() => playingSound === 'awayPenalty' ? stopAllSounds() : playSound('awayPenalty')}
                    className={`p-3 rounded-lg font-semibold transition-colors flex flex-col items-center justify-center gap-1 ${
                      playingSound === 'awayPenalty'
                        ? (darkMode ? 'bg-orange-700 text-white' : 'bg-orange-600 text-white')
                        : (darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-200' : 'bg-gray-100 hover:bg-gray-200 text-gray-800')
                    }`}
                  >
                    {playingSound === 'awayPenalty' ? (
                      <>
                        <div className="flex items-end gap-0.5 h-4">
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                          <div className="eq-bar w-0.5 bg-current rounded-full"></div>
                        </div>
                        <span className="text-xs">Stop</span>
                      </>
                    ) : (
                      <>
                        <span className="text-lg">üöî</span>
                        <span className="text-xs">Penalty</span>
                      </>
                    )}
                  </button>
                </div>
              </div>


             <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-3`}>
                {!spotifyLoaded&&!spotifyLoading?<button onClick={loadSpotify} className={`w-full ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-600 hover:bg-gray-700'} text-white py-8 rounded-lg font-semibold text-lg transition-colors`}>Load Spotify</button>:spotifyLoading?<div className={`py-8 text-center ${darkMode?'text-gray-300':'text-gray-600'}`}><div className="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-2"></div><div>Loading...</div></div>:<div style={{opacity:0,animation:'fadeIn 0.5s ease-in forwards'}}>
                  {spotifyFallback||!getSpotifyUrl(spotifyPlaylist)?(
                    <div className={`text-center py-8`}>
                     <a 
                        href={spotifyPlaylist} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className={`inline-block ${darkMode?'bg-gray-700 hover:bg-gray-600':'bg-gray-600 hover:bg-gray-700'} text-white px-6 py-3 rounded-lg font-semibold transition-colors`}
                      >
                        Open Spotify in new window ‚Üí
                      </a>
                    </div>
                  ):(
                    <div>
                      <iframe 
                        style={{borderRadius:'12px'}} 
                        src={getSpotifyUrl(spotifyPlaylist)} 
                        width="100%" 
                        height="352" 
                        frameBorder="0" 
                        allowFullScreen="" 
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                        loading="lazy"
                        onError={() => setSpotifyFallback(true)}
                        title="Spotify Playlist"
                      ></iframe>
                      <div className={`text-center mt-3 text-xs ${darkMode?'text-gray-400':'text-gray-500'}`}>
                        <button onClick={() => setSpotifyFallback(true)} className={`${darkMode?'text-gray-400 hover:text-gray-300':'text-gray-600 hover:text-gray-800'} underline`}>
                          Show direct link to playlist instead
                        </button>
                      </div>
                    </div>
                  )}
                </div>}
              </div>
             
            </div>}


{activeTab==='stats'&&<div>
              {Object.keys(periodStats).sort((a,b)=>parseInt(a)-parseInt(b)).map(p=>{
                p=parseInt(p);
                const ps=periodStats[p];
                
                const renderTeamStats=(team)=>{
                  const isHome=team==='home';
                  const name=isHome?homeName:awayName;
                  const score=ps[team+'Score'];
                  const saves=ps[team+'Saves'];
                  const oppTeam=isHome?'away':'home';
                  const oppScore=ps[oppTeam+'Score'];
                  const shotsFor=ps[oppTeam+'Saves']+score;
                  const shotsAgainst=saves+oppScore;
                  const color=darkMode?(isHome?'bg-blue-900 bg-opacity-30 border-blue-700':'bg-red-900 bg-opacity-30 border-red-700'):(isHome?'bg-blue-50':'bg-red-50');
                  
                  return(
                    <div className={`${color} ${darkMode?'border':''} rounded p-3`}>
                      <div className={`font-semibold mb-2 ${darkMode?'text-white':''}`}>{name}</div>
                      <div className={`text-sm space-y-1 ${darkMode?'text-gray-300':'text-gray-700'}`}>
                        <div className="flex justify-between"><span>Goals:</span><span className="font-bold">{score}</span></div>
                        <div className="flex justify-between"><span>SOG:</span><span className="font-bold">{shotsFor}</span></div>
                        <div className="flex justify-between"><span>Saves:</span><span className="font-bold">{saves}</span></div>
                        <div className="flex justify-between"><span>SA:</span><span className="font-bold">{shotsAgainst}</span></div>
                        <div className="flex justify-between border-t pt-1"><span>SVS %:</span><span className="font-bold">{calcSP(saves,oppScore)}%</span></div>
                      </div>
                    </div>
                  );
                };
                
                return(
                  <div key={p} className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-4 mb-4`}>
                    <div className="flex justify-between items-center mb-3">
                      <h3 className={`text-xl font-bold ${darkMode?'text-white':''}`}>{p<=3?`Period ${p}`:`OT`}</h3>
                      {currentPeriod===p&&<span className="bg-yellow-400 text-blue-900 px-3 py-1 rounded text-sm font-bold">Current</span>}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      {renderTeamStats('home')}
                      {renderTeamStats('away')}
                    </div>

{(playerStats.home?.players||playerStats.away?.players)&&(()=>{
                      const homePlayers=playerStats.home?.players||{};
                      const awayPlayers=playerStats.away?.players||{};
                      const hasPlayersWithData=Object.keys(homePlayers).some(pNum=>homePlayers[pNum]?.periods?.[p])||
                                                Object.keys(awayPlayers).some(pNum=>awayPlayers[pNum]?.periods?.[p]);
                      
                      if(!hasPlayersWithData)return null;
                      
                      return(
                        <div className="mt-4 pt-4 border-t">
                          <button
                            onClick={()=>setExpandedPlayerStats(prev=>({...prev,[p]:!prev[p]}))}
                            className={`w-full text-left font-semibold text-sm ${darkMode?'bg-gray-700 text-gray-200':'bg-gray-100 text-gray-800'} px-3 py-2 rounded flex items-center justify-between`}
                          >
                            <span>Player Statistics</span>
                            
                                <span>{expandedPlayerStats[p]?<IconChevronUp />:<IconChevronDown />}</span>
                          </button>
                          
                          {expandedPlayerStats[p]&&(
                            <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                              {['home','away'].map(team=>{
                                const teamName=team==='home'?homeName:awayName;
                                const players=playerStats[team]?.players||{};
                                const playerNums=Object.keys(players).filter(pNum=>players[pNum]?.periods?.[p]).sort((a,b)=>parseInt(a)-parseInt(b));
                                
                                if(playerNums.length===0)return null;
                                
                                return(
                                  <div key={team} className={`${darkMode?'bg-gray-700':'bg-gray-50'} rounded p-3`}>
                                    <div className={`font-semibold mb-2 ${darkMode?'text-white':''}`}>{teamName}</div>
                                    <div className="overflow-x-auto">
                                      <table className="w-full text-xs">
                                        <thead>
                                          <tr className={`${darkMode?'text-gray-400':'text-gray-600'}`}>
                                            <th className="text-left">#</th>
                                            <th className="text-center">G</th>
                                            <th className="text-center">A</th>
                                            <th className="text-center">+</th>
                                            <th className="text-center">-</th>
                                            <th className="text-center">+/-</th>
                                            <th className="text-center">FO+</th>
                                            <th className="text-center">FO-</th>
                                            <th className="text-center">FO%</th>
                                            <th className="text-center">SOG</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {playerNums.map(pNum=>{
                                            const pStats=players[pNum].periods[p];
                                            const onIcePlus=pStats?.['OnIce+']||0;
                                            const onIceMinus=pStats?.['OnIce-']||0;
                                            const plusMinus=onIcePlus-onIceMinus;
                                            const foPlus=pStats?.['FO+']||0;
                                            const foMinus=pStats?.['FO-']||0;
                                            const foTotal=foPlus+foMinus;
                                            const foPct=foTotal===0?'-':((foPlus/foTotal)*100).toFixed(0);
                                            return(
                                              <tr key={pNum} className={`border-t ${darkMode?'border-gray-600':'border-gray-200'}`}>
                                                <td className="font-bold py-1">{pNum}</td>
                                                <td className="text-center">{pStats?.['G']||0}</td>
                                                <td className="text-center">{pStats?.['A']||0}</td>
                                                <td className="text-center">{onIcePlus}</td>
                                                <td className="text-center">{onIceMinus}</td>
                                                <td className="text-center font-semibold">{plusMinus>=0?'+':''}{plusMinus}</td>
                                                <td className="text-center">{foPlus}</td>
                                                <td className="text-center">{foMinus}</td>
                                                <td className="text-center font-semibold">{foPct}{foPct!=='-'?'%':''}</td>
                                                <td className="text-center">{pStats?.['SOG']||0}</td>
                                              </tr>
                                            );
                                          })}
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                );
              })}

<div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow p-4 mb-4`}>
                <div className="flex justify-between items-center mb-3">
                  <h3 className={`text-xl font-bold ${darkMode?'text-white':''}`}>FINAL</h3>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  {['home','away'].map(team=>{
                    const name=team==='home'?homeName:awayName;
                    const score=team==='home'?totals.homeScore:totals.awayScore;
                    const saves=team==='home'?totals.homeSaves:totals.awaySaves;
                    const oppTeam=team==='home'?'away':'home';
                    const oppScore=team==='home'?totals.awayScore:totals.homeScore;
                    const shotsFor=(team==='home'?totals.awaySaves:totals.homeSaves)+score;
                    const shotsAgainst=saves+oppScore;
                    const color=darkMode?(team==='home'?'bg-blue-900 bg-opacity-30 border-blue-700':'bg-red-900 bg-opacity-30 border-red-700'):(team==='home'?'bg-blue-50':'bg-red-50');
                    
                    return(
                      <div key={team} className={`${color} ${darkMode?'border':''} rounded p-3`}>
                        <div className={`font-semibold mb-2 ${darkMode?'text-white':''}`}>{name}</div>
                        <div className={`text-sm space-y-1 ${darkMode?'text-gray-300':'text-gray-700'}`}>
                          <div className="flex justify-between"><span>Goals:</span><span className="font-bold text-lg">{score}</span></div>
                          <div className="flex justify-between"><span>SOG:</span><span className="font-bold">{shotsFor}</span></div>
                          <div className="flex justify-between"><span>Saves:</span><span className="font-bold">{saves}</span></div>
                          <div className="flex justify-between"><span>SA:</span><span className="font-bold">{shotsAgainst}</span></div>
                          <div className="flex justify-between border-t pt-1"><span>SVS %:</span><span className="font-bold">{calcSP(saves,oppScore)}%</span></div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                
                {(playerStats.home?.players||playerStats.away?.players)&&(()=>{
                  const homePlayers=playerStats.home?.players||{};
                  const awayPlayers=playerStats.away?.players||{};
                  
                  if(Object.keys(homePlayers).length===0&&Object.keys(awayPlayers).length===0)return null;
                  
                  return(
                    <div className="mt-4 pt-4 border-t">
                      <button
                        onClick={()=>setExpandedPlayerStats(prev=>({...prev,total:!prev.total}))}
                        className={`w-full text-left font-semibold text-sm ${darkMode?'bg-gray-700 text-gray-200':'bg-gray-100 text-gray-800'} px-3 py-2 rounded flex items-center justify-between mb-3`}
                      >
                        <span>Total Player Statistics</span>
                        <span>{expandedPlayerStats.total?<IconChevronUp />:<IconChevronDown />}</span>
                      </button>
                      
                      {expandedPlayerStats.total&&(
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          {['home','away'].map(team=>{
                            const teamName=team==='home'?homeName:awayName;
                            const players=playerStats[team]?.players||{};
                            const playerNums=Object.keys(players).sort((a,b)=>parseInt(a)-parseInt(b));
                            
                            if(playerNums.length===0)return null;
                            
                            return(
                              <div key={team} className={`${darkMode?'bg-gray-700':'bg-gray-50'} rounded p-3`}>
                                <div className={`font-semibold mb-2 ${darkMode?'text-white':''}`}>{teamName}</div>
                                <div className="overflow-x-auto">
                                  <table className="w-full text-xs">
                                    <thead>
                                      <tr className={`${darkMode?'text-gray-400':'text-gray-600'}`}>
                                        <th className="text-left">#</th>
                                        <th className="text-center">G</th>
                                        <th className="text-center">A</th>
                                        <th className="text-center">+</th>
                                        <th className="text-center">-</th>
                                        <th className="text-center">+/-</th>
                                        <th className="text-center">FO+</th>
                                        <th className="text-center">FO-</th>
                                        <th className="text-center">FO%</th>
                                        <th className="text-center">SOG</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {playerNums.map(pNum=>{
                                        const pStats=players[pNum].total;
                                        const onIcePlus=pStats?.['OnIce+']??0;
                                        const onIceMinus=pStats?.['OnIce-']??0;
                                        const plusMinus=onIcePlus-onIceMinus;
                                        const foPlus=pStats?.['FO+']??0;
                                        const foMinus=pStats?.['FO-']??0;
                                        const foTotal=foPlus+foMinus;
                                        const foPct=foTotal===0?'-':((foPlus/foTotal)*100).toFixed(0);
                                        return(
                                          <tr key={pNum} className={`border-t ${darkMode?'border-gray-600':'border-gray-200'}`}>
                                            <td className="font-bold py-1">{pNum}</td>
                                            <td className="text-center">{pStats?.['G']??0}</td>
                                            <td className="text-center">{pStats?.['A']??0}</td>
                                            <td className="text-center">{onIcePlus}</td>
                                            <td className="text-center">{onIceMinus}</td>
                                            <td className="text-center font-semibold">{plusMinus>=0?'+':''}{plusMinus}</td>
                                            <td className="text-center">{foPlus}</td>
                                            <td className="text-center">{foMinus}</td>
                                            <td className="text-center font-semibold">{foPct}{foPct!=='-'?'%':''}</td>
                                            <td className="text-center">{pStats?.['SOG']??0}</td>
                                          </tr>
                                        );
                                      })}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>

              <div className="grid grid-cols-3 gap-3 mt-4">
                <button onClick={copyStats} className={`${darkMode?'bg-gray-800 border-gray-600 text-white':'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>Copy Stats</button>
                <button onClick={downloadCSV} className={`${darkMode?'bg-gray-800 border-gray-600 text-white':'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>Export CSV</button>
                <button onClick={shareStats} className={`${darkMode?'bg-gray-800 border-gray-600 text-white':'bg-white border-gray-200'} border-2 py-3 rounded-lg font-semibold`}>Share</button> 
              </div>
              
            </div>}

           {activeTab === 'referee' && <div>
  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 p-2">
    {refSigs.map((sig, i) => (
      <div 
        key={i} 
        className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 shadow-md hover:shadow-lg transition-shadow cursor-pointer relative group`}
        title={`${sig.name}: ${sig.description}`}
      >
        <div className="w-full aspect-square flex items-center justify-center">
          <img
            src={sig.image}
            alt={sig.name}
            className="max-w-full max-h-full object-contain"
          />
        </div>
        
        {/* Tooltip som visas UNDER vid hover */}
        <div className="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10 hidden md:block">
          <div className="font-bold">{sig.name}</div>
          <div className="text-xs">{sig.description}</div>
          <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-gray-900"></div>
        </div>
        
        {/* Rubrik under bilden (visas alltid p√• mobil) */}
        <div className={`text-center mt-2 text-xs font-semibold ${darkMode ? 'text-white' : 'text-gray-800'} md:hidden`}>
          {sig.name}
        </div>
      </div>
    ))}
  </div>
</div>}

            {activeTab==='external'&&externalLinkUrl&&<div>
              <div className={`${darkMode?'bg-gray-800 border border-gray-700':'bg-white'} rounded-lg shadow overflow-hidden`}>
                <iframe src={externalLinkUrl} className="w-full" style={{height:'70vh',border:'none'}} title={externalLinkTitle||'External Link'}></iframe>
              </div>
            </div>}
          </div>
        </div>
      );
    };

    ReactDOM.render(<JuniorLeagueApp/>,document.getElementById('root'));
  </script>
</body>
</html>
